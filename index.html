<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#1B5E20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <title>Nhóm hộ CCR Nam Phát - Định Hoá</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <style>
    :root {
      --forest-primary: #1B5E20;
      --forest-gradient: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
      --gold-gradient: linear-gradient(135deg, #FBC02D 0%, #F57F17 100%);
      --blue-gradient: linear-gradient(135deg, #42A5F5 0%, #1565C0 100%);
      --bg-light: #F8F9FA;
      --text-main: #2c3e50;
    }

    body {
      font-family: 'Be Vietnam Pro', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-main);
      overflow: hidden;
      font-size: 13px;
      line-height: normal;
    }

    #login-screen {
      background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 40%, #43A047 100%);
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .login-card {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 380px;
      margin: 0 16px;
      overflow: hidden;
    }
    .login-header {
      background: linear-gradient(135deg, #1B5E20, #2E7D32);
      padding: 28px 24px 22px;
      text-align: center;
    }
    .login-body { padding: 24px 24px 20px; }
    .login-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .login-input-group i.input-icon {
      color: #2E7D32; font-size: 18px; flex-shrink: 0; width: 22px; text-align: center;
    }
    .login-input-group .input-wrap {
      position: relative; flex: 1;
    }
    .login-input-group .form-control {
      padding: 14px 40px 14px 14px;
      border-radius: 10px;
      border: 1.5px solid #e0e0e0;
      font-size: 15px;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    .login-input-group .form-control:focus {
      border-color: #2E7D32;
      box-shadow: 0 0 0 3px rgba(46,125,50,0.12);
    }
    .login-input-group .toggle-pass {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: #999; cursor: pointer; z-index: 2;
    }
    .btn-login-main {
      background: linear-gradient(135deg, #2E7D32, #1B5E20);
      color: #fff; border: none; border-radius: 10px;
      padding: 14px; font-size: 16px; font-weight: 600;
      width: 100%; transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(27,94,32,0.3);
    }
    .btn-login-main:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(27,94,32,0.4); background: linear-gradient(135deg, #388E3C, #2E7D32); color: #fff; }
    .btn-login-main:active { transform: translateY(0); }
    .btn-register-main {
      background: linear-gradient(135deg, #43A047, #2E7D32);
      color: #fff; border: none; border-radius: 10px;
      padding: 14px; font-size: 16px; font-weight: 600;
      width: 100%; transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(46,125,50,0.3);
    }
    .btn-register-main:hover { transform: translateY(-1px); color: #fff; }
    @media (max-width: 767px) {
      .login-card { max-width: 100%; margin: 0 12px; border-radius: 16px; }
      .login-header { padding: 22px 20px 18px; }
      .login-header img { height: 56px !important; }
      .login-header h5 { font-size: 15px !important; }
      .login-body { padding: 20px 18px 16px; }
      .login-input-group i.input-icon { font-size: 18px; }
      .login-input-group .form-control { padding: 14px 40px 14px 14px; font-size: 15px; }
      .btn-login-main, .btn-register-main { padding: 14px; font-size: 16px; }
    }
    @media (max-width: 374px) {
      .login-card { margin: 0 8px; }
      .login-header { padding: 18px 14px 14px; }
      .login-header img { height: 48px !important; }
      .login-body { padding: 16px 14px 12px; }
      .login-input-group .form-control { padding: 12px 36px 12px 12px; font-size: 14px; }
    }

    #sidebar-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 270px;
      background: #fff;
      border-right: 1px solid #eaeaea;
      transition: transform 0.3s ease-in-out;
      z-index: 1050;
      transform: translateX(-100%);
      /* Default hidden on mobile */
    }

    /* PC Mode: Sidebar Visible by default */
    @media (min-width: 992px) {
      #sidebar-wrapper {
        transform: translateX(0);
        box-shadow: none;
        transition: transform 0.3s ease;
      }
      #page-content-wrapper {
        margin-left: 270px;
        transition: margin-left 0.3s ease;
      }
      /* PC sidebar hidden */
      #sidebar-wrapper.pc-hidden {
        transform: translateX(-100%);
      }
      #page-content-wrapper.sidebar-collapsed {
        margin-left: 0;
      }
    }

    /* Mobile/Tablet Mode: Sidebar Toggled */
    #sidebar-wrapper.show-sidebar {
      transform: translateX(0);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    /* Overlay for mobile */
    #sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1040;
      display: none;
    }

    #sidebar-overlay.active {
      display: block;
    }

    .sidebar-header {
      padding: 10px;
      background: var(--forest-gradient);
      color: white;
      font-weight: 700;
      text-align: center;
      flex-shrink: 0;
      font-size: 20px;
      transition: all 0.3s ease;
    }
    .sidebar-header:hover {
      background: linear-gradient(135deg, #388E3C 0%, #1B5E20 100%);
    }
    .sidebar-header .home-icon {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: rgba(255,255,255,0.15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .sidebar-header:hover .home-icon {
      background: rgba(255,255,255,0.25);
      transform: scale(1.1);
    }

    .accordion-button {
      font-size: 12px;
      font-weight: 700;
      padding: 8px 12px;
      color: #444;
    }

    .accordion-button:not(.collapsed) {
      color: var(--forest-primary);
      background-color: #E8F5E9;
      box-shadow: inset 3px 0 0 var(--forest-primary);
    }

    .accordion-button:focus {
      box-shadow: none;
    }

    .menu-sub-link {
      display: block;
      padding: 6px 14px 6px 20px;
      color: #555;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      border-left: 4px solid transparent;
    }

    .menu-sub-link:hover {
      background-color: #f0f7f1;
      color: var(--forest-primary);
      border-left: 4px solid var(--forest-primary);
    }
    .menu-sub-link.active {
      background-color: #E8F5E9;
      color: var(--forest-primary);
      border-left: 4px solid var(--forest-primary);
      font-weight: 700;
    }
    /* All sidebar icons dark green */
    .accordion-button i,
    .menu-sub-link i {
      color: #1B5E20 !important;
      opacity: 1 !important;
    }
    .accordion-button:not(.collapsed) i {
      color: #1B5E20 !important;
    }
    .search-result-item:hover { background-color: #E8F5E9 !important; }

    /* Detail action bar - drill-down buttons */
    .detail-action-bar {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .detail-action-bar .btn {
      white-space: nowrap;
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 20px;
    }

    /* Audit form: sticky header + compact file area */
    .audit-sticky-header {
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .audit-sticky-context {
      position: sticky;
      top: 52px;
      z-index: 19;
    }
    .audit-card .bg-light.p-2.rounded {
      padding: 4px 6px !important;
    }
    .audit-card .audit-file {
      font-size: 10px !important;
      padding: 2px 4px !important;
    }
    .audit-card .input-group-sm .input-group-text {
      padding: 2px 6px !important;
    }

    .dashboard-card-3d {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 12px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: none;
      height: 100%;
      position: relative;
      overflow: hidden;
    }
    .dashboard-card-3d::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--card-accent, var(--forest-gradient));
      border-radius: 16px 16px 0 0;
    }

    .dashboard-card-3d:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }
    .dashboard-card-3d:active {
      transform: translateY(-2px);
    }

    .icon-3d-wrapper {
      width: 48px;
      height: 48px;
      margin: 0 auto 10px auto;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
      background: var(--forest-gradient);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
      transition: transform 0.3s ease;
    }
    .dashboard-card-3d:hover .icon-3d-wrapper {
      transform: scale(1.1);
    }

    .card-title-3d {
      font-weight: 700;
      color: #333;
      font-size: 12px;
      letter-spacing: 0.2px;
      line-height: 1.3;
    }

    .nav-pills {
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 12px;
    }

    .nav-pills .nav-link {
      border-radius: 30px;
      padding: 6px 14px;
      font-weight: 600;
      color: var(--forest-primary);
      background: #fff;
      border: 2px solid #E8F5E9;
      transition: all 0.3s ease;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .nav-pills .nav-link:hover {
      background-color: #E8F5E9;
      transform: translateY(-2px);
    }

    .nav-pills .nav-link.active {
      background: var(--forest-gradient) !important;
      color: white !important;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(27, 94, 32, 0.4);
      transform: scale(1.05);
    }

    .fsc-breadcrumb {
      background: white;
      padding: 6px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      font-size: 12px;
      border: 1px solid #eee;
    }

    .breadcrumb-item {
      cursor: pointer;
      color: var(--forest-primary);
      font-weight: 600;
    }

    .breadcrumb-item:hover {
      text-decoration: underline;
    }

    .breadcrumb-item.active {
      color: #777;
      cursor: default;
      text-decoration: none;
    }

    .breadcrumb-separator {
      margin: 0 6px;
      color: #ccc;
      font-size: 11px;
    }

    table.dataTable {
      border-collapse: separate !important;
      border-spacing: 0;
      width: 100% !important;
    }

    table.dataTable thead th {
      background-color: #f1f3f5 !important;
      color: #333;
      padding: 6px 10px !important;
      font-size: 13px;
      border-bottom: 2px solid #ccc !important;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table-responsive {
      max-height: calc(100vh - 280px);
      overflow-y: auto;
    }

    table.dataTable tbody td {
      padding: 6px 10px !important;
      font-size: 13px;
      vertical-align: middle;
      border-bottom: 1px solid #eee;
    }

    .clickable-row {
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .clickable-row:hover {
      background-color: #f1f8e9 !important;
      color: #1B5E20;
    }

    .form-control,
    .form-select {
      font-size: 13px;
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #2E7D32;
      box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
    }

    .btn {
      font-size: 12px;
      font-weight: 700;
      padding: 6px 14px;
      border-radius: 30px;
    }

    .logo-bounce {
      animation: bounce 2s infinite;
    }

    @keyframes bounce {

      0%,
      20%,
      50%,
      80%,
      100% {
        transform: translateY(0);
      }

      40% {
        transform: translateY(-10px);
      }

      60% {
        transform: translateY(-5px);
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f8f9fa;
    }

    ::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    /* Mobile Responsive */
    @media (max-width: 767px) {
      body {
        font-size: 12px !important;
        -webkit-text-size-adjust: 100%;
      }
      /* Navbar mobile */
      .navbar {
        padding: 4px 8px !important;
        min-height: 44px !important;
      }
      .navbar .position-absolute {
        position: relative !important;
        transform: none !important;
        left: auto !important;
        flex: 1;
        min-width: 0;
      }
      .navbar > .d-flex:last-child {
        flex-shrink: 0;
      }
      .navbar .fw-bold[style*="font-size: 25px"] {
        font-size: 13px !important;
        letter-spacing: 0 !important;
      }
      #navbar-project-name {
        font-size: 13px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 140px;
        display: inline-block !important;
        vertical-align: middle;
      }
      .navbar img[height="42"] {
        height: 28px !important;
        margin-right: 6px !important;
      }
      /* Sidebar menu */
      .sidebar-header {
        font-size: 12px !important;
        padding: 10px !important;
      }
      #sidebarAccordion .accordion-button {
        font-size: 12px !important;
        padding: 6px 10px !important;
      }
      .menu-sub-link {
        font-size: 12px !important;
        padding: 5px 10px 5px 28px !important;
      }
      .menu-sub-link i {
        font-size: 10px !important;
      }
      /* Dashboard cards */
      .dashboard-card-3d {
        padding: 10px 6px 8px !important;
        border-radius: 10px !important;
      }
      .icon-3d-wrapper {
        width: 32px !important;
        height: 32px !important;
        font-size: 0.85rem !important;
        border-radius: 8px !important;
        margin-bottom: 4px !important;
      }
      .card-title-3d {
        font-size: 9px !important;
        line-height: 1.2 !important;
      }
      /* KPI cards mobile */
      .kpi-card {
        padding: 4px 6px !important;
        border-radius: 8px !important;
      }
      .kpi-value {
        font-size: 0.85rem !important;
      }
      .kpi-label {
        font-size: 8px !important;
      }
      /* Charts mobile */
      #dashboard-view .card {
        margin-bottom: 6px;
      }
      #dashboard-view .card-body {
        padding: 6px !important;
      }
      #dashboard-view .card-body h6 {
        font-size: 10px !important;
      }
      #dashboard-view .form-select-sm {
        font-size: 9px !important;
        padding: 1px 16px 1px 4px !important;
      }
      /* Audit Form */
      .audit-card {
        font-size: 11px !important;
      }
      .audit-card .card-body {
        padding: 6px !important;
      }
      .audit-card h6 {
        font-size: 11px !important;
        min-height: 30px !important;
        margin-bottom: 4px !important;
      }
      .audit-card .badge {
        font-size: 10px !important;
      }
      .audit-card .btn-group .btn {
        font-size: 10px !important;
        padding: 3px 5px !important;
      }
      .audit-card .form-control-sm {
        font-size: 11px !important;
        padding: 3px 5px !important;
      }
      .audit-card .input-group-text {
        font-size: 11px !important;
        padding: 3px 5px !important;
      }
      #auditAccordion .accordion-button {
        font-size: 11px !important;
        padding: 6px 10px !important;
      }
      /* Detail view mobile */
      .detail-card .col-md-4 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }
      .detail-card .col-md-4 label {
        font-size: 10px !important;
      }
      .detail-card .col-md-4 .fw-medium {
        font-size: 11px !important;
      }
      /* Header bar detail mobile */
      .border-start.border-4 .d-flex {
        flex-wrap: wrap;
        gap: 4px;
      }
      .border-start.border-4 h6 {
        font-size: 12px !important;
      }
      /* Lo_rung action buttons mobile */
      .d-flex.gap-2.mb-2.flex-wrap .btn {
        font-size: 10px !important;
        padding: 4px 6px !important;
        flex: 1 1 calc(50% - 4px) !important;
        max-width: calc(50% - 4px);
      }
      /* Forms */
      .form-control, .form-select {
        font-size: 11px !important;
        padding: 5px 8px !important;
      }
      /* Tables */
      .table-responsive {
        max-height: calc(100vh - 220px) !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
      }
      table.dataTable {
        white-space: nowrap;
      }
      table.dataTable thead th {
        padding: 4px 6px !important;
        font-size: 10px !important;
        font-weight: 700 !important;
      }
      table.dataTable tbody td {
        padding: 3px 6px !important;
        font-size: 10px !important;
      }
      /* Card headers on mobile */
      .card-header.bg-success {
        padding: 8px 10px !important;
      }
      .card-header h5 {
        font-size: 12px !important;
      }
      /* Buttons */
      .btn {
        font-size: 11px !important;
        padding: 4px 10px !important;
      }
      /* Breadcrumb mobile */
      .fsc-breadcrumb {
        padding: 4px 8px !important;
        font-size: 10px !important;
        margin-bottom: 6px !important;
      }
      #data-view > .d-flex:first-child {
        margin-bottom: 6px !important;
      }
      #data-view > .d-flex:first-child .btn {
        font-size: 10px !important;
        padding: 3px 8px !important;
      }
      /* Sub-menu cards mobile */
      .submenu-card {
        padding: 10px 6px !important;
        border-radius: 8px !important;
      }
      .submenu-icon {
        width: 36px !important;
        height: 36px !important;
        font-size: 1rem !important;
        margin-bottom: 6px !important;
      }
      .submenu-label {
        font-size: 10px !important;
      }
      /* Modal mobile */
      .modal-dialog {
        margin: 8px !important;
      }
      .modal-body {
        padding: 10px !important;
      }
      .modal-header {
        padding: 8px 12px !important;
      }
      .modal-title {
        font-size: 13px !important;
      }
      /* Settings mobile */
      .settings-col-pc, .settings-col-mobile {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }
      /* Page content */
      #page-content-wrapper {
        padding: 6px !important;
        padding-bottom: 60px !important;
      }
      /* Map toolbar mobile */
      .map-toolbar {
        padding: 4px 6px !important;
      }
      .map-toolbar .btn {
        font-size: 9px !important;
        padding: 3px 6px !important;
      }
      .map-toolbar span.fw-bold {
        font-size: 10px !important;
      }
      /* Logout button mobile - keep compact */
      .btn-logout {
        font-size: 10px !important;
        padding: 3px 8px !important;
      }
    }

    /* Mobile Bottom Navigation Bar */
    #mobile-home-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1060;
      background: rgba(255,255,255,0.97);
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
      padding: 6px 0 env(safe-area-inset-bottom, 6px) 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    #mobile-home-bar .mob-nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: none;
      border: none;
      color: #1B5E20;
      font-size: 10px;
      padding: 4px 12px;
      cursor: pointer;
      transition: color 0.2s;
    }
    #mobile-home-bar .mob-nav-btn i {
      font-size: 1.2rem;
      margin-bottom: 2px;
      color: #1B5E20;
    }
    #mobile-home-bar .mob-nav-btn.active,
    #mobile-home-bar .mob-nav-btn:active {
      color: #1B5E20;
      font-weight: 700;
    }

    /* Dashboard: fit one screen */
    #dashboard-view {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 76px);
      overflow: hidden;
    }
    #dashboard-view h5 { margin-bottom: 8px !important; font-size: 15px; }
    #dashboard-view h6 { margin-bottom: 6px !important; font-size: 12px; }
    #dashboard-view .kpi-card { padding: 8px 12px; }
    #dashboard-view .kpi-value { font-size: 1.15rem; }
    #dashboard-view .kpi-label { font-size: 11px; }
    #dashboard-view .dashboard-card-3d { padding: 18px 10px 14px; }
    #dashboard-view .icon-3d-wrapper { width: 44px; height: 44px; font-size: 1.15rem; margin-bottom: 8px; border-radius: 13px; }
    #dashboard-view .card-title-3d { font-size: 12px; font-weight: 700; }
    @media (max-width: 767px) {
      #dashboard-view { height: auto; min-height: calc(100vh - 110px); overflow-y: auto; }
      #dashboard-view h5 { font-size: 13px !important; margin-bottom: 6px !important; }
      #dashboard-view h6 { font-size: 10px !important; margin-bottom: 4px !important; }
      #dashboard-view .icon-3d-wrapper { width: 30px !important; height: 30px !important; font-size: 0.8rem !important; border-radius: 8px !important; margin-bottom: 3px !important; }
      #dashboard-view .card-title-3d { font-size: 9px !important; }
      #dashboard-view .kpi-value { font-size: 0.9rem !important; }
      #dashboard-view .kpi-label { font-size: 8px !important; letter-spacing: 0; text-transform: none; }
      #dashboard-view .kpi-card { padding: 6px 6px !important; border-radius: 8px !important; text-align: center; }
      #dashboard-view .kpi-grid { margin-bottom: 6px !important; }
      #dashboard-view .dashboard-card-3d { padding: 8px 4px 6px !important; border-radius: 8px !important; }
      #dashboard-view .row.g-3 { --bs-gutter-x: 0.5rem; --bs-gutter-y: 0.5rem; }
    }

    /* Sub-menu Screen Cards */
    .submenu-card {
      background: #fff;
      border-radius: 12px;
      padding: 18px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      height: 100%;
    }
    .submenu-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    .submenu-icon {
      width: 48px; height: 48px;
      margin: 0 auto 10px auto;
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.2rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .submenu-label {
      font-weight: 600; font-size: 12px; color: #333;
    }

    /* Dashboard Sub-menu Popup (legacy) */
    .dash-submenu {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background: #fff;
      border-radius: 10px;
      min-width: 220px;
      padding: 6px 0;
      border: 1px solid #e8e8e8;
      animation: fadeInUp 0.15s ease;
    }
    .dash-submenu-link {
      display: block;
      padding: 6px 14px;
      color: #333;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      transition: background 0.15s;
    }
    .dash-submenu-link:hover {
      background: #E8F5E9;
      color: #1B5E20;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateX(-50%) translateY(6px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* KPI Cards */
    .kpi-card {
      background: white;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-left: 4px solid #1B5E20;
      transition: all 0.25s ease;
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
    .kpi-value { font-size: 1.3rem; font-weight: 800; color: #1B5E20 !important; letter-spacing: -0.5px; }
    .kpi-label { font-size: 11px; color: #777; font-weight: 600; letter-spacing: 0.3px; }
    .kpi-card.blue { border-left-color: #1B5E20; }
    .kpi-card.blue .kpi-value { color: #1B5E20; }
    .kpi-card.orange { border-left-color: #1B5E20; }
    .kpi-card.orange .kpi-value { color: #1B5E20; }
    .kpi-card.purple { border-left-color: #1B5E20; }
    .kpi-card.purple .kpi-value { color: #1B5E20; }

    /* Map Styles */
    #map-container {
      width: 100%;
      height: calc(100vh - 160px);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    .map-toolbar {
      background: white;
      border-radius: 8px;
      padding: 6px 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 8px;
    }
    .map-layer-control {
      position: absolute;
      top: 70px;
      right: 20px;
      z-index: 1000;
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      max-height: 300px;
      overflow-y: auto;
      min-width: 180px;
    }
    .map-layer-control label {
      display: block;
      cursor: pointer;
      padding: 3px 0;
      font-size: 12px;
    }
    @media (max-width: 767px) {
      #map-container {
        height: calc(100vh - 200px);
        border-radius: 8px;
      }
    }

    /* Plot label tooltips on map (visible at high zoom only) */
    .plot-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      font-size: 8px !important;
      line-height: 1.2 !important;
      color: #1a1a1a;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
      text-shadow: 1px 1px 2px #fff, -1px -1px 2px #fff, 1px -1px 2px #fff, -1px 1px 2px #fff;
      padding: 0 !important;
    }
    .plot-label::before { display: none !important; }

    /* Handbook content styles */
    .handbook-content { font-size: 15px; line-height: 1.7; color: #333; padding: 10px 0; }
    .handbook-content h1 { color: #1b5e20; font-size: 1.5rem; font-weight: 800; border-bottom: 3px solid #a5d6a7; padding-bottom: 8px; margin: 28px 0 14px; }
    .handbook-content h2 { color: #2e7d32; font-size: 1.3rem; font-weight: 700; border-bottom: 2px solid #c8e6c9; padding-bottom: 6px; margin: 24px 0 12px; }
    .handbook-content h3 { color: #388e3c; font-size: 1.15rem; font-weight: 700; margin: 20px 0 10px; }
    .handbook-content h4, .handbook-content h5 { color: #43a047; font-weight: 700; margin: 16px 0 8px; }
    .handbook-content p { margin-bottom: 10px; text-align: justify; }
    .handbook-content table { width: 100%; border-collapse: collapse; margin: 14px 0; font-size: 14px; }
    .handbook-content table th { background: #e8f5e9; color: #1b5e20; font-weight: 700; border: 1px solid #a5d6a7; padding: 8px 10px; }
    .handbook-content table td { border: 1px solid #c8e6c9; padding: 7px 10px; vertical-align: top; }
    .handbook-content table tr:nth-child(even) { background: #f1f8e9; }
    .handbook-content img { max-width: 100%; height: auto; border-radius: 6px; margin: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
    .handbook-content ul, .handbook-content ol { padding-left: 24px; margin-bottom: 12px; }
    .handbook-content li { margin-bottom: 4px; }
    .handbook-content a { color: #2e7d32; }
    .handbook-loading { text-align: center; padding: 60px 20px; color: #888; }
    @media print {
      .no-print, .navbar, .sidebar, .fsc-breadcrumb, #handbookTabs { display: none !important; }
      .handbook-content { font-size: 12pt; line-height: 1.5; padding: 0; }
      .handbook-content h1 { font-size: 16pt; }
      .handbook-content h2 { font-size: 14pt; }
      .handbook-content table { page-break-inside: auto; }
      .handbook-content tr { page-break-inside: avoid; }
      .handbook-content img { max-width: 80%; page-break-inside: avoid; }
      .card { box-shadow: none !important; border: none !important; }
    }
  </style>
</head>

<body style="font-family: 'Be Vietnam Pro', sans-serif; background-color: #F8F9FA;">

  <div id="login-screen" class="d-flex align-items-center justify-content-center" style="min-height:100vh;min-height:100dvh">
    <div class="login-card">
      <div class="login-header" style="position:relative">
        <button type="button" class="btn btn-sm" onclick="toggleLang()" style="position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600" id="lang-toggle-login">
          <i class="fa-solid fa-globe me-1"></i><span id="lang-label-login">EN</span>
        </button>
        <div class="d-flex align-items-center justify-content-center" style="gap:12px;margin-bottom:10px">
          <img src="Logo Clever forestry.png" height="52" alt="Clever Forestry" style="border-radius:8px;background:#fff;padding:2px" onerror="this.style.display='none'">
          <img id="login-logo-custom" src="data:," height="52" alt="" style="border-radius:8px;background:#fff;padding:2px;display:none">
        </div>
        <h5 style="color:#fff;font-weight:700;font-size:15px;margin:0;letter-spacing:0.3px" data-i18n="login_title">He thong Quan ly Rung FSC</h5>
        <div style="color:rgba(255,255,255,0.7);font-size:11px;margin-top:4px" data-i18n="login_subtitle">Forest Stewardship Council</div>
      </div>

      <div class="login-body">
        <form id="form-login">
          <div class="login-input-group">
            <i class="fa-solid fa-user input-icon"></i>
            <div class="input-wrap">
              <input type="text" class="form-control" id="login-email" data-i18n-ph="ph_email_user" placeholder="Email hoac Username" required autocomplete="username" autocapitalize="none" autocorrect="off" spellcheck="false" inputmode="email">
            </div>
          </div>
          <div class="login-input-group">
            <i class="fa-solid fa-lock input-icon"></i>
            <div class="input-wrap">
              <input type="password" class="form-control" id="login-pass" data-i18n-ph="ph_password" placeholder="Mat khau" required autocomplete="current-password">
              <button type="button" class="toggle-pass" onclick="togglePasswordVis(this)" tabindex="-1"><i class="fa-solid fa-eye"></i></button>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3" style="margin-top:-2px">
            <a href="javascript:void(0)" class="text-decoration-none text-success fw-semibold" style="font-size:13px" onclick="toggleAuth('REGISTER')" data-i18n="register_new">Dang ky moi</a>
            <a href="javascript:void(0)" class="text-decoration-none text-muted" style="font-size:12px" onclick="handleForgotPassword()" data-i18n="forgot_pass">Quen mat khau?</a>
          </div>
          <button type="submit" class="btn btn-login-main" id="btn-login"><i class="fa-solid fa-right-to-bracket me-2"></i><span data-i18n="btn_login">Dang nhap</span></button>
        </form>

        <form id="form-register" class="d-none">
          <div class="login-input-group">
            <i class="fa-solid fa-user-pen input-icon"></i>
            <div class="input-wrap"><input type="text" class="form-control" id="reg-name" data-i18n-ph="ph_fullname" placeholder="Ho ten day du" required></div>
          </div>
          <div class="login-input-group">
            <i class="fa-solid fa-at input-icon"></i>
            <div class="input-wrap"><input type="text" class="form-control" id="reg-username" data-i18n-ph="ph_username" placeholder="Username (viet lien, khong dau)" required autocapitalize="none" autocorrect="off" spellcheck="false" pattern="[a-zA-Z0-9_]+" title="Chi cho phep chu cai, so va dau gach duoi"></div>
          </div>
          <div class="login-input-group">
            <i class="fa-solid fa-envelope input-icon"></i>
            <div class="input-wrap"><input type="email" class="form-control" id="reg-email" placeholder="Email" required autocapitalize="none"></div>
          </div>
          <div class="login-input-group">
            <i class="fa-solid fa-phone input-icon"></i>
            <div class="input-wrap"><input type="tel" class="form-control" id="reg-phone" data-i18n-ph="ph_phone" placeholder="So dien thoai"></div>
          </div>
          <div class="login-input-group">
            <i class="fa-solid fa-lock input-icon"></i>
            <div class="input-wrap">
              <input type="password" class="form-control" id="reg-pass" data-i18n-ph="ph_password" placeholder="Mat khau" required autocomplete="new-password">
              <button type="button" class="toggle-pass" onclick="togglePasswordVis(this)" tabindex="-1"><i class="fa-solid fa-eye"></i></button>
            </div>
          </div>
          <div class="login-input-group">
            <i class="fa-solid fa-check-double input-icon"></i>
            <div class="input-wrap"><input type="password" class="form-control" id="reg-confirm-pass" data-i18n-ph="ph_confirm_pass" placeholder="Nhap lai mat khau" required autocomplete="new-password"></div>
          </div>
          <button type="submit" class="btn btn-register-main mb-3" id="btn-register"><i class="fa-solid fa-user-plus me-2"></i><span data-i18n="btn_register">Dang ky</span></button>
          <div class="text-center">
            <a href="javascript:void(0)" class="text-decoration-none text-success fw-semibold" style="font-size:13px" onclick="toggleAuth('LOGIN')"><i class="fa-solid fa-arrow-left me-1"></i><span data-i18n="back_login">Quay lai Dang nhap</span></a>
          </div>
        </form>

        <div id="login-error" class="text-danger mt-2 small fw-bold text-center" style="display:none"></div>
      </div>

      <div class="text-center py-3" style="background:#f8f9fa;border-top:1px solid #eee;font-size:11px;color:#999">
        <i class="fa-solid fa-code me-1"></i> <span data-i18n="developed_by">Phat trien boi Cong ty tu van CleverForestry</span>
      </div>
    </div>
  </div>

  <div id="main-app" class="d-none d-flex flex-column vh-100">
    <nav class="navbar navbar-dark bg-success shadow px-2 px-md-3 d-flex align-items-center"
      style="background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%) !important; min-height: 56px;">
      <button class="btn text-white flex-shrink-0 d-none d-lg-inline-block" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>
      <div class="navbar-title-area position-absolute start-50 translate-middle-x text-center d-none d-md-flex align-items-center" style="gap:12px">
        <img src="Logo Clever forestry.png" height="40" alt="Clever Forestry" style="border-radius:6px" onerror="this.style.display='none'">
        <span class="text-white fw-bold" style="font-size:20px;letter-spacing:0.5px;text-transform:uppercase" id="navbar-project-name">Quan ly rung ben vung FSC</span>
        <img id="navbar-logo-custom" src="data:," height="40" alt="" style="border-radius:6px;display:none">
      </div>
      <div class="d-md-none d-flex align-items-center justify-content-center flex-grow-1 min-w-0 ms-1" style="gap:6px">
        <img src="Logo Clever forestry.png" height="28" class="flex-shrink-0" alt="CF" style="border-radius:4px">
        <span class="text-white fw-bold text-center text-nowrap" id="navbar-project-name-mobile" style="font-size:12px;line-height:1;letter-spacing:0.3px">QUẢN LÝ RỪNG FSC</span>
        <img id="navbar-logo-custom-mobile" src="data:," height="28" class="flex-shrink-0" alt="" style="border-radius:4px;display:none">
      </div>
      <div class="d-flex align-items-center gap-1 gap-md-2 ms-auto flex-shrink-0">
        <div class="text-end d-none d-md-block" style="line-height:1.2">
          <div class="fw-bold" id="navbar-clock" style="font-size:14px;color:#fff;letter-spacing:0.5px"></div>
          <div style="font-size:11px;opacity:0.8;color:#fff" id="navbar-date"></div>
        </div>
        <span class="text-white me-1 small d-none d-md-block" id="user-display-name" style="opacity:0.85">User</span>
        <span id="offline-badge" class="badge bg-warning text-dark d-none" style="font-size:10px"><i class="fa-solid fa-wifi-slash me-1"></i>Offline</span>
        <button type="button" class="btn btn-sm btn-logout fw-bold rounded-pill px-2 px-md-3 shadow-sm"
          style="background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3);white-space:nowrap"
          onmouseenter="this.style.background='rgba(255,255,255,0.3)'" onmouseleave="this.style.background='rgba(255,255,255,0.15)'"
          onclick="logout()"><i class="fa-solid fa-right-from-bracket me-1"></i><span class="d-none d-sm-inline" data-i18n="btn_logout">Thoát</span></button>
      </div>
    </nav>

    <div class="d-flex flex-grow-1 overflow-hidden">
      <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
      <div id="sidebar-wrapper" class="bg-white border-end shadow-sm">
        <div class="sidebar-header d-flex align-items-center justify-content-center" style="cursor:pointer" onclick="goHome()" id="sidebar-home-btn">
          <span class="home-icon"><i class="fa-solid fa-house"></i></span>
        </div>
        <div class="accordion accordion-flush overflow-auto h-100" id="sidebarAccordion"></div>
      </div>

      <div id="page-content-wrapper" class="flex-grow-1 bg-light overflow-auto p-2 p-md-3">
        <div id="dashboard-view"></div>
        <div id="data-view" class="d-none">
          <div class="d-flex align-items-center mb-3">
            <button class="btn btn-outline-success btn-sm me-3 px-3 rounded-pill fw-bold" onclick="navigateBack()">
              <i class="fa-solid fa-arrow-left me-1"></i> <span data-i18n="btn_back">Quay lại</span>
            </button>
            <div id="breadcrumb-container" class="flex-grow-1"></div>
          </div>
          <div id="page-content-dynamic"></div>
          <div id="map-view" class="d-none">
            <div class="map-toolbar d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div>
                <span class="fw-bold text-success" data-i18n="map_title">Bản đồ quản lý lô rừng</span>
              </div>
              <div class="d-flex gap-2 flex-wrap">
                <label class="btn btn-outline-success btn-sm mb-0">
                  <i class="fa-solid fa-upload me-1"></i> <span data-i18n="btn_upload_geojson">Tải GeoJSON</span>
                  <input type="file" accept=".geojson,.json" class="d-none" id="geojson-upload" onchange="handleGeoJSONUpload(event)">
                </label>
                <button type="button" class="btn btn-outline-success btn-sm" id="btn-edit-polygon" onclick="togglePolygonEdit()">
                  <i class="fa-solid fa-pen-to-square me-1"></i> <span data-i18n="btn_edit_polygon">Chỉnh sửa</span>
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleMapLayers()">
                  <i class="fa-solid fa-layer-group me-1"></i> <span data-i18n="btn_layers">Lớp</span>
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="addMapNote()">
                  <i class="fa-solid fa-sticky-note me-1"></i> <span data-i18n="map_notes">Ghi chú</span>
                </button>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-success btn-sm" onclick="zoomToAllData()">
                    <i class="fa-solid fa-expand me-1"></i> <span data-i18n="btn_zoom_all">Toàn bộ</span>
                  </button>
                  <button type="button" class="btn btn-outline-success btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
                  <ul class="dropdown-menu dropdown-menu-end" id="zoom-layer-menu">
                    <li><a class="dropdown-item small" href="#" onclick="zoomToAllData();return false"><i class="fa-solid fa-globe me-1"></i> <span data-i18n="btn_all_layers">Tất cả lớp</span></a></li>
                  </ul>
                </div>
                <button type="button" class="btn btn-outline-success btn-sm" id="btn-toggle-labels" onclick="togglePlotLabels()">
                  <i class="fa-solid fa-tag me-1"></i> Nhãn
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="openGeoJSONRepo()">
                  <i class="fa-solid fa-database me-1"></i> <span data-i18n="btn_geo_repo">Kho bản đồ</span>
                </button>
                <button type="button" class="btn btn-success btn-sm" onclick="goHome()">
                  <i class="fa-solid fa-house me-1"></i> <span data-i18n="btn_home">Trang chủ</span>
                </button>
              </div>
            </div>
            <div id="map-container"></div>
            <div id="map-layer-panel" class="map-layer-control d-none"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="mobile-home-bar" class="d-md-none">
      <button type="button" class="mob-nav-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i><span data-i18n="nav_menu">Menu</span>
      </button>
      <button type="button" class="mob-nav-btn active" onclick="goHome()">
        <i class="fa-solid fa-house"></i><span data-i18n="nav_home">Trang chủ</span>
      </button>
      <button type="button" class="mob-nav-btn" onclick="loadView('Bando_lorung','Bản đồ quản lý lô rừng')">
        <i class="fa-solid fa-map"></i><span data-i18n="nav_map">Bản đồ</span>
      </button>
    </div>
  </div>

  <div class="modal fade" id="dataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalTitle">Form</h5><button type="button" class="btn-close btn-close-white"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="dynamic-form" class="row g-3"></form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-light"
            data-bs-dismiss="modal"><span data-i18n="modal_close">Đóng</span></button><button type="button" class="btn btn-success" id="btn-save"
            onclick="saveData()"><span data-i18n="modal_save">Lưu</span></button></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // === SERVICE WORKER REGISTRATION (PWA Offline) ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => {
          console.log('SW registered:', reg.scope);
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'activated') {
                console.log('SW updated - new content available');
              }
            });
          });
        }).catch(err => console.warn('SW registration failed:', err));
      });
    }

    // === OFFLINE/ONLINE STATUS ===
    function updateOnlineStatus() {
      const badge = document.getElementById('offline-badge');
      if (badge) { navigator.onLine ? badge.classList.add('d-none') : badge.classList.remove('d-none'); }
    }
    window.addEventListener('online', () => { updateOnlineStatus(); console.log('Back online'); });
    window.addEventListener('offline', () => { updateOnlineStatus(); console.log('Gone offline'); });

    // === INTERNATIONALIZATION (i18n) ===
    let currentLang = localStorage.getItem('fscfm_lang') || 'vi';

    const LANG = {
      vi: {
        // Login screen
        login_title: 'Nhóm hộ CCR Nam Phát - Định Hoá',
        login_subtitle: 'Quản lý Rừng bền vững FSC',
        ph_email_user: 'Email hoặc Username',
        ph_password: 'Mật khẩu',
        ph_fullname: 'Họ tên đầy đủ',
        ph_username: 'Username (viết liền, không dấu)',
        ph_phone: 'Số điện thoại',
        ph_confirm_pass: 'Nhập lại mật khẩu',
        register_new: 'Đăng ký mới',
        forgot_pass: 'Quên mật khẩu?',
        btn_login: 'Đăng nhập',
        btn_register: 'Đăng ký',
        back_login: 'Quay lại Đăng nhập',
        developed_by: 'Phát triển bởi Công ty tư vấn CleverForestry',
        processing: 'Đang xử lý...',
        registering: 'Đang đăng ký...',
        username_not_found: 'Không tìm thấy username này',
        conn_error: 'Lỗi kết nối',
        pass_mismatch: 'Mật khẩu nhập lại không khớp!',
        pass_min6: 'Mật khẩu phải có ít nhất 6 ký tự!',
        username_invalid: 'Username chỉ được chứa chữ cái thường, số và dấu _',
        username_taken: 'đã được sử dụng!',
        reg_success: 'Đăng ký thành công! Vui lòng xác thực email rồi đăng nhập.',
        reg_error: 'Lỗi đăng ký',
        forgot_prompt: 'Vui lòng nhập Email đã đăng ký để lấy lại mật khẩu:',
        forgot_sent: 'Link đặt lại mật khẩu đã được gửi về Email!',
        forgot_error: 'Lỗi khi gửi yêu cầu!',

        // Dashboard
        dashboard_title: 'Tổng quan hệ thống',
        search_placeholder: 'Tìm kiếm dữ liệu, menu, chức năng...',
        kpi_title: 'Chỉ số KPI',
        kpi_households: 'Số hộ dân',
        kpi_plots: 'Số lô rừng',
        kpi_fsc_area: 'Tổng DT FSC (ha)',
        kpi_ha_per_ho: 'ha/hộ',
        kpi_ha_per_farm: 'TB ha/lô rừng',
        kpi_harvest_actual: 'DT khai thác (ha)',
        kpi_harvest_plan: 'DT KT kế hoạch (ha)',
        kpi_plant: 'DT trồng rừng (ha)',
        kpi_hlvs: 'DT HLVS (ha)',
        chart_area: 'Phân bổ diện tích',
        chart_groups: 'Thống kê theo nhóm',
        no_results: 'Không tìm thấy kết quả cho',

        // Main menus
        menu_group_mgmt: 'Quản lý nhóm',
        menu_forest_mgmt: 'Quản lý rừng bền vững',
        menu_trade: 'Mua bán sản phẩm',
        menu_docs: 'Tài liệu tham khảo',
        menu_system: 'Hệ thống',
        menu_report: 'Báo cáo',
        menu_monitoring: 'Giám sát',
        menu_settings: 'Cài đặt hệ thống',

        // Chart labels
        chart_fsc_area: 'Diện tích FSC',
        chart_non_fsc: 'DT ngoài FSC',
        chart_riparian: 'Hành lang ven suối',
        chart_planted: 'DT trồng rừng',

        // Buttons & Actions
        btn_back: 'Quay lại',
        btn_add: 'Thêm mới',
        btn_edit: 'Sửa',
        btn_delete: 'Xóa',
        btn_save: 'Lưu',
        btn_close: 'Đóng',
        btn_home: 'Trang chủ',
        btn_map: 'Bản đồ',
        btn_upload_geojson: 'Tải GeoJSON',
        btn_edit_polygon: 'Chỉnh sửa',
        btn_layers: 'Lớp',
        btn_zoom_all: 'Toàn bộ',
        btn_all_layers: 'Tất cả lớp',
        btn_geo_repo: 'Kho bản đồ',
        btn_logout: 'Thoát',
        btn_save_settings: 'Lưu cài đặt',
        btn_reset_settings: 'Khôi phục mặc định',

        // Map
        map_title: 'Bản đồ quản lý lô rừng',

        // Search categories
        search_menu: 'Menu',
        search_functions: 'Chức năng',

        // SEARCH_TABLES titles
        st_ban_ql: 'Ban quản lý nhóm',
        st_nhom: 'Nhóm CCR',
        st_churung: 'Chủ rừng',
        st_lorung: 'Lô rừng',
        st_nhansu: 'Nhân sự',
        st_taphuan: 'Tập huấn',
        st_danhgia: 'Đánh giá nội bộ',

        // Detail drill-down
        dd_nhom: 'Nhóm',
        dd_hodan: 'Hộ dân',
        dd_danhgia: 'Đánh giá',
        dd_lorung: 'Lô rừng',
        dd_taphuan: 'Tập huấn',
        dd_bando: 'Bản đồ',
        dd_baocao: 'Báo cáo',
        dd_kehoach: 'Kế hoạch',
        dd_giamsat: 'Giám sát',
        dd_pheduyet: 'Phê duyệt',

        // App functions (smart search)
        fn_gis_map: 'Bản đồ GIS',
        fn_internal_audit: 'Đánh giá nội bộ',
        fn_settings: 'Cài đặt hệ thống',
        fn_staff_mgmt: 'Quản lý nhân sự',
        fn_training: 'Tập huấn',
        fn_geo_repo: 'Kho bản đồ GeoJSON',
        fn_reports: 'Báo cáo',
        fn_plot_mgmt: 'Quản lý lô rừng',
        fn_owner_mgmt: 'Quản lý chủ rừng',
        fn_ccr_groups: 'Danh sách nhóm CCR',
        fn_mgmt_board: 'Ban quản lý nhóm',

        // Sidebar group names
        grp_group_mgmt: 'Quản lý nhóm',
        grp_forest_mgmt: 'Quản lý rừng bền vững',
        grp_monitoring: 'Giám sát',
        grp_trade: 'Mua bán sản phẩm',
        grp_docs: 'Tài liệu tham khảo',
        grp_system: 'Hệ thống',
        grp_report: 'Báo cáo',
        grp_other: 'Khác',
        grp_consultation: 'Tham vấn các bên liên quan',
        // Consultation Report
        rpt_title: 'Báo cáo phân tích tham vấn',
        rpt_select_session: 'Chọn đợt tham vấn',
        rpt_generate: 'Tạo báo cáo',
        rpt_export_pdf: 'Xuất PDF',
        rpt_overview: 'Tổng quan',
        rpt_response_rate: 'Tỉ lệ phản hồi',
        rpt_strengths: 'Điểm mạnh / Thuận lợi',
        rpt_weaknesses: 'Điểm yếu / Khó khăn',
        rpt_objective: 'Yếu tố khách quan',
        rpt_subjective: 'Yếu tố chủ quan',
        rpt_hcv_analysis: 'Phân tích Giá trị bảo tồn cao',
        rpt_recommendations: 'Kiến nghị và đề xuất',
        rpt_conclusion: 'Kết luận',
        rpt_no_data: 'Chưa có dữ liệu phản hồi cho đợt tham vấn này.',
        rpt_rating_analysis: 'Phân tích đánh giá hoạt động QLRBV',
        rpt_respondents: 'người phản hồi',
        rpt_of_total: 'trên tổng số',
        rpt_stakeholders: 'bên liên quan',
        rpt_positive_pct: 'Tỉ lệ đánh giá tích cực',
        rpt_negative_pct: 'Tỉ lệ đánh giá tiêu cực',
        rpt_opinions: 'Ý kiến và quan điểm',

        // Mobile nav bar
        nav_menu: 'Menu',
        nav_home: 'Trang chủ',
        nav_map: 'Bản đồ',
        nav_logout: 'Thoát',

        // Modal & form
        modal_add: 'Thêm mới',
        modal_update: 'Cập nhật',
        modal_close: 'Đóng',
        modal_save: 'Lưu',

        // Detail view
        detail_title: 'Chi tiết',
        detail_show_table: 'Hiện ở bảng danh sách',

        // Map toolbar
        map_notes: 'Ghi chú',

        // Settings
        settings_title: 'Cài đặt hệ thống',
        settings_save: 'Lưu',
        settings_default: 'Mặc định',
        settings_preview: 'Xem trước',

        // Misc
        offline: 'Ngoại tuyến',
        language: 'Ngôn ngữ',
        confirm_delete: 'Bạn có chắc chắn muốn xóa?',
        saved_ok: 'Đã lưu cài đặt thành công!',
        reset_ok: 'Đã khôi phục cài đặt mặc định.',
        no_network: 'Không có kết nối mạng và không có dữ liệu được lưu trước đó.',
        account_locked: 'Tài khoản chưa kích hoạt hoặc đã bị khóa!',

        // Audit module
        audit_tab_history: 'Lịch sử đánh giá',
        audit_tab_new: 'Thực hiện đánh giá',
        audit_no_history: 'Chưa có dữ liệu lịch sử đánh giá.',
        audit_list_title: 'Danh sách đã đánh giá',
        audit_code: 'Mã ĐG',
        audit_target: 'Đối tượng',
        audit_date: 'Ngày đánh giá',
        audit_staff: 'Người đánh giá',
        audit_detail: 'Chi tiết',
        audit_select_type: 'Chọn loại đối tượng:',
        audit_type_group: 'Nhóm Chứng Chỉ Rừng',
        audit_type_board: 'Ban Quản lý',
        audit_select_hint: 'Chọn đối tượng để tiến hành đánh giá mới',
        audit_no_data: 'Chưa có dữ liệu cho loại đối tượng này.',
        audit_group_code: 'Mã Nhóm',
        audit_group_name: 'Tên Nhóm',
        audit_fsc_area: 'Diện Tích FSC',
        audit_board_id: 'ID Ban',
        audit_board_name: 'Tên Ban Quản lý',
        audit_total_area: 'Tổng Diện Tích',
        audit_action: 'Hành động',
        audit_history_btn: 'Lịch sử & Đánh giá',
        audit_record_title: 'Hồ sơ đánh giá',
        audit_back_list: 'Quay lại DS',
        audit_info: 'Thông tin',
        audit_new_btn: 'Thực hiện đánh giá mới',
        audit_history_label: 'LỊCH SỬ ĐÁNH GIÁ',
        audit_records: 'bản ghi',
        audit_executor: 'Người thực hiện',
        audit_result: 'Kết quả',
        audit_no_records: 'Chưa có lịch sử đánh giá nào.',
        audit_done: 'Đã xong',
        audit_form_title: 'PHIẾU ĐÁNH GIÁ',
        audit_cancel_back: 'Hủy / Quay lại',
        audit_subject: 'Đối tượng',
        audit_date_label: 'Ngày',
        audit_compliant: 'Tuân thủ',
        audit_non_compliant: 'Không TT',
        audit_note_ph: 'Ghi chú chi tiết...',
        audit_cancel_file: 'Hủy file',
        audit_save_btn: 'Lưu kết quả đánh giá',
        audit_detail_title: 'Chi tiết đánh giá',
        audit_back: 'Quay lại',
        audit_auditor: 'Người ĐG',
        audit_update: 'Cập nhật',
        audit_compliant_badge: 'TUÂN THỦ',
        audit_non_compliant_badge: 'KHÔNG TT',
        audit_not_found: 'Không tìm thấy bản ghi đánh giá!',

        // Monitoring module
        mon_title: 'Giám sát lô rừng',
        mon_tab_history: 'Lịch sử giám sát',
        mon_tab_new: 'Thực hiện giám sát',
        mon_no_history: 'Chưa có dữ liệu lịch sử giám sát.',
        mon_list_title: 'Danh sách đã giám sát',
        mon_code: 'Mã GS',
        mon_type: 'Loại giám sát',
        mon_date: 'Ngày GS',
        mon_staff: 'Người GS',
        mon_detail: 'Chi tiết',
        mon_select_type: 'Chọn loại giám sát:',
        mon_select_target: 'Chọn đối tượng giám sát:',
        mon_target_plot: 'Lô rừng',
        mon_target_group: 'Nhóm CCR',
        mon_select_hint: 'Chọn loại giám sát và đối tượng để thực hiện',
        mon_no_data: 'Chưa có dữ liệu.',
        mon_start_new: 'Bắt đầu giám sát mới',
        mon_records: 'lần',
        mon_export_pdf: 'Xuất PDF',
        mon_pdf_title: 'BÁO CÁO GIÁM SÁT',
        mon_pdf_info: 'Thông tin phiên giám sát',
        mon_pdf_result: 'Kết quả đánh giá',
        mon_pdf_note: 'Ghi chú',
        mon_plan_title: 'Kế hoạch giám sát',
        mon_plan_group: 'Nhóm',
        mon_plan_add: 'Thêm kế hoạch',
        mon_photo: 'Ảnh minh chứng',
        mon_pdf_owner_rep: 'Đại diện chủ rừng',
        mon_pdf_staff_rep: 'Nhân viên giám sát',
        mon_pdf_sign: 'Ký tên',
        mon_plot_code: 'Mã lô',
        mon_plot_name: 'Tên lô',
        mon_owner: 'Chủ rừng',
        mon_area: 'Diện tích',
        mon_action: 'Hành động',
        mon_start_btn: 'Giám sát',
        mon_form_title: 'PHIẾU GIÁM SÁT',
        mon_cancel_back: 'Hủy / Quay lại',
        mon_subject: 'Đối tượng',
        mon_date_label: 'Ngày',
        mon_weather: 'Thời tiết',
        mon_area_label: 'Diện tích GS (ha)',
        mon_representative: 'Đại diện tổ thành viên',
        mon_note_ph: 'Ghi chú chi tiết...',
        mon_proposal: 'Đề xuất hoạt động / Nhận xét',
        mon_save_btn: 'Lưu kết quả giám sát',
        mon_detail_title: 'Chi tiết giám sát',
        mon_back: 'Quay lại',
        mon_yes: 'Có',
        mon_no: 'Không',
        mon_good: 'Tốt',
        mon_average: 'TB',
        mon_poor: 'Kém',
        mon_not_found: 'Không tìm thấy bản ghi giám sát!',
        mon_confirm_save: 'Xác nhận lưu kết quả giám sát?',
        mon_save_ok: 'Lưu giám sát thành công!',
        mon_history_btn: 'Lịch sử',
        mon_weather_sunny: 'Nắng',
        mon_weather_cloudy: 'Mây',
        mon_weather_light_rain: 'Mưa nhẹ',
        mon_weather_heavy_rain: 'Mưa to',
        // Consultation module
        con_sessions: 'Đợt tham vấn',
        con_new_session: 'Tạo đợt mới',
        con_session_name: 'Tên đợt tham vấn',
        con_year: 'Năm',
        con_intro: 'Nội dung giới thiệu',
        con_status: 'Trạng thái',
        con_status_open: 'Đang mở',
        con_status_closed: 'Đã đóng',
        con_creator: 'Người tạo',
        con_create_btn: 'Tạo đợt tham vấn',
        con_copy_link: 'Sao chép link',
        con_send_email: 'Gửi email',
        con_send_all: 'Gửi tất cả',
        con_view_responses: 'Xem phản hồi',
        con_responses: 'phản hồi',
        con_link_copied: 'Đã sao chép link tham vấn!',
        con_close_session: 'Đóng đợt',
        con_form_title: 'PHIẾU THAM VẤN CÁC BÊN LIÊN QUAN',
        con_respondent: 'Người trả lời',
        con_date: 'Ngày',
        con_address: 'Địa chỉ',
        con_phone: 'Điện thoại',
        con_good: 'Tốt',
        con_moderate: 'Vừa phải',
        con_poor: 'Chưa tốt',
        con_yes: 'Có',
        con_no: 'Không',
        con_submit: 'Gửi phản hồi',
        con_thank_you: 'Cảm ơn bạn đã tham gia tham vấn!',
        con_session_closed: 'Đợt tham vấn này đã đóng.',
        con_session_not_found: 'Không tìm thấy đợt tham vấn.',
        con_summary: 'Tổng hợp kết quả',
        con_no_sessions: 'Chưa có đợt tham vấn nào.',
        con_no_responses: 'Chưa có phản hồi nào.',
        con_section_b1: 'Đánh giá hoạt động quản lý rừng',
        con_section_b2: 'Vấn đề và kiến nghị',
        con_section_c: 'Giá trị bảo tồn cao',
        // Handbook
        hb_title: 'Sổ tay quản lý rừng bền vững',
        hb_process: 'Sơ đồ tiến trình',
        hb_part: 'Phần',
        hb_print: 'In nội dung',
        hb_loading: 'Đang tải nội dung...'
      },
      en: {
        login_title: 'FSC Forest Management System',
        login_subtitle: 'Forest Stewardship Council',
        ph_email_user: 'Email or Username',
        ph_password: 'Password',
        ph_fullname: 'Full name',
        ph_username: 'Username (letters, numbers, _)',
        ph_phone: 'Phone number',
        ph_confirm_pass: 'Confirm password',
        register_new: 'Register',
        forgot_pass: 'Forgot password?',
        btn_login: 'Sign in',
        btn_register: 'Register',
        back_login: 'Back to Sign in',
        developed_by: 'Developed by CleverForestry Consulting',
        processing: 'Processing...',
        registering: 'Registering...',
        username_not_found: 'Username not found',
        conn_error: 'Connection error',
        pass_mismatch: 'Passwords do not match!',
        pass_min6: 'Password must be at least 6 characters!',
        username_invalid: 'Username can only contain lowercase letters, numbers and _',
        username_taken: 'is already taken!',
        reg_success: 'Registration successful! Please verify your email, then sign in.',
        reg_error: 'Registration error',
        forgot_prompt: 'Enter your registered email to reset password:',
        forgot_sent: 'Password reset link has been sent to your email!',
        forgot_error: 'Error sending request!',

        dashboard_title: 'System Overview',
        search_placeholder: 'Search data, menus, features...',
        kpi_title: 'KPI Indicators',
        kpi_households: 'Households',
        kpi_plots: 'Forest Plots',
        kpi_fsc_area: 'FSC Area (ha)',
        kpi_ha_per_ho: 'ha/household',
        kpi_ha_per_farm: 'Avg ha/plot',
        kpi_harvest_actual: 'Harvest (ha)',
        kpi_harvest_plan: 'Harvest plan (ha)',
        kpi_plant: 'Planted (ha)',
        kpi_hlvs: 'Riparian (ha)',
        chart_area: 'Area Distribution',
        chart_groups: 'Statistics by Group',
        no_results: 'No results found for',

        menu_group_mgmt: 'Group Management',
        menu_forest_mgmt: 'Sustainable Forest Management',
        menu_trade: 'Product Trading',
        menu_docs: 'Reference Documents',
        menu_system: 'System',
        menu_report: 'Reports',
        menu_monitoring: 'Monitoring',
        menu_settings: 'System Settings',

        chart_fsc_area: 'FSC Area',
        chart_non_fsc: 'Non-FSC Area',
        chart_riparian: 'Riparian corridor',
        chart_planted: 'Planted area',

        btn_back: 'Back',
        btn_add: 'Add New',
        btn_edit: 'Edit',
        btn_delete: 'Delete',
        btn_save: 'Save',
        btn_close: 'Close',
        btn_home: 'Home',
        btn_map: 'Map',
        btn_upload_geojson: 'Upload GeoJSON',
        btn_edit_polygon: 'Edit',
        btn_layers: 'Layers',
        btn_zoom_all: 'Zoom All',
        btn_all_layers: 'All layers',
        btn_geo_repo: 'Map Repository',
        btn_logout: 'Logout',
        btn_save_settings: 'Save Settings',
        btn_reset_settings: 'Reset to Defaults',

        map_title: 'Forest Plot Map Management',

        search_menu: 'Menu',
        search_functions: 'Features',

        st_ban_ql: 'Management Board',
        st_nhom: 'CCR Group',
        st_churung: 'Forest Owner',
        st_lorung: 'Forest Plot',
        st_nhansu: 'Staff',
        st_taphuan: 'Training',
        st_danhgia: 'Internal Audit',

        dd_nhom: 'Groups',
        dd_hodan: 'Households',
        dd_danhgia: 'Audit',
        dd_lorung: 'Plots',
        dd_taphuan: 'Training',
        dd_bando: 'Map',
        dd_baocao: 'Report',
        dd_kehoach: 'Plan',
        dd_giamsat: 'Monitor',
        dd_pheduyet: 'Approve',

        fn_gis_map: 'GIS Map',
        fn_internal_audit: 'Internal Audit',
        fn_settings: 'System Settings',
        fn_staff_mgmt: 'Staff Management',
        fn_training: 'Training',
        fn_geo_repo: 'GeoJSON Repository',
        fn_reports: 'Reports',
        fn_plot_mgmt: 'Forest Plot Management',
        fn_owner_mgmt: 'Forest Owner Management',
        fn_ccr_groups: 'CCR Group List',
        fn_mgmt_board: 'Management Board',

        grp_group_mgmt: 'Group Management',
        grp_forest_mgmt: 'Sustainable Forest Management',
        grp_monitoring: 'Monitoring',
        grp_trade: 'Product Trading',
        grp_docs: 'Reference Documents',
        grp_system: 'System',
        grp_report: 'Reports',
        grp_other: 'Other',
        grp_consultation: 'Stakeholder Consultation',
        // Consultation Report
        rpt_title: 'Consultation Analysis Report',
        rpt_select_session: 'Select consultation session',
        rpt_generate: 'Generate report',
        rpt_export_pdf: 'Export PDF',
        rpt_overview: 'Overview',
        rpt_response_rate: 'Response rate',
        rpt_strengths: 'Strengths / Advantages',
        rpt_weaknesses: 'Weaknesses / Challenges',
        rpt_objective: 'Objective factors',
        rpt_subjective: 'Subjective factors',
        rpt_hcv_analysis: 'High Conservation Value Analysis',
        rpt_recommendations: 'Recommendations',
        rpt_conclusion: 'Conclusion',
        rpt_no_data: 'No response data for this consultation session.',
        rpt_rating_analysis: 'Forest Management Activity Evaluation',
        rpt_respondents: 'respondents',
        rpt_of_total: 'out of',
        rpt_stakeholders: 'stakeholders',
        rpt_positive_pct: 'Positive evaluation rate',
        rpt_negative_pct: 'Negative evaluation rate',
        rpt_opinions: 'Opinions and viewpoints',

        nav_menu: 'Menu',
        nav_home: 'Home',
        nav_map: 'Map',
        nav_logout: 'Logout',

        modal_add: 'Add New',
        modal_update: 'Update',
        modal_close: 'Close',
        modal_save: 'Save',

        detail_title: 'Details',
        detail_show_table: 'Show in table list',

        map_notes: 'Notes',

        settings_title: 'System Settings',
        settings_save: 'Save',
        settings_default: 'Defaults',
        settings_preview: 'Preview',

        offline: 'Offline',
        language: 'Language',
        confirm_delete: 'Are you sure you want to delete?',
        saved_ok: 'Settings saved successfully!',
        reset_ok: 'Settings have been reset to defaults.',
        no_network: 'No internet connection and no cached data available.',
        account_locked: 'Account not activated or has been locked!',

        // Audit module
        audit_tab_history: 'Audit History',
        audit_tab_new: 'Perform Audit',
        audit_no_history: 'No audit history data available.',
        audit_list_title: 'Audit List',
        audit_code: 'Audit ID',
        audit_target: 'Target',
        audit_date: 'Audit Date',
        audit_staff: 'Auditor',
        audit_detail: 'Details',
        audit_select_type: 'Select target type:',
        audit_type_group: 'Forest Certificate Groups',
        audit_type_board: 'Management Boards',
        audit_select_hint: 'Select a target to perform a new audit',
        audit_no_data: 'No data available for this target type.',
        audit_group_code: 'Group Code',
        audit_group_name: 'Group Name',
        audit_fsc_area: 'FSC Area',
        audit_board_id: 'Board ID',
        audit_board_name: 'Board Name',
        audit_total_area: 'Total Area',
        audit_action: 'Actions',
        audit_history_btn: 'History & Audit',
        audit_record_title: 'Audit Record',
        audit_back_list: 'Back to List',
        audit_info: 'Information',
        audit_new_btn: 'Perform New Audit',
        audit_history_label: 'AUDIT HISTORY',
        audit_records: 'records',
        audit_executor: 'Performed by',
        audit_result: 'Result',
        audit_no_records: 'No audit history records found.',
        audit_done: 'Completed',
        audit_form_title: 'AUDIT FORM',
        audit_cancel_back: 'Cancel / Back',
        audit_subject: 'Subject',
        audit_date_label: 'Date',
        audit_compliant: 'Compliant',
        audit_non_compliant: 'Non-compliant',
        audit_note_ph: 'Detailed notes...',
        audit_cancel_file: 'Remove file',
        audit_save_btn: 'Save Audit Results',
        audit_detail_title: 'Audit Details',
        audit_back: 'Back',
        audit_auditor: 'Auditor',
        audit_update: 'Updated',
        audit_compliant_badge: 'COMPLIANT',
        audit_non_compliant_badge: 'NON-COMPLIANT',
        audit_not_found: 'Audit record not found!',

        // Monitoring module
        mon_title: 'Forest Plot Monitoring',
        mon_tab_history: 'Monitoring History',
        mon_tab_new: 'Perform Monitoring',
        mon_no_history: 'No monitoring history data available.',
        mon_list_title: 'Monitoring Records',
        mon_code: 'Mon. ID',
        mon_type: 'Type',
        mon_date: 'Date',
        mon_staff: 'Monitor',
        mon_detail: 'Details',
        mon_select_type: 'Select monitoring type:',
        mon_select_target: 'Select monitoring target:',
        mon_target_plot: 'Forest Plot',
        mon_target_group: 'CCR Group',
        mon_select_hint: 'Select monitoring type and target to proceed',
        mon_no_data: 'No data available.',
        mon_start_new: 'Start new monitoring',
        mon_records: 'records',
        mon_export_pdf: 'Export PDF',
        mon_pdf_title: 'MONITORING REPORT',
        mon_pdf_info: 'Monitoring Session Info',
        mon_pdf_result: 'Assessment Results',
        mon_pdf_note: 'Notes',
        mon_plan_title: 'Monitoring Plan',
        mon_plan_group: 'Group',
        mon_plan_add: 'Add plan',
        mon_photo: 'Evidence photo',
        mon_pdf_owner_rep: 'Forest owner representative',
        mon_pdf_staff_rep: 'Monitoring staff',
        mon_pdf_sign: 'Signature',
        mon_plot_code: 'Plot Code',
        mon_plot_name: 'Plot Name',
        mon_owner: 'Forest Owner',
        mon_area: 'Area',
        mon_action: 'Actions',
        mon_start_btn: 'Monitor',
        mon_form_title: 'MONITORING FORM',
        mon_cancel_back: 'Cancel / Back',
        mon_subject: 'Subject',
        mon_date_label: 'Date',
        mon_weather: 'Weather',
        mon_area_label: 'Monitored Area (ha)',
        mon_representative: 'Team Representative',
        mon_note_ph: 'Detailed notes...',
        mon_proposal: 'Proposed Actions / Comments',
        mon_save_btn: 'Save Monitoring Results',
        mon_detail_title: 'Monitoring Details',
        mon_back: 'Back',
        mon_yes: 'Yes',
        mon_no: 'No',
        mon_good: 'Good',
        mon_average: 'Avg',
        mon_poor: 'Poor',
        mon_not_found: 'Monitoring record not found!',
        mon_confirm_save: 'Confirm saving monitoring results?',
        mon_save_ok: 'Monitoring saved successfully!',
        mon_history_btn: 'History',
        mon_weather_sunny: 'Sunny',
        mon_weather_cloudy: 'Cloudy',
        mon_weather_light_rain: 'Light Rain',
        mon_weather_heavy_rain: 'Heavy Rain',
        // Consultation module
        con_sessions: 'Consultation Sessions',
        con_new_session: 'Create New Session',
        con_session_name: 'Session Name',
        con_year: 'Year',
        con_intro: 'Introduction',
        con_status: 'Status',
        con_status_open: 'Open',
        con_status_closed: 'Closed',
        con_creator: 'Created by',
        con_create_btn: 'Create Consultation Session',
        con_copy_link: 'Copy Link',
        con_send_email: 'Send Email',
        con_send_all: 'Send All',
        con_view_responses: 'View Responses',
        con_responses: 'responses',
        con_link_copied: 'Consultation link copied!',
        con_close_session: 'Close Session',
        con_form_title: 'STAKEHOLDER CONSULTATION FORM',
        con_respondent: 'Respondent',
        con_date: 'Date',
        con_address: 'Address',
        con_phone: 'Phone',
        con_good: 'Good',
        con_moderate: 'Moderate',
        con_poor: 'Poor',
        con_yes: 'Yes',
        con_no: 'No',
        con_submit: 'Submit Response',
        con_thank_you: 'Thank you for your participation!',
        con_session_closed: 'This consultation session is closed.',
        con_session_not_found: 'Consultation session not found.',
        con_summary: 'Results Summary',
        con_no_sessions: 'No consultation sessions found.',
        con_no_responses: 'No responses yet.',
        con_section_b1: 'Forest Management Evaluation',
        con_section_b2: 'Issues and Recommendations',
        con_section_c: 'High Conservation Values',
        // Handbook
        hb_title: 'Forest Management Handbook',
        hb_process: 'Process Diagram',
        hb_part: 'Part',
        hb_print: 'Print content',
        hb_loading: 'Loading content...'
      }
    };

    function t(key) {
      return (LANG[currentLang] && LANG[currentLang][key]) || (LANG['vi'] && LANG['vi'][key]) || key;
    }

    // === COLUMN NAME TRANSLATION (Vietnamese → English) ===
    const COL_EN = {
      // Common
      'ID':'ID','Email':'Email','Website':'Website','QR code':'QR code','Username':'Username',
      // NhanSu
      'ID_staff':'Staff ID','Họ và tên':'Full Name','Giới tính':'Gender','Ngày sinh':'Date of Birth',
      'Chức vụ':'Position','Số điện thoại':'Phone','Trạng thái':'Status',
      'Thuộc Ban quản lý':'Management Board','Thuộc nhóm':'Group',
      // Ban_Quanlynhom
      'ID ban quản lý':'Board ID','Tên ban quản lý':'Board Name','Loại tổ chức':'Organization Type',
      'Địa chỉ':'Address','Tỉnh':'Province','Huyện':'District','Người đại diện':'Representative',
      'Điện thoại':'Phone','Loài cây trồng chính':'Main Tree Species',
      // NhomCCR
      'ID nhóm':'Group ID','ID ban quản lý':'Board ID','Mã nhóm':'Group Code','Tên nhóm':'Group Name',
      'Xã':'Commune','Xóm':'Village','Vị trí':'Location',
      'Diện tích FSC':'FSC Area','Diện tích ngoài FSC':'Non-FSC Area',
      'Diện tích rừng tự nhiên':'Natural Forest Area','Diện tích vùng đệm':'Buffer Zone Area',
      'Tổng diện tích':'Total Area','Sản lượng dự kiến năm':'Annual Estimated Yield',
      'Diện tích trồng rừng năm':'Annual Planting Area','Số thành viên':'Members',
      'Ngày cập nhật':'Updated Date','Người cập nhật':'Updated By','Đường dẫn file':'File Path',
      // Churung
      'ID chủ rừng':'Owner ID','Họ tên chủ rừng':'Forest Owner Name',
      'Dân tộc':'Ethnicity','CCCD':'Citizen ID',
      'Họ tên vợ':'Wife Name','Họ tên chồng':'Husband Name','Thôn':'Hamlet',
      'Ngày tham gia':'Join Date','Ngày rời nhóm':'Leave Date',
      'Số lô rừng':'Number of Plots','Người nhập dữ liệu':'Data Entry By',
      // Lo_rung
      'ID lô rừng':'Plot ID','Mã số lô rừng':'Plot Code','Mã số lô 2023':'Plot Code 2023',
      'Tên lô rừng':'Plot Name','Số sổ đỏ':'Land Title No.','Tờ bản đồ':'Map Sheet',
      'Thửa đất':'Land Parcel','Tiểu khu':'Sub-zone','Khoảnh':'Compartment',
      'Tọa độ tâm lô':'Plot Center Coordinates','Khoảng cách tới nhà':'Distance to House',
      'Địa chỉ lô':'Plot Address','Tình trạng sổ đỏ':'Land Title Status',
      'Ngày tham gia FSC':'FSC Join Date','Tình trạng xói mòn':'Erosion Status',
      'Nguyên nhân xói mòn':'Erosion Cause','Mốc ranh giới':'Boundary Markers',
      'Độ bền vững mốc ranh':'Marker Durability',
      'Độ dốc bình quân':'Average Slope','Giáp ranh rừng tự nhiên':'Adjacent to Natural Forest',
      'Có loài cây bản địa':'Has Native Species','Tên động vật thực vật quý':'Rare Species Names',
      'Loài cây trồng xen ghép':'Intercropping Species','Loài cây trồng FSC':'FSC Tree Species',
      'Nguồn gốc giống':'Seedling Origin','Mô tả nguồn gốc giống':'Seedling Origin Description',
      'Có hóa đơn giống':'Has Seedling Invoice','Mật độ ban đầu':'Initial Density',
      'Mật độ sau khi tỉa thưa':'Density After Thinning','Số cây trồng chính':'Main Trees Count',
      'Số cây trồng dặm':'Supplemental Trees Count','Diện tích GCN QSDĐ':'Land Certificate Area',
      'Diện tích trồng rừng':'Planted Forest Area','Diện tích HLVS':'Riparian Corridor Area',
      'Có ao hồ':'Has Ponds','Thời điểm trồng':'Planting Date','Năm trồng':'Planting Year',
      'Số năm khai thác':'Harvest Cycle (years)','Năm khai thác':'Harvest Year',
      'Sản lượng khai thác xe':'Harvest Volume (loads)','Sản lượng khai thác đăm':'Harvest Volume (cubic)',
      'Có thuê lao động':'Hired Labor','Phương tiện bảo hộ lao động':'PPE Equipment',
      'Loại phương tiện BHLD':'PPE Types',
      'Kỹ thuật trước trồng':'Pre-planting Technique','Kỹ thuật chăm sóc':'Maintenance Technique',
      'Cuốc hố bằng máy':'Machine Digging','Bón phân':'Fertilizer Applied',
      'Loại phân bón':'Fertilizer Type','Định lượng phân bón':'Fertilizer Amount',
      'Kiểm soát dịch bệnh':'Pest Control','Tình hình sâu bệnh':'Pest Situation',
      'Thuốc sử dụng':'Pesticides Used','Phòng cháy chữa cháy':'Fire Prevention',
      'Thời gian khai thác':'Harvest Time','Địa danh':'Locality','Số hiệu lô':'Plot Number',
      'Kinh độ':'Longitude','Vĩ độ':'Latitude','Tên tỉnh':'Province','Tên huyện':'District','Tên xã':'Commune','Tên xã mới':'New Commune',
      // Section headers in Lo_rung
      '2. Thông tin địa lý – pháp lý':'2. Geographic & Legal Info',
      '3. Thông tin pháp lý – sở hữu – ổn định':'3. Legal & Ownership Info',
      '4. Đặc điểm sinh thái – địa hình':'4. Ecology & Terrain',
      '5. Cây trồng và nguồn gốc giống':'5. Species & Seedling Origin',
      '6. Mật độ và số cây':'6. Density & Tree Count',
      '8. Thời gian – chu kỳ – sản lượng':'8. Time & Yield Cycle',
      '9. Lao động – an toàn – thiết bị':'9. Labor & Safety',
      '10. Biện pháp kỹ thuật lâm sinh':'10. Silviculture Techniques',
      // Churung section headers
      'Thông tin cá nhân':'Personal Info','Thông tin liên hệ và địa chỉ':'Contact & Address',
      'Thông tin tham gia nhóm':'Group Membership','Thông tin rừng quản lý':'Forest Management Info',
      'Thông tin hệ thống':'System Info','Cập nhật':'Updated',
      // Taphuan
      'ID tập huấn':'Training ID','ID chủ rừng':'Owner ID','Loại tập huấn':'Training Type',
      'Ngày tập huấn':'Training Date','Địa điểm':'Location','Giảng viên':'Instructor',
      'Số lượng tham dự':'Attendees',
      // Noidung_taphuan
      'Tên lớp tập huấn':'Class Name','Ghi chú':'Notes',
      // KH_QL_Lorung / Biendong
      'ID kế hoạch':'Plan ID','Hoạt động':'Activity','Ngày thực hiện':'Execution Date',
      'Nội dung':'Content','Người nhập':'Entered By',
      'Loại biến động':'Change Type','Ngày biến động':'Change Date',
      // HD_Lorung
      'ID hoạt động lô':'Plot Activity ID','ID hoạt động':'Activity ID','Tên hoạt động':'Activity Name',
      'Ngày triển khai':'Start Date','Ngày kết thúc':'End Date','Ngày báo cáo':'Report Date',
      'Địa điểm kiểm tra':'Inspection Location','Người kiểm tra':'Inspector',
      'Kết quả hoạt động':'Activity Result','Diện tích thực hiện':'Area Implemented',
      'Số lao động':'Workers','Tuổi lao động':'Worker Age',
      // DS_HDong
      'ID DS hoat dong':'Activity List ID','Hoạt động chi tiết':'Activity Details','Nhóm hoạt động':'Activity Group',
      // CauHoi_DanhGia
      'ID câu hỏi':'Question ID','Nhóm tiêu chí':'Criteria Group','Nội dung câu hỏi':'Question Content',
      'Phương pháp kiểm tra':'Inspection Method','Gợi ý bằng chứng':'Evidence Suggestions',
      // DG_noibo
      'ID đánh giá':'Audit ID','Date':'Date','Staff':'Staff','Update':'Update',
      // Loai_hoatdong_rung
      'Tên hoạt động':'Activity Name','Mô tả chi tiết':'Detailed Description',
      // Menu
      'Nhom':'Group','Module':'Module','View':'View','Xem':'View','Thêm':'Add','Sửa':'Edit','Xóa':'Delete','PhanQuyen':'Permission',
      // Admin
      'Province code':'Province Code','Province':'Province','District':'District','Commune':'Commune','TYPE':'Type',
      'Số nhóm quản lý':'Managed Groups','Số hộ thành viên':'Member Households',
      'Dien tich ngoai FSC':'Non-FSC Area','Diện tích vùng đệm':'Buffer Zone Area'
    };

    // Translate column name: returns English when lang is EN
    function tc(colName) {
      if (currentLang === 'en' && COL_EN[colName]) return COL_EN[colName];
      return colName;
    }

    // === AUDIT DICTIONARY ENGLISH TRANSLATIONS ===
    const AUDIT_CAT_EN = {
      'Tuân thủ pháp luật':'Legal Compliance',
      'Quyền người lao động':'Workers\' Rights',
      'Quyền người bản địa':'Indigenous Peoples\' Rights',
      'Quan hệ cộng đồng':'Community Relations',
      'Lợi ích từ rừng':'Benefits from Forests',
      'Môi trường':'Environmental Impact',
      'Kế hoạch quản lý':'Management Planning',
      'Giám sát & Đánh giá':'Monitoring & Evaluation',
      'Thực hiện quản lý':'Management Implementation'
    };
    function tcat(catName) {
      if (currentLang === 'en' && AUDIT_CAT_EN[catName]) return AUDIT_CAT_EN[catName];
      return catName;
    }

    // Audit question label translations (68 questions)
    const AUDIT_LABEL_EN = {
      'RanhGioiRoRang':'Are the boundaries of all Management Units within the certificate scope clearly defined, documented, and shown on maps?',
      'NopThuePhiDayDu':'Are all taxes and fees related to forest management paid on time in accordance with current regulations?',
      'GiamSatNoiBo':'Is internal monitoring of group activities being carried out?',
      'XuLyViPham':'If illegal or unauthorized activities are detected, does the forest owner take measures to address them?',
      'GiaiQuyetTranhChapNgoaiToa':'Are disputes related to law and traditional rights resolved promptly out of court?',
      'HoSoTranhChap':'Are dispute records updated with resolution steps, results, or reasons for pending resolution?',
      'NgungHoatDongKhiTranhChap':'Does the forest owner cease operations in areas with serious, prolonged, or multi-party disputes?',
      'TuDoThamGiaToChuc':'Are workers free to join the labor organization of their choice?',
      'KhongLaoDongCuongBuc':'Are there any forms of forced labor among forest owners and contractor workers?',
      'TraLuongCongBang':'Are women and men paid equally for the same work?',
      'PhuongThucTraLuongNu':'Are women paid directly using safe methods (bank transfer, tuition payment, etc.)?',
      'NghiThaiSan':'Are women granted maternity leave as required by social insurance law?',
      'TrangBiBaoHo':'Are workers provided with adequate and appropriate personal protective equipment?',
      'BatBuocDungBaoHo':'Is the use of personal protective equipment mandatory?',
      'HoSoAnToanLaoDong':'Are occupational safety records, including accidents and work-loss time, maintained?',
      'CaiThienAnToanSauSuCo':'Is occupational safety reviewed and improved after serious incidents or accidents?',
      'MucLuongToiThieu':'Are wages equal to or higher than the regional/industry minimum wage or agreed rates?',
      'TraLuongDungHan':'Are wages and contractual payments made on time and as agreed?',
      'DaoTaoNguoiLaoDong':'Are workers trained on specific tasks and supervised for safety to contribute to the forest management plan?',
      'HoSoDaoTao':'Are up-to-date training records maintained for all workers?',
      'GiaiQuyetKhieuNai':'Are worker complaints and grievances identified, responded to, and resolved satisfactorily?',
      'BoiThuongThietHai':'Are workers fairly compensated for work-related damages (accidents, occupational diseases, etc.)?',
      'NhanDienNguoiBanDia':'Have indigenous peoples (if any) affected by forest management activities been identified?',
      'TaiLieuHoaQuyenLoi':'Are the legal, traditional rights and aspirations of indigenous peoples documented and mapped?',
      'ThamVanNguoiBanDia':'Are indigenous peoples informed and consulted about forest management activities to protect their rights?',
      'HoSoThoaThuan':'Are records of binding agreements with indigenous peoples maintained?',
      'BaoVeDiaDiemVanHoa':'Are sites of special cultural and spiritual significance to indigenous peoples identified and protected?',
      'NhanDienCongDong':'Have local communities inside and around the Management Unit been identified?',
      'ThamVanCongDong':'Are local communities informed and consulted about forest management activities?',
      'BaoVeQuyenLoiCongDong':'Are the legal and traditional rights of local communities respected and not violated?',
      'GiaiQuyetXamPhamQuyenLoi':'If community rights are violated, is the situation corrected and disputes resolved satisfactorily?',
      'QuyTrinhGiaiQuyetTranhChap':'Is there a public dispute resolution process developed with community participation?',
      'XuLyTranhChapCongDong':'Are disputes related to forest management activities responded to and resolved promptly?',
      'CanCuKhaiThac':'Is timber harvesting based on documented evidence of growth, yield, and ecosystem protection?',
      'GioiHanKhaiThac':'Does the annual timber harvest ensure it does not exceed forest growth rates?',
      'NganNguaTacDongXau':'Do management activities prevent negative environmental impacts?',
      'GiamThieuTacDong':'Where negative impacts occur, are prevention, mitigation, or remediation measures applied?',
      'BaoVeLoaiQuyHiem':'Are rare and endangered species and their habitats identified and protected?',
      'NganChanSanBat':'Are measures in place to prevent hunting and harvesting of rare and endangered forest products?',
      'TuanThuBaoVeDongVat':'Are wildlife protection regulations, including bans on hunting and illegal trade, complied with?',
      'NganNguoiLaoDongSanBat':'Is it ensured that workers do not participate in hunting prohibited species?',
      'BaoVeNguonNuoc':'Are measures implemented to protect water sources, riparian areas, and water quality?',
      'PhucHoiNguonNuoc':'If water sources are not well protected, are restoration activities being carried out?',
      'KhacPhucHauQuaCu':'Are water sources affected by past activities being restored?',
      'NganChanSuyThoaiTiepDien':'Are measures in place to prevent ongoing water resource degradation caused by other parties?',
      'KhongChuyenDoiRungTuNhien':'Is it ensured that natural forests are not converted to plantations or other land uses (except in special permitted cases)?',
      'ChungChiKhuVucChuyenDoi':'Do areas converted from natural forest after 1994 meet the conditions for certification?',
      'CongKhaiKeHoach':'Is a summary of the Forest Management Plan (excluding confidential info) publicly available free of charge to stakeholders?',
      'HeThongTruyXuat':'Is there a system to track and trace the origin of all FSC products?',
      'TaiLieuHoaSanPham':'Are details of sold products (species name, volume, harvest date, etc.) fully documented?',
      'LuuTruHoaDon':'Are sales invoices and related documents retained for at least 5 years?',
      'TrongRungSauKhaiThac':'Is the harvest site replanted within one planting season?',
      'LoaiCayPhuHop':'Are tree species selected appropriate for the site conditions?',
      'KiemSoatLoaiXamLan':'Is the list of invasive alien species regularly updated?',
      'KhongGMO':'Is it ensured that genetically modified organisms (GMOs) are not used?',
      'BienPhapLamSinh':'Are silvicultural measures appropriate for ecological characteristics and management objectives?',
      'HanChePhanBonHoaHoc':'Is the use of chemical fertilizers limited or avoided?',
      'GiamThieuTacHaiPhanBon':'Are measures in place to minimize or remediate environmental damage from chemical fertilizers?',
      'KhongSuDungThuocCam':'Is it ensured that FSC-prohibited pesticides are not used or stored?',
      'GhiChepSuDungThuoc':'Are detailed records of pesticide use (name, dosage, location, etc.) maintained?',
      'AnToanSuDungThuoc':'Does pesticide use comply with ILO safety guidelines?',
      'GiamThieuLuongThuoc':'Are measures in place to minimize pesticide use while maintaining effectiveness?',
      'HanCheAnhHuongSucKhoe':'Are measures in place to limit the health and environmental impacts of pesticides?',
      'DanhMucThuocDuocPhep':'Are only pesticides on the approved list being used correctly?',
      'KiemSoatSinhHoc':'Are biological control agents regularly updated?',
      'CanhBaoChayRung':'Is a forest fire warning system established and functioning effectively?',
      'CapNhatVuChay':'Is information about forest fires regularly updated?',
      'QuanLyRacThai':'Is it ensured that waste is not littered and pesticide containers are collected properly?',
      'XuLyRacThai':'Is the waste management system functioning properly?'
    };
    function tq(qId, viLabel) {
      if (currentLang === 'en' && AUDIT_LABEL_EN[qId]) return AUDIT_LABEL_EN[qId];
      return viLabel;
    }

    // Monitoring type & section translations
    const MON_TYPE_EN = {
      'giam_sat_nhom':'Group Internal Monitoring',
      'trong_rung':'Planting Monitoring',
      'trong_khai_thac':'Harvesting Monitoring',
      'truoc_khai_thac':'Pre-Harvest Assessment',
      'sau_khai_thac':'Post-Harvest Assessment',
      'bao_ve_rung':'Forest Protection Monitoring',
      'hanh_lang_ven_suoi':'Riparian Corridor Monitoring'
    };
    const MON_SEC_EN = {
      'Nội dung giám sát':'Monitoring Content',
      'I. Xử lý thực bì':'I. Vegetation Clearance','II. Múc hố':'II. Planting Pits',
      'III. Bón phân':'III. Fertilizing','IV. Trồng rừng':'IV. Planting',
      'V. Lao động':'V. Labor','VI. Môi trường':'VI. Environment',
      'VII. Hành lang ven suối, vùng đệm':'VII. Riparian Corridor & Buffer',
      'I. Kỹ thuật khai thác':'I. Harvesting Technique','II. Đường vận chuyển':'II. Transport Roads',
      'III. Lao động':'III. Labor','IV. Máy cưa':'IV. Chainsaws',
      'V. Môi trường':'V. Environment','VI. Vận chuyển':'VI. Transport',
      'VII. Nhà thầu':'VII. Contractors','VIII. Đai xanh, vùng đệm':'VIII. Buffer Zone',
      '1. Suối':'1. Streams','2. Rừng chừa lại, đai xanh':'2. Retained Forest & Buffer',
      '3. Đường dây điện cắt ngang':'3. Power Lines','4. Xói mòn':'4. Erosion',
      '5. Lửa rừng':'5. Forest Fire','6. Vệ sinh':'6. Sanitation',
      '7. Mồ mả, ụ mối':'7. Graves & Termite Mounds',
      'Đánh giá tác động môi trường':'Environmental Impact Assessment',
      'I. Tình trạng rừng':'I. Forest Condition','II. Nhân công và cộng đồng':'II. Labor & Community',
      'III. Môi trường':'III. Environment',
      'I. Hành lang ven suối, vùng đệm':'I. Riparian Corridor & Buffer',
      'II. Khe suối':'II. Streams','III. Ngôi mộ, miếu thờ':'III. Graves & Temples'
    };
    const MON_LABEL_EN = {
      'GS_N_01':'Compliance level with forest management standards','GS_N_02':'Is the management organization suitable for the group',
      'GS_N_03':'Compliance with FSC Sustainable Forest Management standards','GS_N_04':'Understanding of monitoring forms and plans',
      'GS_N_05':'Implementation of internal monitoring activities','GS_N_06':'Submitting monitoring reports on time',
      'GS_N_07':'Understanding the management area','GS_N_08':'Ensuring compliance with forest management plans',
      'GS_N_09':'Ensuring group meeting schedules','GS_N_10':'Compliance with group rules and management procedures',
      'GS_N_11':'Compliance with company & group policies (gender equality, environment, labor, anti-discrimination, OHS...)',
      'GS_N_12':'Participation in company/group training courses','GS_N_13':'Compliance with commitments and corrective action plans',
      'GS_N_14':'Completing error corrections on time','GS_N_15':'Implementing plans as scheduled',
      'GS_N_16':'General forest management information',
      'TR_01':'Vegetation clearance method (Mechanical/Manual)','TR_02':'Vegetation clearance area',
      'TR_03':'Technical specifications for clearance','TR_04':'Pit location','TR_05':'Pit dimensions',
      'TR_06':'Pit area','TR_07':'Pit density','TR_08':'Fertilizing applied?','TR_09':'Fertilized area',
      'TR_10':'Fertilizing technical specifications','TR_11':'Environmental impact of fertilizer use',
      'TR_12':'Planted area','TR_13':'Tree species','TR_14':'Planting technique','TR_15':'Tree condition',
      'TR_16':'Number of workers','TR_17':'Ethnic minority workers?','TR_18':'Workers trained?',
      'TR_19':'Adequate work tools?','TR_20':'Adequate PPE?','TR_21':'First aid kit?',
      'TR_22':'Work accidents?','TR_23':'Regular health checks?','TR_24':'Working hours/day',
      'TR_25':'Pesticide use? What type?','TR_26':'Invasive alien species detected?',
      'TR_27':'GM seedlings used?','TR_28':'Waste?','TR_29':'Stream water affected?','TR_30':'Erosion?',
      'TR_31':'Buffer zone area','TR_32':'Buffer condition (stable/deteriorating)','TR_33':'Vegetation falling into streams?',
      'TR_34':'Natural regeneration present?','TR_35':'Stream flow blocked?','TR_36':'Buffer zone affected?',
      'KT_01':'Proper debarking and felling direction?','KT_02':'Stump height and cut quality adequate?',
      'KT_03':'Road condition','KT_04':'Road maintenance done?','KT_05':'New road opened?',
      'KT_06':'Maintenance length','KT_07':'Close to streams/buffer?','KT_08':'Close to power lines/graves?',
      'KT_09':'Number of workers/ethnic workers','KT_10':'Workers trained?','KT_11':'Sawyer PPE?',
      'KT_12':'Work accidents?','KT_13':'Harvesting worker PPE?','KT_14':'Working hours/day',
      'KT_15':'First aid kit?','KT_16':'Technical condition adequate?','KT_17':'Adequate work tools?',
      'KT_18':'Number of chainsaws','KT_19':'Chain brake and front guard functional?',
      'KT_20':'Chain catcher functional?','KT_21':'Stream water (present/dirty)?',
      'KT_22':'Erosion (present/severe)?','KT_23':'Waste (workers/oil)?','KT_24':'Road condition in rain (muddy)?',
      'KT_25':'Vehicles per day','KT_26':'Timber volume per day','KT_27':'Vehicle status (shortage/excess/adequate)',
      'KT_28':'Delivery slips issued?','KT_29':'Number of contractor workers','KT_30':'Workers trained?',
      'KT_31':'Workers insured?','KT_32':'PPE provided?','KT_33':'Workers paid adequately?',
      'KT_34':'Buffer zone area','KT_35':'Buffer condition (stable/deteriorating)',
      'KT_36':'Graves or power lines found?','KT_37':'Stream flow blocked?',
      'KT_38':'Harvest debris falling into buffer/streams?',
      'TKT_01':'Stream location in plot','TKT_02':'Water level (Width/Depth)',
      'TKT_03':'Water quality (Clean/Dirty/Drinkable/Fish)','TKT_04':'Vegetation along stream banks',
      'TKT_05':'Retained forest area (ha)','TKT_06':'Retained forest condition','TKT_07':'Encroachment detected?',
      'TKT_08':'Power line length','TKT_09':'Affected area','TKT_10':'Contact point location',
      'TKT_11':'Erosion condition','TKT_12':'Erosion season','TKT_13':'Fire-affected area (ha)',
      'TKT_14':'Forest fire condition','TKT_15':'Sanitation area (ha)','TKT_16':'Sanitation condition',
      'TKT_17':'Graves or termite mounds present?','TKT_18':'Location, coordinates (lat/lng)',
      'SKT_01':'Vegetation condition (Tall/Dense)?','SKT_02':'Stream water (Present/Dirty)?',
      'SKT_03':'Soil condition (Dry/Muddy/Moist)','SKT_04':'Erosion (Present/Severe)?',
      'SKT_05':'Waste in streams?','SKT_06':'Worker waste?','SKT_07':'Road muddy in rain?',
      'SKT_08':'Environmentally friendly sanitation?','SKT_09':'Buffer zone/graves affected?',
      'SKT_10':'Impact on surrounding residential area?','SKT_11':'Stream flow blocked?',
      'BVR_01':'Land encroachment (Much/Little/None)','BVR_02':'Forest fire?','BVR_03':'Livestock damage?',
      'BVR_04':'Fire prevention measures?','BVR_05':'Human destruction?','BVR_06':'Fungi/Pest damage?',
      'BVR_07':'Storm/tornado damage?','BVR_08':'Buffer zone protected?',
      'BVR_09':'Number of workers','BVR_10':'Workers trained?','BVR_11':'PPE provided?',
      'BVR_12':'PPE being used?','BVR_13':'First aid kit?','BVR_14':'Medicine adequate?',
      'BVR_15':'Work accidents?','BVR_16':'Locals collecting firewood?',
      'BVR_17':'Community coordination in fire prevention, dispute resolution?',
      'BVR_18':'Locals cutting timber?','BVR_19':'Livestock grazing in forest?',
      'BVR_20':'Other activities (honey/mushroom/hunting)?',
      'BVR_21':'Vegetation condition?','BVR_22':'Waste (Much/Little/None)','BVR_23':'Number of streams',
      'BVR_24':'Water quality (Clear/Turbid)','BVR_25':'Streams have water?',
      'BVR_26':'Soil erosion (Much/Little/None)','BVR_27':'Fish or aquatic life observed?',
      'BVR_28':'Fish/aquatic quantity (Much/Little)','BVR_29':'Soil condition (Dry/Moist/Other)',
      'BVR_30':'Waste collected?','BVR_31':'Rare species detected?','BVR_32':'Vegetation/waste in streams cleared?',
      'BVR_33':'Invasive alien species present?',
      'HLVS_01':'Location','HLVS_02':'Area','HLVS_03':'Tree species present',
      'HLVS_04':'Condition (stable/deteriorating)','HLVS_05':'Stream present?',
      'HLVS_06':'Stream flow flowing?','HLVS_07':'Stream flow blocked?','HLVS_08':'Turbid water?',
      'HLVS_09':'Waste at stream?','HLVS_10':'Graves/temples present?','HLVS_11':'Quantity',
      'HLVS_12':'Tree species present','HLVS_13':'Condition'
    };
    function tms(secName) {
      if (currentLang === 'en' && MON_SEC_EN[secName]) return MON_SEC_EN[secName];
      return secName;
    }
    function tmq(qId, viLabel) {
      if (currentLang === 'en' && MON_LABEL_EN[qId]) return MON_LABEL_EN[qId];
      return viLabel;
    }
    function tmt(typeKey) {
      if (currentLang === 'en' && MON_TYPE_EN[typeKey]) return MON_TYPE_EN[typeKey];
      return MONITORING_TYPES[typeKey] ? MONITORING_TYPES[typeKey].title : typeKey;
    }

    // Module name translations (sidebar & sub-menu)
    const MODULE_EN = {
      'Danh sách nhóm':'Group List','Tập huấn':'Training','Khiếu nại':'Complaints',
      'Tài sản':'Assets','Dụng cụ lao động':'Work Tools',
      'Kế hoạch hoạt động':'Activity Plan','Đánh giá nội bộ':'Internal Audit',
      'Hoạt động giám sát':'Monitoring Activities','Thực hiện giám sát':'Execute Monitoring','Kế hoạch giám sát':'Monitoring Plan','Quản lý hồ sơ':'Records Management',
      'Bộ tiêu chuẩn FSC':'FSC Standards','Tham vấn các bên liên quan':'Stakeholder Consultation',
      'Danh sách bên liên quan':'Stakeholder List','Thực hiện tham vấn':'Conduct Consultation','Báo cáo tham vấn':'Consultation Report',
      'Tổng hợp báo cáo':'Report Summary','Bản đồ quản lý lô rừng':'Forest Plot Map',
      'Kế hoạch quản lý lô rừng':'Plot Management Plan','Kế hoạch khai thác':'Harvesting Plan',
      'Kế hoạch trồng rừng':'Reforestation Plan',
      'Danh sách đơn vị thu mua':'Buyer List','Kế hoạch bán sản phẩm':'Product Sales Plan',
      'Giá cả thị trường':'Market Prices',
      'Danh mục thuốc bảo vệ thực vật':'Pesticide Catalog','Danh mục cây trồng':'Plant Catalog',
      'Danh mục phân bón':'Fertilizer Catalog','Nguồn gốc cây giống':'Seedling Sources',
      'Quản lý nhân sự':'Staff Management','Phân quyền người dùng':'User Permissions','Trợ giúp':'Help',
      'Báo cáo giám sát nội bộ':'Internal Monitoring Report','Báo cáo giám sát':'Monitoring Report',
      'Báo cáo sản lượng':'Production Report','Báo cáo FSC các năm':'Annual FSC Report',
      'Báo cáo đánh giá rủi ro':'Risk Assessment Report','Báo cáo các chuyên đề':'Thematic Reports',
      'Cài đặt hệ thống':'System Settings',
      'Giám sát lô rừng':'Forest Plot Monitoring',
      'Ban Quản lý nhóm':'Group Management Board','Nhóm CCR':'CCR Groups',
      'Chủ rừng':'Forest Owners','Lô rừng':'Forest Plots',
      'Biến động lô rừng':'Plot Changes','Nội dung tập huấn':'Training Content',
      'Loại hoạt động rừng':'Forest Activity Types','Nhân sự':'Staff',
      'Quản lý Menu':'Menu Management','Dữ liệu Tỉnh/Huyện':'Province/District Data',
      'Quản lý nhóm':'Group Management',
      'Giám sát nhóm':'Group Monitoring',
      'Giám sát trồng rừng':'Planting Monitoring',
      'Giám sát khai thác':'Harvesting Monitoring',
      'Giám sát môi trường':'Environmental Monitoring',
      'Danh sách bên liên quan':'Stakeholder List',
      'Thực hiện tham vấn':'Execute Consultation',
      'Sổ tay quản lý rừng bền vững':'Forest Management Handbook'
    };
    function tm(moduleName) {
      if (currentLang === 'en' && MODULE_EN[moduleName]) return MODULE_EN[moduleName];
      return moduleName;
    }

    function toggleLang() {
      currentLang = currentLang === 'vi' ? 'en' : 'vi';
      localStorage.setItem('fscfm_lang', currentLang);
      applyI18n();
    }

    function applyI18n() {
      // Update text content for elements with data-i18n
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (LANG[currentLang][key]) el.textContent = LANG[currentLang][key];
      });
      // Update placeholders for elements with data-i18n-ph
      document.querySelectorAll('[data-i18n-ph]').forEach(el => {
        const key = el.getAttribute('data-i18n-ph');
        if (LANG[currentLang][key]) el.placeholder = LANG[currentLang][key];
      });
      // Update lang toggle button label
      const nextLang = currentLang === 'vi' ? 'EN' : 'VI';
      const lblLogin = document.getElementById('lang-label-login');
      if (lblLogin) lblLogin.textContent = nextLang;
      const lblDash = document.getElementById('lang-label-dash');
      if (lblDash) lblDash.textContent = nextLang;
      // Re-render dashboard if visible
      if ($('#dashboard-view').is(':visible') && typeof renderDashboardContent === 'function') {
        renderDashboardContent();
      }
      // Re-render sidebar menu if loaded
      if (typeof renderSystemMenu === 'function' && APP_DATA && APP_DATA['Menu']) {
        renderSystemMenu(APP_DATA['Menu']);
      }
      // Re-render current view if data-view is active (for audit etc.)
      if ($('#data-view').is(':visible') && typeof renderContent === 'function') {
        renderContent();
      }
      // Update mobile project name
      const mobName = document.getElementById('navbar-project-name-mobile');
      if (mobName) { const s = getSettings(); mobName.textContent = s.projectName; }
    }

    // Apply language on page load
    document.addEventListener('DOMContentLoaded', () => applyI18n());

    // === SUPABASE CONFIG ===
    const SUPABASE_URL = 'https://rvvctklkxjhypgmzcaym.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2dmN0a2xreGpoeXBnbXpjYXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTQyOTEsImV4cCI6MjA4NjEzMDI5MX0.h_Y-_YRFlfKlmchIcz6h5nz6FusmVotwjXpPHUZvDvs';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let APP_DATA = {};
    let navHistory = [];

    // === DB TABLE MAPPING: oldSheetName → { table, cols: {dbCol: displayCol} } ===
    const DB_MAP = {
      'NhanSu': { table: 'profiles', cols: {
        id_staff:'ID_staff', ho_va_ten:'Họ và tên', email:'Email', username:'Username', gioi_tinh:'Giới tính',
        ngay_sinh:'Ngày sinh', chuc_vu:'Chức vụ', so_dien_thoai:'Số điện thoại',
        trang_thai:'Trạng thái', thuoc_ban_quan_ly:'Thuộc Ban quản lý', thuoc_nhom:'Thuộc nhóm'
      }},
      'Menu': { table: 'menu', cols: {
        id:'ID', nhom:'Nhom', module:'Module', view_name:'View',
        xem:'Xem', them:'Thêm', sua:'Sửa', xoa:'Xóa', phan_quyen:'PhanQuyen'
      }},
      'Admin': { table: 'admin_province', cols: {
        id:'ID', province_code:'Province code', province:'Province',
        district:'District', commune:'Commune', type:'TYPE'
      }},
      'Ban_Quanlynhom': { table: 'ban_quan_ly_nhom', cols: {
        id:'ID ban quản lý', ten:'Tên ban quản lý', loai_to_chuc:'Loại tổ chức',
        dia_chi:'Địa chỉ', tinh:'Tỉnh', huyen:'Huyện', nguoi_dai_dien:'Người đại diện',
        chuc_vu:'Chức vụ', dien_thoai:'Điện thoại', email:'Email', website:'Website',
        loai_cay_trong_chinh:'Loài cây trồng chính'
      }},
      'NhomCCR': { table: 'nhom_ccr', cols: {
        id:'ID nhóm', id_ban_quan_ly:'ID ban quản lý', ma_nhom:'Mã nhóm', ten_nhom:'Tên nhóm',
        nguoi_dai_dien:'Người đại diện', so_dien_thoai:'Số điện thoại', dia_chi:'Địa chỉ',
        tinh:'Tỉnh', huyen:'Huyện', xa:'Xã', xom:'Xóm', vi_tri:'Vị trí',
        dien_tich_fsc:'Diện tích FSC', dien_tich_ngoai_fsc:'Diện tích ngoài FSC',
        dien_tich_rung_tu_nhien:'Diện tích rừng tự nhiên', dien_tich_vung_dem:'Diện tích vùng đệm',
        tong_dien_tich:'Tổng diện tích', san_luong_du_kien_nam:'Sản lượng dự kiến năm',
        dien_tich_trong_rung_nam:'Diện tích trồng rừng năm', so_thanh_vien:'Số thành viên',
        ngay_cap_nhat:'Ngày cập nhật', nguoi_cap_nhat:'Người cập nhật', duong_dan_file:'Đường dẫn file'
      }},
      'Churung': { table: 'chu_rung', cols: {
        id:'ID chủ rừng', id_nhom:'ID nhóm', ho_ten:'Họ tên chủ rừng', gioi_tinh:'Giới tính',
        ngay_sinh:'Ngày sinh', dan_toc:'Dân tộc', cccd:'CCCD',
        ho_ten_vo:'Họ tên vợ', ho_ten_chong:'Họ tên chồng',
        so_dien_thoai:'Số điện thoại', tinh:'Tỉnh', huyen:'Huyện', xa:'Xã', thon:'Thôn', dia_chi:'Địa chỉ',
        ngay_tham_gia:'Ngày tham gia', ngay_roi_nhom:'Ngày rời nhóm',
        so_lo_rung:'Số lô rừng', tong_dien_tich:'Tổng diện tích', dien_tich_fsc:'Diện tích FSC',
        dien_tich_rung_tu_nhien:'Diện tích rừng tự nhiên', dien_tich_vung_dem:'Diện tích vùng đệm',
        san_luong_du_kien_nam:'Sản lượng dự kiến năm', dien_tich_trong_rung_nam:'Diện tích trồng rừng năm',
        nguoi_nhap:'Người nhập dữ liệu', duong_dan_file:'Đường dẫn file'
      }},
      'Lo_rung': { table: 'lo_rung', cols: {
        id:'ID lô rừng', id_nhom:'ID nhóm', id_chu_rung:'ID chủ rừng',
        ma_so_lo_rung:'Mã số lô rừng', ma_so_lo_2023:'Mã số lô 2023', qr_code:'QR code', ten_lo_rung:'Tên lô rừng',
        so_so_do:'Số sổ đỏ', to_ban_do:'Tờ bản đồ', thua_dat:'Thửa đất', tieu_khu:'Tiểu khu', khoanh:'Khoảnh',
        toa_do_tam_lo:'Tọa độ tâm lô', khoang_cach_toi_nha:'Khoảng cách tới nhà', dia_chi_lo:'Địa chỉ lô',
        tinh_trang_so_do:'Tình trạng sổ đỏ', ngay_tham_gia_fsc:'Ngày tham gia FSC',
        tinh_trang_xoi_mon:'Tình trạng xói mòn', nguyen_nhan_xoi_mon:'Nguyên nhân xói mòn',
        moc_ranh_gioi:'Mốc ranh giới', do_ben_vung_moc_ranh:'Độ bền vững mốc ranh', trang_thai:'Trạng thái',
        do_doc_binh_quan:'Độ dốc bình quân', giap_ranh_rung_tu_nhien:'Giáp ranh rừng tự nhiên',
        co_loai_cay_ban_dia:'Có loài cây bản địa', ten_dong_vat_thuc_vat_quy:'Tên động vật thực vật quý',
        loai_cay_trong_chinh:'Loài cây trồng chính', loai_cay_trong_xen_ghep:'Loài cây trồng xen ghép',
        loai_cay_trong_fsc:'Loài cây trồng FSC', nguon_goc_giong:'Nguồn gốc giống',
        mo_ta_nguon_goc_giong:'Mô tả nguồn gốc giống', co_hoa_don_giong:'Có hóa đơn giống',
        mat_do_ban_dau:'Mật độ ban đầu', mat_do_sau_tia_thua:'Mật độ sau khi tỉa thưa',
        so_cay_trong_chinh:'Số cây trồng chính', so_cay_trong_dam:'Số cây trồng dặm',
        tong_dien_tich:'Tổng diện tích', dien_tich_gcn_qsdd:'Diện tích GCN QSDĐ',
        dien_tich_trong_rung:'Diện tích trồng rừng', dien_tich_fsc:'Diện tích FSC',
        dien_tich_ngoai_fsc:'Diện tích ngoài FSC', dien_tich_vung_dem:'Diện tích vùng đệm',
        dien_tich_rung_tu_nhien:'Diện tích rừng tự nhiên', dien_tich_hlvs:'Diện tích HLVS', co_ao_ho:'Có ao hồ',
        thoi_diem_trong:'Thời điểm trồng', nam_trong:'Năm trồng', so_nam_khai_thac:'Số năm khai thác',
        nam_khai_thac:'Năm khai thác', san_luong_khai_thac_xe:'Sản lượng khai thác xe',
        san_luong_khai_thac_dam:'Sản lượng khai thác đăm',
        co_thue_lao_dong:'Có thuê lao động', phuong_tien_bao_ho:'Phương tiện bảo hộ lao động',
        loai_phuong_tien_bhld:'Loại phương tiện BHLD',
        ky_thuat_truoc_trong:'Kỹ thuật trước trồng', ky_thuat_cham_soc:'Kỹ thuật chăm sóc',
        cuoc_ho_bang_may:'Cuốc hố bằng máy', bon_phan:'Bón phân', loai_phan_bon:'Loại phân bón',
        dinh_luong_phan_bon:'Định lượng phân bón', kiem_soat_dich_benh:'Kiểm soát dịch bệnh',
        tinh_hinh_sau_benh:'Tình hình sâu bệnh', thuoc_su_dung:'Thuốc sử dụng',
        phong_chay_chua_chay:'Phòng cháy chữa cháy',
        thoi_gian_khai_thac:'Thời gian khai thác',
        dia_danh:'Địa danh', so_hieu_lo:'Số hiệu lô',
        kinh_do:'Kinh độ', vi_do:'Vĩ độ',
        ten_tinh:'Tên tỉnh', ten_huyen:'Tên huyện', ten_xa:'Tên xã', ten_xa_moi:'Tên xã mới'
      }},
      'Taphuan': { table: 'tap_huan', cols: {
        id:'ID tập huấn', id_chu_rung:'ID chủ rừng', loai_tap_huan:'Loại tập huấn',
        ngay_tap_huan:'Ngày tập huấn', dia_diem:'Địa điểm', giang_vien:'Giảng viên',
        so_luong_tham_du:'Số lượng tham dự'
      }},
      'Noidung_taphuan': { table: 'noi_dung_tap_huan', cols: {
        id:'ID tập huấn', ten_lop:'Tên lớp tập huấn', loai_tap_huan:'Loại tập huấn', ghi_chu:'Ghi chú'
      }},
      'Loai_hoatdong_rung': { table: 'loai_hoat_dong_rung', cols: {
        id:'ID hoạt động', ten_hoat_dong:'Tên hoạt động', mo_ta_chi_tiet:'Mô tả chi tiết'
      }},
      'KH_QL_Lorung': { table: 'kh_ql_lo_rung', cols: {
        id:'ID kế hoạch', id_lo_rung:'ID lô rừng', hoat_dong:'Hoạt động',
        ngay_thuc_hien:'Ngày thực hiện', noi_dung:'Nội dung', trang_thai:'Trạng thái',
        nguoi_nhap:'Người nhập', ghi_chu:'Ghi chú'
      }},
      'Biendong_lorung': { table: 'bien_dong_lo_rung', cols: {
        id:'ID', id_lo_rung:'ID lô rừng', loai_bien_dong:'Loại biến động',
        ngay_bien_dong:'Ngày biến động', noi_dung:'Nội dung', nguoi_nhap:'Người nhập', ghi_chu:'Ghi chú'
      }},
      'KH_HD_nhom': { table: 'kh_hd_nhom', cols: {
        id:'ID', id_nhom:'ID nhóm', hoat_dong:'Hoạt động', ngay_thuc_hien:'Ngày thực hiện',
        noi_dung:'Nội dung', trang_thai:'Trạng thái', nguoi_nhap:'Người nhập', ghi_chu:'Ghi chú'
      }},
      'KH_HD_Churung': { table: 'kh_hd_chu_rung', cols: {
        id:'ID', id_chu_rung:'ID chủ rừng', hoat_dong:'Hoạt động', ngay_thuc_hien:'Ngày thực hiện',
        noi_dung:'Nội dung', trang_thai:'Trạng thái', nguoi_nhap:'Người nhập', ghi_chu:'Ghi chú'
      }},
      'HD_Lorung': { table: 'hd_lo_rung', cols: {
        id:'ID hoạt động lô', id_lo_rung:'ID lô rừng', id_hoat_dong:'ID hoạt động',
        ten_hoat_dong:'Tên hoạt động', ngay_trien_khai:'Ngày triển khai', ngay_ket_thuc:'Ngày kết thúc',
        ngay_bao_cao:'Ngày báo cáo', dia_diem_kiem_tra:'Địa điểm kiểm tra', nguoi_kiem_tra:'Người kiểm tra',
        ket_qua_hoat_dong:'Kết quả hoạt động', dien_tich_thuc_hien:'Diện tích thực hiện',
        so_lao_dong:'Số lao động', tuoi_lao_dong:'Tuổi lao động'
      }},
      'DS_HDong': { table: 'ds_hdong', cols: {
        id:'ID DS hoat dong', hoat_dong_chi_tiet:'Hoạt động chi tiết', nhom_hoat_dong:'Nhóm hoạt động'
      }},
      'CauHoi_DanhGia': { table: 'cau_hoi_danh_gia', cols: {
        id:'ID câu hỏi', nhom_tieu_chi:'Nhóm tiêu chí', noi_dung:'Nội dung câu hỏi',
        phuong_phap:'Phương pháp kiểm tra', goi_y_bang_chung:'Gợi ý bằng chứng'
      }},
      'KetQua_DanhGia': { table: 'ket_qua_danh_gia', cols: {
        id:'ID', id_cau_hoi:'ID câu hỏi', id_dg:'ID đánh giá', ket_qua:'Kết quả', ghi_chu:'Ghi chú'
      }},
      'DG_noibo': { table: 'dg_noi_bo', cols: {
        id:'ID', id_nhom:'ID nhóm', audit_date:'Date', staff:'Staff', updated_at:'Update'
      }},
      'Banghoi_DG_noibo': { table: 'bang_hoi_dg_noi_bo', cols: {
        id:'ID_hoi', id_dg:'ID_DG', answers:'answers'
      }},
      'GiamSat_LoRung': { table: 'giam_sat_lo_rung', cols: {
        id:'ID', id_lo_rung:'ID lô rừng', id_nhom:'ID nhóm', id_chu_rung:'ID chủ rừng',
        loai_giam_sat:'Loại giám sát', ngay_giam_sat:'Ngày giám sát', nguoi_giam_sat:'Người giám sát',
        dai_dien_to:'Đại diện tổ', dien_tich_giam_sat:'Diện tích GS', thoi_tiet:'Thời tiết',
        ghi_chu:'Ghi chú', de_xuat:'Đề xuất', updated_at:'Cập nhật'
      }},
      'Banghoi_GiamSat': { table: 'bang_hoi_giam_sat', cols: {
        id:'ID_hoi', id_giam_sat:'ID_GS', answers:'answers'
      }},
      'KH_GiamSat_Nhom': { table: 'kh_giam_sat_nhom', cols: {
        id:'ID', id_nhom:'ID nhóm', nam:'Năm', loai_giam_sat:'Loại giám sát',
        thang_1:'T1', thang_2:'T2', thang_3:'T3', thang_4:'T4',
        thang_5:'T5', thang_6:'T6', thang_7:'T7', thang_8:'T8',
        thang_9:'T9', thang_10:'T10', thang_11:'T11', thang_12:'T12', ghi_chu:'Ghi chú'
      }},
      'BenLienQuan': { table: 'ben_lien_quan', cols: {
        id:'ID', ten_to_chuc:'Tên tổ chức', email:'Email', dia_chi:'Địa chỉ',
        dien_thoai:'Điện thoại', nguoi_dai_dien:'Người đại diện', website:'Website',
        nhom_blq:'Nhóm BLQ'
      }},
      'DotThamVan': { table: 'dot_tham_van', cols: {
        id:'ID', ten_dot:'Tên đợt', nam:'Năm', noi_dung_gioi_thieu:'Nội dung giới thiệu',
        trang_thai:'Trạng thái', nguoi_tao:'Người tạo'
      }},
      'PhanHoiThamVan': { table: 'phan_hoi_tham_van', cols: {
        id:'ID', id_dot:'ID đợt', id_ben_lien_quan:'ID BLQ', nguoi_tra_loi:'Người trả lời',
        dia_chi:'Địa chỉ', dien_thoai:'Điện thoại', ngay_phan_hoi:'Ngày phản hồi',
        answers:'answers'
      }}
    };

    // === HELPER: Convert Supabase row (snake_case) → Display (Vietnamese) ===
    function fromDB(sheetName, rows) {
      const map = DB_MAP[sheetName];
      if (!map || !rows) return rows || [];
      const colMap = map.cols;
      return rows.map(row => {
        const obj = {};
        for (const [dbCol, displayCol] of Object.entries(colMap)) {
          if (row[dbCol] !== undefined && row[dbCol] !== null) {
            let val = row[dbCol];
            if (val instanceof Object && !(val instanceof Date)) val = JSON.stringify(val);
            obj[displayCol] = val;
          } else {
            obj[displayCol] = '';
          }
        }
        return obj;
      });
    }

    // === HELPER: Convert Display (Vietnamese) → Supabase (snake_case) ===
    function toDB(sheetName, obj) {
      const map = DB_MAP[sheetName];
      if (!map) return obj;
      const reverseMap = {};
      for (const [dbCol, displayCol] of Object.entries(map.cols)) {
        reverseMap[displayCol] = dbCol;
      }
      const dbObj = {};
      for (const [key, val] of Object.entries(obj)) {
        const dbCol = reverseMap[key];
        if (dbCol && val !== undefined) {
          dbObj[dbCol] = val === '' ? null : val;
        }
      }
      return dbObj;
    }

    function getDBTable(sheetName) {
      return DB_MAP[sheetName] ? DB_MAP[sheetName].table : sheetName;
    }

    function getIdColumn(sheetName) {
      const map = DB_MAP[sheetName];
      if (!map) return 'id';
      return 'id';
    }

    const TABLE_CONFIG = {
      'Menu': { columns: ['ID', 'Nhom', 'Module', 'View', 'Xem', 'Thêm', 'Sửa', 'Xóa'] },
      'Admin': { columns: ['ID', 'Province code', 'Province', 'District', 'Commune', 'TYPE'] },
      'NhanSu': { columns: ['ID_staff', 'Họ và tên', 'Email', 'Giới tính', 'Ngày sinh', 'Chức vụ', 'Số điện thoại', 'Trạng thái'] },
      'Ban_Quanlynhom': {
        columns: [
          'ID ban quản lý', 'Tên ban quản lý', 'Loại tổ chức', 'Địa chỉ', 'Tỉnh', 'Huyện',
          'Người đại diện', 'Chức vụ', 'Điện thoại', 'Email', 'Website',
          'Số nhóm quản lý', 'Số hộ thành viên', 'Tổng diện tích', 'Diện tích FSC',
          'Diện tích rừng tự nhiên', 'Diện tích vùng đệm', 'Sản lượng dự kiến năm',
          'Diện tích trồng rừng năm', 'Loài cây trồng chính'
        ],
        main: ['ID ban quản lý', 'Tên ban quản lý', 'Người đại diện', 'Tổng diện tích', 'Diện tích FSC']
      },
      'NhomCCR': {
        columns: [
          'ID nhóm', 'Mã nhóm', 'Tên nhóm', 'Người đại diện', 'Số điện thoại', 'Địa chỉ',
          'Tỉnh', 'Huyện', 'Xã', 'Xóm', 'Vị trí', 'Diện tích FSC', 'Diện tích ngoài FSC',
          'Diện tích rừng tự nhiên', 'Diện tích vùng đệm', 'Tổng diện tích', 'Sản lượng dự kiến năm', 'Diện tích trồng rừng năm',
          'Số thành viên', 'Ngày cập nhật', 'Người cập nhật', 'Đường dẫn file'
        ],
        main: ['ID nhóm', 'Tên nhóm', 'Người đại diện', 'Số thành viên', 'Tổng diện tích', 'Diện tích FSC']
      },
      'Churung': {
        columns: [
          'ID chủ rừng', 'ID nhóm', 'Thông tin cá nhân', 'Họ tên chủ rừng', 'Giới tính', 'Ngày sinh',
          'Dân tộc', 'CCCD', 'Họ tên vợ', 'Họ tên chồng', 'Thông tin liên hệ và địa chỉ',
          'Số điện thoại', 'Tỉnh', 'Huyện', 'Xã', 'Thôn', 'Địa chỉ', 'Thông tin tham gia nhóm',
          'Ngày tham gia', 'Ngày rời nhóm', 'Thông tin rừng quản lý', 'Số lô rừng',
          'Tổng diện tích', 'Diện tích FSC', 'Diện tích rừng tự nhiên', 'Diện tích vùng đệm', 'Sản lượng dự kiến năm', 'Diện tích trồng rừng năm',
          'Thông tin hệ thống', 'Người nhập dữ liệu', 'Cập nhật', 'Đường dẫn file'
        ],
        main: ['ID chủ rừng', 'Họ tên chủ rừng', 'Số điện thoại', 'Tổng diện tích', 'Diện tích FSC']
      },
      'Lo_rung': {
        columns: [
          'ID nhóm', 'ID chủ rừng', 'ID lô rừng', 'Mã số lô rừng', 'Mã số lô 2023', 'QR code', 'Tên lô rừng',
          '2. Thông tin địa lý – pháp lý', 'Số sổ đỏ', 'Tờ bản đồ', 'Thửa đất', 'Tiểu khu', 'Khoảnh', 'Số hiệu lô',
          'Tọa độ tâm lô', 'Kinh độ', 'Vĩ độ', 'Khoảng cách tới nhà', 'Địa chỉ lô',
          'Địa danh', 'Tên tỉnh', 'Tên huyện', 'Tên xã', 'Tên xã mới',
          '3. Thông tin pháp lý – sở hữu – ổn định',
          'Tình trạng sổ đỏ', 'Ngày tham gia FSC', 'Tình trạng xói mòn', 'Nguyên nhân xói mòn',
          'Mốc ranh giới', 'Độ bền vững mốc ranh', 'Trạng thái', '4. Đặc điểm sinh thái – địa hình',
          'Độ dốc bình quân', 'Giáp ranh rừng tự nhiên', 'Có loài cây bản địa', 'Tên động vật thực vật quý',
          '5. Cây trồng và nguồn gốc giống', 'Loài cây trồng chính', 'Loài cây trồng xen ghép',
          'Loài cây trồng FSC', 'Nguồn gốc giống', 'Mô tả nguồn gốc giống', 'Có hóa đơn giống',
          '6. Mật độ và số cây', 'Mật độ ban đầu', 'Mật độ sau khi tỉa thưa', 'Số cây trồng chính',
          'Số cây trồng dặm', 'Tổng diện tích', 'Diện tích GCN QSDĐ', 'Diện tích trồng rừng',
          'Diện tích FSC', 'Diện tích ngoài FSC', 'Diện tích vùng đệm', 'Diện tích rừng tự nhiên',
          'Diện tích HLVS', 'Có ao hồ', '8. Thời gian – chu kỳ – sản lượng', 'Thời điểm trồng',
          'Năm trồng', 'Số năm khai thác', 'Năm khai thác', 'Thời gian khai thác', 'Sản lượng khai thác xe',
          'Sản lượng khai thác đăm', '9. Lao động – an toàn – thiết bị', 'Có thuê lao động',
          'Phương tiện bảo hộ lao động', 'Loại phương tiện BHLD', '10. Biện pháp kỹ thuật lâm sinh',
          'Kỹ thuật trước trồng', 'Kỹ thuật chăm sóc', 'Cuốc hố bằng máy', 'Bón phân', 'Loại phân bón',
          'Định lượng phân bón', 'Kiểm soát dịch bệnh', 'Tình hình sâu bệnh', 'Thuốc sử dụng', 'Phòng cháy chữa cháy'
        ],
        main: ['ID lô rừng', 'Mã số lô rừng', 'Tổng diện tích', 'Diện tích FSC']
      },
      'Taphuan': { columns: ['ID tập huấn', 'ID chủ rừng', 'Loại tập huấn', 'Ngày tập huấn', 'Địa điểm', 'Giảng viên', 'Số lượng tham dự'] },
      'Noidung_taphuan': { columns: ['ID tập huấn', 'Tên lớp tập huấn', 'Loại tập huấn', 'Ghi chú'] },
      'Loai_hoatdong_rung': { columns: ['ID hoạt động', 'Tên hoạt động', 'Mô tả chi tiết'] },
      'KH_QL_Lorung': {
        columns: ['ID kế hoạch', 'ID lô rừng', 'Hoạt động', 'Ngày thực hiện', 'Nội dung', 'Trạng thái', 'Người nhập', 'Ghi chú'],
        main: ['ID kế hoạch', 'Hoạt động', 'Ngày thực hiện', 'Trạng thái']
      },
      'HD_Lorung': {
        columns: ['ID hoạt động lô', 'ID lô rừng', 'ID hoạt động', 'Tên hoạt động', 'Ngày triển khai', 'Ngày kết thúc', 'Ngày báo cáo', 'Địa điểm kiểm tra', 'Người kiểm tra', 'Kết quả hoạt động', 'Diện tích thực hiện', 'Số lao động', 'Tuổi lao động'],
        main: ['ID hoạt động lô', 'Tên hoạt động', 'Ngày triển khai', 'Kết quả hoạt động']
      },
      'DS_HDong': { columns: ['ID DS hoat dong', 'Hoạt động chi tiết', 'Nhóm hoạt động'] },
      'CauHoi_DanhGia': {
        columns: ['ID câu hỏi', 'Nhóm tiêu chí', 'Nội dung câu hỏi', 'Phương pháp kiểm tra', 'Gợi ý bằng chứng']
      },
      'DG_noibo': {
        columns: ['ID', 'ID nhóm', 'Date', 'Staff', 'Update'],
        main: ['ID', 'ID nhóm', 'Date', 'Staff']
      },
      'KH_GiamSat_Nhom': {
        columns: ['ID', 'ID nhóm', 'Năm', 'Loại giám sát', 'T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12', 'Ghi chú'],
        main: ['ID nhóm', 'Năm', 'Loại giám sát', 'T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12']
      },
      'BenLienQuan': {
        columns: ['ID', 'Tên tổ chức', 'Email', 'Địa chỉ', 'Điện thoại', 'Người đại diện', 'Website', 'Nhóm BLQ'],
        main: ['Tên tổ chức', 'Email', 'Điện thoại', 'Người đại diện']
      },
      'DotThamVan': {
        columns: ['ID', 'Tên đợt', 'Năm', 'Trạng thái', 'Người tạo', 'Nội dung giới thiệu'],
        main: ['ID', 'Tên đợt', 'Năm', 'Trạng thái']
      },
      'Banghoi_DG_noibo': {
        columns: ['ID_hoi', 'ID_DG', 'RanhGioiRoRang', 'NopThuePhiDayDu', 'GiamSatNoiBo', 'XuLyViPham', 'GiaiQuyetTranhChapNgoaiToa', 'HoSoTranhChap', 'NgungHoatDongKhiTranhChap', 'TuDoThamGiaToChuc', 'KhongLaoDongCuongBuc', 'TraLuongCongBang', 'PhuongThucTraLuongNu', 'NghiThaiSan', 'TrangBiBaoHo', 'BatBuocDungBaoHo', 'HoSoAnToanLaoDong', 'CaiThienAnToanSauSuCo', 'MucLuongToiThieu', 'TraLuongDungHan', 'DaoTaoNguoiLaoDong', 'HoSoDaoTao', 'GiaiQuyetKhieuNai', 'BoiThuongThietHai', 'NhanDienNguoiBanDia', 'TaiLieuHoaQuyenLoi', 'ThamVanNguoiBanDia', 'HoSoThoaThuan', 'BaoVeDiaDiemVanHoa', 'NhanDienCongDong', 'ThamVanCongDong', 'BaoVeQuyenLoiCongDong', 'GiaiQuyetXamPhamQuyenLoi', 'QuyTrinhGiaiQuyetTranhChap', 'XuLyTranhChapCongDong', 'CanCuKhaiThac', 'GioiHanKhaiThac', 'NganNguaTacDongXau', 'GiamThieuTacDong', 'BaoVeLoaiQuyHiem', 'NganChanSanBat', 'TuanThuBaoVeDongVat', 'NganNguoiLaoDongSanBat', 'BaoVeNguonNuoc', 'PhucHoiNguonNuoc', 'KhacPhucHauQuaCu', 'NganChanSuyThoaiTiepDien', 'KhongChuyenDoiRungTuNhien', 'ChungChiKhuVucChuyenDoi', 'CongKhaiKeHoach', 'HeThongTruyXuat', 'TaiLieuHoaSanPham', 'LuuTruHoaDon', 'TrongRungSauKhaiThac', 'LoaiCayPhuHop', 'KiemSoatLoaiXamLan', 'KhongGMO', 'BienPhapLamSinh', 'HanChePhanBonHoaHoc', 'GiamThieuTacHaiPhanBon', 'KhongSuDungThuocCam', 'GhiChepSuDungThuoc', 'AnToanSuDungThuoc', 'GiamThieuLuongThuoc', 'HanCheAnhHuongSucKhoe', 'DanhMucThuocDuocPhep', 'KiemSoatSinhHoc', 'CanhBaoChayRung', 'CapNhatVuChay', 'QuanLyRacThai', 'XuLyRacThai']
      }
    };

    const AUDIT_DICTIONARY = {
      "Tuân thủ pháp luật": [
        { id: "RanhGioiRoRang", label: "Ranh giới của tất cả các Đơn vị Quản lý trong phạm vi chứng chỉ có được xác định hoặc tài liệu hóa rõ ràng và thể hiện rõ trên bản đồ không?", index: "1.2.3" },
        { id: "NopThuePhiDayDu", label: "Việc chi trả các loại thuế và phí liên quan đến quản lý rừng có được thực hiện kịp thời theo đúng quy định hiện hành không?", index: "1.3.2" },
        { id: "GiamSatNoiBo", label: "Công tác giám sát nội bộ hoạt động nhóm có được thực hiện không?", index: "1.4.2" },
        { id: "XuLyViPham", label: "Nếu phát hiện các hoạt động trái phép hoặc bất hợp pháp, chủ rừng có thực thi các biện pháp để giải quyết các vấn đề không?", index: "1.4.3" },
        { id: "GiaiQuyetTranhChapNgoaiToa", label: "Các tranh chấp liên quan đến pháp luật và quyền truyền thống có được giải quyết kịp thời ngoài tòa án không?", index: "1.6.2" },
        { id: "HoSoTranhChap", label: "Hồ sơ tranh chấp có được cập nhật đầy đủ các bước giải quyết, kết quả, hoặc lý do chưa giải quyết xong không?", index: "1.6.3" },
        { id: "NgungHoatDongKhiTranhChap", label: "Chủ rừng có ngừng hoạt động ở các nơi có tranh chấp nghiêm trọng, kéo dài hoặc liên quan đến nhiều bên không?", index: "1.6.4" }
      ],
      "Quyền người lao động": [
        { id: "TuDoThamGiaToChuc", label: "Người lao động có được tự do tham gia tổ chức lao động mà họ lựa chọn không?", index: "2.1.2" },
        { id: "KhongLaoDongCuongBuc", label: "Có tồn tại bất cứ hình thức lao động cưỡng bức nào đối với người lao động của chủ rừng và nhà thầu không?", index: "2.1.4" },
        { id: "TraLuongCongBang", label: "Phụ nữ và nam giới có được trả lương công bằng khi làm cùng một công việc không?", index: "2.2.4" },
        { id: "PhuongThucTraLuongNu", label: "Phụ nữ có được trả lương trực tiếp và sử dụng các phương thức an toàn (chuyển khoản, thanh toán học phí...) không?", index: "2.2.5" },
        { id: "NghiThaiSan", label: "Phụ nữ có được nghỉ thai sản theo quy định của luật bảo hiểm xã hội không?", index: "2.2.6" },
        { id: "TrangBiBaoHo", label: "Người lao động có được trang bị đầy đủ thiết bị bảo hộ cá nhân phù hợp không?", index: "2.3.2" },
        { id: "BatBuocDungBaoHo", label: "Việc sử dụng thiết bị bảo hộ cá nhân có phải là yêu cầu bắt buộc không?", index: "2.3.3" },
        { id: "HoSoAnToanLaoDong", label: "Hồ sơ về an toàn lao động, bao gồm tai nạn và thời gian nghỉ việc do tai nạn, có được lưu giữ không?", index: "2.3.4" },
        { id: "CaiThienAnToanSauSuCo", label: "Công tác an toàn lao động có được xem xét và cải thiện sau các sự cố, tai nạn nghiêm trọng không?", index: "2.3.6" },
        { id: "MucLuongToiThieu", label: "Mức lương chi trả có bằng hoặc cao hơn mức lương tối thiểu vùng/ngành hoặc thỏa thuận không?", index: "2.4.1" },
        { id: "TraLuongDungHan", label: "Tiền lương và các khoản theo hợp đồng có được chi trả kịp thời và đúng thỏa thuận không?", index: "2.4.3" },
        { id: "DaoTaoNguoiLaoDong", label: "Người lao động có được đào tạo công việc cụ thể và giám sát an toàn để đóng góp vào kế hoạch quản lý rừng không?", index: "2.5.1" },
        { id: "HoSoDaoTao", label: "Hồ sơ đào tạo cập nhật cho tất cả người lao động có được lưu giữ không?", index: "2.5.2" },
        { id: "GiaiQuyetKhieuNai", label: "Các khiếu nại, tố cáo của người lao động có được xác định, phản hồi và giải quyết thỏa đáng không?", index: "2.6.2" },
        { id: "BoiThuongThietHai", label: "Người lao động có được bồi thường công bằng cho các thiệt hại liên quan đến công việc (tai nạn, bệnh nghề nghiệp...) không?", index: "2.6.4" }
      ],
      "Quyền người bản địa": [
        { id: "NhanDienNguoiBanDia", label: "Có xác định được Người dân tộc (nếu có) bị ảnh hưởng bởi hoạt động quản lý rừng không?", index: "3.1.1" },
        { id: "TaiLieuHoaQuyenLoi", label: "Các quyền lợi hợp pháp, truyền thống và nguyện vọng của người dân tộc có được tài liệu hóa và đưa vào bản đồ không?", index: "3.1.2" },
        { id: "ThamVanNguoiBanDia", label: "Người dân tộc có được thông báo và tham vấn về các hoạt động quản lý rừng để bảo vệ quyền lợi của họ không?", index: "3.2.1" },
        { id: "HoSoThoaThuan", label: "Hồ sơ về các thỏa thuận ràng buộc với người dân tộc có được lưu giữ không?", index: "3.3.2" },
        { id: "BaoVeDiaDiemVanHoa", label: "Các địa điểm có ý nghĩa văn hóa, tâm linh đặc biệt của người dân tộc có được xác định và bảo vệ không?", index: "3.5.1" }
      ],
      "Quan hệ cộng đồng": [
        { id: "NhanDienCongDong", label: "Có xác định được cộng đồng địa phương bên trong và xung quanh Đơn vị Quản lý không?", index: "4.1.1" },
        { id: "ThamVanCongDong", label: "Cộng đồng địa phương có được thông báo và tham vấn về các hoạt động quản lý rừng không?", index: "4.2.1" },
        { id: "BaoVeQuyenLoiCongDong", label: "Các quyền hợp pháp và truyền thống của cộng đồng địa phương có được tôn trọng và không bị vi phạm không?", index: "4.2.2" },
        { id: "GiaiQuyetXamPhamQuyenLoi", label: "Nếu có vi phạm quyền lợi cộng đồng, tình hình có được điều chỉnh và giải quyết tranh chấp thỏa đáng không?", index: "4.2.3" },
        { id: "QuyTrinhGiaiQuyetTranhChap", label: "Có quy trình giải quyết tranh chấp công khai, được xây dựng với sự tham gia của cộng đồng không?", index: "4.6.1" },
        { id: "XuLyTranhChapCongDong", label: "Các tranh chấp liên quan đến hoạt động quản lý rừng có được phản hồi và giải quyết kịp thời không?", index: "4.6.2" }
      ],
      "Lợi ích từ rừng": [
        { id: "CanCuKhaiThac", label: "Lượng khai thác gỗ có dựa trên các tài liệu chứng minh về tăng trưởng, sản lượng và bảo vệ hệ sinh thái không?", index: "5.2.1" },
        { id: "GioiHanKhaiThac", label: "Lượng gỗ khai thác hàng năm có đảm bảo không vượt quá lượng tăng trưởng của rừng không?", index: "5.2.2" }
      ],
      "Môi trường": [
        { id: "NganNguaTacDongXau", label: "Các hoạt động quản lý có ngăn ngừa tác động tiêu cực tới môi trường không?", index: "6.3.1" },
        { id: "GiamThieuTacDong", label: "Tại nơi xảy ra tác động tiêu cực, có áp dụng biện pháp ngăn chặn, giảm nhẹ hoặc sửa chữa không?", index: "6.3.2" },
        { id: "BaoVeLoaiQuyHiem", label: "Có xác định và bảo vệ các loài quý hiếm, bị đe dọa và sinh cảnh sống của chúng không?", index: "6.4.1" },
        { id: "NganChanSanBat", label: "Có biện pháp ngăn chặn săn bắt, thu hái các loài lâm sản quý hiếm và bị đe dọa không?", index: "6.4.4" },
        { id: "TuanThuBaoVeDongVat", label: "Có tuân thủ các quy định về bảo vệ động vật hoang dã, cấm săn bắn và buôn bán trái phép không?", index: "6.6.5" },
        { id: "NganNguoiLaoDongSanBat", label: "Có đảm bảo người lao động không tham gia săn bắn các loài bị cấm không?", index: "6.6.6" },
        { id: "BaoVeNguonNuoc", label: "Có thực hiện biện pháp bảo vệ nguồn nước, vùng ven sông và chất lượng nước không?", index: "6.7.1" },
        { id: "PhucHoiNguonNuoc", label: "Nếu chưa bảo vệ tốt, có thực hiện các hoạt động phục hồi nguồn nước không?", index: "6.7.2" },
        { id: "KhacPhucHauQuaCu", label: "Có thực hiện phục hồi nguồn nước bị ảnh hưởng bởi các hoạt động trong quá khứ không?", index: "6.7.3" },
        { id: "NganChanSuyThoaiTiepDien", label: "Có biện pháp ngăn chặn suy thoái nguồn nước do các bên khác gây ra không?", index: "6.7.4" },
        { id: "KhongChuyenDoiRungTuNhien", label: "Có đảm bảo không chuyển đổi rừng tự nhiên sang rừng trồng hoặc đất khác (trừ trường hợp đặc biệt cho phép) không?", index: "6.9.1" },
        { id: "ChungChiKhuVucChuyenDoi", label: "Các khu vực chuyển đổi từ rừng tự nhiên sau 1994 có đáp ứng đủ điều kiện để được cấp chứng chỉ không?", index: "6.10.1" }
      ],
      "Kế hoạch quản lý": [
        { id: "CongKhaiKeHoach", label: "Bản tóm tắt Kế hoạch Quản lý rừng (trừ thông tin mật) có được công khai miễn phí cho các bên liên quan không?", index: "7.5.1" }
      ],
      "Giám sát & Đánh giá": [
        { id: "HeThongTruyXuat", label: "Có hệ thống theo dõi và truy xuất nguồn gốc tất cả sản phẩm FSC không?", index: "8.5.1" },
        { id: "TaiLieuHoaSanPham", label: "Thông tin chi tiết về các sản phẩm đã bán (tên loài, khối lượng, ngày khai thác...) có được ghi chép đầy đủ không?", index: "8.5.2" },
        { id: "LuuTruHoaDon", label: "Các hóa đơn bán hàng và tài liệu liên quan có được lưu giữ ít nhất 5 năm không?", index: "8.5.3" }
      ],
      "Thực hiện quản lý": [
        { id: "TrongRungSauKhaiThac", label: "Hiện trường khai thác có được trồng lại ngay trong 1 mùa vụ không?", index: "10.1.1" },
        { id: "LoaiCayPhuHop", label: "Việc lựa chọn loài cây trồng có phù hợp với điều kiện lập địa không?", index: "10.2.1" },
        { id: "KiemSoatLoaiXamLan", label: "Danh sách các loài xâm lấn ngoại lai có được cập nhật thường xuyên không?", index: "10.3.3" },
        { id: "KhongGMO", label: "Có đảm bảo không sử dụng sinh vật biến đổi gen (GMO) không?", index: "10.4.1" },
        { id: "BienPhapLamSinh", label: "Các biện pháp lâm sinh có phù hợp với đặc điểm sinh thái và mục tiêu quản lý không?", index: "10.5.1" },
        { id: "HanChePhanBonHoaHoc", label: "Việc sử dụng phân bón hóa học có được hạn chế hoặc tránh sử dụng không?", index: "10.6.1" },
        { id: "GiamThieuTacHaiPhanBon", label: "Có biện pháp giảm thiểu hoặc khắc phục thiệt hại môi trường do phân bón hóa học gây ra không?", index: "10.6.5" },
        { id: "KhongSuDungThuocCam", label: "Có đảm bảo không sử dụng hoặc lưu trữ các loại thuốc BVTV bị cấm bởi FSC không?", index: "10.7.2" },
        { id: "GhiChepSuDungThuoc", label: "Có hồ sơ ghi chép chi tiết việc sử dụng thuốc BVTV (tên, liều lượng, địa điểm...) không?", index: "10.7.3" },
        { id: "AnToanSuDungThuoc", label: "Việc sử dụng thuốc BVTV có tuân thủ hướng dẫn an toàn của ILO không?", index: "10.7.4" },
        { id: "GiamThieuLuongThuoc", label: "Có biện pháp giảm thiểu lượng thuốc BVTV sử dụng mà vẫn đảm bảo hiệu quả không?", index: "10.7.5" },
        { id: "HanCheAnhHuongSucKhoe", label: "Có biện pháp hạn chế tác hại của thuốc BVTV đến sức khỏe con người và môi trường không?", index: "10.7.6" },
        { id: "DanhMucThuocDuocPhep", label: "Chỉ sử dụng các loại thuốc BVTV nằm trong danh mục cho phép đúng không?", index: "10.7.7" },
        { id: "KiemSoatSinhHoc", label: "Các tác nhân kiểm soát sinh học có được cập nhật không?", index: "10.8.1" },
        { id: "CanhBaoChayRung", label: "Hệ thống cảnh báo cháy rừng có được thiết lập và hoạt động hiệu quả không?", index: "10.9.1" },
        { id: "CapNhatVuChay", label: "Thông tin về các vụ cháy rừng có được cập nhật đầy đủ không?", index: "10.9.3" },
        { id: "QuanLyRacThai", label: "Có đảm bảo không vứt rác thải bừa bãi và thu gom vỏ thuốc BVTV đúng quy định không?", index: "10.12.1" },
        { id: "XuLyRacThai", label: "Hệ thống xử lý rác thải có hoạt động đúng chức năng không?", index: "10.12.2" }
      ]
    };

    // === MONITORING MODULE: Types & Dictionary ===
    const MONITORING_TYPES = {
      giam_sat_nhom: { title: 'Giám sát nội bộ thành viên nhóm', icon: 'fa-users', target: 'nhom', color: '#6A1B9A' },
      trong_rung: { title: 'Giám sát trồng rừng', icon: 'fa-seedling', target: 'lo_rung', color: '#2E7D32' },
      trong_khai_thac: { title: 'Giám sát khai thác', icon: 'fa-tree', target: 'lo_rung', color: '#E65100' },
      truoc_khai_thac: { title: 'Đánh giá trước khai thác', icon: 'fa-clipboard-check', target: 'lo_rung', color: '#0277BD' },
      sau_khai_thac: { title: 'Đánh giá sau khai thác', icon: 'fa-leaf', target: 'lo_rung', color: '#00695C' },
      bao_ve_rung: { title: 'Giám sát bảo vệ rừng', icon: 'fa-shield-alt', target: 'lo_rung', color: '#AD1457' },
      hanh_lang_ven_suoi: { title: 'Giám sát hành lang ven suối', icon: 'fa-water', target: 'lo_rung', color: '#1565C0' }
    };

    const MONITORING_DICTIONARY = {
      "giam_sat_nhom": {
        "Nội dung giám sát": [
          { id: "GS_N_01", label: "Mức độ tuân thủ các tiêu chuẩn quản lý rừng", type: "rating3" },
          { id: "GS_N_02", label: "Cách tổ chức quản lý có phù hợp với nhóm", type: "rating3" },
          { id: "GS_N_03", label: "Mức độ tuân thủ các tiêu chuẩn Quản lý rừng bền vững FSC", type: "rating3" },
          { id: "GS_N_04", label: "Sự am hiểu các biểu mẫu và kế hoạch giám sát", type: "rating3" },
          { id: "GS_N_05", label: "Thực hiện các hoạt động giám sát nội bộ", type: "rating3" },
          { id: "GS_N_06", label: "Nộp báo cáo giám sát đúng hẹn", type: "rating3" },
          { id: "GS_N_07", label: "Nắm bắt được khu vực quản lý", type: "rating3" },
          { id: "GS_N_08", label: "Đảm bảo tuân thủ kế hoạch quản lý rừng", type: "rating3" },
          { id: "GS_N_09", label: "Đảm bảo kế hoạch họp nhóm", type: "rating3" },
          { id: "GS_N_10", label: "Tuân thủ quy chế nhóm và các quy trình liên quan tới việc quản lý nhóm", type: "rating3" },
          { id: "GS_N_11", label: "Tuân thủ các chính sách của công ty & nhóm hộ (bình đẳng giới, môi trường, lao động, chống phân biệt đối xử, an toàn sức khỏe nghề nghiệp...)", type: "rating3" },
          { id: "GS_N_12", label: "Tham gia các khóa tập huấn do công ty, nhóm tổ chức", type: "rating3" },
          { id: "GS_N_13", label: "Tuân thủ cam kết và kế hoạch sửa lỗi", type: "rating3" },
          { id: "GS_N_14", label: "Hoàn thiện khắc phục lỗi đúng hẹn/tiến độ", type: "rating3" },
          { id: "GS_N_15", label: "Thực hiện đúng kế hoạch đã lập ra", type: "rating3" },
          { id: "GS_N_16", label: "Thông tin chung về quản lý rừng", type: "rating3" }
        ]
      },
      "trong_rung": {
        "I. Xử lý thực bì": [
          { id: "TR_01", label: "Phương thức xử lý thực bì (Cơ giới / Thủ công)", type: "text" },
          { id: "TR_02", label: "Diện tích xử lý thực bì", type: "text" },
          { id: "TR_03", label: "Quy cách kỹ thuật xử lý thực bì", type: "text" }
        ],
        "II. Múc hố": [
          { id: "TR_04", label: "Địa điểm múc hố", type: "text" },
          { id: "TR_05", label: "Kích thước hố", type: "text" },
          { id: "TR_06", label: "Diện tích múc hố", type: "text" },
          { id: "TR_07", label: "Mật độ hố", type: "text" }
        ],
        "III. Bón phân": [
          { id: "TR_08", label: "Có bón phân không?", type: "check" },
          { id: "TR_09", label: "Diện tích bón phân", type: "text" },
          { id: "TR_10", label: "Quy cách kỹ thuật bón phân", type: "text" },
          { id: "TR_11", label: "Đánh giá tình trạng sử dụng phân đến môi trường", type: "text" }
        ],
        "IV. Trồng rừng": [
          { id: "TR_12", label: "Diện tích trồng", type: "text" },
          { id: "TR_13", label: "Loài cây", type: "text" },
          { id: "TR_14", label: "Kỹ thuật trồng", type: "text" },
          { id: "TR_15", label: "Tình trạng cây", type: "text" }
        ],
        "V. Lao động": [
          { id: "TR_16", label: "Số lượng lao động", type: "text" },
          { id: "TR_17", label: "Có người dân tộc?", type: "check" },
          { id: "TR_18", label: "Được tập huấn?", type: "check" },
          { id: "TR_19", label: "Dụng cụ lao động đầy đủ?", type: "check" },
          { id: "TR_20", label: "Bảo hộ lao động đầy đủ?", type: "check" },
          { id: "TR_21", label: "Hộp thuốc y tế?", type: "check" },
          { id: "TR_22", label: "Tai nạn lao động?", type: "check" },
          { id: "TR_23", label: "Khám sức khỏe định kỳ?", type: "check" },
          { id: "TR_24", label: "Thời gian làm việc/ngày", type: "text" }
        ],
        "VI. Môi trường": [
          { id: "TR_25", label: "Sử dụng thuốc BVTV? Loại gì?", type: "check" },
          { id: "TR_26", label: "Phát hiện các loài ngoại lai xâm hại?", type: "check" },
          { id: "TR_27", label: "Sử dụng giống cây biến đổi gen?", type: "check" },
          { id: "TR_28", label: "Rác thải?", type: "check" },
          { id: "TR_29", label: "Nước khe suối bị ảnh hưởng?", type: "check" },
          { id: "TR_30", label: "Xói mòn?", type: "check" }
        ],
        "VII. Hành lang ven suối, vùng đệm": [
          { id: "TR_31", label: "Diện tích vùng đệm", type: "text" },
          { id: "TR_32", label: "Tình trạng (ổn định/xấu đi)", type: "text" },
          { id: "TR_33", label: "Thực bì rơi xuống khe suối?", type: "check" },
          { id: "TR_34", label: "Có cây tái sinh tự nhiên?", type: "check" },
          { id: "TR_35", label: "Dòng chảy bị tắc nghẽn?", type: "check" },
          { id: "TR_36", label: "Vùng đệm bị ảnh hưởng?", type: "check" }
        ]
      },
      "trong_khai_thac": {
        "I. Kỹ thuật khai thác": [
          { id: "KT_01", label: "Bóc vỏ, hướng đổ đúng kỹ thuật?", type: "check" },
          { id: "KT_02", label: "Gốc chừa lại, mặt cắt đạt yêu cầu?", type: "check" }
        ],
        "II. Đường vận chuyển": [
          { id: "KT_03", label: "Tình trạng đường", type: "text" },
          { id: "KT_04", label: "Tu sửa đường?", type: "check" },
          { id: "KT_05", label: "Mở tuyến mới?", type: "check" },
          { id: "KT_06", label: "Chiều dài tu sửa", type: "text" },
          { id: "KT_07", label: "Sát khe suối, vùng đệm?", type: "check" },
          { id: "KT_08", label: "Sát đường điện, khu mộ?", type: "check" }
        ],
        "III. Lao động": [
          { id: "KT_09", label: "Số lượng lao động / Người dân tộc?", type: "text" },
          { id: "KT_10", label: "Được tập huấn?", type: "check" },
          { id: "KT_11", label: "Bảo hộ lao động thợ cưa?", type: "check" },
          { id: "KT_12", label: "Tai nạn lao động?", type: "check" },
          { id: "KT_13", label: "Bảo hộ lao động CN khai thác?", type: "check" },
          { id: "KT_14", label: "Thời gian làm việc/ngày", type: "text" },
          { id: "KT_15", label: "Hộp thuốc y tế?", type: "check" },
          { id: "KT_16", label: "Tình trạng kỹ thuật đạt yêu cầu?", type: "check" },
          { id: "KT_17", label: "Dụng cụ lao động đầy đủ?", type: "check" },
          { id: "KT_18", label: "Số lượng cưa máy", type: "text" }
        ],
        "IV. Máy cưa": [
          { id: "KT_19", label: "Bộ phanh xích và bảo vệ tay trước hoạt động tốt?", type: "check" },
          { id: "KT_20", label: "Móc hãm xích hoạt động tốt?", type: "check" }
        ],
        "V. Môi trường": [
          { id: "KT_21", label: "Nước tại các con suối (hiện diện/bẩn)?", type: "check" },
          { id: "KT_22", label: "Xói mòn (xuất hiện/nghiêm trọng)?", type: "check" },
          { id: "KT_23", label: "Rác thải (công nhân/dầu nhớt)?", type: "check" },
          { id: "KT_24", label: "Điều kiện đường khi mưa (lầy lội)?", type: "check" }
        ],
        "VI. Vận chuyển": [
          { id: "KT_25", label: "Số lượng xe/ngày", type: "text" },
          { id: "KT_26", label: "Khối lượng gỗ/ngày", type: "text" },
          { id: "KT_27", label: "Tình trạng xe (thiếu/thừa/đủ)", type: "text" },
          { id: "KT_28", label: "Xuất phiếu đầy đủ?", type: "check" }
        ],
        "VII. Nhà thầu": [
          { id: "KT_29", label: "Số lượng công nhân", type: "text" },
          { id: "KT_30", label: "Được tập huấn?", type: "check" },
          { id: "KT_31", label: "Đóng bảo hiểm cho công nhân?", type: "check" },
          { id: "KT_32", label: "Trang bị bảo hộ lao động?", type: "check" },
          { id: "KT_33", label: "Trả lương cho công nhân đầy đủ?", type: "check" }
        ],
        "VIII. Đai xanh, vùng đệm": [
          { id: "KT_34", label: "Diện tích đai xanh, vùng đệm", type: "text" },
          { id: "KT_35", label: "Tình trạng (ổn định/xấu đi)", type: "text" },
          { id: "KT_36", label: "Phát hiện mồ mả, đường điện?", type: "check" },
          { id: "KT_37", label: "Dòng chảy tại suối bị tắc nghẽn?", type: "check" },
          { id: "KT_38", label: "Cành nhánh cây khai thác đổ xuống đai xanh, khe suối?", type: "check" }
        ]
      },
      "truoc_khai_thac": {
        "1. Suối": [
          { id: "TKT_01", label: "Vị trí suối thuộc lô", type: "text" },
          { id: "TKT_02", label: "Lượng nước hiện có (Rộng/Sâu)", type: "text" },
          { id: "TKT_03", label: "Chất lượng nước (Sạch/Bẩn/Có thể uống/Có cá)", type: "text" },
          { id: "TKT_04", label: "Tình trạng thực bì dọc theo 2 bên bờ suối", type: "text" }
        ],
        "2. Rừng chừa lại, đai xanh": [
          { id: "TKT_05", label: "Diện tích rừng chừa lại (ha)", type: "text" },
          { id: "TKT_06", label: "Tình trạng rừng chừa lại", type: "text" },
          { id: "TKT_07", label: "Có bị lấn chiếm?", type: "check" }
        ],
        "3. Đường dây điện cắt ngang": [
          { id: "TKT_08", label: "Chiều dài đường điện", type: "text" },
          { id: "TKT_09", label: "Diện tích ảnh hưởng", type: "text" },
          { id: "TKT_10", label: "Vị trí tiếp xúc", type: "text" }
        ],
        "4. Xói mòn": [
          { id: "TKT_11", label: "Tình trạng xói mòn", type: "text" },
          { id: "TKT_12", label: "Mùa xói mòn", type: "text" }
        ],
        "5. Lửa rừng": [
          { id: "TKT_13", label: "Diện tích cháy (ha)", type: "text" },
          { id: "TKT_14", label: "Tình trạng lửa rừng", type: "text" }
        ],
        "6. Vệ sinh": [
          { id: "TKT_15", label: "Diện tích vệ sinh (ha)", type: "text" },
          { id: "TKT_16", label: "Tình trạng vệ sinh", type: "text" }
        ],
        "7. Mồ mả, ụ mối": [
          { id: "TKT_17", label: "Sự xuất hiện ngôi mộ hoặc ụ mối?", type: "check" },
          { id: "TKT_18", label: "Địa điểm, tọa độ (kinh độ/vĩ độ)", type: "text" }
        ]
      },
      "sau_khai_thac": {
        "Đánh giá tác động môi trường": [
          { id: "SKT_01", label: "Tình trạng thực bì (Cao/Dày đặc)?", type: "check" },
          { id: "SKT_02", label: "Nước tại các con suối (Hiện diện/Bẩn)?", type: "check" },
          { id: "SKT_03", label: "Điều kiện đất đai (Khô/Lầy lội/Ẩm)", type: "text" },
          { id: "SKT_04", label: "Xói mòn (Xuất hiện/Nghiêm trọng)?", type: "check" },
          { id: "SKT_05", label: "Rác thải tại các con suối?", type: "check" },
          { id: "SKT_06", label: "Rác thải do công nhân?", type: "check" },
          { id: "SKT_07", label: "Điều kiện đường khi mưa lầy lội?", type: "check" },
          { id: "SKT_08", label: "Vệ sinh thân thiện với môi trường?", type: "check" },
          { id: "SKT_09", label: "Đai xanh, vùng đệm, ngôi mộ bị ảnh hưởng?", type: "check" },
          { id: "SKT_10", label: "Tác động đến khu dân cư sống chung quanh?", type: "check" },
          { id: "SKT_11", label: "Dòng chảy bị tắc nghẽn?", type: "check" }
        ]
      },
      "bao_ve_rung": {
        "I. Tình trạng rừng": [
          { id: "BVR_01", label: "Lấn chiếm đất đai (Nhiều/Ít/Không)", type: "text" },
          { id: "BVR_02", label: "Cháy rừng?", type: "check" },
          { id: "BVR_03", label: "Gia súc phá hại?", type: "check" },
          { id: "BVR_04", label: "Công tác phòng cháy?", type: "check" },
          { id: "BVR_05", label: "Phá hoại do con người?", type: "check" },
          { id: "BVR_06", label: "Nấm/Sâu bệnh hại?", type: "check" },
          { id: "BVR_07", label: "Gẫy đổ do bão/lốc?", type: "check" },
          { id: "BVR_08", label: "Vùng đệm được bảo vệ?", type: "check" }
        ],
        "II. Nhân công và cộng đồng": [
          { id: "BVR_09", label: "Số lượng người làm việc", type: "text" },
          { id: "BVR_10", label: "Được tập huấn?", type: "check" },
          { id: "BVR_11", label: "Trang bị bảo hộ lao động?", type: "check" },
          { id: "BVR_12", label: "Sử dụng bảo hộ lao động?", type: "check" },
          { id: "BVR_13", label: "Hộp cứu thương?", type: "check" },
          { id: "BVR_14", label: "Đầy đủ thuốc trong hộp cứu thương?", type: "check" },
          { id: "BVR_15", label: "Tai nạn lao động?", type: "check" },
          { id: "BVR_16", label: "Người dân vào rừng lấy củi?", type: "check" },
          { id: "BVR_17", label: "Phối hợp cộng đồng trong PCCC, giải quyết tranh chấp?", type: "check" },
          { id: "BVR_18", label: "Người dân vào rừng chặt gỗ?", type: "check" },
          { id: "BVR_19", label: "Chăn thả gia súc vào rừng?", type: "check" },
          { id: "BVR_20", label: "Các hoạt động khác (lấy mật ong/hái nấm/săn bắt)?", type: "check" }
        ],
        "III. Môi trường": [
          { id: "BVR_21", label: "Tình trạng thực bì?", type: "check" },
          { id: "BVR_22", label: "Rác thải (Nhiều/Ít/Không)", type: "text" },
          { id: "BVR_23", label: "Số lượng khe suối", type: "text" },
          { id: "BVR_24", label: "Chất lượng nước (Trong/Đục)", type: "text" },
          { id: "BVR_25", label: "Khe suối có nước?", type: "check" },
          { id: "BVR_26", label: "Tình trạng xói mòn đất (Nhiều/Ít/Không)", type: "text" },
          { id: "BVR_27", label: "Quan sát thấy cá hoặc thủy sản?", type: "check" },
          { id: "BVR_28", label: "Số lượng cá hoặc thủy sản (Nhiều/Ít)", type: "text" },
          { id: "BVR_29", label: "Tình trạng đất (Khô/Ẩm/Khác)", type: "text" },
          { id: "BVR_30", label: "Thu gom rác thải?", type: "check" },
          { id: "BVR_31", label: "Phát hiện loài quý hiếm?", type: "check" },
          { id: "BVR_32", label: "Xử lý thực bì/rác đổ vào suối?", type: "check" },
          { id: "BVR_33", label: "Có sự xuất hiện của sinh vật ngoại lai xâm hại?", type: "check" }
        ]
      },
      "hanh_lang_ven_suoi": {
        "I. Hành lang ven suối, vùng đệm": [
          { id: "HLVS_01", label: "Địa điểm", type: "text" },
          { id: "HLVS_02", label: "Diện tích", type: "text" },
          { id: "HLVS_03", label: "Loài cây xuất hiện", type: "text" },
          { id: "HLVS_04", label: "Tình trạng (ổn định/xấu đi)", type: "text" }
        ],
        "II. Khe suối": [
          { id: "HLVS_05", label: "Khe suối hiện diện?", type: "check" },
          { id: "HLVS_06", label: "Dòng chảy lưu thông?", type: "check" },
          { id: "HLVS_07", label: "Dòng chảy bị tắc nghẽn?", type: "check" },
          { id: "HLVS_08", label: "Nước đục?", type: "check" },
          { id: "HLVS_09", label: "Rác thải tại khe suối?", type: "check" }
        ],
        "III. Ngôi mộ, miếu thờ": [
          { id: "HLVS_10", label: "Hiện diện ngôi mộ, miếu thờ?", type: "check" },
          { id: "HLVS_11", label: "Số lượng", type: "text" },
          { id: "HLVS_12", label: "Loài cây xuất hiện", type: "text" },
          { id: "HLVS_13", label: "Tình trạng", type: "text" }
        ]
      }
    };

    // === CONSULTATION DICTIONARY (Stakeholder Consultation Form Questions) ===
    const CONSULTATION_DICTIONARY = {
      "B-I. Đánh giá hoạt động quản lý rừng": [
        { id: "TV_01", label: "Nội dung của bản phương án QLRBV có mức độ phù hợp với tình hình địa phương?", type: "rating" },
        { id: "TV_02", label: "Đóng góp vào sự phát triển kinh tế xã hội của địa phương/tỉnh nhà?", type: "rating" },
        { id: "TV_03", label: "Tạo ra công ăn việc làm cho người dân địa phương? Mức lương thỏa mãn?", type: "rating" },
        { id: "TV_04", label: "Nguồn gốc đất trồng rừng của các hộ tham gia FSC được phát triển trên đất trống, đồi núi trọc sau chiến tranh và không có chuyển đổi từ rừng tự nhiên sau 01/11/1994?", type: "rating" },
        { id: "TV_05", label: "Cải thiện môi trường bằng việc trồng rừng các loại cây phù hợp với đất đai, tiểu khí hậu và có hiệu quả kinh tế?", type: "rating" },
        { id: "TV_06", label: "Diện tích rừng trồng các hộ tham gia đều ổn định bền vững lâu dài, không có tranh chấp đất đai?", type: "rating" },
        { id: "TV_07", label: "Nhóm hộ gây dựng phong trào trồng rừng - Quản lý rừng bền vững cho cộng đồng địa phương?", type: "rating" },
        { id: "TV_08", label: "Tác động môi trường của hoạt động khai thác gỗ? Hoạt động trồng rừng?", type: "rating" },
        { id: "TV_09", label: "Hoạt động trồng rừng bảo vệ được môi trường - Hành lang ven suối?", type: "rating" },
        { id: "TV_10", label: "Tham gia hoạt động trồng rừng người dân giải quyết công ăn việc làm? Nâng cao đời sống?", type: "rating" },
        { id: "TV_11", label: "Người tham gia được tuyên truyền, tập huấn và thông tin liên quan đến quản lý rừng bền vững có chứng chỉ rừng FSC?", type: "rating" },
        { id: "TV_12", label: "Quyền của người lao động: Lương, chế độ, trang cấp, bình đẳng giới được đảm bảo?", type: "rating" }
      ],
      "B-II. Vấn đề và kiến nghị": [
        { id: "TV_13", label: "Nêu ra những tồn tại, khuyết điểm của bản phương án QLRBV và những đề nghị:", type: "textarea" },
        { id: "TV_14", label: "Nêu quan điểm khác của quý cơ quan/cá nhân:", type: "textarea" }
      ],
      "C. Giá trị bảo tồn cao": [
        { id: "TV_15", label: "Rừng của các hộ dân có sự xuất hiện của các loài động, thực vật quý hiếm?", type: "yesno" },
        { id: "TV_16", label: "Rừng có tồn tại những dạng sinh cảnh đặc biệt? Có giá trị bảo tồn cao?", type: "yesno" },
        { id: "TV_17", label: "Rừng có vai trò quan trọng vào việc nhận diện văn hóa truyền thống của cộng đồng địa phương?", type: "yesno" },
        { id: "TV_18", label: "Rừng có được coi là rừng lưu trữ nguồn gen quý? Đa dạng sinh học cao?", type: "yesno" },
        { id: "TV_19", label: "Rừng có hiện hữu những nhu cầu cơ bản là nền tảng đối với cộng đồng địa phương?", type: "yesno" }
      ]
    };

    const VIEW_MAP = {
      'Ban_Quanly': 'Ban_Quanlynhom',
      'DS_NhomCCR': 'NhomCCR',
      'Churung': 'Churung',
      'Lo_rung': 'Lo_rung',
      'Taphuan': 'Taphuan',
      'Nhan_Su': 'NhanSu',
      'Admin_Province': 'Admin',
      'Biendong': 'Biendong_lorung',
      'ThucHien_GiamSat': 'NhomCCR',
      'GS_Nhom': 'NhomCCR',
      'GS_TrongRung': 'NhomCCR',
      'GS_KhaiThac': 'NhomCCR',
      'GS_MoiTruong': 'NhomCCR',
      'DS_BenLienQuan': 'BenLienQuan',
      'ThucHien_ThamVan': 'DotThamVan',
      'BaoCao_ThamVan': 'DotThamVan'
    };

    // === SUPABASE DATA LOADING ===
    // Fetch all rows from a Supabase table (paginated to bypass 1000-row limit)
    async function fetchAll(table) {
      const PAGE = 1000;
      let allData = [], from = 0;
      while (true) {
        const { data, error } = await sb.from(table).select('*').range(from, from + PAGE - 1);
        if (error) return { data: null, error };
        if (!data || data.length === 0) break;
        allData = allData.concat(data);
        if (data.length < PAGE) break;
        from += PAGE;
      }
      return { data: allData, error: null };
    }

    async function loadAllData() {
      const sheetsToLoad = [
        'Menu', 'NhanSu', 'Ban_Quanlynhom', 'NhomCCR', 'Churung',
        'Taphuan', 'Noidung_taphuan', 'Lo_rung', 'KH_QL_Lorung',
        'Loai_hoatdong_rung', 'Biendong_lorung', 'KH_HD_nhom',
        'KH_HD_Churung', 'HD_Lorung', 'DS_HDong', 'CauHoi_DanhGia', 'KetQua_DanhGia',
        'DG_noibo', 'Banghoi_DG_noibo',
        'GiamSat_LoRung', 'Banghoi_GiamSat', 'KH_GiamSat_Nhom',
        'BenLienQuan', 'DotThamVan', 'PhanHoiThamVan'
      ];

      // Offline mode: load from localStorage cache
      if (!navigator.onLine) {
        console.log('OFFLINE MODE - Loading cached data from localStorage');
        const cached = localStorage.getItem('fscfm_app_data');
        if (cached) {
          try { APP_DATA = JSON.parse(cached); console.log('Loaded offline data:', Object.keys(APP_DATA)); return; }
          catch(e) { console.warn('Cache parse error:', e); }
        }
        console.warn('No cached data available offline');
        return;
      }

      const promises = sheetsToLoad.map(sheetName => {
        const dbTable = getDBTable(sheetName);
        return fetchAll(dbTable).then(res => ({ sheetName, data: res.data, error: res.error }));
      });

      const results = await Promise.all(promises);
      results.forEach(r => {
        if (r.error) {
          console.warn(`Error loading ${r.sheetName}:`, r.error.message);
          APP_DATA[r.sheetName] = [];
        } else {
          // Special handling for JSONB answer tables
          if (r.sheetName === 'Banghoi_DG_noibo') {
            APP_DATA[r.sheetName] = (r.data || []).map(row => {
              const obj = { 'ID_hoi': row.id, 'ID_DG': row.id_dg };
              if (row.answers && typeof row.answers === 'object') {
                Object.assign(obj, row.answers);
              }
              return obj;
            });
          } else if (r.sheetName === 'Banghoi_GiamSat') {
            APP_DATA[r.sheetName] = (r.data || []).map(row => {
              const obj = { 'ID_hoi': row.id, 'ID_GS': row.id_giam_sat };
              if (row.answers && typeof row.answers === 'object') {
                Object.assign(obj, row.answers);
              }
              return obj;
            });
          } else if (r.sheetName === 'PhanHoiThamVan') {
            APP_DATA[r.sheetName] = (r.data || []).map(row => {
              const obj = {
                'ID': row.id, 'ID đợt': row.id_dot, 'ID BLQ': row.id_ben_lien_quan,
                'Người trả lời': row.nguoi_tra_loi, 'Địa chỉ': row.dia_chi,
                'Điện thoại': row.dien_thoai, 'Ngày phản hồi': row.ngay_phan_hoi
              };
              if (row.answers && typeof row.answers === 'object') {
                Object.assign(obj, row.answers);
              }
              return obj;
            });
          } else {
            APP_DATA[r.sheetName] = fromDB(r.sheetName, r.data || []);
          }
        }
      });

      // Cache data to localStorage for offline use
      try { localStorage.setItem('fscfm_app_data', JSON.stringify(APP_DATA)); }
      catch(e) { console.warn('Cannot cache data to localStorage:', e); }

      console.log("All data loaded:", Object.keys(APP_DATA));
    }

    /**
     * Tổng hợp dữ liệu từ NhomCCR lên Ban_Quanlynhom
     */
    function aggregateManagementBoardData() {
      console.log("Aggregating Management Board Data...");
      if (!APP_DATA['Ban_Quanlynhom'] || !APP_DATA['NhomCCR']) return;

      const groups = APP_DATA['NhomCCR'];
      const boards = APP_DATA['Ban_Quanlynhom'];

      boards.forEach(board => {
        const boardID = board['ID ban quản lý'];
        const relatedGroups = groups.filter(g => g['ID ban quản lý'] === boardID || g['Tên ban quản lý'] === board['Tên ban quản lý']);

        board['Số nhóm quản lý'] = relatedGroups.length;
        board['Số hộ thành viên'] = relatedGroups.reduce((sum, g) => sum + (parseFloat(g['Số thành viên']) || 0), 0);
        board['Tổng diện tích'] = relatedGroups.reduce((sum, g) => sum + (parseFloat(g['Tổng diện tích']) || 0), 0).toFixed(2);
        board['Diện tích FSC'] = relatedGroups.reduce((sum, g) => sum + (parseFloat(g['Diện tích FSC']) || 0), 0).toFixed(2);
        board['Diện tích rừng tự nhiên'] = relatedGroups.reduce((sum, g) => sum + (parseFloat(g['Diện tích rừng tự nhiên']) || 0), 0).toFixed(2);
        board['Diện tích vùng đệm'] = relatedGroups.reduce((sum, g) => sum + (parseFloat(g['Diện tích vùng đệm'] || 0) || 0), 0).toFixed(2);
        board['Sản lượng dự kiến năm'] = relatedGroups.reduce((sum, g) => sum + (parseFloat(g['Diện tích khai thác'] || 0) || 0), 0).toFixed(2);
        board['Diện tích trồng rừng năm'] = relatedGroups.reduce((sum, g) => sum + (parseFloat(g['Diện tích trồng'] || 0) || 0), 0).toFixed(2);
      });
      console.log("Aggregation complete.");
    }

    /**
     * Tính toán thống kê nhóm CCR từ dữ liệu Lô rừng
     * - Số thành viên: đếm distinct ID chủ rừng trong nhóm
     * - Tổng diện tích: tổng diện tích tất cả lô trong nhóm
     * - Diện tích FSC: tổng diện tích FSC tất cả lô trong nhóm
     */
    function computeGroupStats() {
      if (!APP_DATA['NhomCCR'] || !APP_DATA['Lo_rung']) return;
      console.log("Computing group stats from Lo_rung...");

      const plots = APP_DATA['Lo_rung'];
      const groups = APP_DATA['NhomCCR'];
      const owners = APP_DATA['Churung'] || [];
      const safeFloat = v => parseFloat(String(v || '0').replace(/,/g, '')) || 0;
      const currentYear = new Date().getFullYear();

      // Aggregate lo_rung → chu_rung (owner level)
      owners.forEach(owner => {
        const ownerId = owner['ID chủ rừng'];
        const ownerPlots = plots.filter(p => p['ID chủ rừng'] === ownerId);
        owner['Tổng diện tích'] = ownerPlots.reduce((s, p) => s + safeFloat(p['Tổng diện tích']), 0).toFixed(2);
        owner['Diện tích FSC'] = ownerPlots.reduce((s, p) => s + safeFloat(p['Diện tích FSC']), 0).toFixed(2);
        owner['Diện tích HLVS'] = ownerPlots.reduce((s, p) => s + safeFloat(p['Diện tích HLVS']), 0).toFixed(2);
        owner['Số lô rừng'] = ownerPlots.length;
      });

      // Aggregate lo_rung → nhom_ccr (group level)
      groups.forEach(group => {
        const groupID = group['ID nhóm'];
        const groupPlots = plots.filter(p => p['ID nhóm'] === groupID);

        const distinctOwners = new Set(groupPlots.map(p => p['ID chủ rừng']).filter(Boolean));
        group['Số thành viên'] = distinctOwners.size;
        group['Số lô rừng'] = groupPlots.length;

        group['Tổng diện tích'] = groupPlots.reduce((s, p) => s + safeFloat(p['Tổng diện tích']), 0).toFixed(2);
        group['Diện tích FSC'] = groupPlots.reduce((s, p) => s + safeFloat(p['Diện tích FSC']), 0).toFixed(2);
        group['Diện tích HLVS'] = groupPlots.reduce((s, p) => s + safeFloat(p['Diện tích HLVS']), 0).toFixed(2);
        group['Diện tích rừng tự nhiên'] = groupPlots.reduce((s, p) => s + safeFloat(p['Diện tích rừng tự nhiên']), 0).toFixed(2);
        group['Diện tích vùng đệm'] = groupPlots.reduce((s, p) => s + safeFloat(p['Diện tích vùng đệm']), 0).toFixed(2);
      });

      console.log("Group stats computed:", groups.length, "groups,", owners.length, "owners updated");
    }

    $(document).ready(function () {
      $("#sidebarToggle").click(function (e) {
        e.preventDefault();
        toggleSidebar();
      });

      // Kiểm tra session Supabase
      sb.auth.getSession().then(async ({ data: { session } }) => {
        if (session) {
          console.log("Existing session found:", session.user.email);
          await initUserSession(session.user);
        }
      });

      // Lắng nghe thay đổi auth state
      sb.auth.onAuthStateChange(async (event, session) => {
        console.log("Auth state changed:", event);
        if (event === 'SIGNED_OUT') {
          currentUser = null;
          APP_DATA = {};
          location.reload();
        }
      });
    });

    async function initUserSession(authUser) {
      try {
        let profileDisplay;

        if (!navigator.onLine) {
          // Offline: load cached profile
          const cached = localStorage.getItem('fscfm_user_profile');
          if (cached) {
            profileDisplay = JSON.parse(cached);
            console.log('Offline mode - using cached profile');
          } else {
            alert(t('no_network'));
            return;
          }
        } else {
          // Online: load profile from Supabase
          const { data: profile, error } = await sb.from('profiles').select('*').eq('id', authUser.id).single();
          if (error || !profile) {
            console.error("Profile not found:", error);
            return;
          }
          if (profile.trang_thai !== 'Act') {
            alert(t('account_locked'));
            await sb.auth.signOut();
            return;
          }
          profileDisplay = fromDB('NhanSu', [profile])[0];
          // Cache profile for offline use
          try { localStorage.setItem('fscfm_user_profile', JSON.stringify(profileDisplay)); } catch(e) {}
        }

        currentUser = profileDisplay;
        await loadAllData();
        showAppMain();
        updateOnlineStatus();
      } catch (err) {
        console.error("Error initializing session:", err);
      }
    }

    function showAppMain() {
      console.log("Entering showAppMain...", { currentUser, APP_DATA });
      try {
        // Luôn ẩn màn hình đăng nhập trước
        $('#login-screen').removeClass('d-flex').addClass('d-none').hide();
        $('#main-app').removeClass('d-none').addClass('d-flex');

        if (!currentUser) throw new Error("currentUser is missing");

        $('#user-display-name').text(currentUser['Họ và tên'] || currentUser['Email'] || 'User');

        if (APP_DATA && APP_DATA['Menu']) {
          computeGroupStats(); // TÍNH TOÁN THỐNG KÊ NHÓM TỪ LÔ RỪNG
          aggregateManagementBoardData(); // TỔNG HỢP DỮ LIỆU
          renderSystemMenu(APP_DATA['Menu']);
        } else {
          console.warn("APP_DATA['Menu'] is missing or empty");
        }

        showDashboard();
        loadSettings();
        console.log("Transition to main-app complete.");
      } catch (err) {
        console.error("Error in showAppMain:", err);
        alert("Lỗi khi vào hệ thống: " + err.message);
        // Fallback: Nếu lỗi vẫn cố hiển thị main-app để người dùng thấy gì đó
        $('#main-app').removeClass('d-none');
      }
    }

    function toggleAuth(mode) {
      $('#login-error').text('').hide();
      if (mode === 'REGISTER') {
        $('#form-login').addClass('d-none');
        $('#form-register').removeClass('d-none').hide().fadeIn(200);
      } else {
        $('#form-register').addClass('d-none');
        $('#form-login').removeClass('d-none').hide().fadeIn(200);
      }
    }

    function togglePasswordVis(btn) {
      const input = $(btn).siblings('input');
      const icon = $(btn).find('i');
      if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
      } else {
        input.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
      }
    }

    $('#form-login').on('submit', async function (e) {
      e.preventDefault();
      const btn = $('#btn-login');
      const err = $('#login-error');
      btn.prop('disabled', true).html(`<i class="fas fa-spinner fa-spin me-2"></i>${t('processing')}`);
      err.hide();

      try {
        const input = $('#login-email').val().trim();
        const password = $('#login-pass').val().trim();
        let loginEmail = input;

        if (!input.includes('@')) {
          const { data: profile, error: lookupErr } = await sb.from('profiles')
            .select('email').eq('username', input.toLowerCase()).single();
          if (lookupErr || !profile || !profile.email) {
            err.html(`<i class="fas fa-exclamation-circle me-1"></i> ${t('username_not_found')}`).show();
            return;
          }
          loginEmail = profile.email;
        }

        const { data, error } = await sb.auth.signInWithPassword({ email: loginEmail, password });

        if (error) {
          err.html(`<i class="fas fa-exclamation-circle me-1"></i> ${error.message}`).show();
          return;
        }

        await initUserSession(data.user);

      } catch (error) {
        console.error("Login Error:", error);
        err.html(`<i class="fas fa-wifi me-1"></i> ${t('conn_error')}: ${error.message}`).show();
      } finally {
        btn.prop('disabled', false).html(`<i class="fa-solid fa-right-to-bracket me-2"></i>${t('btn_login')}`);
      }
    });

    $(document).on('input', '#reg-username', function() {
      this.value = this.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
    });

    $('#form-register').on('submit', async function (e) {
      e.preventDefault();
      const btn = $('#btn-register');
      const err = $('#login-error');

      const password = $('#reg-pass').val();
      if (password !== $('#reg-confirm-pass').val()) {
        err.text(t('pass_mismatch')).show();
        return;
      }
      if (password.length < 6) {
        err.text(t('pass_min6')).show();
        return;
      }

      const username = $('#reg-username').val().trim().toLowerCase();
      if (!username || !/^[a-z0-9_]+$/.test(username)) {
        err.text(t('username_invalid')).show();
        return;
      }

      btn.prop('disabled', true).html(`<i class="fas fa-spinner fa-spin me-2"></i>${t('registering')}`);
      err.hide();

      try {
        const email = $('#reg-email').val().trim();
        const fullName = $('#reg-name').val().trim();
        const phone = $('#reg-phone').val().trim();

        const { data: existing } = await sb.from('profiles').select('id').eq('username', username).single();
        if (existing) {
          err.text("Username '" + username + "' " + t('username_taken')).show();
          return;
        }

        const { data, error } = await sb.auth.signUp({
          email,
          password,
          options: {
            data: { ho_va_ten: fullName, so_dien_thoai: phone, username: username },
            emailRedirectTo: window.location.origin + window.location.pathname
          }
        });

        if (error) {
          err.text(error.message).show();
          return;
        }

        if (data.user) {
          await sb.from('profiles').update({
            ho_va_ten: fullName,
            so_dien_thoai: phone,
            username: username,
            chuc_vu: 'Thanh vien',
            trang_thai: 'Act'
          }).eq('id', data.user.id);
        }

        if (data.session) {
          await initUserSession(data.user);
        } else {
          alert(t('reg_success'));
          toggleAuth('LOGIN');
          $('#login-email').val(username);
        }

      } catch (error) {
        err.text(t('reg_error') + ': ' + error.message).show();
      } finally {
        btn.prop('disabled', false).html(`<i class="fa-solid fa-user-plus me-2"></i>${t('btn_register')}`);
      }
    });

    async function handleForgotPassword() {
      const email = prompt(t('forgot_prompt'));
      if (!email) return;

      try {
        const { error } = await sb.auth.resetPasswordForEmail(email.trim(), {
          redirectTo: window.location.origin + window.location.pathname
        });
        if (error) alert(error.message);
        else alert(t('forgot_sent'));
      } catch (error) {
        alert(t('forgot_error'));
      }
    }

    async function logout() {
      await sb.auth.signOut();
      currentUser = null;
      APP_DATA = {};
      location.reload();
    }

    // ============================================================
    // SETTINGS MODULE
    // ============================================================
    const DEFAULT_SETTINGS = {
      projectName: 'Nhóm hộ CCR Nam Phát - Định Hoá',
      fontFamily: 'Be Vietnam Pro',
      titleAlign: 'center',
      logoUrl: '',
      // Màu sắc chung
      colorPrimary: '#1B5E20',
      colorAccent: '#2E7D32',
      colorText: '#1a1a1a',
      colorBg: '#F5F7F5',
      // Navbar
      colorNavbarText: '#FFFFFF',
      fontSizeTitle: 25,
      // Sidebar
      colorSidebarText: '#FFFFFF',
      fontSizeSidebarGroup: 12,
      fontSizeSidebarItem: 12,
      // Dashboard
      colorCardText: '#1a1a1a',
      iconMenuSize: 44,
      fontSizeKPI: 14,
      iconKPISize: 16,
      // PC
      fontSizePC: 13,
      fontSizeTable: 13,
      fontSizeDetail: 13,
      fontSizeInput: 13,
      fontSizeButton: 12,
      fontSizeChart: 12,
      tableLineHeight: 1.4,
      // Mobile
      fontSizeMobile: 11,
      fontSizeMobileTable: 11,
      fontSizeMobileInput: 11,
      fontSizeMobileButton: 11,
      // Bố cục
      sidebarWidth: 270,
      borderRadius: 8
    };

    function getSettings() {
      try {
        const saved = localStorage.getItem('fscfm_settings');
        if (saved) return { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
      } catch(e) {}
      return { ...DEFAULT_SETTINGS };
    }

    function applySettings(s) {
      if (!s) s = getSettings();
      const root = document.documentElement.style;
      root.setProperty('--forest-primary', s.colorPrimary);
      root.setProperty('--forest-gradient', `linear-gradient(135deg, ${s.colorAccent} 0%, ${s.colorPrimary} 100%)`);
      root.setProperty('--text-main', s.colorText);
      root.setProperty('--bg-light', s.colorBg);

      document.body.style.fontFamily = `'${s.fontFamily}', sans-serif`;
      $('#navbar-project-name').text(s.projectName);
      $('#navbar-project-name-mobile').text(s.projectName);

      // Title alignment
      const titleAlign = s.titleAlign || 'center';
      const titleContainer = $('#navbar-project-name').closest('.position-absolute');
      if (titleAlign === 'left') {
        titleContainer.removeClass('start-50 translate-middle-x').addClass('start-0').css({'left':'60px','transform':'none'});
      } else if (titleAlign === 'right') {
        titleContainer.removeClass('start-50 translate-middle-x start-0').css({'left':'auto','right':'180px','transform':'none'});
      } else {
        titleContainer.addClass('start-50 translate-middle-x').removeClass('start-0').css({'left':'','right':'','transform':''});
      }

      // Custom logo from settings
      const logoEls = ['#navbar-logo-custom', '#navbar-logo-custom-mobile', '#login-logo-custom'];
      if (s.logoUrl) {
        logoEls.forEach(sel => { const el = $(sel); if (el.length) { el.attr('src', s.logoUrl).css('display', ''); el.on('error', function() { $(this).css('display','none'); }); } });
      } else {
        logoEls.forEach(sel => $(sel).css('display', 'none'));
      }

      const navTxt = s.colorNavbarText || '#FFFFFF';
      const sidebarTxt = s.colorSidebarText || '#FFFFFF';
      const cardTxt = s.colorCardText || '#1a1a1a';
      const mTbl = s.fontSizeMobileTable || s.fontSizeMobile;
      const mInp = s.fontSizeMobileInput || s.fontSizeMobile;
      const mBtn = s.fontSizeMobileButton || s.fontSizeMobile;
      const sGrp = s.fontSizeSidebarGroup || 12;
      const sItm = s.fontSizeSidebarItem || 12;

      let css = `
        body { font-size: ${s.fontSizePC}px !important; color: ${s.colorText} !important; }
        table.dataTable thead th { font-size: ${s.fontSizeTable}px !important; line-height: ${s.tableLineHeight} !important; }
        table.dataTable tbody td { font-size: ${s.fontSizeTable}px !important; line-height: ${s.tableLineHeight} !important; }
        .form-control, .form-select { font-size: ${s.fontSizeInput}px !important; }
        .btn { font-size: ${s.fontSizeButton}px !important; }
        #navbar-project-name { font-size: ${s.fontSizeTitle}px !important; color: ${navTxt} !important; }
        .navbar .text-white, .navbar .btn:not(.btn-logout) { color: ${navTxt} !important; }
        .sidebar-header, .sidebar-header span, .sidebar-header i { color: ${sidebarTxt} !important; }
        .accordion-button { font-size: ${sGrp}px !important; }
        .menu-sub-link { font-size: ${sItm}px !important; }
        .card-title-3d { color: ${cardTxt} !important; }
        .detail-table td, .detail-table th, .detail-card .form-label, .detail-card td { font-size: ${s.fontSizeDetail}px !important; }
        #dashboard-view .icon-3d-wrapper { width: ${s.iconMenuSize}px !important; height: ${s.iconMenuSize}px !important; font-size: ${Math.round(s.iconMenuSize * 0.45)}px !important; }
        #dashboard-view .kpi-value { font-size: ${s.fontSizeKPI}px !important; }
        .kpi-card i { font-size: ${s.iconKPISize}px !important; }
        #sidebar-wrapper { width: ${s.sidebarWidth}px; }
        @media (min-width: 992px) {
          #page-content-wrapper { margin-left: ${s.sidebarWidth}px; }
          #sidebar-wrapper.pc-hidden ~ #page-content-wrapper { margin-left: 0; }
        }
        @media (max-width: 767px) {
          body { font-size: ${s.fontSizeMobile}px !important; }
          table.dataTable thead th { font-size: ${mTbl}px !important; }
          table.dataTable tbody td { font-size: ${mTbl}px !important; }
          .form-control, .form-select { font-size: ${mInp}px !important; }
          .btn { font-size: ${mBtn}px !important; }
        }
      `;
      let el = document.getElementById('settings-override');
      if (!el) { el = document.createElement('style'); el.id = 'settings-override'; document.head.appendChild(el); }
      el.textContent = css;
    }

    function loadSettings() { applySettings(getSettings()); startNavbarClock(); }

    function startNavbarClock() {
      function tick() {
        const now = new Date();
        const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const date = now.toLocaleDateString('vi-VN', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
        const el = document.getElementById('navbar-clock');
        const el2 = document.getElementById('navbar-date');
        if (el) el.textContent = time;
        if (el2) el2.textContent = date;
      }
      tick();
      setInterval(tick, 1000);
    }

    function readSettingsForm() {
      return {
        projectName: $('#set-project-name').val() || DEFAULT_SETTINGS.projectName,
        fontFamily: $('#set-font-family').val() || DEFAULT_SETTINGS.fontFamily,
        titleAlign: $('#set-title-align').val() || DEFAULT_SETTINGS.titleAlign,
        logoUrl: $('#set-logo-url').val() || '',
        colorPrimary: $('#set-color-primary').val() || DEFAULT_SETTINGS.colorPrimary,
        colorAccent: $('#set-color-accent').val() || DEFAULT_SETTINGS.colorAccent,
        colorText: $('#set-color-text').val() || DEFAULT_SETTINGS.colorText,
        colorBg: $('#set-color-bg').val() || DEFAULT_SETTINGS.colorBg,
        colorNavbarText: $('#set-color-navbar-text').val() || DEFAULT_SETTINGS.colorNavbarText,
        fontSizeTitle: parseInt($('#set-fontsize-title').val()) || DEFAULT_SETTINGS.fontSizeTitle,
        colorSidebarText: $('#set-color-sidebar-text').val() || DEFAULT_SETTINGS.colorSidebarText,
        fontSizeSidebarGroup: parseInt($('#set-fontsize-sidebar-group').val()) || DEFAULT_SETTINGS.fontSizeSidebarGroup,
        fontSizeSidebarItem: parseInt($('#set-fontsize-sidebar-item').val()) || DEFAULT_SETTINGS.fontSizeSidebarItem,
        colorCardText: $('#set-color-card-text').val() || DEFAULT_SETTINGS.colorCardText,
        iconMenuSize: parseInt($('#set-icon-menu-size').val()) || DEFAULT_SETTINGS.iconMenuSize,
        fontSizeKPI: parseInt($('#set-fontsize-kpi').val()) || DEFAULT_SETTINGS.fontSizeKPI,
        iconKPISize: parseInt($('#set-icon-kpi-size').val()) || DEFAULT_SETTINGS.iconKPISize,
        fontSizePC: parseInt($('#set-fontsize-pc').val()) || DEFAULT_SETTINGS.fontSizePC,
        fontSizeTable: parseInt($('#set-fontsize-table').val()) || DEFAULT_SETTINGS.fontSizeTable,
        fontSizeDetail: parseInt($('#set-fontsize-detail').val()) || DEFAULT_SETTINGS.fontSizeDetail,
        fontSizeInput: parseInt($('#set-fontsize-input').val()) || DEFAULT_SETTINGS.fontSizeInput,
        fontSizeButton: parseInt($('#set-fontsize-button').val()) || DEFAULT_SETTINGS.fontSizeButton,
        fontSizeChart: parseInt($('#set-fontsize-chart').val()) || DEFAULT_SETTINGS.fontSizeChart,
        tableLineHeight: parseFloat($('#set-table-lineheight').val()) || DEFAULT_SETTINGS.tableLineHeight,
        fontSizeMobile: parseInt($('#set-fontsize-mobile').val()) || DEFAULT_SETTINGS.fontSizeMobile,
        fontSizeMobileTable: parseInt($('#set-fontsize-mobile-table').val()) || DEFAULT_SETTINGS.fontSizeMobileTable,
        fontSizeMobileInput: parseInt($('#set-fontsize-mobile-input').val()) || DEFAULT_SETTINGS.fontSizeMobileInput,
        fontSizeMobileButton: parseInt($('#set-fontsize-mobile-button').val()) || DEFAULT_SETTINGS.fontSizeMobileButton,
        sidebarWidth: parseInt($('#set-sidebar-width').val()) || DEFAULT_SETTINGS.sidebarWidth,
        borderRadius: parseInt($('#set-border-radius').val()) || DEFAULT_SETTINGS.borderRadius
      };
    }

    function saveSettingsFromForm() {
      const s = readSettingsForm();
      localStorage.setItem('fscfm_settings', JSON.stringify(s));
      applySettings(s);
      alert('Đã lưu cài đặt thành công!');
    }

    function resetSettingsToDefault() {
      if (!confirm('Xác nhận khôi phục tất cả cài đặt về mặc định?')) return;
      localStorage.removeItem('fscfm_settings');
      applySettings(DEFAULT_SETTINGS);
      renderSettingsView(); // Re-render form with defaults
      alert('Đã khôi phục cài đặt mặc định.');
    }

    function colorInput(id, val, label) {
      return `<div class="mb-2"><label class="form-label small fw-bold mb-1">${label}</label><div class="d-flex align-items-center gap-1"><input type="color" class="form-control form-control-color" id="${id}" value="${val}" style="width:36px;height:28px;padding:2px"><input type="text" class="form-control" value="${val}" onchange="$('#${id}').val(this.value)" style="font-size:10px;padding:3px 6px"></div></div>`;
    }
    function numInput(id, val, label, min, max, step) {
      return `<div class="mb-2"><label class="form-label small fw-bold mb-1">${label}</label><input type="number" class="form-control form-control-sm" id="${id}" value="${val}" min="${min}" max="${max}" ${step ? 'step="'+step+'"' : ''}></div>`;
    }

    function renderSettingsView() {
      const s = getSettings();
      const fonts = ['Be Vietnam Pro', 'Roboto', 'Inter', 'Arial', 'Montserrat', 'Nunito', 'Open Sans', 'Lato'];
      const fontOpts = fonts.map(f => `<option value="${f}" ${s.fontFamily === f ? 'selected' : ''}>${f}</option>`).join('');
      const alignOpts = ['left','center','right'].map(a => `<option value="${a}" ${(s.titleAlign||'center')===a ? 'selected' : ''}>${a==='left'?'Trái':a==='center'?'Giữa':'Phải'}</option>`).join('');

      const html = `
        <div class="card border-0 shadow-sm">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold text-success mb-0"><i class="fa-solid fa-sliders me-2"></i>${t('settings_title')}</h6>
              <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm fw-bold" onclick="saveSettingsFromForm()"><i class="fa-solid fa-check me-1"></i>${t('settings_save')}</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetSettingsToDefault()"><i class="fa-solid fa-rotate-left me-1"></i>${t('settings_default')}</button>
                <button class="btn btn-outline-primary btn-sm" onclick="previewSettings()"><i class="fa-solid fa-eye me-1"></i>${t('settings_preview')}</button>
              </div>
            </div>

            <!-- ===== THANH HỆ THỐNG & LOGO ===== -->
            <div class="card bg-light border-0 mb-2">
              <div class="card-body p-2">
                <h6 class="fw-bold mb-2 small"><i class="fa-solid fa-desktop me-1 text-success"></i> Thanh hệ thống & Logo</h6>
                <div class="row g-2">
                  <div class="col-md-8"><label class="form-label small fw-bold mb-1">Tên dự án</label><input type="text" class="form-control form-control-sm" id="set-project-name" value="${s.projectName}"></div>
                  <div class="col-md-2 col-6"><label class="form-label small fw-bold mb-1">Canh lề</label><select class="form-select form-select-sm" id="set-title-align">${alignOpts}</select></div>
                  <div class="col-md-2 col-6">${numInput('set-fontsize-title', s.fontSizeTitle, 'Cỡ chữ tiêu đề', 12, 36)}</div>
                  <div class="col-md-6"><label class="form-label small fw-bold mb-1">Font chữ</label><select class="form-select form-select-sm" id="set-font-family">${fontOpts}</select></div>
                  <div class="col-md-3 col-6">${colorInput('set-color-navbar-text', s.colorNavbarText||'#FFFFFF', 'Màu chữ Navbar')}</div>
                  <div class="col-md-3 col-6">${colorInput('set-color-primary', s.colorPrimary, 'Màu chính')}</div>
                  <div class="col-md-6"><label class="form-label small fw-bold mb-1">Logo (URL)</label><input type="text" class="form-control form-control-sm" id="set-logo-url" value="${s.logoUrl||''}" placeholder="Dán URL logo hoặc để trống"></div>
                  <div class="col-md-3 col-6">${colorInput('set-color-accent', s.colorAccent, 'Màu gradient phụ')}</div>
                  <div class="col-md-3 col-6">${colorInput('set-color-bg', s.colorBg, 'Màu nền chung')}</div>
                </div>
              </div>
            </div>

            <!-- ===== MENU BAR (Sidebar) ===== -->
            <div class="card bg-light border-0 mb-2">
              <div class="card-body p-2">
                <h6 class="fw-bold mb-2 small"><i class="fa-solid fa-bars me-1 text-primary"></i> Menu Bar (Sidebar)</h6>
                <div class="row g-2">
                  <div class="col-md-3 col-6">${numInput('set-fontsize-sidebar-group', s.fontSizeSidebarGroup||12, 'Cỡ chữ nhóm chính', 9, 18)}</div>
                  <div class="col-md-3 col-6">${numInput('set-fontsize-sidebar-item', s.fontSizeSidebarItem||12, 'Cỡ chữ menu con', 9, 18)}</div>
                  <div class="col-md-3 col-6">${colorInput('set-color-sidebar-text', s.colorSidebarText||'#FFFFFF', 'Màu chữ Header')}</div>
                  <div class="col-md-3 col-6">
                    <label class="form-label small fw-bold mb-1">Sidebar width (px)</label>
                    <input type="range" class="form-range" id="set-sidebar-width" min="200" max="350" value="${s.sidebarWidth}" oninput="$('#sw-val').text(this.value+'px')">
                    <span class="small text-muted" id="sw-val">${s.sidebarWidth}px</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- ===== MÀN HÌNH CHÍNH (Dashboard) ===== -->
            <div class="card bg-light border-0 mb-2">
              <div class="card-body p-2">
                <h6 class="fw-bold mb-2 small"><i class="fa-solid fa-gauge-high me-1 text-warning"></i> Màn hình chính (Dashboard)</h6>
                <div class="row g-2">
                  <div class="col-md-3 col-6">${numInput('set-icon-menu-size', s.iconMenuSize, 'Icon menu (px)', 24, 64)}</div>
                  <div class="col-md-3 col-6">${numInput('set-fontsize-kpi', s.fontSizeKPI, 'Cỡ chữ KPI', 10, 24)}</div>
                  <div class="col-md-3 col-6">${numInput('set-icon-kpi-size', s.iconKPISize, 'Icon KPI (px)', 10, 30)}</div>
                  <div class="col-md-3 col-6">${colorInput('set-color-card-text', s.colorCardText||'#1a1a1a', 'Màu chữ thẻ menu')}</div>
                </div>
              </div>
            </div>

            <!-- ===== 2 CỘT: PC / MOBILE ===== -->
            <div class="row g-2">
              <!-- CỘT TRÁI: PC -->
              <div class="col-md-6">
                <div class="card border-0 mb-2" style="background:#e8f5e9">
                  <div class="card-body p-2">
                    <h6 class="fw-bold mb-2 small"><i class="fa-solid fa-display me-1 text-success"></i> PC / Màn hình lớn</h6>
                    <div class="row g-2">
                      <div class="col-6">${numInput('set-fontsize-pc', s.fontSizePC, 'Cỡ chữ chung', 9, 18)}</div>
                      <div class="col-6">${numInput('set-fontsize-table', s.fontSizeTable, 'Cỡ chữ bảng', 9, 18)}</div>
                      <div class="col-6">${numInput('set-fontsize-detail', s.fontSizeDetail, 'Cỡ chữ chi tiết', 9, 18)}</div>
                      <div class="col-6">${numInput('set-fontsize-input', s.fontSizeInput, 'Cỡ chữ input', 9, 18)}</div>
                      <div class="col-6">${numInput('set-fontsize-button', s.fontSizeButton, 'Cỡ chữ nút', 9, 18)}</div>
                      <div class="col-6">${numInput('set-fontsize-chart', s.fontSizeChart, 'Cỡ chữ biểu đồ', 8, 18)}</div>
                      <div class="col-6">${numInput('set-table-lineheight', s.tableLineHeight, 'Giãn dòng bảng', 1, 2.5, 0.1)}</div>
                      <div class="col-6">${colorInput('set-color-text', s.colorText, 'Màu chữ chung')}</div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- CỘT PHẢI: MOBILE -->
              <div class="col-md-6">
                <div class="card border-0 mb-2" style="background:#e3f2fd">
                  <div class="card-body p-2">
                    <h6 class="fw-bold mb-2 small"><i class="fa-solid fa-mobile-screen me-1 text-primary"></i> Mobile / Màn hình nhỏ</h6>
                    <div class="row g-2">
                      <div class="col-6">${numInput('set-fontsize-mobile', s.fontSizeMobile, 'Cỡ chữ chung', 8, 16)}</div>
                      <div class="col-6">${numInput('set-fontsize-mobile-table', s.fontSizeMobileTable||s.fontSizeMobile, 'Cỡ chữ bảng', 8, 16)}</div>
                      <div class="col-6">${numInput('set-fontsize-mobile-input', s.fontSizeMobileInput||s.fontSizeMobile, 'Cỡ chữ input', 8, 16)}</div>
                      <div class="col-6">${numInput('set-fontsize-mobile-button', s.fontSizeMobileButton||s.fontSizeMobile, 'Cỡ chữ nút', 8, 16)}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ===== BỐ CỤC ===== -->
            <div class="card bg-light border-0 mb-2">
              <div class="card-body p-2">
                <h6 class="fw-bold mb-2 small"><i class="fa-solid fa-table-columns me-1 text-secondary"></i> Bố cục</h6>
                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label small fw-bold mb-1">Bo góc (px)</label>
                    <input type="range" class="form-range" id="set-border-radius" min="0" max="20" value="${s.borderRadius}" oninput="$('#br-val').text(this.value+'px')">
                    <span class="small text-muted" id="br-val">${s.borderRadius}px</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Preview -->
            <div class="p-2 rounded mb-2" id="color-preview" style="background:${s.colorBg};color:${s.colorText};border:1px solid #ddd;font-size:12px">
              <span style="color:${s.colorPrimary};font-weight:700">Chính</span> |
              <span style="color:${s.colorAccent};font-weight:700">Phụ</span> |
              <span>Chữ</span> |
              <span class="px-2 rounded" style="background:${s.colorPrimary};color:${s.colorNavbarText||'#fff'}">Navbar</span> |
              <span class="px-2 rounded" style="background:${s.colorPrimary};color:${s.colorSidebarText||'#fff'}">Sidebar</span>
            </div>

            <!-- Actions (bottom) -->
            <div class="d-flex gap-2">
              <button class="btn btn-success fw-bold" onclick="saveSettingsFromForm()"><i class="fa-solid fa-check me-1"></i> Lưu cài đặt</button>
              <button class="btn btn-outline-secondary" onclick="resetSettingsToDefault()"><i class="fa-solid fa-rotate-left me-1"></i> Khôi phục mặc định</button>
              <button class="btn btn-outline-primary" onclick="previewSettings()"><i class="fa-solid fa-eye me-1"></i> Xem trước</button>
            </div>
          </div>
        </div>
      `;
      $('#page-content-dynamic').html(html);

      // Live preview for all color pickers
      $('[id^="set-color-"]').on('input', function() {
        $(this).closest('.d-flex').find('input[type=text]').val($(this).val());
      });
    }

    function previewSettings() {
      applySettings(readSettingsForm());
    }
    // ============================================================
    // END SETTINGS MODULE
    // ============================================================

    function showDashboard() {
      $('#data-view').addClass('d-none');
      $('#dashboard-view').removeClass('d-none');
      navHistory = [];
      // Lock scroll on dashboard
      $('#page-content-wrapper').css('overflow', 'hidden');
      renderDashboardContent();
    }

    function renderDashboardContent() {
      const safeFloat = v => { if (!v) return 0; return parseFloat(String(v).replace(/,/g, '')) || 0; };

      // Compute KPIs from data
      const groups = APP_DATA['NhomCCR'] || [];
      const owners = APP_DATA['Churung'] || [];
      const plots = APP_DATA['Lo_rung'] || [];

      const soHo = owners.length;
      const soFarm = plots.length;
      const tongDTFSC = plots.reduce((s, p) => s + safeFloat(p['Diện tích FSC']), 0);
      const haPerHo = soHo > 0 ? (tongDTFSC / soHo).toFixed(2) : 0;
      const haPerFarm = soFarm > 0 ? (tongDTFSC / soFarm).toFixed(2) : 0;
      const dtHLVS = plots.reduce((s, p) => s + safeFloat(p['Diện tích HLVS']), 0);
      const tongDT = plots.reduce((s, p) => s + safeFloat(p['Tổng diện tích']), 0);

      // KPI: Harvest calculations based on Thời gian khai thác
      const currentYear = new Date().getFullYear();
      const prevYear = currentYear - 1;

      // DT khai thác thực tế: plots with harvest time in current year
      const dtKhaiThacTT = plots.reduce((s, p) => {
        const tgkt = p['Thời gian khai thác'] || '';
        if (tgkt && tgkt.includes('/' + currentYear)) return s + safeFloat(p['Tổng diện tích']);
        return s;
      }, 0);

      // DT trồng rừng: plots harvested T11-T12 of previous year (replanted current year)
      const dtTrongRung = plots.reduce((s, p) => {
        const tgkt = p['Thời gian khai thác'] || '';
        if (tgkt === 'T11/' + prevYear || tgkt === 'T12/' + prevYear) return s + safeFloat(p['Tổng diện tích']);
        return s;
      }, 0);

      // DT khai thác kế hoạch: plots with age > 5 years (nam_trong + 5 < currentYear)
      const dtKTKeHoach = plots.reduce((s, p) => {
        const yr = parseInt(p['Năm trồng']);
        if (yr && (currentYear - yr) > 5) return s + safeFloat(p['Tổng diện tích']);
        return s;
      }, 0);

      // Main menu icon cards (Hệ thống moved to header bar)
      const mainMenus = [
        { icon: 'fa-users-between-lines', labelKey: 'menu_group_mgmt', color: '#1B5E20', group: 'Quản lý nhóm' },
        { icon: 'fa-tree', labelKey: 'menu_forest_mgmt', color: '#1B5E20', group: 'Quản lý rừng bền vững' },
        { icon: 'fa-binoculars', labelKey: 'menu_monitoring', color: '#0277BD', group: 'Giám sát' },
        { icon: 'fa-cart-shopping', labelKey: 'menu_trade', color: '#1B5E20', group: 'Mua bán sản phẩm' },
        { icon: 'fa-book-open', labelKey: 'menu_docs', color: '#1B5E20', group: 'Tài liệu tham khảo' },
        { icon: 'fa-chart-pie', labelKey: 'menu_report', color: '#1B5E20', group: 'Báo cáo' }
      ];

      const nextLang = currentLang === 'vi' ? 'EN' : 'VI';
      let html = `
        <div class="d-flex align-items-center mb-2">
          <div class="me-auto">
            <h5 class="fw-bold mb-0" style="color:var(--forest-primary)"><i class="fa-solid fa-gauge-high me-2"></i>${t('dashboard_title')}</h5>
          </div>
          <button class="btn btn-sm btn-outline-secondary rounded-pill px-2 me-1" onclick="openMenuGroup('Hệ thống')" style="font-size:11px;font-weight:600">
            <i class="fa-solid fa-gears me-1"></i>${t('menu_system')}
          </button>
          <button class="btn btn-sm btn-outline-success rounded-pill px-2" onclick="toggleLang()" style="font-size:11px;font-weight:600" id="lang-toggle-dash">
            <i class="fa-solid fa-globe me-1"></i><span id="lang-label-dash">${nextLang}</span>
          </button>
        </div>

        <!-- Smart Search -->
        <div class="position-relative mb-3">
          <div class="input-group input-group-sm shadow-sm" style="max-width:100%">
            <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
            <input type="text" class="form-control border-start-0" id="smart-search-input" placeholder="${t('search_placeholder')}" autocomplete="off" oninput="smartSearch(this.value)">
            <button class="btn btn-outline-secondary border-start-0" type="button" onclick="$('#smart-search-input').val('');$('#smart-search-results').addClass('d-none')"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div id="smart-search-results" class="d-none position-absolute w-100 bg-white border rounded shadow mt-1" style="z-index:1050;max-height:350px;overflow-y:auto"></div>
        </div>

        <!-- 6 Main Menu Cards -->
        <div class="row row-cols-3 row-cols-md-6 g-2 mb-3">
          ${mainMenus.map(m => `
            <div class="col">
              <div class="dashboard-card-3d" style="--card-accent:${m.color}" onclick="openMenuGroup('${m.group}')">
                <div class="icon-3d-wrapper" style="background:${m.color}"><i class="fa-solid ${m.icon}"></i></div>
                <div class="card-title-3d">${t(m.labelKey)}</div>
              </div>
            </div>
          `).join('')}
        </div>

        <!-- KPIs -->
        <h6 class="fw-bold text-secondary mb-2"><i class="fa-solid fa-chart-line me-2"></i>${t('kpi_title')}</h6>
        <div class="row row-cols-3 row-cols-md-9 g-1 g-md-2 mb-2 kpi-grid">
          <div class="col"><div class="kpi-card h-100" style="cursor:pointer" onclick="showKpiDetail('households')"><div class="kpi-value">${soHo}</div><div class="kpi-label">${t('kpi_households')}</div></div></div>
          <div class="col"><div class="kpi-card blue h-100" style="cursor:pointer" onclick="showKpiDetail('plots')"><div class="kpi-value">${soFarm}</div><div class="kpi-label">${t('kpi_plots')}</div></div></div>
          <div class="col"><div class="kpi-card h-100" style="cursor:pointer" onclick="showKpiDetail('fsc_area')"><div class="kpi-value">${tongDTFSC.toFixed(1)}</div><div class="kpi-label">${t('kpi_fsc_area')}</div></div></div>
          <div class="col"><div class="kpi-card orange h-100"><div class="kpi-value">${haPerHo}</div><div class="kpi-label">${t('kpi_ha_per_ho')}</div></div></div>
          <div class="col"><div class="kpi-card blue h-100"><div class="kpi-value">${haPerFarm}</div><div class="kpi-label">${t('kpi_ha_per_farm')}</div></div></div>
          <div class="col"><div class="kpi-card orange h-100" style="cursor:pointer" onclick="showKpiDetail('harvest_actual')"><div class="kpi-value">${dtKhaiThacTT.toFixed(1)}</div><div class="kpi-label">${t('kpi_harvest_actual')}</div></div></div>
          <div class="col"><div class="kpi-card purple h-100" style="cursor:pointer" onclick="showKpiDetail('plant')"><div class="kpi-value">${dtTrongRung.toFixed(1)}</div><div class="kpi-label">${t('kpi_plant')}</div></div></div>
          <div class="col"><div class="kpi-card blue h-100" style="cursor:pointer" onclick="showKpiDetail('harvest_plan')"><div class="kpi-value">${dtKTKeHoach.toFixed(1)}</div><div class="kpi-label">${t('kpi_harvest_plan')}</div></div></div>
          <div class="col"><div class="kpi-card h-100" style="cursor:pointer" onclick="showKpiDetail('hlvs')"><div class="kpi-value">${dtHLVS.toFixed(1)}</div><div class="kpi-label">${t('kpi_hlvs')}</div></div></div>
        </div>

        <!-- Charts -->
        <div class="row g-3 flex-grow-1" style="min-height:0">
          <div class="col-md-6 d-flex">
            <div class="card border-0 shadow-sm flex-grow-1">
              <div class="card-body p-2 p-md-3 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="fw-bold text-success mb-0" style="font-size:12px"><i class="fa-solid fa-chart-pie me-1"></i>${t('chart_area')}</h6>
                  <select class="form-select form-select-sm" style="width:auto;font-size:11px;padding:2px 24px 2px 8px" onchange="switchChartType('area', this.value)">
                    <option value="doughnut" selected>Doughnut</option>
                    <option value="pie">Pie</option>
                    <option value="bar">Bar</option>
                    <option value="polarArea">Polar Area</option>
                    <option value="radar">Radar</option>
                  </select>
                </div>
                <div class="flex-grow-1" style="position:relative;min-height:0"><canvas id="chart-area"></canvas></div>
              </div>
            </div>
          </div>
          <div class="col-md-6 d-flex">
            <div class="card border-0 shadow-sm flex-grow-1">
              <div class="card-body p-2 p-md-3 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="fw-bold text-success mb-0" style="font-size:12px"><i class="fa-solid fa-chart-bar me-1"></i>${t('chart_groups')}</h6>
                  <select class="form-select form-select-sm" style="width:auto;font-size:11px;padding:2px 24px 2px 8px" onchange="switchChartType('groups', this.value)">
                    <option value="bar" selected>Bar</option>
                    <option value="line">Line</option>
                    <option value="radar">Radar</option>
                    <option value="pie">Pie</option>
                    <option value="doughnut">Doughnut</option>
                    <option value="polarArea">Polar Area</option>
                  </select>
                </div>
                <div class="flex-grow-1" style="position:relative;min-height:0"><canvas id="chart-groups"></canvas></div>
              </div>
            </div>
          </div>
        </div>
      `;

      $('#dashboard-view').html(html);

      // Render charts after DOM is ready
      setTimeout(() => renderDashboardCharts(groups, plots, tongDT, tongDTFSC, dtTrongRung, dtHLVS, dtKhaiThacTT, dtKTKeHoach), 200);
    }

    let chartInstances = {};
    let chartDataStore = {};

    function renderDashboardCharts(groups, plots, tongDT, tongDTFSC, dtTrongRung, dtHLVS, dtKhaiThacTT, dtKTKeHoach) {
      const safeFloat = v => parseFloat(String(v || 0).replace(/,/g, '')) || 0;

      // Area comparison chart: FSC, non-FSC, HLVS, harvest actual, harvest plan
      const dtNgoaiFSC = Math.max(0, tongDT - tongDTFSC - dtHLVS);
      chartDataStore.area = {
        labels: [t('chart_fsc_area'), t('chart_non_fsc'), t('chart_riparian'),
                 t('kpi_harvest_actual'), t('kpi_harvest_plan'), t('kpi_plant')],
        values: [tongDTFSC.toFixed(1), dtNgoaiFSC.toFixed(1), dtHLVS.toFixed(1),
                 (dtKhaiThacTT || 0).toFixed(1), (dtKTKeHoach || 0).toFixed(1), dtTrongRung.toFixed(1)],
        colors: ['#1B5E20', '#43A047', '#81C784', '#FF8F00', '#0277BD', '#7B1FA2']
      };

      // Groups chart: sort by area descending
      const groupData = groups.map(g => ({
        label: g['Tên nhóm'] || g['Mã nhóm'] || g['ID nhóm'],
        members: safeFloat(g['Số thành viên']),
        area: safeFloat(g['Tổng diện tích'])
      })).sort((a, b) => b.area - a.area);

      chartDataStore.groups = {
        labels: groupData.map(g => g.label),
        members: groupData.map(g => g.members),
        areas: groupData.map(g => g.area)
      };

      buildChart('area', 'doughnut');
      buildChart('groups', 'bar');
    }

    function buildChart(chartKey, chartType) {
      if (chartInstances[chartKey]) { chartInstances[chartKey].destroy(); chartInstances[chartKey] = null; }

      const canvasId = chartKey === 'area' ? 'chart-area' : 'chart-groups';
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const s = getSettings();
      const legendFont = { size: s.fontSizeChart || 11, family: `'${s.fontFamily}'` };

      if (chartKey === 'area') {
        const d = chartDataStore.area;
        if (!d) return;
        const isCartesian = ['bar', 'line'].includes(chartType);
        chartInstances.area = new Chart(ctx.getContext('2d'), {
          type: chartType,
          data: {
            labels: d.labels,
            datasets: [{
              data: d.values,
              backgroundColor: d.colors,
              borderWidth: 2,
              borderColor: '#fff',
              ...(isCartesian ? { label: 'Diện tích (ha)', borderRadius: 4 } : {})
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: legendFont, padding: 12 } } },
            ...(isCartesian ? { scales: { y: { beginAtZero: true } } } : {})
          }
        });
      } else {
        const d = chartDataStore.groups;
        if (!d || !d.labels.length) return;
        const isCartesian = ['bar', 'line'].includes(chartType);
        const isPieType = ['pie', 'doughnut', 'polarArea'].includes(chartType);

        if (isPieType) {
          // For pie-like charts, combine datasets into one
          chartInstances.groups = new Chart(ctx.getContext('2d'), {
            type: chartType,
            data: {
              labels: d.labels,
              datasets: [{
                data: d.areas,
                backgroundColor: d.labels.map((_, i) => ['#1B5E20', '#2E7D32', '#388E3C', '#43A047', '#4CAF50', '#66BB6A', '#81C784', '#A5D6A7', '#C8E6C9'][i % 9]),
                borderWidth: 2, borderColor: '#fff',
                label: 'Diện tích (ha)'
              }]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom', labels: { font: legendFont, padding: 12 } } }
            }
          });
        } else {
          chartInstances.groups = new Chart(ctx.getContext('2d'), {
            type: chartType,
            data: {
              labels: d.labels,
              datasets: [
                { label: 'Số hộ', data: d.members, backgroundColor: '#2E7D32', borderColor: '#2E7D32', borderRadius: 4, fill: false },
                { label: 'Diện tích (ha)', data: d.areas, backgroundColor: '#81C784', borderColor: '#81C784', borderRadius: 4, fill: false }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom', labels: { font: legendFont, padding: 12 } } },
              ...(isCartesian ? { scales: { x: { ticks: { font: { size: 10 }, maxRotation: 45 } }, y: { beginAtZero: true } } } : {})
            }
          });
        }
      }
    }

    function switchChartType(chartKey, newType) {
      buildChart(chartKey, newType);
    }

    // KPI Detail: show list grouped by Nhóm FSC with drill-down
    window.showKpiDetail = function(kpiType) {
      const safeFloat = v => parseFloat(String(v || '0').replace(/,/g, '')) || 0;
      const plots = APP_DATA['Lo_rung'] || [];
      const groups = APP_DATA['NhomCCR'] || [];
      const owners = APP_DATA['Churung'] || [];
      const currentYear = new Date().getFullYear();
      const prevYear = currentYear - 1;

      // Build lookups
      const groupNameMap = {};
      groups.forEach(g => { groupNameMap[g['ID nhóm']] = g['Tên nhóm'] || g['Mã nhóm'] || g['ID nhóm']; });
      const ownerNameMap = {};
      owners.forEach(o => { ownerNameMap[o['ID chủ rừng']] = o['Họ tên chủ rừng'] || o['ID chủ rừng']; });

      // Build plots by group and by owner
      const plotsByGroup = {};
      const plotsByOwner = {};
      const ownerGroupMap = {};
      plots.forEach(p => {
        const gid = p['ID nhóm'], oid = p['ID chủ rừng'];
        if (gid) { if (!plotsByGroup[gid]) plotsByGroup[gid] = []; plotsByGroup[gid].push(p); }
        if (oid) { if (!plotsByOwner[oid]) plotsByOwner[oid] = []; plotsByOwner[oid].push(p); ownerGroupMap[oid] = gid; }
      });

      // Aggregate data by group based on KPI type
      const groupData = {};
      const initGroup = (gid) => {
        if (!groupData[gid]) groupData[gid] = { name: groupNameMap[gid] || gid, households: 0, plotCount: 0, area: 0, ownerIds: new Set() };
      };

      // Filter function per KPI type (returns true if plot matches)
      let plotFilter;
      let title = '', areaLabel = '';
      if (kpiType === 'households' || kpiType === 'plots') {
        title = kpiType === 'households' ? t('kpi_households') : t('kpi_plots');
        plotFilter = () => true;
      } else if (kpiType === 'fsc_area') {
        title = t('kpi_fsc_area');
        areaLabel = 'DT FSC (ha)';
        plotFilter = () => true;
      } else if (kpiType === 'harvest_actual') {
        title = t('kpi_harvest_actual');
        areaLabel = 'DT KT (ha)';
        plotFilter = p => { const tgkt = p['Thời gian khai thác'] || ''; return tgkt && tgkt.includes('/' + currentYear); };
      } else if (kpiType === 'plant') {
        title = t('kpi_plant');
        areaLabel = 'DT trồng (ha)';
        plotFilter = p => { const tgkt = p['Thời gian khai thác'] || ''; return tgkt === 'T11/' + prevYear || tgkt === 'T12/' + prevYear; };
      } else if (kpiType === 'harvest_plan') {
        title = t('kpi_harvest_plan');
        areaLabel = 'DT KH (ha)';
        plotFilter = p => { const yr = parseInt(p['Năm trồng']); return yr && (currentYear - yr) > 5; };
      } else if (kpiType === 'hlvs') {
        title = t('kpi_hlvs');
        areaLabel = 'DT HLVS (ha)';
        plotFilter = p => safeFloat(p['Diện tích HLVS']) > 0;
      }

      // Populate groupData
      plots.forEach(p => {
        if (!plotFilter(p)) return;
        const gid = p['ID nhóm'];
        if (!gid) return;
        initGroup(gid);
        groupData[gid].plotCount++;
        if (p['ID chủ rừng']) groupData[gid].ownerIds.add(p['ID chủ rừng']);
        if (kpiType === 'fsc_area') groupData[gid].area += safeFloat(p['Diện tích FSC']);
        else if (kpiType === 'hlvs') groupData[gid].area += safeFloat(p['Diện tích HLVS']);
        else if (['harvest_actual', 'plant', 'harvest_plan'].includes(kpiType)) groupData[gid].area += safeFloat(p['Tổng diện tích']);
      });
      // Set household counts from ownerIds
      Object.values(groupData).forEach(g => { g.households = g.ownerIds.size; });

      // Sort groups
      const hasArea = ['fsc_area', 'harvest_actual', 'plant', 'harvest_plan', 'hlvs'].includes(kpiType);
      const sorted = Object.entries(groupData).sort((a, b) => (b[1].area || b[1].plotCount) - (a[1].area || a[1].plotCount));
      const totalHH = sorted.reduce((s, [, g]) => s + g.households, 0);
      const totalPlots = sorted.reduce((s, [, g]) => s + g.plotCount, 0);
      const totalArea = sorted.reduce((s, [, g]) => s + g.area, 0);

      // Build modal HTML
      let html = `<div class="modal fade" id="kpiDetailModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content"><div class="modal-header py-2" style="background:var(--forest-primary);color:#fff">
          <h6 class="modal-title fw-bold"><i class="fa-solid fa-chart-line me-2"></i>${title}</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div><div class="modal-body p-2">
          <table class="table table-sm table-hover small mb-0" id="kpiDrillTable">
            <thead class="table-success"><tr>
              <th style="width:30px">#</th><th>Mã nhóm</th><th>Tên nhóm</th>
              <th class="text-end">Số hộ</th><th class="text-end">Số lô</th>
              ${hasArea ? '<th class="text-end">' + areaLabel + '</th>' : ''}
            </tr></thead><tbody>`;

      sorted.forEach(([gid, g], i) => {
        html += `<tr class="kpi-group-row" style="cursor:pointer" data-gid="${gid}" title="Bấm để xem danh sách hộ dân">
          <td>${i + 1}</td><td><strong>${gid}</strong> <i class="fa-solid fa-chevron-right fa-2xs text-muted kpi-chevron"></i></td><td>${g.name}</td>
          <td class="text-end">${g.households}</td><td class="text-end">${g.plotCount}</td>
          ${hasArea ? '<td class="text-end fw-bold">' + g.area.toFixed(2) + '</td>' : ''}
        </tr>`;
      });

      html += `</tbody><tfoot class="table-success fw-bold"><tr>
        <td colspan="3">Tổng</td>
        <td class="text-end">${totalHH}</td><td class="text-end">${totalPlots}</td>
        ${hasArea ? '<td class="text-end">' + totalArea.toFixed(2) + '</td>' : ''}
      </tr></tfoot></table>
        </div></div></div></div>`;

      // Remove old modal and show new
      $('#kpiDetailModal').remove();
      $('body').append(html);
      const modal = new bootstrap.Modal(document.getElementById('kpiDetailModal'));
      modal.show();

      // Drill-down: click group row → expand owners
      const colSpan = hasArea ? 6 : 5;
      $('#kpiDrillTable').on('click', '.kpi-group-row', function() {
        const $row = $(this);
        const gid = $row.data('gid');
        const $chevron = $row.find('.kpi-chevron');
        // Toggle: remove if already expanded
        if ($row.hasClass('kpi-expanded')) {
          $row.removeClass('kpi-expanded');
          $chevron.removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $row.nextUntil('.kpi-group-row').remove();
          return;
        }
        // Collapse any other expanded group
        $('#kpiDrillTable .kpi-expanded').each(function() {
          $(this).removeClass('kpi-expanded').find('.kpi-chevron').removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $(this).nextUntil('.kpi-group-row').remove();
        });
        $row.addClass('kpi-expanded');
        $chevron.removeClass('fa-chevron-right').addClass('fa-chevron-down');
        // Find distinct owners for this group matching the filter
        const ownerMap = {};
        (plotsByGroup[gid] || []).forEach(p => {
          if (!plotFilter(p)) return;
          const oid = p['ID chủ rừng'];
          if (!oid) return;
          if (!ownerMap[oid]) ownerMap[oid] = { name: ownerNameMap[oid] || oid, plotCount: 0, area: 0 };
          ownerMap[oid].plotCount++;
          if (kpiType === 'fsc_area') ownerMap[oid].area += safeFloat(p['Diện tích FSC']);
          else if (kpiType === 'hlvs') ownerMap[oid].area += safeFloat(p['Diện tích HLVS']);
          else if (['harvest_actual', 'plant', 'harvest_plan'].includes(kpiType)) ownerMap[oid].area += safeFloat(p['Tổng diện tích']);
        });
        const ownerEntries = Object.entries(ownerMap).sort((a, b) => a[0].localeCompare(b[0]));
        let ownerHtml = '';
        ownerEntries.forEach(([oid, o], idx) => {
          ownerHtml += `<tr class="kpi-owner-row table-light" style="cursor:pointer" data-oid="${oid}" data-gid="${gid}" title="Bấm để xem lô rừng">
            <td></td><td class="ps-3"><i class="fa-solid fa-user text-success fa-xs me-1"></i>${oid} <i class="fa-solid fa-chevron-right fa-2xs text-muted kpi-chevron-owner"></i></td>
            <td>${o.name}</td>
            <td class="text-end">${idx + 1}</td><td class="text-end">${o.plotCount}</td>
            ${hasArea ? '<td class="text-end">' + o.area.toFixed(2) + '</td>' : ''}
          </tr>`;
        });
        if (!ownerEntries.length) {
          ownerHtml = `<tr class="kpi-owner-row table-light"><td colspan="${colSpan}" class="text-center text-muted">Không có dữ liệu</td></tr>`;
        }
        $row.after(ownerHtml);
      });

      // Drill-down: click owner row → expand plots
      $('#kpiDrillTable').on('click', '.kpi-owner-row', function(e) {
        e.stopPropagation();
        const $row = $(this);
        const oid = $row.data('oid');
        const $chevron = $row.find('.kpi-chevron-owner');
        // Toggle: remove if already expanded
        if ($row.hasClass('kpi-owner-expanded')) {
          $row.removeClass('kpi-owner-expanded');
          $chevron.removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $row.nextUntil('.kpi-owner-row, .kpi-group-row').remove();
          return;
        }
        // Collapse other expanded owners in same group
        const gid = $row.data('gid');
        $row.siblings('.kpi-owner-expanded[data-gid="' + gid + '"]').each(function() {
          $(this).removeClass('kpi-owner-expanded').find('.kpi-chevron-owner').removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $(this).nextUntil('.kpi-owner-row, .kpi-group-row').remove();
        });
        $row.addClass('kpi-owner-expanded');
        $chevron.removeClass('fa-chevron-right').addClass('fa-chevron-down');
        // Find plots for this owner matching the filter
        const ownerPlots = (plotsByOwner[oid] || []).filter(plotFilter);
        let plotHtml = '';
        ownerPlots.forEach(p => {
          const pid = p['ID lô rừng'] || '';
          const maLo = p['Mã số lô rừng'] || pid;
          const area = kpiType === 'fsc_area' ? safeFloat(p['Diện tích FSC']) : kpiType === 'hlvs' ? safeFloat(p['Diện tích HLVS']) : safeFloat(p['Tổng diện tích']);
          const extra = p['Thời gian khai thác'] ? ' <span class="text-muted">(' + p['Thời gian khai thác'] + ')</span>' : '';
          plotHtml += `<tr class="kpi-plot-row" style="cursor:pointer;font-size:11px;background:#f0faf0" data-pid="${pid}" title="Bấm để xem trên bản đồ">
            <td></td><td class="ps-5"><i class="fa-solid fa-tree text-success fa-xs me-1"></i>${maLo}${extra}</td>
            <td>${p['Tên lô rừng'] || ''}</td>
            <td></td><td class="text-end">${safeFloat(p['Tổng diện tích']).toFixed(2)}</td>
            ${hasArea ? '<td class="text-end">' + area.toFixed(2) + '</td>' : ''}
          </tr>`;
        });
        if (!ownerPlots.length) {
          plotHtml = `<tr class="kpi-plot-row"><td colspan="${colSpan}" class="text-center text-muted ps-5" style="font-size:11px">Không có lô rừng</td></tr>`;
        }
        $row.after(plotHtml);
      });

      // Drill-down: click plot row → navigate to map
      $('#kpiDrillTable').on('click', '.kpi-plot-row[data-pid]', function(e) {
        e.stopPropagation();
        const pid = $(this).data('pid');
        if (!pid) return;
        // Close modal and navigate to map
        bootstrap.Modal.getInstance(document.getElementById('kpiDetailModal'))?.hide();
        setTimeout(() => { showOnMap(String(pid)); }, 300);
      });
    };

    // Icon mapping for sub-menu items based on keywords
    const SUB_MENU_ICONS = {
      'nhóm ccr': 'fa-people-group', 'chủ rừng': 'fa-user-tie', 'lô rừng': 'fa-map',
      'quản lý nhóm': 'fa-users-gear', 'ban quản lý': 'fa-building-columns',
      'kế hoạch': 'fa-calendar-check', 'hoạt động': 'fa-list-check', 'tập huấn': 'fa-chalkboard-teacher',
      'biến động': 'fa-arrows-rotate', 'đánh giá': 'fa-clipboard-check', 'nội bộ': 'fa-magnifying-glass', 'giám sát': 'fa-binoculars', 'thực hiện': 'fa-play-circle', 'trồng rừng': 'fa-seedling', 'khai thác': 'fa-tree', 'môi trường': 'fa-leaf', 'tham vấn': 'fa-comments', 'bên liên quan': 'fa-handshake', 'sổ tay': 'fa-book',
      'bản đồ': 'fa-map-location-dot', 'bán': 'fa-receipt', 'mua': 'fa-truck',
      'sản phẩm': 'fa-boxes-stacked', 'tài liệu': 'fa-file-lines', 'hệ thống': 'fa-gears',
      'menu': 'fa-bars', 'người dùng': 'fa-user-shield', 'profile': 'fa-id-card',
      'báo cáo': 'fa-chart-column', 'thống kê': 'fa-chart-bar', 'cài đặt': 'fa-sliders',
      'loại': 'fa-tags', 'danh sách': 'fa-clipboard-list'
    };

    function getSubMenuIcon(moduleName) {
      const lower = (moduleName || '').toLowerCase();
      for (const [key, icon] of Object.entries(SUB_MENU_ICONS)) {
        if (lower.includes(key)) return icon;
      }
      return 'fa-circle-dot';
    }

    function openMenuGroup(groupName) {
      if (!APP_DATA['Menu']) return;
      const GROUP_DISPLAY = { 'BAO_CAO_FSC': 'Báo cáo' };
      const toSentence = s => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
      const clean = (n) => { if (!n) return 'Khác'; let c = n.replace(/^\d+\.\s*/, '').trim(); return GROUP_DISPLAY[c] || toSentence(c); };

      const items = APP_DATA['Menu'].filter(m => clean(m['Nhom']) === groupName);
      if (!items.length) return;

      // Find the parent menu color and icon
      const mainMenus = [
        { label: 'Quản lý nhóm', color: '#1B5E20', icon: 'fa-users-between-lines' },
        { label: 'Quản lý rừng bền vững', color: '#2E7D32', icon: 'fa-tree' },
        { label: 'Giám sát', color: '#0277BD', icon: 'fa-binoculars' },
        { label: 'Mua bán sản phẩm', color: '#388E3C', icon: 'fa-cart-shopping' },
        { label: 'Tài liệu tham khảo', color: '#43A047', icon: 'fa-book-open' },
        { label: 'Hệ thống', color: '#4CAF50', icon: 'fa-gears' },
        { label: 'Báo cáo', color: '#66BB6A', icon: 'fa-chart-pie' }
      ];
      const parent = mainMenus.find(m => m.label === groupName) || { color: '#2E7D32', icon: 'fa-folder' };

      // Sub-group definitions: items to separate into sub-sections
      const SUB_GROUPS = {
        'Quản lý rừng bền vững': [
          { views: ['DS_BenLienQuan', 'ThucHien_ThamVan', 'BaoCao_ThamVan'], labelKey: 'grp_consultation', icon: 'fa-comments' }
        ]
      };

      const buildCard = (v, m, color) => {
        const subIcon = getSubMenuIcon(m);
        const safeV = v.replace(/'/g, "\\'");
        const safeM = m.replace(/'/g, "\\'");
        const safeG = groupName.replace(/'/g, "\\'");
        return `<div class="col">
          <div class="submenu-card" onclick="loadViewFromGroup('${safeV}','${safeM}','${safeG}')" style="border-top: 3px solid ${color}">
            <div class="submenu-icon" style="background: ${color}"><i class="fa-solid ${subIcon}"></i></div>
            <div class="submenu-label">${tm(m)}</div>
          </div>
        </div>`;
      };

      // Separate items into main and sub-groups
      const subGroupDef = SUB_GROUPS[groupName] || [];
      const subGroupViews = new Set(subGroupDef.flatMap(sg => sg.views));
      const mainItems = items.filter(i => !subGroupViews.has(i['View']));
      const subGroupItems = subGroupDef.map(sg => ({
        ...sg,
        items: items.filter(i => sg.views.includes(i['View']))
      }));

      // Build main cards
      let cards = mainItems.map(i => buildCard(i['View'] || '', i['Module'] || '', parent.color)).join('');

      // Inject "Cài đặt hệ thống" if group is Hệ thống
      if (groupName === 'Hệ thống') {
        cards += buildCard('CaiDat_HeThong', 'Cài đặt hệ thống', parent.color);
      }

      // Build sub-group sections
      let subGroupHtml = '';
      subGroupItems.forEach(sg => {
        if (sg.items.length === 0) return;
        const sgCards = sg.items.map(i => buildCard(i['View'] || '', i['Module'] || '', parent.color)).join('');
        subGroupHtml += `
          <h6 class="fw-bold mt-4 mb-2" style="color:${parent.color}"><i class="fa-solid ${sg.icon} me-2"></i>${t(sg.labelKey)}</h6>
          <div class="row row-cols-2 row-cols-md-4 g-3">${sgCards}</div>`;
      });

      // Translate group heading
      const GRP_I18N = {
        'Quản lý nhóm':'grp_group_mgmt','Quản lý rừng bền vững':'grp_forest_mgmt',
        'Giám sát':'grp_monitoring',
        'Mua bán sản phẩm':'grp_trade','Tài liệu tham khảo':'grp_docs',
        'Hệ thống':'grp_system','Báo cáo':'grp_report'
      };
      const groupLabel = GRP_I18N[groupName] ? t(GRP_I18N[groupName]) : groupName;

      const html = `
        <div style="padding: 10px">
          <div class="d-flex align-items-center mb-3">
            <button class="btn btn-outline-success btn-sm me-2" onclick="goHome()"><i class="fa-solid fa-arrow-left me-1"></i>${t('btn_back')}</button>
            <h5 class="fw-bold mb-0" style="color:${parent.color}"><i class="fa-solid ${parent.icon} me-2"></i>${groupLabel}</h5>
          </div>
          <div class="row row-cols-2 row-cols-md-4 g-3">${cards}</div>
          ${subGroupHtml}
        </div>`;

      $('#dashboard-view').html(html);
    }

    function getVisibleColumns(sheetName) {
      const saved = localStorage.getItem(`vcols_${sheetName}`);
      if (saved) return JSON.parse(saved);
      // Mặc định trả về 'main' nếu có, không thì tất cả
      return TABLE_CONFIG[sheetName] && TABLE_CONFIG[sheetName].main ? TABLE_CONFIG[sheetName].main : TABLE_CONFIG[sheetName].columns;
    }

    function toggleColumnVisibility(sheetName, colName) {
      let vcols = getVisibleColumns(sheetName);
      if (vcols.includes(colName)) {
        vcols = vcols.filter(c => c !== colName);
      } else {
        vcols.push(colName);
      }
      localStorage.setItem(`vcols_${sheetName}`, JSON.stringify(vcols));
      renderContent(); // Vẽ lại để cập nhật bảng
    }

    function hasPermission(moduleName, action) {
      if (!APP_DATA['Menu']) return true;
      const menu = APP_DATA['Menu'].find(m => m['Module'] === moduleName || m['View'] === moduleName);
      console.log(`Checking permission for ${moduleName}/${action}:`, menu ? menu[action] : 'Menu not found');
      if (!menu) return true;
      // action = 'Xem' | 'Thêm' | 'Sửa' | 'Xóa'
      const p = String(menu[action]).toLowerCase();
      return p === '1' || p === 'x' || p === 'yes' || p === 'được';
    }

    function renderSystemMenu(menuData) {
      console.log("Rendering System Menu...", menuData);
      try {
        if (!menuData) return;
        const grouped = {};
        const userRole = currentUser && currentUser['Chức vụ'] ? String(currentUser['Chức vụ']).toLowerCase().trim() : '';
        const GROUP_DISPLAY = { 'BAO_CAO_FSC': 'Báo cáo' };
        const toSentence = s => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
        const clean = (n) => {
          if (!n) return 'Khác';
          let c = n.replace(/^\d+\.\s*/, '').trim();
          return GROUP_DISPLAY[c] || toSentence(c);
        };

        menuData.forEach(item => {
          const rawRole = item['PhanQuyen'] ? String(item['PhanQuyen']).toLowerCase() : '';
          const roles = rawRole.split(',').map(r => r.trim()).filter(r => r !== '');
          if (roles.length === 0 || roles.includes(userRole)) {
            let g = clean(item['Nhom']);
            if (!grouped[g]) grouped[g] = [];
            grouped[g].push(item);
          }
        });

        // Group icons for accordion headers
        const GROUP_ICONS = {
          'Quản lý nhóm': 'fa-users-between-lines', 'Quản lý rừng bền vững': 'fa-tree',
          'Giám sát': 'fa-binoculars',
          'Mua bán sản phẩm': 'fa-cart-shopping', 'Tài liệu tham khảo': 'fa-book-open',
          'Hệ thống': 'fa-gears', 'Báo cáo': 'fa-chart-pie', 'Khác': 'fa-folder'
        };
        // Map Vietnamese group names to i18n keys
        const GROUP_I18N = {
          'Quản lý nhóm': 'grp_group_mgmt', 'Quản lý rừng bền vững': 'grp_forest_mgmt',
          'Giám sát': 'grp_monitoring',
          'Mua bán sản phẩm': 'grp_trade', 'Tài liệu tham khảo': 'grp_docs',
          'Hệ thống': 'grp_system', 'Báo cáo': 'grp_report', 'Khác': 'grp_other'
        };

        let accordionHtml = ''; let idx = 0;
        for (const [group, items] of Object.entries(grouped)) {
          idx++; const cId = `collapseSidebar${idx}`;
          const groupIcon = GROUP_ICONS[group] || 'fa-folder';
          const groupLabel = GROUP_I18N[group] ? t(GROUP_I18N[group]) : group;
          const safeGroup = group.replace(/'/g, "\\'");
          let sub = items.map(i => {
            const v = (i['View'] || '').replace(/'/g, "\\'");
            const m = (i['Module'] || '').replace(/'/g, "\\'");
            const mIcon = getSubMenuIcon(m);
            return `<a href="#" class="menu-sub-link" onclick="loadViewFromGroup('${v}', '${m}', '${safeGroup}')"><i class="fa-solid ${mIcon} me-2" style="width:16px;text-align:center"></i>${tm(i['Module'])}</a>`;
          }).join('');
          accordionHtml += `<div class="accordion-item" data-group-vi="${group}"><h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#${cId}"><i class="fa-solid ${groupIcon} me-2"></i><span class="fw-bold">${groupLabel}</span></button></h2><div id="${cId}" class="accordion-collapse collapse show"><div class="accordion-body p-0">${sub}</div></div></div>`;
        }
        $('#sidebarAccordion').html(accordionHtml);

        // Inject "Cài đặt hệ thống" vào group Hệ thống
        $('#sidebarAccordion .accordion-item').each(function() {
          const grpVi = $(this).attr('data-group-vi');
          if (grpVi && grpVi.trim().toLowerCase() === 'hệ thống') {
            $(this).find('.accordion-body').append(`<a href="#" class="menu-sub-link" onclick="loadViewFromGroup('CaiDat_HeThong', '${t('menu_settings')}', 'Hệ thống')"><i class="fa-solid fa-sliders me-2"></i>${t('menu_settings')}</a>`);
          }
        });

        console.log("Menu rendering complete.");
      } catch (err) {
        console.error("Error in renderSystemMenu:", err);
      }
    }

    function highlightActiveMenu(viewName, title) {
      // Remove all active states
      $('.menu-sub-link.active').removeClass('active');
      // Find matching menu link by viewName in onclick, or by title text
      $('#sidebarAccordion .menu-sub-link').each(function() {
        const onclick = $(this).attr('onclick') || '';
        const text = $(this).text().trim();
        if (onclick.includes("'" + viewName + "'") || text === title) {
          $(this).addClass('active');
          // Expand the parent accordion if collapsed
          const collapse = $(this).closest('.accordion-collapse');
          if (collapse.length && !collapse.hasClass('show')) {
            collapse.addClass('show');
            collapse.closest('.accordion-item').find('.accordion-button').removeClass('collapsed');
          }
        }
      });
    }

    let _parentMenuGroup = null; // Track which group sub-menu we came from

    // Load view from a group sub-menu card (stores parent for back navigation)
    window.loadViewFromGroup = function(viewName, title, groupName) {
      _parentMenuGroup = groupName;
      loadView(viewName, title);
    };

    function loadView(viewName, title) {
      if ($(window).width() < 768) {
        $('#sidebar-wrapper').removeClass('show-sidebar');
        $('#sidebar-overlay').removeClass('active');
      }
      // Unlock scroll when leaving dashboard
      $('#page-content-wrapper').css('overflow', 'auto');
      $('#dashboard-view').addClass('d-none');
      $('#data-view').removeClass('d-none');
      navHistory = [{ mode: 'LIST', viewName, title, filter: null }];
      renderBreadcrumb();
      renderContent();
      highlightActiveMenu(viewName, title);
    }

    function renderContent() {
      const current = navHistory[navHistory.length - 1];

      // Reset map view visibility
      $('#map-view').addClass('d-none');
      $('#page-content-dynamic').removeClass('d-none');

      // Update Sidebar Context (PC Only)
      updateSidebarContext();

      // Xử lý View đặc biệt: Audit (DG_noibo)
      if (current.viewName === 'InternalAudit' || current.viewName === 'DG_noibo' || current.title === 'Đánh giá nội bộ') {
        renderAuditModule();
        return;
      }

      // Xử lý View đặc biệt: Giám sát lô rừng (tổng hợp tất cả loại)
      if (current.viewName === 'GiamSat_LoRung' || current.viewName === 'ThucHien_GiamSat' || current.title === 'Giám sát lô rừng') {
        _monTypeFilter = null; // show all types
        renderMonitoringModule();
        return;
      }

      // Xử lý View đặc biệt: Giám sát theo loại (sub-menu items)
      if (MONITORING_VIEW_TYPES[current.viewName]) {
        _monTypeFilter = MONITORING_VIEW_TYPES[current.viewName];
        // Lo_rung-targeting types: inline drill-down Nhóm → Hộ → Lô rừng
        const LO_RUNG_VIEWS = ['GS_TrongRung', 'GS_KhaiThac', 'GS_MoiTruong'];
        if (LO_RUNG_VIEWS.includes(current.viewName)) {
          renderMonDrillDown(current);
          return;
        }
        renderMonitoringModule();
        return;
      }

      // Xử lý View đặc biệt: Kế hoạch giám sát
      if (current.viewName === 'KH_GiamSat_Nhom') {
        renderMonitoringPlanView();
        return;
      }

      // Xử lý View đặc biệt: Thực hiện tham vấn
      if (current.viewName === 'ThucHien_ThamVan') {
        renderConsultationModule();
        return;
      }

      // Xử lý View đặc biệt: Báo cáo tham vấn
      if (current.viewName === 'BaoCao_ThamVan') {
        renderConsultationReport();
        return;
      }

      // Xử lý View đặc biệt: Sổ tay QLRBV
      if (current.viewName === 'SoTay_QLRBV') {
        renderHandbookView();
        return;
      }

      // Xử lý View đặc biệt: Cài đặt hệ thống
      if (current.viewName === 'CaiDat_HeThong') {
        renderSettingsView();
        return;
      }

      // Xử lý View đặc biệt: Bản đồ
      if (current.viewName === 'Bando_lorung') {
        renderMapView();
        return;
      }

      const sheetName = VIEW_MAP[current.viewName] || current.viewName;
      const data = APP_DATA[sheetName] || [];
      $('#page-content-dynamic').empty();
      if (current.mode === 'DETAIL') renderDetailMaster(sheetName, current.rowData);
      else renderTable(data, current, sheetName);
    }

    function toggleSidebar() {
      if ($(window).width() >= 992) {
        // PC: toggle pc-hidden class
        $('#sidebar-wrapper').toggleClass('pc-hidden');
        $('#page-content-wrapper').toggleClass('sidebar-collapsed');
      } else {
        // Mobile: overlay sidebar
        $('#sidebar-wrapper').toggleClass('show-sidebar');
        $('#sidebar-overlay').toggleClass('active');
      }
    }

    function goHome() {
      navHistory = [];
      $('#data-view').addClass('d-none');
      $('#map-view').addClass('d-none');
      $('#dashboard-view').removeClass('d-none');
      renderDashboardContent();
      // Re-render full system menu in sidebar
      if (APP_DATA['Menu']) {
        $('#sidebarAccordion').empty();
        renderSystemMenu(APP_DATA['Menu']);
      }
      // sidebar home icon (no text)
      // Close sidebar on mobile
      if ($(window).width() < 768) {
        $('#sidebar-wrapper').removeClass('show-sidebar');
        $('#sidebar-overlay').removeClass('active');
      }
    }

    // Swipe gesture for sidebar on mobile
    let touchStartX = 0;
    document.addEventListener('touchstart', function(e) {
      touchStartX = e.touches[0].clientX;
    }, { passive: true });
    document.addEventListener('touchend', function(e) {
      const diff = e.changedTouches[0].clientX - touchStartX;
      if (diff > 80 && touchStartX < 40) {
        $('#sidebar-wrapper').addClass('show-sidebar');
        $('#sidebar-overlay').addClass('active');
      } else if (diff < -80 && $('#sidebar-wrapper').hasClass('show-sidebar')) {
        $('#sidebar-wrapper').removeClass('show-sidebar');
        $('#sidebar-overlay').removeClass('active');
      }
    }, { passive: true });

    // ============================================================
    // MAP MODULE - Bản đồ quản lý lô rừng
    // ============================================================
    let mapInstance = null;
    let mapLayers = {};
    let mapDrawnItems = null;
    let mapAnnotations = [];
    let mapDrawControl = null;
    let mapEditMode = false;
    let geoJsonNamedLayers = {}; // { layerName: L.FeatureGroup }
    let mapPlotLabels = null; // L.LayerGroup for plot labels (shown at high zoom only)

    function renderMapView() {
      $('#page-content-dynamic').addClass('d-none');
      $('#map-view').removeClass('d-none');

      if (mapInstance) {
        setTimeout(() => {
          mapInstance.invalidateSize();
          zoomToAllData();
        }, 100);
        return;
      }

      mapInstance = L.map('map-container', { preferCanvas: true }).setView([21.6, 105.8], 10);

      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 19
      }).addTo(mapInstance);

      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri',
        maxZoom: 19
      });

      // Google Satellite
      const googleSatLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: '&copy; Google',
        maxZoom: 20
      });

      mapLayers['OpenStreetMap'] = osmLayer;
      mapLayers['Vệ tinh (Esri)'] = satelliteLayer;
      mapLayers['Google Satellite'] = googleSatLayer;

      mapDrawnItems = new L.FeatureGroup().addTo(mapInstance);
      mapLayers['Lô rừng (GeoJSON)'] = mapDrawnItems;

      // Draw control - initially not added (edit mode off)
      mapDrawControl = new L.Control.Draw({
        edit: { featureGroup: mapDrawnItems },
        draw: {
          polygon: { allowIntersection: false, shapeOptions: { color: '#2E7D32', weight: 2 } },
          polyline: false, rectangle: false, circle: false, circlemarker: false,
          marker: { icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [25, 41], iconAnchor: [12, 41] }) }
        }
      });

      mapInstance.on(L.Draw.Event.CREATED, function(e) {
        mapDrawnItems.addLayer(e.layer);
        if (e.layerType === 'polygon') {
          promptLinkPolygonToLoRung(e.layer);
        }
      });

      mapInstance.on(L.Draw.Event.EDITED, function(e) {
        e.layers.eachLayer(function(layer) {
          if (layer.loRungId) savePolygonGeometry(layer);
        });
      });

      mapPlotLabels = L.layerGroup(); // Labels shown only at zoom >= 18 and within viewport
      mapLayers['Nhãn lô rừng'] = mapPlotLabels;

      // Auto-update labels on zoom/pan (debounced, viewport-only, zoom >= 18 ~ 1:1000)
      let _labelTimer = null;
      mapInstance.on('moveend zoomend', function() {
        clearTimeout(_labelTimer);
        _labelTimer = setTimeout(updateViewportLabels, 200);
      });

      loadStoredGeoJSON().then(() => {
        setTimeout(() => { zoomToAllData(); updateZoomLayerMenu(); renderMapLayerPanel(); }, 300);
      });
      renderMapLayerPanel();
    }

    let _labelsEnabled = false; // Labels off by default for speed
    const LABEL_ZOOM_MIN = 18; // ~1:1000 scale

    // Toggle labels on/off
    window.togglePlotLabels = function() {
      _labelsEnabled = !_labelsEnabled;
      const btn = document.getElementById('btn-toggle-labels');
      if (_labelsEnabled) {
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success', 'text-white');
        updateViewportLabels();
      } else {
        btn.classList.remove('btn-success', 'text-white');
        btn.classList.add('btn-outline-success');
        if (mapPlotLabels) { mapPlotLabels.clearLayers(); mapInstance.removeLayer(mapPlotLabels); }
      }
    };

    // Build labels only for polygons visible in current viewport at high zoom
    function updateViewportLabels() {
      if (!mapPlotLabels || !mapInstance || !_labelsEnabled) return;
      mapPlotLabels.clearLayers();
      const z = mapInstance.getZoom();
      if (z < LABEL_ZOOM_MIN) {
        if (mapInstance.hasLayer(mapPlotLabels)) mapInstance.removeLayer(mapPlotLabels);
        return;
      }
      if (!mapInstance.hasLayer(mapPlotLabels)) mapInstance.addLayer(mapPlotLabels);

      const bounds = mapInstance.getBounds();
      const loRungData = APP_DATA['Lo_rung'] || [];
      const churungData = APP_DATA['Churung'] || [];
      const ownerMap = {};
      churungData.forEach(cr => { ownerMap[cr['ID chủ rừng']] = cr['Họ tên chủ rừng'] || ''; });

      mapDrawnItems.eachLayer(function(layer) {
        if (!layer.getBounds && !layer.getLatLng) return;
        const center = layer.getBounds ? layer.getBounds().getCenter() : layer.getLatLng();
        // Skip polygons outside current viewport
        if (!bounds.contains(center)) return;

        let plotCode = '', ownerName = '', area = '';
        if (layer.loRungId) {
          const lr = loRungData.find(r => String(r['ID lô rừng']) === String(layer.loRungId));
          if (lr) {
            plotCode = lr['Mã số lô rừng'] || '';
            ownerName = ownerMap[lr['ID chủ rừng']] || '';
            area = lr['Tổng diện tích'] || '';
          }
        }
        if (!plotCode && layer.feature && layer.feature.properties) {
          const p = layer.feature.properties;
          plotCode = p['Mã số lô rừng'] || p['ma_so_lo'] || '';
          ownerName = p['Tên chủ rừng'] || p['ten_chu_rung'] || '';
          area = p['Diện tích'] || p['dien_tich'] || '';
        }
        if (!plotCode && !ownerName) return;

        const labelText = [plotCode, ownerName, area ? area + ' ha' : ''].filter(Boolean).join('\n');
        mapPlotLabels.addLayer(L.tooltip({
          permanent: true, direction: 'center', className: 'plot-label', offset: [0, 0]
        }).setContent(labelText.replace(/\n/g, '<br>')).setLatLng(center));
      });
    }

    function togglePolygonEdit() {
      mapEditMode = !mapEditMode;
      const btn = document.getElementById('btn-edit-polygon');
      if (mapEditMode) {
        mapInstance.addControl(mapDrawControl);
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success', 'text-white');
        btn.innerHTML = `<i class="fa-solid fa-pen-to-square me-1"></i> ${t('btn_edit_polygon')} ✓`;
      } else {
        mapInstance.removeControl(mapDrawControl);
        btn.classList.remove('btn-success', 'text-white');
        btn.classList.add('btn-outline-success');
        btn.innerHTML = `<i class="fa-solid fa-pen-to-square me-1"></i> ${t('btn_edit_polygon')}`;
      }
    }

    function zoomToAllData() {
      if (!mapInstance) return;
      if (mapDrawnItems && mapDrawnItems.getLayers().length > 0) {
        mapInstance.fitBounds(mapDrawnItems.getBounds().pad(0.1));
      }
    }

    // loadLoRungMarkers removed — only polygons with data linkage are shown

    function handleGeoJSONUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Prompt for layer name
      const defaultName = file.name.replace(/\.(geojson|json)$/i, '');
      const layerName = prompt('Đặt tên cho lớp bản đồ:', defaultName);
      if (!layerName) { event.target.value = ''; return; }

      const reader = new FileReader();
      reader.onload = async function(ev) {
        try {
          const rawText = ev.target.result;
          const geojson = JSON.parse(rawText);

          // Inline add GeoJSON to map (avoid scope issues)
          const loRungData = APP_DATA['Lo_rung'] || [];
          let linkedCount = 0;
          const layerGroup = new L.FeatureGroup();

          L.geoJSON(geojson, {
            style: { color: '#FFFF00', weight: 2.5, fillColor: '#2E7D32', fillOpacity: 0.15 },
            onEachFeature: function(feature, layer) {
              let linkedId = null;
              if (feature.properties) {
                for (const [k, v] of Object.entries(feature.properties)) {
                  if (!v) continue;
                  const vStr = String(v).trim();
                  const match = loRungData.find(lr =>
                    String(lr['ID lô rừng']).trim() === vStr ||
                    String(lr['Mã số lô rừng']).trim() === vStr ||
                    String(lr['Mã số lô 2023']).trim() === vStr ||
                    String(lr['Tên lô rừng']).trim() === vStr
                  );
                  if (match) { linkedId = match['ID lô rừng']; break; }
                }
                let popup = `<div class="small"><strong class="text-success">${layerName}</strong><hr class="my-1">`;
                for (const [k, v] of Object.entries(feature.properties)) popup += `<strong>${k}:</strong> ${v}<br>`;
                if (linkedId) {
                  const lr = loRungData.find(r => String(r['ID lô rừng']) === String(linkedId));
                  popup += `<span class="badge bg-success mt-1">Liên kết: ${lr ? (lr['Mã số lô rừng'] || linkedId) : linkedId}</span>`;
                  popup += `<br><button class="btn btn-sm btn-outline-success mt-1" onclick="viewLoRungFromMap('${linkedId}')">Xem chi tiết</button>`;
                }
                popup += '</div>';
                layer.bindPopup(popup);
              }
              if (linkedId) {
                layer.loRungId = linkedId;
                layer.setStyle({ color: '#2E7D32', weight: 2, fillColor: '#4CAF50', fillOpacity: 0.2 });
                linkedCount++;
              }
              layerGroup.addLayer(layer);
              mapDrawnItems.addLayer(layer);
            }
          });

          geoJsonNamedLayers[layerName] = layerGroup;
          mapLayers[layerName] = layerGroup;

          // Save linked polygons to lo_rung_geojson
          const layersToSave = [];
          mapDrawnItems.eachLayer(function(l) {
            if (l.loRungId && l.toGeoJSON) layersToSave.push(l);
          });
          for (const l of layersToSave) {
            await savePolygonGeometry(l);
          }

          // Save full GeoJSON to geojson_kho
          const existingVersions = await sb.from('geojson_kho').select('version').eq('ten_lop', layerName).order('version', { ascending: false }).limit(1);
          const nextVersion = (existingVersions.data && existingVersions.data.length > 0) ? existingVersions.data[0].version + 1 : 1;
          const { error: saveErr } = await sb.from('geojson_kho').insert({
            ten_lop: layerName,
            geojson_data: geojson,
            ghi_chu: 'Tải lên từ file: ' + file.name,
            version: nextVersion
          });
          if (saveErr) console.error('Save to geojson_kho error:', saveErr);
          else console.log('GeoJSON saved to kho: "' + layerName + '" v' + nextVersion);

          // Zoom to uploaded data
          if (layerGroup.getLayers().length > 0) {
            mapInstance.fitBounds(layerGroup.getBounds().pad(0.05));
          }
          updateZoomLayerMenu();
          renderMapLayerPanel();
          updateViewportLabels();

          var msg = 'Tải GeoJSON thành công: "' + layerName + '" (v' + nextVersion + ')';
          if (linkedCount > 0) msg += '\nTự động liên kết ' + linkedCount + ' polygon với lô rừng.';
          alert(msg);
        } catch (err) {
          alert('Lỗi đọc file GeoJSON: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function promptLinkPolygonToLoRung(layer) {
      const loRungData = APP_DATA['Lo_rung'] || [];
      let options = loRungData.map(lr =>
        `<option value="${lr['ID lô rừng']}">${lr['Mã số lô rừng'] || lr['Tên lô rừng'] || lr['ID lô rừng']}</option>`
      ).join('');

      const popup = L.popup()
        .setLatLng(layer.getBounds().getCenter())
        .setContent(`
          <div style="min-width:220px">
            <label class="fw-bold small mb-1">Liên kết với lô rừng:</label>
            <select class="form-select form-select-sm mb-2" id="map-link-select">
              <option value="">-- Chọn lô rừng --</option>
              ${options}
            </select>
            <button class="btn btn-success btn-sm w-100" onclick="linkPolygonConfirm()">
              <i class="fa-solid fa-link me-1"></i>Liên kết & Lưu
            </button>
          </div>
        `)
        .openOn(mapInstance);
      popup._linkedLayer = layer;
    }

    window.linkPolygonConfirm = async function() {
      const select = document.getElementById('map-link-select');
      const loRungId = select ? select.value : '';
      if (!loRungId) return;
      const popup = mapInstance._popup;
      if (popup && popup._linkedLayer) {
        popup._linkedLayer.loRungId = loRungId;
        await savePolygonGeometry(popup._linkedLayer);
        // Update popup to show linked info
        const lr = (APP_DATA['Lo_rung'] || []).find(r => String(r['ID lô rừng']) === String(loRungId));
        if (lr) {
          popup._linkedLayer.bindPopup(`
            <strong>${lr['Mã số lô rừng'] || lr['Tên lô rừng']}</strong><br>
            <span class="badge bg-success">Đã liên kết</span><br>
            <button class="btn btn-sm btn-outline-success mt-1" onclick="viewLoRungFromMap('${loRungId}')">Xem chi tiết</button>
            <button class="btn btn-sm btn-outline-danger mt-1" onclick="unlinkPolygon('${loRungId}')">Hủy liên kết</button>
          `);
        }
      }
      mapInstance.closePopup();
      alert('Đã liên kết và lưu thành công!');
    };

    window.unlinkPolygon = async function(loRungId) {
      if (!confirm('Xác nhận hủy liên kết polygon này với lô rừng?')) return;
      try {
        const { error } = await sb.from('lo_rung_geojson').delete().eq('id_lo_rung', loRungId);
        if (error) { alert('Lỗi: ' + error.message); return; }
        // Remove layer from map
        mapDrawnItems.eachLayer(l => {
          if (l.loRungId === loRungId) {
            mapDrawnItems.removeLayer(l);
          }
        });
        mapInstance.closePopup();
        alert('Đã hủy liên kết thành công.');
      } catch (e) {
        alert('Lỗi: ' + e.message);
      }
    };

    async function savePolygonGeometry(layer) {
      const geojson = layer.toGeoJSON();
      const loRungId = layer.loRungId;
      if (!loRungId) return;
      try {
        const { error } = await sb.from('lo_rung_geojson')
          .upsert({ id_lo_rung: loRungId, geojson: geojson, updated_at: new Date().toISOString() }, { onConflict: 'id_lo_rung' });
        if (error) console.error('Save GeoJSON error:', error);
        else console.log('GeoJSON saved for', loRungId);
      } catch (e) {
        console.error('Save polygon error:', e);
      }
    }

    // Add GeoJSON data to map with a named layer group
    function addGeoJSONToMap(geojson, layerName) {
      const loRungData = APP_DATA['Lo_rung'] || [];
      let linkedCount = 0;
      const layerGroup = new L.FeatureGroup();

      L.geoJSON(geojson, {
        style: { color: '#FFFF00', weight: 2.5, fillColor: '#2E7D32', fillOpacity: 0.15 },
        onEachFeature: function(feature, layer) {
          let linkedId = null;
          if (feature.properties) {
            for (const [k, v] of Object.entries(feature.properties)) {
              if (!v) continue;
              const vStr = String(v).trim();
              const match = loRungData.find(lr =>
                String(lr['ID lô rừng']).trim() === vStr ||
                String(lr['Mã số lô rừng']).trim() === vStr ||
                String(lr['Mã số lô 2023']).trim() === vStr ||
                String(lr['Tên lô rừng']).trim() === vStr
              );
              if (match) { linkedId = match['ID lô rừng']; break; }
            }
            let popup = `<div class="small"><strong class="text-success">${layerName}</strong><hr class="my-1">`;
            for (const [k, v] of Object.entries(feature.properties)) popup += `<strong>${k}:</strong> ${v}<br>`;
            if (linkedId) {
              const lr = loRungData.find(r => String(r['ID lô rừng']) === String(linkedId));
              popup += `<span class="badge bg-success mt-1">Liên kết: ${lr ? (lr['Mã số lô rừng'] || linkedId) : linkedId}</span>`;
              popup += `<br><button class="btn btn-sm btn-outline-success mt-1" onclick="viewLoRungFromMap('${linkedId}')">Xem chi tiết</button>`;
              popup += `<button class="btn btn-sm btn-outline-danger mt-1 ms-1" onclick="unlinkPolygon('${linkedId}')">Hủy liên kết</button>`;
            }
            popup += '</div>';
            layer.bindPopup(popup);
          }
          if (linkedId) {
            layer.loRungId = linkedId;
            layer.setStyle({ color: '#2E7D32', weight: 2, fillColor: '#4CAF50', fillOpacity: 0.2 });
            linkedCount++;
          }
          layerGroup.addLayer(layer);
          mapDrawnItems.addLayer(layer);
        }
      });

      geoJsonNamedLayers[layerName] = layerGroup;
      mapLayers[layerName] = layerGroup;
      return { linkedCount, layerGroup };
    }

    // Load all GeoJSON layers from geojson_kho (Supabase)
    async function loadGeoJSONFromKho() {
      try {
        // Get latest version of each layer name
        const { data, error } = await sb.from('geojson_kho')
          .select('*')
          .order('ten_lop', { ascending: true })
          .order('version', { ascending: false });
        if (error || !data || data.length === 0) return;

        // Group by name, take latest version only
        const latest = {};
        data.forEach(row => {
          if (!latest[row.ten_lop]) latest[row.ten_lop] = row;
        });

        for (const row of Object.values(latest)) {
          if (row.geojson_data) {
            addGeoJSONToMap(row.geojson_data, row.ten_lop);
            console.log(`Loaded from kho: "${row.ten_lop}" v${row.version}`);
          }
        }
        updateZoomLayerMenu();
      } catch (e) {
        console.error('Load GeoJSON from kho error:', e);
      }
    }

    // Load all polygons from lo_rung_geojson (paginated)
    async function loadStoredGeoJSON() {
      try {
        const { data, error } = await fetchAll('lo_rung_geojson');
        if (error || !data) { console.error('Load lo_rung_geojson error:', error); return; }
        console.log(`Loading ${data.length} polygons from lo_rung_geojson...`);
        const loRungData = APP_DATA['Lo_rung'] || [];
        const churungData = APP_DATA['Churung'] || [];

        // Build lookup maps for fast matching
        const ownerMap = {};
        churungData.forEach(cr => { ownerMap[cr['ID chủ rừng']] = cr['Họ tên chủ rừng'] || ''; });
        const loRungById = {};
        const loRungByPlotCode = {};
        loRungData.forEach(lr => {
          loRungById[String(lr['ID lô rừng'])] = lr;
          const code = lr['Mã số lô rừng'];
          if (code) loRungByPlotCode[String(code).trim()] = lr;
        });

        // Batch all features into a single FeatureCollection for performance
        const features = [];
        const featureMeta = [];
        data.forEach(row => {
          if (!row.geojson) return;
          const geo = row.geojson;
          // Link by id_lo_rung first, then by plot code from GeoJSON properties
          let lr = loRungById[String(row.id_lo_rung)];
          if (!lr && geo.properties) {
            const plotCode = geo.properties['Mã số lô rừng'];
            if (plotCode) lr = loRungByPlotCode[String(plotCode).trim()];
          }
          // Store feature with metadata
          if (geo.type === 'Feature') {
            geo.properties = geo.properties || {};
            geo.properties._loRungId = row.id_lo_rung;
            geo.properties._linked = !!lr;
            if (lr) {
              geo.properties._plotName = lr['Mã số lô rừng'] || lr['Tên lô rừng'] || row.id_lo_rung;
              geo.properties._ownerName = ownerMap[lr['ID chủ rừng']] || '';
              geo.properties._area = lr['Tổng diện tích'] || '?';
              geo.properties._diaDanh = lr['Địa danh'] || '';
            } else {
              geo.properties._plotName = row.id_lo_rung;
              geo.properties._ownerName = '';
              geo.properties._area = '?';
              geo.properties._diaDanh = '';
            }
            features.push(geo);
          }
        });

        // Create single GeoJSON layer from all features
        const fc = { type: 'FeatureCollection', features };
        const geoLayer = L.geoJSON(fc, {
          style: { color: '#FFFF00', weight: 1.5, fillColor: '#2E7D32', fillOpacity: 0.12 },
          onEachFeature: function(feature, layer) {
            const p = feature.properties;
            layer.loRungId = p._loRungId;
            layer.bindPopup(`<div class="small">
              <strong>${p._plotName}</strong><br>
              ${p._ownerName ? 'Chủ rừng: ' + p._ownerName + '<br>' : ''}
              ${p._diaDanh ? 'Địa danh: ' + p._diaDanh + '<br>' : ''}
              Diện tích: ${p._area} ha<br>
              <button class="btn btn-sm btn-outline-success mt-1" onclick="viewLoRungFromMap('${p._loRungId}')">Xem chi tiết</button>
            </div>`);
            mapDrawnItems.addLayer(layer);
          }
        });
        console.log(`Loaded ${features.length} polygons as single FeatureCollection.`);
      } catch (e) {
        console.error('Load stored GeoJSON error:', e);
      }
    }

    // Update zoom dropdown menu with available layers
    window.updateZoomLayerMenu = updateZoomLayerMenu;
    function updateZoomLayerMenu() {
      const menu = document.getElementById('zoom-layer-menu');
      if (!menu) return;
      let html = '<li><a class="dropdown-item small" href="#" onclick="zoomToAllData();return false"><i class="fa-solid fa-globe me-2"></i>Tất cả lớp</a></li>';
      if (mapDrawnItems && mapDrawnItems.getLayers().length > 0) {
        html += '<li><a class="dropdown-item small" href="#" onclick="mapInstance.fitBounds(mapDrawnItems.getBounds().pad(0.05));return false"><i class="fa-solid fa-map me-2"></i>Lô rừng (GeoJSON)</a></li>';
      }
      for (const name of Object.keys(geoJsonNamedLayers)) {
        html += `<li><a class="dropdown-item small" href="#" onclick="zoomToLayer('${name.replace(/'/g,"\\'")}');return false"><i class="fa-solid fa-map me-2"></i>${name}</a></li>`;
      }
      menu.innerHTML = html;
    }

    // Zoom to a specific named layer
    window.zoomToLayer = zoomToLayer;
    function zoomToLayer(name) {
      const layer = mapLayers[name] || geoJsonNamedLayers[name];
      if (layer && layer.getLayers && layer.getLayers().length > 0) {
        mapInstance.fitBounds(layer.getBounds().pad(0.05));
      } else {
        alert('Lớp "' + name + '" không có dữ liệu.');
      }
    }

    // GeoJSON Repository Panel
    window.openGeoJSONRepo = openGeoJSONRepo;
    async function openGeoJSONRepo() {
      const { data, error } = await sb.from('geojson_kho')
        .select('id, ten_lop, ghi_chu, version, created_at')
        .order('created_at', { ascending: false });

      if (error) { alert('Lỗi tải kho bản đồ: ' + error.message); return; }

      let html = `<div class="card shadow border-0" style="position:absolute;top:10px;right:10px;z-index:1100;width:380px;max-height:80vh;overflow-y:auto">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center py-2">
          <strong class="small"><i class="fa-solid fa-database me-1" style="color:#7B1FA2"></i>Kho bản đồ GeoJSON</strong>
          <button type="button" class="btn-close btn-close-sm" onclick="closeGeoJSONRepo()"></button>
        </div>
        <div class="card-body p-2">`;

      if (!data || data.length === 0) {
        html += '<div class="text-center text-muted py-3 small">Chưa có bản đồ nào được lưu.</div>';
      } else {
        data.forEach(row => {
          const date = new Date(row.created_at).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
          html += `
            <div class="border rounded p-2 mb-2 bg-light d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="fw-bold small text-dark">${row.ten_lop} <span class="badge bg-secondary">v${row.version}</span></div>
                <div class="text-muted" style="font-size:10px"><i class="fa-solid fa-clock me-1"></i>${date}</div>
                ${row.ghi_chu ? `<div class="text-muted" style="font-size:10px">${row.ghi_chu}</div>` : ''}
              </div>
              <div class="d-flex gap-1 flex-shrink-0 ms-2">
                <button class="btn btn-outline-success btn-sm" style="font-size:10px;padding:2px 6px" onclick="loadKhoLayer(${row.id})" title="Hiển thị"><i class="fa-solid fa-eye"></i></button>
                <button class="btn btn-outline-primary btn-sm" style="font-size:10px;padding:2px 6px" onclick="zoomKhoLayer('${row.ten_lop.replace(/'/g,"\\'")}')" title="Zoom"><i class="fa-solid fa-expand"></i></button>
                <button class="btn btn-outline-danger btn-sm" style="font-size:10px;padding:2px 6px" onclick="deleteKhoLayer(${row.id}, '${row.ten_lop.replace(/'/g,"\\'")}')" title="Xóa"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>`;
        });
      }
      html += '</div></div>';

      // Remove existing panel if any
      closeGeoJSONRepo();
      const panel = document.createElement('div');
      panel.id = 'geojson-repo-panel';
      document.getElementById('map-view').appendChild(panel);
      panel.innerHTML = html;
    }

    function closeGeoJSONRepo() {
      const el = document.getElementById('geojson-repo-panel');
      if (el) el.remove();
    }

    window.loadKhoLayer = async function(id) {
      const { data, error } = await sb.from('geojson_kho').select('*').eq('id', id).single();
      if (error || !data) { alert('Lỗi tải dữ liệu'); return; }
      // Remove old layer if exists
      if (geoJsonNamedLayers[data.ten_lop]) {
        geoJsonNamedLayers[data.ten_lop].eachLayer(l => mapDrawnItems.removeLayer(l));
        delete geoJsonNamedLayers[data.ten_lop];
        delete mapLayers[data.ten_lop];
      }
      addGeoJSONToMap(data.geojson_data, data.ten_lop);
      updateZoomLayerMenu();
      renderMapLayerPanel();
      mapInstance.fitBounds(geoJsonNamedLayers[data.ten_lop].getBounds().pad(0.05));
      closeGeoJSONRepo();
    };

    window.zoomKhoLayer = function(name) {
      if (geoJsonNamedLayers[name]) {
        mapInstance.fitBounds(geoJsonNamedLayers[name].getBounds().pad(0.05));
      } else {
        alert('Lớp "' + name + '" chưa được hiển thị trên bản đồ.');
      }
    };

    window.deleteKhoLayer = async function(id, name) {
      if (!confirm(`Xác nhận xóa bản đồ "${name}" khỏi kho?`)) return;
      const { error } = await sb.from('geojson_kho').delete().eq('id', id);
      if (error) { alert('Lỗi: ' + error.message); return; }
      // Remove from map if displayed
      if (geoJsonNamedLayers[name]) {
        geoJsonNamedLayers[name].eachLayer(l => mapDrawnItems.removeLayer(l));
        delete geoJsonNamedLayers[name];
        delete mapLayers[name];
        updateZoomLayerMenu();
        renderMapLayerPanel();
      }
      openGeoJSONRepo(); // Refresh panel
    };

    function toggleMapLayers() {
      const panel = $('#map-layer-panel');
      panel.toggleClass('d-none');
      if (!panel.hasClass('d-none')) {
        setTimeout(() => {
          $(document).one('click', function closeLayerPanel(e) {
            if (!$(e.target).closest('#map-layer-panel, [onclick*="toggleMapLayers"]').length) {
              panel.addClass('d-none');
            } else if (!panel.hasClass('d-none')) {
              $(document).one('click', closeLayerPanel);
            }
          });
        }, 10);
      }
    }

    function renderMapLayerPanel() {
      let html = '<h6 class="fw-bold mb-2 small">Lớp bản đồ nền</h6>';
      const baseLayers = ['OpenStreetMap', 'Vệ tinh (Esri)', 'Google Satellite'];
      for (const name of baseLayers) {
        const layer = mapLayers[name];
        if (!layer) continue;
        const checked = mapInstance.hasLayer(layer) ? 'checked' : '';
        const safeName = name.replace(/'/g, "\\'");
        html += `<label><input type="radio" name="map-basemap" ${checked} onchange="switchBasemap('${safeName}')" class="me-1"> ${name}</label>`;
      }
      html += '<hr class="my-2"><h6 class="fw-bold mb-2 small">Dữ liệu</h6>';
      const dataLayers = ['Lô rừng (GeoJSON)', 'Ghi chú'];
      for (const name of dataLayers) {
        const layer = mapLayers[name];
        if (!layer) continue;
        const checked = mapInstance.hasLayer(layer) ? 'checked' : '';
        const safeName = name.replace(/'/g, "\\'");
        html += `<label><input type="checkbox" ${checked} onchange="toggleLayer('${safeName}', this.checked)" class="me-1"> ${name}</label>`;
      }
      $('#map-layer-panel').html(html);
    }

    window.switchBasemap = function(name) {
      const baseLayers = ['OpenStreetMap', 'Vệ tinh (Esri)', 'Google Satellite'];
      baseLayers.forEach(bl => {
        if (mapLayers[bl] && mapInstance.hasLayer(mapLayers[bl])) {
          mapInstance.removeLayer(mapLayers[bl]);
        }
      });
      if (mapLayers[name]) mapInstance.addLayer(mapLayers[name]);
    };

    window.toggleLayer = function(name, show) {
      if (mapLayers[name]) {
        if (show) mapInstance.addLayer(mapLayers[name]);
        else mapInstance.removeLayer(mapLayers[name]);
      }
    };


    function addMapNote() {
      alert('Nhấn vào bản đồ để đặt ghi chú');
      mapInstance.once('click', function(e) {
        const note = prompt('Nhập nội dung ghi chú:');
        if (note) {
          L.marker(e.latlng, {
            icon: L.divIcon({ className: '', html: '<i class="fas fa-sticky-note text-warning fa-lg"></i>', iconSize: [20, 20] })
          }).bindPopup(`<div class="small fw-bold">${note}</div>`).addTo(mapInstance).openPopup();
          mapAnnotations.push({ latlng: e.latlng, note });
        }
      });
    }

    window.viewLoRungFromMap = function(loRungId) {
      const data = APP_DATA['Lo_rung'] || [];
      const row = data.find(r => String(r['ID lô rừng']) === String(loRungId));
      if (row) {
        $('#map-view').addClass('d-none');
        $('#page-content-dynamic').removeClass('d-none');
        navHistory.push({ mode: 'DETAIL', viewName: 'Lo_rung', title: row['Mã số lô rừng'] || 'Lô rừng', rowData: row });
        renderBreadcrumb();
        renderDetailMaster('Lo_rung', row);
      }
    };

    window.showOnMap = function(loRungId) {
      loadView('Bando_lorung', 'Bản đồ quản lý lô rừng');

      // Retry mechanism: GeoJSON loads async, so we try multiple times
      let attempts = 0;
      const maxAttempts = 10;
      const tryFlyTo = () => {
        attempts++;
        if (!mapInstance) { if (attempts < maxAttempts) setTimeout(tryFlyTo, 500); return; }

        // 1. Try to find polygon in drawn items (stored GeoJSON)
        let found = false;
        if (mapDrawnItems) {
          mapDrawnItems.eachLayer(layer => {
            if (found) return;
            // Check nested layers (L.geoJSON creates layer groups)
            if (layer.eachLayer) {
              layer.eachLayer(sub => {
                if (found) return;
                if (sub.loRungId === loRungId) {
                  found = true;
                  if (sub.getBounds) mapInstance.fitBounds(sub.getBounds().pad(0.1));
                  if (sub.openPopup) sub.openPopup();
                }
              });
            }
            if (!found && layer.loRungId === loRungId) {
              found = true;
              if (layer.getBounds) mapInstance.fitBounds(layer.getBounds().pad(0.1));
              else if (layer.getLatLng) mapInstance.setView(layer.getLatLng(), 16);
              if (layer.openPopup) layer.openPopup();
            }
          });
        }

        // 2. Fallback: use coordinates from Lo_rung data (kinh_do/vi_do or toa_do_tam_lo)
        if (!found) {
          const loRungData = APP_DATA['Lo_rung'] || [];
          const lr = loRungData.find(r => String(r['ID lô rừng']) === String(loRungId));
          if (lr) {
            let lat, lng;
            const kd = parseFloat(lr['Kinh độ']);
            const vd = parseFloat(lr['Vĩ độ']);
            if (!isNaN(vd) && !isNaN(kd)) { lat = vd; lng = kd; }
            else {
              const coords = lr['Tọa độ tâm lô'];
              if (coords) { const parts = String(coords).split(',').map(s => parseFloat(s.trim())); if (parts.length === 2) { lat = parts[0]; lng = parts[1]; } }
            }
            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
              mapInstance.setView([lat, lng], 16);
              found = true;
            }
          }
        }

        // 3. If still not found and GeoJSON might still be loading, retry
        if (!found && attempts < maxAttempts) setTimeout(tryFlyTo, 500);
      };
      setTimeout(tryFlyTo, 600);
    };
    // ============================================================
    // END MAP MODULE
    // ============================================================

    function updateSidebarContext() {
      // Logic: Nếu là PC (>992px) VÀ đang Drill-down (navHistory > 1) -> Hiển thị "Sơ đồ làm việc"
      if ($(window).width() < 992) {
        // Mobile/Tablet: Giữ nguyên Menu hệ thống
        if (APP_DATA['Menu']) {
          if ($('#sidebarAccordion').children().length === 0) renderSystemMenu(APP_DATA['Menu']);
        }
        return;
      }

      const container = $('#sidebarAccordion');

      // Nếu ở trang chủ (navHistory items = 1) -> Hiển thị Menu Gốc
      if (navHistory.length <= 1) {
        // sidebar home icon (no text)
        if (APP_DATA['Menu']) {
          // FIX: Only render if empty to preserve accordion state
          if (container.children().length === 0) renderSystemMenu(APP_DATA['Menu']);
        }
        return;
      }


      // Nếu đang Drill-down -> Hiển thị Context Map
      // sidebar home icon (no text)
      let html = '<div class="list-group list-group-flush">';

      navHistory.forEach((item, index) => {
        const isActive = index === navHistory.length - 1;
        const icon = index === 0 ? '<i class="fas fa-home me-2"></i>' : '<i class="fas fa-folder-open me-2"></i>';
        const activeClass = isActive ? 'bg-success text-white fw-bold' : 'text-secondary bg-light';

        html += `
           <a href="javascript:void(0)" class="list-group-item list-group-item-action ${activeClass} border-0 my-1 rounded mx-2" onclick="navigateBack(${navHistory.length - 1 - index})">
             <div class="d-flex w-100 justify-content-between align-items-center">
               <span class="small">${icon} ${item.title || item.viewName}</span>
               ${isActive ? '<i class="fas fa-chevron-right small"></i>' : ''}
             </div>
           </a>
         `;

        // Nếu item này có rowData, hiển thị thêm thông tin context con (ví dụ: Tên nhóm, Tên chủ rừng)
        if (item.rowData) {
          const name = item.rowData['Tên nhóm'] || item.rowData['Họ tên chủ rừng'] || item.rowData['Tên ban quản lý'] || item.rowData['ID'];
          if (name) {
            html += `<div class="ms-4 small text-muted mb-2 fst-italic"><i class="fas fa-level-up-alt fa-rotate-90 me-2"></i>${name}</div>`;
          }
        }
      });

      html += '</div>';
      container.html(html);
    }
    function renderAuditView(current) {
      const container = $('#page-content-dynamic');
      container.empty();

      const auditQuestions = APP_DATA['CauHoi_DanhGia'] || [];
      if (auditQuestions.length === 0) {
        container.html('<div class="alert alert-warning">Chưa có bộ câu hỏi đánh giá (Sheet LauHoi_DanhGia trống).</div>');
        return;
      }

      // Nhóm câu hỏi theo tiêu chí
      const categories = {};
      auditQuestions.forEach(q => {
        const cat = q['Nhóm tiêu chí'] || 'Khác';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(q);
      });

      let html = `
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-success text-white fw-bold">Thông tin đánh giá</div>
          <div class="card-body">
            <div class="row g-3">
               <div class="col-md-4">
                 <label class="form-label fw-bold">Đối tượng đánh giá</label>
                 <select class="form-select" id="audit-target-type" onchange="loadAuditTargets()">
                   <option value="">-- Chọn loại đối tượng --</option>
                   <option value="Churung">Chủ rừng</option>
                   <option value="NhomCCR">Nhóm chứng chỉ</option>
                 </select>
               </div>
               <div class="col-md-4">
                 <label class="form-label fw-bold">Chọn Đơn vị/Cá nhân</label>
                 <select class="form-select" id="audit-target-id" disabled><option>-- Vui lòng chọn loại trước --</option></select>
               </div>
               <div class="col-md-4">
                 <label class="form-label fw-bold">Ngày đánh giá</label>
                 <input type="date" class="form-control" id="audit-date" value="${new Date().toISOString().split('T')[0]}">
               </div>
            </div>
          </div>
        </div>
      `;

      html += `<div class="accordion" id="auditAccordion">`;
      let idx = 0;
      for (const [cat, questions] of Object.entries(categories)) {
        const safeCat = cat.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_');
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading${idx}">
              <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${idx}">
                ${cat} (${questions.length} tiêu chí)
              </button>
            </h2>
            <div id="collapse${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#auditAccordion">
              <div class="accordion-body bg-light">
                ${questions.map((q, i) => `
                  <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-body">
                      <h6 class="fw-bold text-success">${q['Nội dung câu hỏi']}</h6>
                      <p class="small text-muted mb-2"><i class="fas fa-info-circle me-1"></i>${q['Phương pháp kiểm tra'] || ''} | <i>${q['Gợi ý bằng chứng'] || ''}</i></p>
                      <div class="row g-2 align-items-center">
                        <div class="col-md-3">
                          <select class="form-select form-select-sm audit-result" data-qid="${q['ID câu hỏi']}">
                            <option value="NA">Không áp dụng (N/A)</option>
                            <option value="Pass">Đạt (Pass)</option>
                            <option value="Fail">Không đạt (Fail)</option>
                          </select>
                        </div>
                        <div class="col-md-9">
                          <input type="text" class="form-control form-control-sm audit-note" placeholder="Ghi chú / Bằng chứng..." data-qid="${q['ID câu hỏi']}">
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
        idx++;
      }
      html += `</div>`;

      html += `<div class="mt-4 text-center">
        <button class="btn btn-primary btn-lg px-5 fw-bold" onclick="submitAudit()"><i class="fas fa-save me-2"></i>Lưu kết quả đánh giá</button>
      </div>`;

      container.html(html);
    }

    // Hàm hỗ trợ cho Audit View
    window.loadAuditTargets = function () {
      const type = $('#audit-target-type').val();
      const select = $('#audit-target-id');
      select.prop('disabled', true).html('<option>Đang tải...</option>');

      if (!type || !APP_DATA[type]) {
        select.html('<option>-- Không có dữ liệu --</option>');
        return;
      }

      let opts = '<option value="">-- Chọn đối tượng --</option>';
      APP_DATA[type].forEach(item => {
        // Tự động tìm cột ID và Tên
        const keys = Object.keys(item);
        const idCol = keys.find(k => k.includes('ID') || k.includes('Mã'));
        const nameCol = keys.find(k => k.includes('Tên') || k.includes('Họ tên'));
        if (idCol) {
          opts += `<option value="${item[idCol]}">${item[idCol]} - ${nameCol ? item[nameCol] : ''}</option>`;
        }
      });
      select.html(opts).prop('disabled', false);
    };

    window.submitAuditWithUpload = async function () {
      const targetId = $('#audit-target-id').val();
      const date = $('#audit-date').val();

      if (!targetId || targetId === "") { return alert("Vui lòng chọn đối tượng đánh giá!"); }

      // Format: [ID nhóm]-yy[Sequence]
      const today = new Date();
      const yy = today.getFullYear().toString().slice(-2);
      const idPrefix = `${targetId}-${yy}`;

      let nextSeq = 1;
      const existingAudits = APP_DATA['DG_noibo'] || [];
      existingAudits.forEach(row => {
        const rID = String(row['ID'] || '');
        if (rID.startsWith(idPrefix)) {
          const suffix = parseInt(rID.replace(idPrefix, ''), 10);
          if (!isNaN(suffix) && suffix >= nextSeq) nextSeq = suffix + 1;
        }
      });
      const seqStr = String(nextSeq).padStart(2, '0');
      const idDG = `${idPrefix}${seqStr}`;

      // Prepare answers JSONB
      const answers = {};
      let passCount = 0, total = 0;

      $('.audit-result').each(function () {
        const qid = $(this).data('qid');
        const val = $(this).val();
        const note = $(`.audit-note[data-qid="${qid}"]`).val() || '';
        if (val !== 'NA') { total++; if (val === 'TT') passCount++; }
        answers[qid] = JSON.stringify({ r: val, n: note });
      });

      const score = total === 0 ? 100 : Math.round((passCount / total) * 100);

      if (confirm(`Xác nhận lưu kết quả đánh giá?\nĐiểm số dự kiến: ${score}%`)) {
        const btn = $('button[onclick="submitAuditWithUpload()"]');
        btn.prop('disabled', true).html('ĐANG LƯU...');

        try {
          // Step 1: Save DG_noibo
          const { error: err1 } = await sb.from('dg_noi_bo').insert({
            id: idDG, id_nhom: targetId, audit_date: date,
            staff: currentUser['Email']
          });
          if (err1) throw new Error("Lỗi lưu DG_noibo: " + err1.message);

          // Step 2: Save Banghoi_DG_noibo with answers JSONB
          const pad = (n) => String(n).padStart(2, '0');
          const ts = pad(today.getDate()) + pad(today.getMonth() + 1) + yy +
            pad(today.getHours()) + pad(today.getMinutes()) + pad(today.getSeconds());
          const idHoi = `${idDG}-${ts}`;

          const { error: err2 } = await sb.from('bang_hoi_dg_noi_bo').insert({
            id: idHoi, id_dg: idDG, answers: answers
          });
          if (err2) throw new Error("Lỗi lưu Banghoi_DG_noibo: " + err2.message);

          // Update local data
          APP_DATA['DG_noibo'].push({ 'ID': idDG, 'ID nhóm': targetId, 'Date': date, 'Staff': currentUser['Email'], 'Update': new Date().toLocaleString() });
          const hoiLocal = { 'ID_hoi': idHoi, 'ID_DG': idDG, ...answers };
          if (!APP_DATA['Banghoi_DG_noibo']) APP_DATA['Banghoi_DG_noibo'] = [];
          APP_DATA['Banghoi_DG_noibo'].push(hoiLocal);

          alert("Lưu thành công!");
          navigateBack();

        } catch (e) {
          alert("Lỗi: " + e.message);
          console.error(e);
        } finally {
          btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Lưu kết quả đánh giá');
        }
      }
    };

    function renderAuditModule() {
      const container = $('#page-content-dynamic');
      container.empty();

      const html = `
        <div class="card shadow border-0 rounded-4">
          <div class="card-header bg-white border-0 pt-4 px-4">
            <ul class="nav nav-tabs card-header-tabs" id="auditTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold text-success" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab"><i class="fas fa-history me-2"></i>${t('audit_tab_history')}</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold text-success" id="new-audit-tab" data-bs-toggle="tab" data-bs-target="#new-audit-pane" type="button" role="tab"><i class="fas fa-plus-circle me-2"></i>${t('audit_tab_new')}</button>
              </li>
            </ul>
          </div>
          <div class="card-body p-2">
            <div class="tab-content" id="auditTabsContent">
              <div class="tab-pane fade show active" id="history-pane" role="tabpanel" aria-labelledby="history-tab">
                <!-- HISTORY TABLE -->
                <div id="audit-history-container"></div>
              </div>
              <div class="tab-pane fade" id="new-audit-pane" role="tabpanel" aria-labelledby="new-audit-tab">
                <!-- NEW AUDIT LIST -->
                <div id="audit-new-container"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      container.html(html);

      // Render content for tabs
      renderAuditHistoryTable();
      renderNewAuditList();
    }

    function renderAuditHistoryTable() {
      const data = APP_DATA['DG_noibo'] || [];
      const container = $('#audit-history-container');

      if (data.length === 0) {
        container.html(`<div class="text-center text-muted py-5"><i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i><br>${t('audit_no_history')}</div>`);
        return;
      }

      // Sort by Date Descending
      const sortedData = [...data].sort((a, b) => new Date(b.Date) - new Date(a.Date));

      let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-success fw-bold m-0"><i class="fas fa-list me-2"></i>${t('audit_list_title')}</h5>
            <button class="btn btn-success btn-sm rounded-pill px-3 fw-bold shadow-sm" onclick="$('#new-audit-tab').tab('show')">
                <i class="fas fa-plus me-1"></i>${t('btn_add')}
            </button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle" id="audit-history-table">
            <thead class="table-light text-success">
              <tr>
                <th>${t('audit_code')}</th>
                <th>${t('audit_target')}</th>
                <th>${t('audit_date')}</th>
                <th>${t('audit_staff')}</th>
                <th class="text-center">${t('audit_detail')}</th>
              </tr>
            </thead>
            <tbody>
      `;

      sortedData.forEach(row => {
        // Tìm tên đối tượng (Nhóm hoặc Chủ rừng)
        let targetName = row['ID nhóm'];
        // Thử tìm trong NhomCCR
        if (APP_DATA['NhomCCR']) {
          const g = APP_DATA['NhomCCR'].find(x => String(x['ID nhóm']) === String(row['ID nhóm']));
          if (g) targetName = `${g['Tên nhóm']} (${row['ID nhóm']})`;
        }

        html += `
          <tr>
            <td class="fw-bold">${row['ID']}</td>
            <td>${targetName}</td>
            <td>${row['Date']}</td>
            <td>${row['Staff']}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary" onclick="viewAuditDetail('${row['ID']}')"><i class="fas fa-eye"></i></button>
            </td>
          </tr>
        `;
      });
      html += `</tbody></table></div>`;
      container.html(html);

      // Datatable init
      if ($.fn.DataTable) {
        $('#audit-history-table').DataTable({
          language: currentLang === 'en' ? {} : { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/vi.json" },
          pageLength: 10,
          dom: 'ftp', // Simplified DOM
          ordering: false // Disable sorting to keep our Date desc sort
        });
      }
    }

    function renderNewAuditList() {
      const container = $('#audit-new-container');

      const html = `
        <div class="card bg-light border-0 mb-3">
          <div class="card-body py-3">
             <div class="row align-items-center">
               <div class="col-md-4">
                 <label class="fw-bold text-success mb-1">${t('audit_select_type')}</label>
                 <select class="form-select border-success" id="audit-type-select" onchange="renderAuditCandidateTable(this.value)">
                   <option value="NhomCCR">${t('audit_type_group')}</option>
                   <option value="Ban_Quanlynhom">${t('audit_type_board')}</option>
                 </select>
               </div>
               <div class="col-md-8 text-end">
                  <small class="text-muted fst-italic"><i class="fas fa-info-circle me-1"></i>${t('audit_select_hint')}</small>
               </div>
             </div>
          </div>
        </div>
        <div id="audit-candidate-table-container"></div>
      `;
      container.html(html);
      renderAuditCandidateTable('NhomCCR');
    }

    // --- IMPROVED AUDIT FLOW ---

    function renderAuditCandidateTable(type) {
      const container = $('#audit-candidate-table-container');
      const data = APP_DATA[type] || [];

      if (data.length === 0) {
        container.html(`<div class="alert alert-warning">${t('audit_no_data')}</div>`);
        return;
      }

      let th = '';
      if (type === 'NhomCCR') {
        th = `<th>${t('audit_group_code')}</th><th>${t('audit_group_name')}</th><th>${t('audit_fsc_area')}</th>`;
      } else {
        th = `<th>${t('audit_board_id')}</th><th>${t('audit_board_name')}</th><th>${t('audit_total_area')}</th>`;
      }

      let html = `
        <div class="table-responsive">
          <table class="table table-hover table-bordered bg-white shadow-sm align-middle">
            <thead class="table-light text-success">
              <tr>
                ${th}
                <th class="text-center" style="width: 180px;">${t('audit_action')}</th>
              </tr>
            </thead>
            <tbody>
      `;

      data.forEach(item => {
        let col1 = '', col2 = '', col3 = '', idVal = '';
        if (type === 'NhomCCR') {
          idVal = item['ID nhóm'] || item['Mã nhóm'];
          col1 = idVal;
          col2 = item['Tên nhóm'];
          col3 = (item['Diện tích FSC'] || 0) + ' ha';
        } else {
          idVal = item['ID ban quản lý'];
          col1 = idVal;
          col2 = item['Tên ban quản lý'];
          col3 = (item['Tổng diện tích'] || 0) + ' ha';
        }

        const safeItem = JSON.stringify(item).replace(/"/g, '&quot;');

        html += `
           <tr class="clickable-row" onclick="showTargetHistory(${safeItem}, '${type}')">
             <td class="fw-bold text-success">${col1}</td>
             <td class="fw-bold">${col2}</td>
             <td>${col3}</td>
             <td class="text-center">
               <button class="btn btn-sm btn-outline-success fw-bold px-3 rounded-pill" onclick="event.stopPropagation(); showTargetHistory(${safeItem}, '${type}')">
                 <i class="fas fa-history me-1"></i>${t('audit_history_btn')}
               </button>
             </td>
           </tr>
         `;
      });

      html += `</tbody></table></div>`;
      container.html(html);
    }

    // New: Show History and Option to Create New
    function showTargetHistory(item, type) {
      const container = $('#page-content-dynamic');

      let idVal = '', nameVal = '';
      if (type === 'NhomCCR') { idVal = item['ID nhóm'] || item['Mã nhóm']; nameVal = item['Tên nhóm']; }
      else { idVal = item['ID ban quản lý']; nameVal = item['Tên ban quản lý']; }

      // Filter History
      const allHistory = APP_DATA['DG_noibo'] || [];
      const myHistory = allHistory.filter(h => String(h['ID nhóm']).trim() === String(idVal).trim());
      // Note: 'ID nhóm' in DG_noibo stores the Target ID regardless of type (Group or Manager)

      // Sort recent first
      myHistory.sort((a, b) => new Date(b.Date) - new Date(a.Date));

      const safeItem = JSON.stringify(item).replace(/"/g, '&quot;');

      let html = `
        <div class="card shadow-sm border-0 mb-4">
           <div class="card-header bg-success text-white py-3">
              <div class="d-flex justify-content-between align-items-center">
                 <h5 class="mb-0 fw-bold"><i class="fas fa-clipboard-list me-2"></i>${t('audit_record_title')}: ${nameVal}</h5>
                 <button class="btn btn-light btn-sm fw-bold text-success" onclick="renderAuditModule()"><i class="fas fa-arrow-left me-1"></i>${t('audit_back_list')}</button>
              </div>
           </div>
           <div class="card-body">
              <div class="row g-3 mb-4">
                 <div class="col-md-8">
                    <div class="alert alert-info border-0 bg-light text-dark mb-0">
                       <strong><i class="fas fa-info-circle me-1"></i>${t('audit_info')}:</strong> ${nameVal} (${idVal})
                    </div>
                 </div>
                 <div class="col-md-4 text-end">
                    <button class="btn btn-success fw-bold w-100 shadow py-2" onclick="renderAuditFormUI(${safeItem}, '${type}')">
                       <i class="fas fa-plus-circle me-2"></i>${t('audit_new_btn')}
                    </button>
                 </div>
              </div>

              <h6 class="fw-bold text-success border-bottom pb-2 mb-3">${t('audit_history_label')} (${myHistory.length} ${t('audit_records')})</h6>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                   <thead class="table-light">
                      <tr>
                         <th>${t('audit_code')}</th><th>${t('audit_date')}</th><th>${t('audit_executor')}</th><th>${t('audit_result')}</th><th>${t('audit_action')}</th>
                      </tr>
                   </thead>
                   <tbody>
      `;

      if (myHistory.length === 0) {
        html += `<tr><td colspan="5" class="text-center py-4 text-muted">${t('audit_no_records')}</td></tr>`;
      } else {
        myHistory.forEach(h => {
          html += `
                <tr>
                   <td class="fw-bold text-primary">${h['ID']}</td>
                   <td>${h['Date']}</td>
                   <td>${h['Staff']}</td>
                   <td><span class="badge bg-secondary">${t('audit_done')}</span></td>
                   <td><button class="btn btn-sm btn-outline-secondary" onclick="viewAuditDetail('${h['ID']}')">${t('audit_detail')}</button></td>
                </tr>
             `;
        });
      }

      html += `</tbody></table></div></div></div>`;
      container.html(html);
    }

    // New: 2-Column Grid + Button Answers + Files
    function renderAuditFormUI(item, type) {
      const container = $('#page-content-dynamic');
      container.empty();

      let idVal = '', nameVal = '';
      if (type === 'NhomCCR') { idVal = item['ID nhóm'] || item['Mã nhóm']; nameVal = item['Tên nhóm']; }
      else { idVal = item['ID ban quản lý']; nameVal = item['Tên ban quản lý']; }
      const safeItem = JSON.stringify(item).replace(/"/g, '&quot;');

      let html = `
        <div class="card shadow-sm mb-4 border-0">
          <div class="card-header bg-success text-white fw-bold py-2 audit-sticky-header">
            <div class="d-flex justify-content-between align-items-center">
               <span><i class="fas fa-edit me-2"></i>${t('audit_form_title')}: ${nameVal}</span>
               <button class="btn btn-sm btn-light text-success fw-bold" onclick="showTargetHistory(${safeItem}, '${type}')"><i class="fas fa-arrow-left me-1"></i>${t('audit_cancel_back')}</button>
            </div>
          </div>
          <div class="card-body bg-light" style="padding-top:0">
             <!-- Hidden Context -->
             <input type="hidden" id="audit-target-id" value="${idVal}">
             <input type="hidden" id="audit-target-type" value="${type}">

             <div class="row g-2 align-items-center bg-white p-2 rounded shadow-sm mb-3 audit-sticky-context">
               <div class="col-md-6"><h6 class="m-0 text-muted small">${t('audit_subject')}: <strong class="text-dark">${nameVal}</strong> (${idVal})</h6></div>
               <div class="col-md-6 text-md-end">
                  <div class="input-group input-group-sm w-auto d-inline-flex">
                     <span class="input-group-text fw-bold">${t('audit_date_label')}:</span>
                     <input type="date" class="form-control" id="audit-date" value="${new Date().toISOString().split('T')[0]}">
                  </div>
               </div>
            </div>
      `;

      html += `<div class="accordion" id="auditAccordion">`;
      let idx = 0;
      for (const [cat, questions] of Object.entries(AUDIT_DICTIONARY)) {
        html += `
          <div class="accordion-item mb-3 border rounded shadow-sm overflow-hidden">
            <h2 class="accordion-header" id="heading${idx}">
              <button class="accordion-button ${idx > 0 ? 'collapsed' : ''} fw-bold bg-white text-success" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${idx}">
                ${tcat(cat)} <span class="badge bg-light text-dark ms-2 border">${questions.length}</span>
              </button>
            </h2>
            <div id="collapse${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#auditAccordion">
              <div class="accordion-body bg-light p-3">
                
                <div class="row row-cols-1 row-cols-md-2 g-3">
                  ${questions.map((q) => `
                    <div class="col">
                      <div class="card h-100 border-0 shadow-sm audit-card">
                        <div class="card-body p-3">
                           <div class="d-flex justify-content-between mb-2">
                              <span class="badge bg-success bg-opacity-10 text-success">${q.index}</span>
                           </div>
                           <h6 class="fw-bold mb-3" style="font-size: 12px; min-height: 36px;">${tq(q.id, q.label)}</h6>

                           <!-- Answer Buttons -->
                           <input type="hidden" class="audit-result" data-qid="${q.id}" value="NA">
                           <div class="btn-group w-100 mb-3" role="group">
                              <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleScoreBtn(this, '${q.id}', 'TT')">${t('audit_compliant')}</button>
                              <button type="button" class="btn btn-outline-danger btn-sm" onclick="toggleScoreBtn(this, '${q.id}', 'KTT')">${t('audit_non_compliant')}</button>
                              <button type="button" class="btn btn-secondary btn-sm active" onclick="toggleScoreBtn(this, '${q.id}', 'NA')">N/A</button>
                           </div>
                           
                           <!-- Tools: Note + File -->
                           <div class="bg-light p-2 rounded">
                              <div class="mb-2">
                                <textarea class="form-control form-control-sm audit-note border-0 bg-white" rows="1" placeholder="${t('audit_note_ph')}" data-qid="${q.id}" style="resize: none;"></textarea>
                              </div>
                              <div class="input-group input-group-sm">
                                <label class="input-group-text bg-white border-0"><i class="fas fa-paperclip text-muted"></i></label>
                                <input type="file" class="form-control form-control-sm border-0 bg-white audit-file" multiple data-qid="${q.id}">
                                <button class="btn btn-outline-secondary border-0" type="button" onclick="clearFileInput(this, '${q.id}')" title="${t('audit_cancel_file')}"><i class="fas fa-times"></i></button>
                              </div>
                           </div>

                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>

              </div>
            </div>
          </div>
        `;
        idx++;
      }
      html += `</div>`;

      html += `
             <div class="mt-4 text-center">
               <button class="btn btn-success btn-lg px-5 fw-bold shadow" onclick="submitAuditWithUpload()">
                 <i class="fas fa-save me-2"></i>${t('audit_save_btn')}
               </button>
             </div>
      `;

      html += `</div></div>`;
      container.html(html);
    }

    // --- VIEW AUDIT DETAIL ---
    function viewAuditDetail(idDG) {
      console.log("Viewing Audit Detail for:", idDG);

      const dgList = APP_DATA['DG_noibo'] || [];
      const hoiList = APP_DATA['Banghoi_DG_noibo'] || [];

      const dgRecord = dgList.find(r => String(r['ID']) === String(idDG));
      if (!dgRecord) return alert(t('audit_not_found'));

      const hoiRecord = hoiList.find(r => String(r['ID_DG']) === String(idDG));

      // prepare UI
      const container = $('#page-content-dynamic');
      container.empty();

      const targetId = dgRecord['ID nhóm']; // Helper to find name
      let targetName = targetId;
      // Try to find name in Group or Board
      if (APP_DATA['NhomCCR']) {
        const g = APP_DATA['NhomCCR'].find(x => String(x['ID nhóm']) === String(targetId) || String(x['Mã nhóm']) === String(targetId));
        if (g) targetName = g['Tên nhóm'];
      }
      if (targetName === targetId && APP_DATA['Ban_Quanlynhom']) {
        const b = APP_DATA['Ban_Quanlynhom'].find(x => String(x['ID ban quản lý']) === String(targetId));
        if (b) targetName = b['Tên ban quản lý'];
      }

      let html = `
        <div class="card shadow-sm mb-4 border-0">
          <div class="card-header bg-primary text-white fw-bold py-3">
             <div class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-eye me-2"></i>${t('audit_detail_title')}: ${targetName}</span>
                <button class="btn btn-sm btn-light text-primary fw-bold" onclick="renderAuditModule()"><i class="fas fa-arrow-left me-1"></i>${t('audit_back')}</button>
             </div>
          </div>
          <div class="card-body bg-light">
             <div class="alert alert-light border shadow-sm mb-4">
               <div class="row">
                 <div class="col-md-3"><strong>${t('audit_code')}:</strong> ${dgRecord['ID']}</div>
                 <div class="col-md-3"><strong>${t('audit_date_label')}:</strong> ${dgRecord['Date']}</div>
                 <div class="col-md-3"><strong>${t('audit_auditor')}:</strong> ${dgRecord['Staff']}</div>
                 <div class="col-md-3"><strong>${t('audit_update')}:</strong> ${dgRecord['Update']}</div>
               </div>
             </div>
             
             <div class="accordion" id="auditDetailAccordion">`;

      let idx = 0;
      for (const [cat, questions] of Object.entries(AUDIT_DICTIONARY)) {
        html += `
          <div class="accordion-item mb-3 border rounded shadow-sm overflow-hidden">
            <h2 class="accordion-header" id="headingD${idx}">
              <button class="accordion-button ${idx > 0 ? 'collapsed' : ''} fw-bold bg-white text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseD${idx}">
                ${tcat(cat)}
              </button>
            </h2>
            <div id="collapseD${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#auditDetailAccordion">
              <div class="accordion-body bg-light p-3">
                <div class="row row-cols-1 row-cols-md-2 g-3">`;

        questions.forEach(q => {
          let ans = { r: 'NA', n: '' };
          if (hoiRecord && hoiRecord[q.id]) {
            try {
              // Try parsing JSON first
              if (hoiRecord[q.id].startsWith('{')) {
                ans = JSON.parse(hoiRecord[q.id]);
              } else {
                // Fallback for simple text if any
                ans = { r: hoiRecord[q.id], n: '' };
              }
            } catch (e) {
              ans = { r: hoiRecord[q.id], n: '' };
            }
          }

          let badge = '<span class="badge bg-secondary">N/A</span>';
          if (ans.r === 'TT') badge = `<span class="badge bg-success">${t('audit_compliant_badge')}</span>`;
          if (ans.r === 'KTT') badge = `<span class="badge bg-danger">${t('audit_non_compliant_badge')}</span>`;

          html += `
             <div class="col">
               <div class="card h-100 border-0 shadow-sm">
                 <div class="card-body p-3">
                    <div class="d-flex justify-content-between mb-2">
                       <span class="badge bg-primary bg-opacity-10 text-primary">${q.index}</span>
                    </div>
                    <h6 class="fw-bold mb-3 small" style="min-height:40px">${tq(q.id, q.label)}</h6>
                    <div class="mb-2">${badge}</div>
                    ${ans.n ? `<div class="bg-light p-2 rounded small text-dark mt-2 border"><i class="fas fa-comment-alt me-1 text-muted"></i> ${ans.n}</div>` : ''}
                 </div>
               </div>
             </div>
           `;
        });

        html += `</div></div></div></div>`;
        idx++;
      }

      html += `</div></div></div>`;
      container.html(html);
    }

    // Helper: Toggle Answer Button Styling and Update Hidden Input
    function toggleScoreBtn(btn, qid, val) {
      const wrapper = $(btn).parent();
      wrapper.find('.btn').removeClass('active');

      // Add active class based on type
      if (val === 'TT') $(btn).addClass('active btn-success text-white').removeClass('btn-outline-success');
      else if (val === 'KTT') $(btn).addClass('active btn-danger text-white').removeClass('btn-outline-danger');
      else $(btn).addClass('active');

      // Reset siblings style
      wrapper.find('.btn-outline-success').not(btn).removeClass('active btn-success text-white');
      wrapper.find('.btn-outline-danger').not(btn).removeClass('active btn-danger text-white');

      // Update hidden input
      $(`.audit-result[data-qid="${qid}"]`).val(val);
    }

    // Helper: Clear File Input
    function clearFileInput(btn, qid) {
      const input = $(`.audit-file[data-qid="${qid}"]`);
      input.val(''); // Clear value
    }

    // ============================================================
    // MONITORING PLAN VIEW
    // ============================================================

    function renderMonitoringPlanView() {
      const container = $('#page-content-dynamic');
      container.empty();
      const planData = APP_DATA['KH_GiamSat_Nhom'] || [];
      const groups = APP_DATA['NhomCCR'] || [];
      const currentYear = new Date().getFullYear();

      // Get unique years from data, default to current year
      const years = [...new Set(planData.map(r => parseInt(r['Năm'])).filter(y => !isNaN(y)))].sort((a, b) => b - a);
      if (!years.includes(currentYear)) years.unshift(currentYear);

      const months = ['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];
      const monthFull = ['Tháng 1','Tháng 2','Tháng 3','Tháng 4','Tháng 5','Tháng 6','Tháng 7','Tháng 8','Tháng 9','Tháng 10','Tháng 11','Tháng 12'];

      let html = `
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="fw-bold text-success mb-0"><i class="fas fa-calendar-check me-2"></i>${t('mon_plan_title')}</h5>
              <div class="d-flex gap-2 align-items-center">
                <select class="form-select form-select-sm fw-bold" id="planYearSelect" style="width:120px" onchange="filterPlanYear()">
                  ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                </select>
                <button class="btn btn-success btn-sm fw-bold" onclick="addMonitoringPlanRow()"><i class="fas fa-plus me-1"></i>${t('mon_plan_add')}</button>
              </div>
            </div>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-bordered table-hover align-middle mb-0 small" id="monPlanTable">
                <thead class="table-success text-center">
                  <tr>
                    <th style="min-width:140px">${t('mon_plan_group')}</th>
                    <th style="min-width:140px">${t('mon_type')}</th>
                    ${months.map((m, i) => `<th style="min-width:50px">${monthFull[i]}</th>`).join('')}
                    <th style="min-width:100px">${t('mon_pdf_note')}</th>
                    <th style="width:60px"></th>
                  </tr>
                </thead>
                <tbody id="monPlanBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>`;

      container.html(html);
      filterPlanYear();
    }

    function filterPlanYear() {
      const year = parseInt($('#planYearSelect').val());
      const planData = (APP_DATA['KH_GiamSat_Nhom'] || []).filter(r => parseInt(r['Năm']) === year);
      const groups = APP_DATA['NhomCCR'] || [];
      const months = ['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];

      let bodyHtml = '';
      if (planData.length === 0) {
        bodyHtml = `<tr><td colspan="15" class="text-center text-muted py-4"><i class="fas fa-inbox me-2"></i>${t('mon_no_data')}</td></tr>`;
      } else {
        planData.forEach(row => {
          const grp = groups.find(g => String(g['ID nhóm']) === String(row['ID nhóm']));
          const grpName = grp ? (grp['Tên nhóm'] || row['ID nhóm']) : row['ID nhóm'];
          const typeKey = row['Loại giám sát'] || '';
          const tInfo = MONITORING_TYPES[typeKey] || { color: '#666', icon: 'fa-clipboard' };

          bodyHtml += `<tr>
            <td class="fw-bold small">${grpName}</td>
            <td><span class="badge text-white" style="background:${tInfo.color}; font-size:10px"><i class="fas ${tInfo.icon} me-1"></i>${tmt(typeKey)}</span></td>
            ${months.map(m => {
              const val = row[m] || '';
              const cellColor = val ? '#E8F5E9' : '';
              return `<td class="text-center small" style="background:${cellColor}; cursor:pointer" onclick="editPlanCell('${row['ID']}', '${m}')" title="${val || 'Click để nhập'}">${val}</td>`;
            }).join('')}
            <td class="small">${row['Ghi chú'] || ''}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger" onclick="deletePlanRow('${row['ID']}')"><i class="fas fa-trash-alt"></i></button>
            </td>
          </tr>`;
        });
      }
      $('#monPlanBody').html(bodyHtml);
    }

    async function addMonitoringPlanRow() {
      const year = parseInt($('#planYearSelect').val());
      const groups = APP_DATA['NhomCCR'] || [];
      const typeOptions = Object.entries(MONITORING_TYPES).map(([k, v]) => `<option value="${k}">${v.title}</option>`).join('');
      const grpOptions = groups.map(g => `<option value="${g['ID nhóm']}">${g['Tên nhóm'] || g['ID nhóm']}</option>`).join('');

      const formHtml = `<div class="row g-2">
        <div class="col-md-6"><label class="fw-bold small">${t('mon_plan_group')}</label><select class="form-select form-select-sm" id="planNewGroup">${grpOptions}</select></div>
        <div class="col-md-6"><label class="fw-bold small">${t('mon_type')}</label><select class="form-select form-select-sm" id="planNewType">${typeOptions}</select></div>
      </div>`;

      const modal = $(`<div class="modal fade" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header bg-success text-white"><h6 class="modal-title fw-bold"><i class="fas fa-plus-circle me-2"></i>${t('mon_plan_add')} - ${year}</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">${formHtml}</div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">${t('mon_cancel_back')}</button><button type="button" class="btn btn-success btn-sm fw-bold" id="planSaveBtn"><i class="fas fa-save me-1"></i>${t('mon_save_btn')}</button></div>
      </div></div></div>`);

      $('body').append(modal);
      const bsModal = new bootstrap.Modal(modal[0]);
      bsModal.show();

      modal.find('#planSaveBtn').on('click', async function() {
        const groupId = modal.find('#planNewGroup').val();
        const typeKey = modal.find('#planNewType').val();
        if (!groupId || !typeKey) return;

        const id = `KHGS_${groupId}_${typeKey}_${year}`;
        const existing = (APP_DATA['KH_GiamSat_Nhom'] || []).find(r => r['ID'] === id);
        if (existing) { alert('Kế hoạch này đã tồn tại!'); return; }

        const saveBtn = $(this);
        saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

        try {
          const insertData = { id, id_nhom: groupId, nam: year, loai_giam_sat: typeKey };
          const { error } = await sb.from('kh_giam_sat_nhom').insert(insertData);
          if (error) throw new Error(error.message);

          if (!APP_DATA['KH_GiamSat_Nhom']) APP_DATA['KH_GiamSat_Nhom'] = [];
          APP_DATA['KH_GiamSat_Nhom'].push({
            'ID': id, 'ID nhóm': groupId, 'Năm': year, 'Loại giám sát': typeKey,
            'T1':'','T2':'','T3':'','T4':'','T5':'','T6':'','T7':'','T8':'','T9':'','T10':'','T11':'','T12':'', 'Ghi chú':''
          });

          bsModal.hide();
          filterPlanYear();
        } catch(e) {
          alert('Error: ' + e.message);
        } finally {
          saveBtn.prop('disabled', false).html(`<i class="fas fa-save me-1"></i>${t('mon_save_btn')}`);
        }
      });

      modal.on('hidden.bs.modal', function() { modal.remove(); });
    }

    async function editPlanCell(rowId, monthKey) {
      const planData = APP_DATA['KH_GiamSat_Nhom'] || [];
      const row = planData.find(r => r['ID'] === rowId);
      if (!row) return;

      const currentVal = row[monthKey] || '';
      const newVal = prompt(`${monthKey} (${row['Loại giám sát']}):`, currentVal);
      if (newVal === null) return; // cancelled

      try {
        const dbCol = DB_MAP['KH_GiamSat_Nhom'].cols;
        const colName = Object.entries(dbCol).find(([k, v]) => v === monthKey);
        if (!colName) return;

        const { error } = await sb.from('kh_giam_sat_nhom').update({ [colName[0]]: newVal }).eq('id', rowId);
        if (error) throw new Error(error.message);

        row[monthKey] = newVal;
        filterPlanYear();
      } catch(e) {
        alert('Error: ' + e.message);
      }
    }

    async function deletePlanRow(rowId) {
      if (!confirm(t('mon_confirm_save'))) return;
      try {
        const { error } = await sb.from('kh_giam_sat_nhom').delete().eq('id', rowId);
        if (error) throw new Error(error.message);

        APP_DATA['KH_GiamSat_Nhom'] = (APP_DATA['KH_GiamSat_Nhom'] || []).filter(r => r['ID'] !== rowId);
        filterPlanYear();
      } catch(e) {
        alert('Error: ' + e.message);
      }
    }

    // MONITORING MODULE
    // ============================================================

    function renderMonitoringModule() {
      const container = $('#page-content-dynamic');
      container.empty();

      const html = `
        <div class="card shadow border-0 rounded-4">
          <div class="card-header bg-white border-0 pt-4 px-4">
            <ul class="nav nav-tabs card-header-tabs" id="monTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold text-success" id="mon-history-tab" data-bs-toggle="tab" data-bs-target="#mon-history-pane" type="button" role="tab"><i class="fas fa-history me-2"></i>${t('mon_tab_history')}</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold text-success" id="mon-new-tab" data-bs-toggle="tab" data-bs-target="#mon-new-pane" type="button" role="tab"><i class="fas fa-plus-circle me-2"></i>${t('mon_tab_new')}</button>
              </li>
            </ul>
          </div>
          <div class="card-body p-2">
            <div class="tab-content" id="monTabsContent">
              <div class="tab-pane fade show active" id="mon-history-pane" role="tabpanel">
                <div id="mon-history-container"></div>
              </div>
              <div class="tab-pane fade" id="mon-new-pane" role="tabpanel">
                <div id="mon-new-container"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      container.html(html);
      renderMonHistoryTable();
      renderMonNewPanel();
    }

    function renderMonHistoryTable() {
      let data = APP_DATA['GiamSat_LoRung'] || [];
      const container = $('#mon-history-container');

      // Apply type filter if set from monitoring sub-menu
      if (_monTypeFilter && _monTypeFilter.length > 0) {
        data = data.filter(r => _monTypeFilter.includes(r['Loại giám sát']));
      }

      if (data.length === 0) {
        container.html(`<div class="text-center text-muted py-5"><i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i><br>${t('mon_no_history')}</div>`);
        return;
      }

      const sortedData = [...data].sort((a, b) => new Date(b['Ngày giám sát']) - new Date(a['Ngày giám sát']));

      let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="text-success fw-bold m-0"><i class="fas fa-list me-2"></i>${t('mon_list_title')}</h5>
          <button class="btn btn-success btn-sm rounded-pill px-3 fw-bold shadow-sm" onclick="$('#mon-new-tab').tab('show')">
            <i class="fas fa-plus me-1"></i>${t('btn_add')}
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle" id="mon-history-table">
            <thead class="table-light text-success">
              <tr>
                <th>${t('mon_code')}</th>
                <th>${t('mon_type')}</th>
                <th>${t('mon_date')}</th>
                <th>${t('mon_staff')}</th>
                <th class="text-center">${t('mon_detail')}</th>
              </tr>
            </thead>
            <tbody>
      `;

      sortedData.forEach(row => {
        const typeKey = row['Loại giám sát'] || '';
        const typeName = tmt(typeKey);
        html += `
          <tr>
            <td class="fw-bold">${row['ID']}</td>
            <td><span class="badge" style="background:${(MONITORING_TYPES[typeKey]||{}).color||'#666'}">${typeName}</span></td>
            <td>${row['Ngày giám sát'] || ''}</td>
            <td>${row['Người giám sát'] || ''}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary" onclick="viewMonitoringDetail('${row['ID']}')"><i class="fas fa-eye"></i></button>
            </td>
          </tr>
        `;
      });
      html += `</tbody></table></div>`;
      container.html(html);

      if ($.fn.DataTable) {
        $('#mon-history-table').DataTable({
          language: currentLang === 'en' ? {} : { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/vi.json" },
          pageLength: 10, dom: 'ftp', ordering: false
        });
      }
    }

    function renderMonNewPanel() {
      const container = $('#mon-new-container');

      let typeOptions = '';
      for (const [key, info] of Object.entries(MONITORING_TYPES)) {
        // Filter type options if a monitoring sub-menu filter is active
        if (_monTypeFilter && _monTypeFilter.length > 0 && !_monTypeFilter.includes(key)) continue;
        typeOptions += `<option value="${key}">${tmt(key)}</option>`;
      }

      const html = `
        <div class="card bg-light border-0 mb-3">
          <div class="card-body py-3">
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="fw-bold text-success mb-1">${t('mon_select_type')}</label>
                <select class="form-select border-success" id="mon-type-select" onchange="onMonTypeChange()">
                  ${typeOptions}
                </select>
              </div>
              <div class="col-md-4">
                <label class="fw-bold text-success mb-1">${t('mon_select_target')}</label>
                <select class="form-select border-success" id="mon-target-select">
                  <option value="">-- ${t('mon_select_hint')} --</option>
                </select>
              </div>
              <div class="col-md-4 text-end">
                <button class="btn btn-success fw-bold px-4 rounded-pill shadow-sm" onclick="startMonitoringForm()">
                  <i class="fas fa-clipboard-check me-1"></i>${t('mon_start_btn')}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div id="mon-target-info"></div>
      `;
      container.html(html);
      onMonTypeChange();
    }

    function onMonTypeChange() {
      const typeKey = $('#mon-type-select').val();
      const info = MONITORING_TYPES[typeKey];
      const select = $('#mon-target-select');
      select.empty().append(`<option value="">-- ${t('mon_select_hint')} --</option>`);

      if (info.target === 'nhom') {
        const groups = APP_DATA['NhomCCR'] || [];
        groups.forEach(g => {
          select.append(`<option value="${g['ID nhóm']}" data-type="nhom">${g['Tên nhóm']} (${g['ID nhóm']})</option>`);
        });
      } else {
        const plots = APP_DATA['Lo_rung'] || [];
        plots.forEach(p => {
          const ownerName = findOwnerName(p['ID chủ rừng']);
          select.append(`<option value="${p['ID lô rừng']}" data-type="lo_rung">${p['Mã số lô rừng'] || p['ID lô rừng']} - ${ownerName}</option>`);
        });
      }
    }

    function findOwnerName(idChuRung) {
      if (!idChuRung) return '';
      const owners = APP_DATA['Churung'] || [];
      const o = owners.find(x => String(x['ID chủ rừng']) === String(idChuRung));
      return o ? o['Họ tên chủ rừng'] : '';
    }

    function findGroupName(idNhom) {
      if (!idNhom) return idNhom;
      const groups = APP_DATA['NhomCCR'] || [];
      const g = groups.find(x => String(x['ID nhóm']) === String(idNhom));
      return g ? g['Tên nhóm'] : idNhom;
    }

    function startMonitoringForm() {
      const typeKey = $('#mon-type-select').val();
      const targetId = $('#mon-target-select').val();
      if (!targetId) return alert(t('mon_select_hint'));

      const info = MONITORING_TYPES[typeKey];
      let targetName = '';
      if (info.target === 'nhom') {
        targetName = findGroupName(targetId);
      } else {
        const plots = APP_DATA['Lo_rung'] || [];
        const p = plots.find(x => String(x['ID lô rừng']) === String(targetId));
        targetName = p ? (p['Mã số lô rừng'] || p['Tên lô rừng'] || targetId) : targetId;
      }

      renderMonitoringFormUI(typeKey, targetId, targetName);
    }

    function renderMonitoringFormUI(typeKey, targetId, targetName) {
      const container = $('#page-content-dynamic');
      container.empty();
      const info = MONITORING_TYPES[typeKey];
      const sections = MONITORING_DICTIONARY[typeKey];
      if (!sections) return;

      let html = `
        <div class="card shadow-sm mb-4 border-0">
          <div class="card-header text-white fw-bold py-2" style="background:${info.color}">
            <div class="d-flex justify-content-between align-items-center">
              <span><i class="fas ${info.icon} me-2"></i>${t('mon_form_title')}: ${tmt(typeKey)}</span>
              <button class="btn btn-sm btn-light fw-bold" onclick="monGoBack()"><i class="fas fa-arrow-left me-1"></i>${t('mon_cancel_back')}</button>
            </div>
          </div>
          <div class="card-body bg-light" style="padding-top:0">
            <input type="hidden" id="mon-target-id" value="${targetId}">
            <input type="hidden" id="mon-type-key" value="${typeKey}">

            <div class="row g-2 align-items-center bg-white p-2 rounded shadow-sm mb-3 mt-2">
              <div class="col-md-3"><h6 class="m-0 text-muted small">${t('mon_subject')}: <strong class="text-dark">${targetName}</strong></h6></div>
              <div class="col-md-3">
                <div class="input-group input-group-sm">
                  <span class="input-group-text fw-bold">${t('mon_date_label')}:</span>
                  <input type="date" class="form-control" id="mon-date" value="${new Date().toISOString().split('T')[0]}">
                </div>
              </div>
              <div class="col-md-3">
                <div class="input-group input-group-sm">
                  <span class="input-group-text fw-bold">${t('mon_weather')}:</span>
                  <select class="form-control" id="mon-weather">
                    <option value="Nắng">${t('mon_weather_sunny')}</option>
                    <option value="Mây">${t('mon_weather_cloudy')}</option>
                    <option value="Mưa nhẹ">${t('mon_weather_light_rain')}</option>
                    <option value="Mưa to">${t('mon_weather_heavy_rain')}</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="input-group input-group-sm">
                  <span class="input-group-text fw-bold">${t('mon_area_label')}:</span>
                  <input type="number" class="form-control" id="mon-area" step="0.01" placeholder="ha">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <div class="input-group input-group-sm">
                <span class="input-group-text fw-bold">${t('mon_representative')}:</span>
                <input type="text" class="form-control" id="mon-representative" placeholder="">
              </div>
            </div>
      `;

      html += `<div class="accordion" id="monAccordion">`;
      let idx = 0;
      for (const [secName, questions] of Object.entries(sections)) {
        html += `
          <div class="accordion-item mb-3 border rounded shadow-sm overflow-hidden">
            <h2 class="accordion-header">
              <button class="accordion-button ${idx > 0 ? 'collapsed' : ''} fw-bold bg-white" style="color:${info.color}" type="button" data-bs-toggle="collapse" data-bs-target="#monCol${idx}">
                ${tms(secName)} <span class="badge bg-light text-dark ms-2 border">${questions.length}</span>
              </button>
            </h2>
            <div id="monCol${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#monAccordion">
              <div class="accordion-body bg-light p-3">
                <div class="row row-cols-1 row-cols-md-2 g-3">
                  ${questions.map(q => renderMonQuestionCard(q, info.color)).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
        idx++;
      }
      html += `</div>`;

      html += `
        <div class="mb-3 mt-3">
          <label class="fw-bold small mb-1">${t('mon_proposal')}</label>
          <textarea class="form-control" id="mon-proposal" rows="3" placeholder="${t('mon_note_ph')}"></textarea>
        </div>
        <div class="mt-4 text-center">
          <button class="btn btn-lg px-5 fw-bold shadow text-white" style="background:${info.color}" onclick="submitMonitoring()">
            <i class="fas fa-save me-2"></i>${t('mon_save_btn')}
          </button>
        </div>
      `;

      html += `</div></div>`;
      container.html(html);
    }

    function renderMonQuestionCard(q, color) {
      let answerUI = '';
      if (q.type === 'rating3') {
        answerUI = `
          <input type="hidden" class="mon-result" data-qid="${q.id}" value="NA">
          <div class="btn-group w-100 mb-2" role="group">
            <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleMonBtn(this,'${q.id}','Tot')">${t('mon_good')}</button>
            <button type="button" class="btn btn-outline-warning btn-sm" onclick="toggleMonBtn(this,'${q.id}','TB')">${t('mon_average')}</button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="toggleMonBtn(this,'${q.id}','Kem')">${t('mon_poor')}</button>
            <button type="button" class="btn btn-secondary btn-sm active" onclick="toggleMonBtn(this,'${q.id}','NA')">N/A</button>
          </div>`;
      } else if (q.type === 'check') {
        answerUI = `
          <input type="hidden" class="mon-result" data-qid="${q.id}" value="NA">
          <div class="btn-group w-100 mb-2" role="group">
            <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleMonBtn(this,'${q.id}','Co')">${t('mon_yes')}</button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="toggleMonBtn(this,'${q.id}','Khong')">${t('mon_no')}</button>
            <button type="button" class="btn btn-secondary btn-sm active" onclick="toggleMonBtn(this,'${q.id}','NA')">N/A</button>
          </div>`;
      } else {
        answerUI = `
          <input type="hidden" class="mon-result" data-qid="${q.id}" value="">
          <input type="text" class="form-control form-control-sm mb-2 mon-text-input" data-qid="${q.id}" placeholder="${tmq(q.id, q.label)}">`;
      }

      return `
        <div class="col">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body p-3">
              <h6 class="fw-bold mb-3" style="font-size: 12px; min-height: 36px; color:${color}">${tmq(q.id, q.label)}</h6>
              ${answerUI}
              <div class="bg-light p-2 rounded mb-2">
                <textarea class="form-control form-control-sm mon-note border-0 bg-white" rows="1" placeholder="${t('mon_note_ph')}" data-qid="${q.id}" style="resize:none;"></textarea>
              </div>
              <div class="d-flex align-items-center gap-1">
                <label class="btn btn-outline-secondary btn-sm flex-fill mb-0" style="font-size:10px; cursor:pointer">
                  <i class="fas fa-camera me-1"></i>${t('mon_photo')}
                  <input type="file" accept="image/*" capture="environment" class="d-none mon-photo-input" data-qid="${q.id}" onchange="previewMonPhoto(this,'${q.id}')">
                </label>
                <div class="mon-photo-preview d-flex gap-1 flex-wrap" data-qid="${q.id}"></div>
              </div>
              <input type="hidden" class="mon-photo-urls" data-qid="${q.id}" value="">
            </div>
          </div>
        </div>`;
    }

    function previewMonPhoto(input, qid) {
      const files = input.files;
      if (!files || !files.length) return;
      const file = files[0];
      if (file.size > 5 * 1024 * 1024) { alert('Max 5MB'); input.value = ''; return; }

      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = $(`.mon-photo-preview[data-qid="${qid}"]`);
        const idx = preview.find('img').length;
        preview.append(`
          <div class="position-relative" style="width:48px;height:48px">
            <img src="${e.target.result}" class="rounded border" style="width:48px;height:48px;object-fit:cover">
            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0" style="width:16px;height:16px;font-size:8px;line-height:1" onclick="removeMonPhoto(this,'${qid}',${idx})"><i class="fas fa-times"></i></button>
          </div>
        `);
        // Store file data for upload later
        if (!window._monPhotoPending) window._monPhotoPending = {};
        if (!window._monPhotoPending[qid]) window._monPhotoPending[qid] = [];
        window._monPhotoPending[qid].push(file);
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    function removeMonPhoto(btn, qid, idx) {
      $(btn).parent().remove();
      if (window._monPhotoPending && window._monPhotoPending[qid]) {
        window._monPhotoPending[qid].splice(idx, 1);
      }
    }

    function toggleMonBtn(btn, qid, val) {
      const wrapper = $(btn).parent();
      wrapper.find('.btn').removeClass('active btn-success btn-warning btn-danger text-white')
        .each(function() {
          const cl = this.className;
          if (!cl.includes('btn-outline-') && !cl.includes('btn-secondary')) {
            $(this).addClass('btn-outline-' + (cl.includes('success') ? 'success' : cl.includes('warning') ? 'warning' : 'danger'));
          }
        });

      // Reset all buttons
      wrapper.find('.btn').removeClass('active btn-success btn-warning btn-danger text-white');
      wrapper.find('.btn-outline-success').removeClass('btn-success text-white');
      wrapper.find('.btn-outline-warning').removeClass('btn-warning text-white');
      wrapper.find('.btn-outline-danger').removeClass('btn-danger text-white');

      // Apply active
      $(btn).addClass('active');
      if (val === 'Tot' || val === 'Co') $(btn).addClass('btn-success text-white').removeClass('btn-outline-success');
      else if (val === 'TB') $(btn).addClass('btn-warning text-white').removeClass('btn-outline-warning');
      else if (val === 'Kem' || val === 'Khong') $(btn).addClass('btn-danger text-white').removeClass('btn-outline-danger');

      $(`.mon-result[data-qid="${qid}"]`).val(val);
    }

    window.submitMonitoring = async function() {
      const targetId = $('#mon-target-id').val();
      const typeKey = $('#mon-type-key').val();
      const date = $('#mon-date').val();
      const weather = $('#mon-weather').val();
      const area = $('#mon-area').val();
      const representative = $('#mon-representative').val();
      const proposal = $('#mon-proposal').val();

      if (!targetId) return alert(t('mon_select_hint'));

      const today = new Date();
      const yy = today.getFullYear().toString().slice(-2);
      const typeShort = typeKey.substring(0, 3).toUpperCase();
      const idPrefix = `GS_${typeShort}_${targetId}-${yy}`;

      let nextSeq = 1;
      const existing = APP_DATA['GiamSat_LoRung'] || [];
      existing.forEach(row => {
        const rID = String(row['ID'] || '');
        if (rID.startsWith(idPrefix)) {
          const suffix = parseInt(rID.replace(idPrefix, ''), 10);
          if (!isNaN(suffix) && suffix >= nextSeq) nextSeq = suffix + 1;
        }
      });
      const idGS = `${idPrefix}${String(nextSeq).padStart(2, '0')}`;

      // Upload pending photos first
      const pendingPhotos = window._monPhotoPending || {};
      const photoUrls = {};
      for (const [qid, files] of Object.entries(pendingPhotos)) {
        const urls = [];
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const ext = file.name.split('.').pop() || 'jpg';
          const filePath = `monitoring/${idGS}/${qid}_${i}.${ext}`;
          const { data: upData, error: upErr } = await sb.storage.from('fscfm-uploads').upload(filePath, file, { upsert: true });
          if (!upErr && upData) {
            const { data: urlData } = sb.storage.from('fscfm-uploads').getPublicUrl(filePath);
            if (urlData) urls.push(urlData.publicUrl);
          }
        }
        if (urls.length) photoUrls[qid] = urls;
      }
      window._monPhotoPending = {};

      // Prepare answers
      const answers = {};
      $('.mon-result').each(function() {
        const qid = $(this).data('qid');
        let val = $(this).val();
        const note = $(`.mon-note[data-qid="${qid}"]`).val() || '';
        const textInput = $(`.mon-text-input[data-qid="${qid}"]`);
        if (textInput.length) val = textInput.val() || '';
        const ans = { r: val, n: note };
        if (photoUrls[qid]) ans.p = photoUrls[qid];
        answers[qid] = JSON.stringify(ans);
      });

      if (!confirm(t('mon_confirm_save'))) return;

      const btn = $('button[onclick="submitMonitoring()"]');
      btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>...');

      try {
        const info = MONITORING_TYPES[typeKey];
        const gsData = {
          id: idGS,
          loai_giam_sat: typeKey,
          ngay_giam_sat: date,
          nguoi_giam_sat: currentUser['Email'],
          dai_dien_to: representative,
          dien_tich_giam_sat: area ? parseFloat(area) : null,
          thoi_tiet: weather,
          ghi_chu: '',
          de_xuat: proposal
        };

        if (info.target === 'nhom') {
          gsData.id_nhom = targetId;
        } else {
          gsData.id_lo_rung = targetId;
          // Also set nhom from lo_rung
          const plot = (APP_DATA['Lo_rung'] || []).find(p => String(p['ID lô rừng']) === String(targetId));
          if (plot) {
            gsData.id_nhom = plot['ID nhóm'] || null;
            gsData.id_chu_rung = plot['ID chủ rừng'] || null;
          }
        }

        const { error: err1 } = await sb.from('giam_sat_lo_rung').insert(gsData);
        if (err1) throw new Error("Error saving monitoring: " + err1.message);

        // Save answers
        const pad = (n) => String(n).padStart(2, '0');
        const ts = pad(today.getDate()) + pad(today.getMonth() + 1) + yy +
          pad(today.getHours()) + pad(today.getMinutes()) + pad(today.getSeconds());
        const idHoi = `${idGS}-${ts}`;

        const { error: err2 } = await sb.from('bang_hoi_giam_sat').insert({
          id: idHoi, id_giam_sat: idGS, answers: answers
        });
        if (err2) throw new Error("Error saving answers: " + err2.message);

        // Update local data
        if (!APP_DATA['GiamSat_LoRung']) APP_DATA['GiamSat_LoRung'] = [];
        APP_DATA['GiamSat_LoRung'].push({
          'ID': idGS, 'ID lô rừng': gsData.id_lo_rung || '', 'ID nhóm': gsData.id_nhom || '',
          'Loại giám sát': typeKey, 'Ngày giám sát': date, 'Người giám sát': currentUser['Email'],
          'Đại diện tổ': representative, 'Diện tích GS': area, 'Thời tiết': weather,
          'Đề xuất': proposal, 'Cập nhật': new Date().toLocaleString()
        });

        if (!APP_DATA['Banghoi_GiamSat']) APP_DATA['Banghoi_GiamSat'] = [];
        APP_DATA['Banghoi_GiamSat'].push({ 'ID_hoi': idHoi, 'ID_GS': idGS, ...answers });

        alert(t('mon_save_ok'));
        monGoBack();

      } catch (e) {
        alert("Error: " + e.message);
        console.error(e);
      } finally {
        btn.prop('disabled', false).html(`<i class="fas fa-save me-2"></i>${t('mon_save_btn')}`);
      }
    };

    function viewMonitoringDetail(idGS) {
      const gsList = APP_DATA['GiamSat_LoRung'] || [];
      const hoiList = APP_DATA['Banghoi_GiamSat'] || [];

      const gsRecord = gsList.find(r => String(r['ID']) === String(idGS));
      if (!gsRecord) return alert(t('mon_not_found'));

      const hoiRecord = hoiList.find(r => String(r['ID_GS']) === String(idGS));
      const typeKey = gsRecord['Loại giám sát'];
      const info = MONITORING_TYPES[typeKey] || { color: '#666', icon: 'fa-clipboard' };
      const sections = MONITORING_DICTIONARY[typeKey];
      if (!sections) return;

      let targetName = gsRecord['ID lô rừng'] || gsRecord['ID nhóm'] || '';
      if (gsRecord['ID lô rừng']) {
        const p = (APP_DATA['Lo_rung'] || []).find(x => String(x['ID lô rừng']) === String(gsRecord['ID lô rừng']));
        if (p) targetName = p['Mã số lô rừng'] || p['Tên lô rừng'] || targetName;
      } else if (gsRecord['ID nhóm']) {
        targetName = findGroupName(gsRecord['ID nhóm']);
      }

      const container = $('#page-content-dynamic');
      container.empty();

      let html = `
        <div class="card shadow-sm mb-4 border-0">
          <div class="card-header text-white fw-bold py-3" style="background:${info.color}">
            <div class="d-flex justify-content-between align-items-center">
              <span><i class="fas fa-eye me-2"></i>${t('mon_detail_title')}: ${tmt(typeKey)}</span>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-danger fw-bold" onclick="exportMonitoringPDF('${idGS}')"><i class="fas fa-file-pdf me-1"></i>${t('mon_export_pdf')}</button>
                <button class="btn btn-sm btn-light fw-bold" onclick="monGoBack()"><i class="fas fa-arrow-left me-1"></i>${t('mon_back')}</button>
              </div>
            </div>
          </div>
          <div class="card-body bg-light">
            <div class="alert alert-light border shadow-sm mb-4">
              <div class="row">
                <div class="col-md-2"><strong>${t('mon_code')}:</strong> ${gsRecord['ID']}</div>
                <div class="col-md-2"><strong>${t('mon_subject')}:</strong> ${targetName}</div>
                <div class="col-md-2"><strong>${t('mon_date_label')}:</strong> ${gsRecord['Ngày giám sát']}</div>
                <div class="col-md-2"><strong>${t('mon_staff')}:</strong> ${gsRecord['Người giám sát']}</div>
                <div class="col-md-2"><strong>${t('mon_weather')}:</strong> ${gsRecord['Thời tiết'] || ''}</div>
                <div class="col-md-2"><strong>${t('mon_area_label')}:</strong> ${gsRecord['Diện tích GS'] || ''} ha</div>
              </div>
            </div>
            <div class="accordion" id="monDetailAccordion">`;

      let idx = 0;
      for (const [secName, questions] of Object.entries(sections)) {
        html += `
          <div class="accordion-item mb-3 border rounded shadow-sm overflow-hidden">
            <h2 class="accordion-header">
              <button class="accordion-button ${idx > 0 ? 'collapsed' : ''} fw-bold bg-white" style="color:${info.color}" type="button" data-bs-toggle="collapse" data-bs-target="#monDCol${idx}">
                ${tms(secName)}
              </button>
            </h2>
            <div id="monDCol${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#monDetailAccordion">
              <div class="accordion-body bg-light p-3">
                <div class="row row-cols-1 row-cols-md-2 g-3">`;

        questions.forEach(q => {
          let ans = { r: 'NA', n: '' };
          if (hoiRecord && hoiRecord[q.id]) {
            try {
              if (typeof hoiRecord[q.id] === 'string' && hoiRecord[q.id].startsWith('{')) {
                ans = JSON.parse(hoiRecord[q.id]);
              } else {
                ans = { r: hoiRecord[q.id], n: '' };
              }
            } catch (e) { ans = { r: hoiRecord[q.id], n: '' }; }
          }

          let badge = '<span class="badge bg-secondary">N/A</span>';
          if (q.type === 'rating3') {
            if (ans.r === 'Tot') badge = `<span class="badge bg-success">${t('mon_good')}</span>`;
            else if (ans.r === 'TB') badge = `<span class="badge bg-warning text-dark">${t('mon_average')}</span>`;
            else if (ans.r === 'Kem') badge = `<span class="badge bg-danger">${t('mon_poor')}</span>`;
          } else if (q.type === 'check') {
            if (ans.r === 'Co') badge = `<span class="badge bg-success">${t('mon_yes')}</span>`;
            else if (ans.r === 'Khong') badge = `<span class="badge bg-danger">${t('mon_no')}</span>`;
          } else {
            if (ans.r && ans.r !== 'NA' && ans.r !== '') badge = `<span class="badge bg-info text-dark">${ans.r}</span>`;
          }

          html += `
            <div class="col">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-body p-3">
                  <h6 class="fw-bold mb-3 small" style="min-height:36px; color:${info.color}">${tmq(q.id, q.label)}</h6>
                  <div class="mb-2">${badge}</div>
                  ${ans.n ? `<div class="bg-light p-2 rounded small text-dark mt-2 border"><i class="fas fa-comment-alt me-1 text-muted"></i> ${ans.n}</div>` : ''}
                  ${ans.p && ans.p.length ? `<div class="d-flex gap-1 flex-wrap mt-2">${ans.p.map(u => `<a href="${u}" target="_blank"><img src="${u}" class="rounded border" style="width:60px;height:60px;object-fit:cover" title="${t('mon_photo')}"></a>`).join('')}</div>` : ''}
                </div>
              </div>
            </div>`;
        });

        html += `</div></div></div></div>`;
        idx++;
      }

      html += `</div>`;

      if (gsRecord['Đề xuất']) {
        html += `<div class="card border-0 shadow-sm mt-3"><div class="card-body"><strong>${t('mon_proposal')}:</strong><p class="mt-2 mb-0">${gsRecord['Đề xuất']}</p></div></div>`;
      }

      html += `</div></div>`;
      container.html(html);
    }

    // === MONITORING PDF EXPORT ===
    function exportMonitoringPDF(idGS) {
      const gsList = APP_DATA['GiamSat_LoRung'] || [];
      const hoiList = APP_DATA['Banghoi_GiamSat'] || [];
      const gsRecord = gsList.find(r => String(r['ID']) === String(idGS));
      if (!gsRecord) return alert(t('mon_not_found'));

      const hoiRecord = hoiList.find(r => String(r['ID_GS']) === String(idGS));
      const typeKey = gsRecord['Loại giám sát'];
      const info = MONITORING_TYPES[typeKey] || { color: '#666', icon: 'fa-clipboard' };
      const sections = MONITORING_DICTIONARY[typeKey];
      if (!sections) return;

      // Resolve target name
      let targetName = gsRecord['ID lô rừng'] || gsRecord['ID nhóm'] || '';
      let plotInfo = null;
      if (gsRecord['ID lô rừng']) {
        plotInfo = (APP_DATA['Lo_rung'] || []).find(x => String(x['ID lô rừng']) === String(gsRecord['ID lô rừng']));
        if (plotInfo) targetName = plotInfo['Mã số lô rừng'] || plotInfo['Tên lô rừng'] || targetName;
      } else if (gsRecord['ID nhóm']) {
        targetName = findGroupName(gsRecord['ID nhóm']);
      }

      const ownerName = plotInfo ? (plotInfo['Họ tên chủ rừng'] || '') : '';
      const groupName = gsRecord['ID nhóm'] ? findGroupName(gsRecord['ID nhóm']) : '';

      // Build print content
      let rows = '';
      for (const [secName, questions] of Object.entries(sections)) {
        rows += `<tr class="sec-row"><td colspan="5" style="background:${info.color}; color:#fff; font-weight:700; padding:8px 12px; font-size:13px;">${tms(secName)}</td></tr>`;
        questions.forEach((q, qi) => {
          let ans = { r: 'N/A', n: '', p: [] };
          if (hoiRecord && hoiRecord[q.id]) {
            try {
              if (typeof hoiRecord[q.id] === 'string' && hoiRecord[q.id].startsWith('{')) ans = { ...ans, ...JSON.parse(hoiRecord[q.id]) };
              else ans = { r: hoiRecord[q.id], n: '', p: [] };
            } catch(e) { ans = { r: hoiRecord[q.id], n: '', p: [] }; }
          }

          let resultText = ans.r || 'N/A';
          let resultStyle = 'color:#666';
          if (q.type === 'rating3') {
            if (ans.r === 'Tot') { resultText = t('mon_good'); resultStyle = 'color:#2E7D32; font-weight:700'; }
            else if (ans.r === 'TB') { resultText = t('mon_average'); resultStyle = 'color:#E65100; font-weight:700'; }
            else if (ans.r === 'Kem') { resultText = t('mon_poor'); resultStyle = 'color:#C62828; font-weight:700'; }
          } else if (q.type === 'check') {
            if (ans.r === 'Co') { resultText = t('mon_yes'); resultStyle = 'color:#2E7D32; font-weight:700'; }
            else if (ans.r === 'Khong') { resultText = t('mon_no'); resultStyle = 'color:#C62828; font-weight:700'; }
          } else {
            if (ans.r && ans.r !== 'NA' && ans.r !== 'N/A') resultStyle = 'color:#1565C0';
          }

          const photoHtml = (ans.p && ans.p.length) ? ans.p.map(u => `<img src="${u}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;border:1px solid #ddd;margin:2px">`).join('') : '';

          rows += `<tr style="border-bottom:1px solid #eee;">
            <td style="padding:6px 8px; width:35px; text-align:center; color:#999; font-size:11px;">${qi+1}</td>
            <td style="padding:6px 8px; font-size:12px;">${tmq(q.id, q.label)}</td>
            <td style="padding:6px 8px; text-align:center; min-width:70px;"><span style="${resultStyle}">${resultText}</span></td>
            <td style="padding:6px 8px; font-size:11px; color:#555; max-width:180px;">${ans.n || ''}</td>
            <td style="padding:4px; width:140px;">${photoHtml}</td>
          </tr>`;
        });
      }

      const projectName = getSettings().projectName;

      const printHTML = `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<title>${t('mon_pdf_title')} - ${gsRecord['ID']}</title>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Be Vietnam Pro', sans-serif; color:#333; padding:20px; font-size:12px; }
  .project-name { text-align:center; font-size:11px; color:#1B5E20; font-weight:700; letter-spacing:2px; text-transform:uppercase; margin-bottom:8px; }
  .header { text-align:center; margin-bottom:20px; border-bottom:3px solid ${info.color}; padding-bottom:15px; }
  .header h1 { font-size:20px; color:${info.color}; margin-bottom:4px; letter-spacing:1px; }
  .header h2 { font-size:14px; color:#555; font-weight:500; }
  .info-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:20px; background:#f8f9fa; padding:12px; border-radius:6px; border:1px solid #ddd; }
  .info-item { font-size:11px; }
  .info-item strong { color:${info.color}; display:block; font-size:10px; text-transform:uppercase; margin-bottom:2px; }
  table { width:100%; border-collapse:collapse; margin-bottom:16px; }
  table th { background:#f0f0f0; padding:8px; text-align:left; font-size:11px; border-bottom:2px solid #ccc; }
  .sec-row td { page-break-inside:avoid; }
  .proposal-box { background:#FFF8E1; border:1px solid #FFE082; border-left:4px solid #FFA000; padding:12px; margin-top:16px; border-radius:4px; }
  .proposal-box h4 { color:#E65100; margin-bottom:6px; font-size:13px; }
  .signature-section { display:flex; justify-content:space-between; margin-top:40px; padding:0 40px; }
  .signature-box { text-align:center; width:40%; }
  .signature-box .title { font-weight:700; font-size:12px; margin-bottom:6px; color:${info.color}; }
  .signature-box .name { font-size:11px; margin-bottom:60px; }
  .signature-box .line { border-top:1px solid #333; padding-top:4px; font-size:11px; font-style:italic; }
  .footer { margin-top:24px; text-align:center; font-size:10px; color:#999; border-top:1px solid #ddd; padding-top:10px; }
  @media print {
    body { padding:10px; }
    .no-print { display:none !important; }
    table { page-break-inside:auto; }
    tr { page-break-inside:avoid; }
    .signature-section { page-break-inside:avoid; }
  }
</style>
</head><body>
<div class="no-print" style="text-align:center; margin-bottom:16px;">
  <button onclick="window.print()" style="padding:8px 24px; background:${info.color}; color:#fff; border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:14px; font-family:inherit;">
    🖨️ ${t('mon_export_pdf')}
  </button>
</div>
<div class="project-name">${projectName}</div>
<div class="header">
  <h1>${t('mon_pdf_title')}</h1>
  <h2>${tmt(typeKey)}</h2>
</div>
<div class="info-grid">
  <div class="info-item"><strong>${t('mon_code')}</strong>${gsRecord['ID']}</div>
  <div class="info-item"><strong>${t('mon_subject')}</strong>${targetName}</div>
  <div class="info-item"><strong>${t('mon_date_label')}</strong>${gsRecord['Ngày giám sát'] || ''}</div>
  <div class="info-item"><strong>${t('mon_staff')}</strong>${gsRecord['Người giám sát'] || ''}</div>
  <div class="info-item"><strong>${t('mon_weather')}</strong>${gsRecord['Thời tiết'] || ''}</div>
  <div class="info-item"><strong>${t('mon_area_label')}</strong>${gsRecord['Diện tích GS'] || ''} ha</div>
  ${ownerName ? `<div class="info-item"><strong>${t('mon_owner')}</strong>${ownerName}</div>` : ''}
  ${groupName ? `<div class="info-item"><strong>${t('mon_target_group')}</strong>${groupName}</div>` : ''}
  <div class="info-item"><strong>${t('mon_representative')}</strong>${gsRecord['Đại diện tổ'] || ''}</div>
</div>
<table>
  <thead><tr>
    <th style="width:35px">#</th>
    <th>${t('mon_pdf_result')}</th>
    <th style="width:70px; text-align:center">${t('mon_action')}</th>
    <th style="width:180px">${t('mon_pdf_note')}</th>
    <th style="width:140px">${t('mon_photo')}</th>
  </tr></thead>
  <tbody>${rows}</tbody>
</table>
${gsRecord['Đề xuất'] ? `<div class="proposal-box"><h4>${t('mon_proposal')}</h4><p>${gsRecord['Đề xuất']}</p></div>` : ''}
<div class="signature-section">
  <div class="signature-box">
    <div class="title">${t('mon_pdf_owner_rep')}</div>
    <div class="name">${ownerName || gsRecord['Đại diện tổ'] || ''}</div>
    <div class="line">(${t('mon_pdf_sign')})</div>
  </div>
  <div class="signature-box">
    <div class="title">${t('mon_pdf_staff_rep')}</div>
    <div class="name">${gsRecord['Người giám sát'] || ''}</div>
    <div class="line">(${t('mon_pdf_sign')})</div>
  </div>
</div>
<div class="footer">
  ${projectName} — ${gsRecord['ID']} — ${new Date().toLocaleDateString()}
</div>
</body></html>`;

      const printWin = window.open('', '_blank', 'width=900,height=700');
      printWin.document.write(printHTML);
      printWin.document.close();
    }

    // === PLOT/GROUP MONITORING: Action from detail views ===
    let _monReturnContext = null; // stores {type:'plot'|'group', data: d} for back navigation
    let _monTypeFilter = null; // null = show all types, or array of typeKeys from menu navigation

    // Map monitoring sub-menu view names to type filters
    // Inline drill-down for lo_rung-targeting monitoring (like KPI detail)
    function renderMonDrillDown(current) {
      const container = $('#page-content-dynamic');
      container.empty();
      _selectedMonType = (_monTypeFilter && _monTypeFilter.length) ? _monTypeFilter[0] : null;
      const plots = APP_DATA['Lo_rung'] || [];
      const groups = APP_DATA['NhomCCR'] || [];
      const owners = APP_DATA['Churung'] || [];
      const safeFloat = v => parseFloat(String(v || '0').replace(/,/g, '')) || 0;

      // Build lookups
      const ownerNameMap = {};
      owners.forEach(o => { ownerNameMap[o['ID chủ rừng']] = o['Họ tên chủ rừng'] || o['ID chủ rừng']; });
      const plotsByGroup = {}, plotsByOwner = {};
      plots.forEach(p => {
        const gid = p['ID nhóm'], oid = p['ID chủ rừng'];
        if (gid) { if (!plotsByGroup[gid]) plotsByGroup[gid] = []; plotsByGroup[gid].push(p); }
        if (oid) { if (!plotsByOwner[oid]) plotsByOwner[oid] = []; plotsByOwner[oid].push(p); }
      });

      // Aggregate by group
      const groupData = {};
      plots.forEach(p => {
        const gid = p['ID nhóm'];
        if (!gid) return;
        if (!groupData[gid]) groupData[gid] = { name: '', households: new Set(), plotCount: 0, area: 0 };
        groupData[gid].plotCount++;
        groupData[gid].area += safeFloat(p['Tổng diện tích']);
        if (p['ID chủ rừng']) groupData[gid].households.add(p['ID chủ rừng']);
      });
      groups.forEach(g => { if (groupData[g['ID nhóm']]) groupData[g['ID nhóm']].name = g['Tên nhóm'] || g['ID nhóm']; });

      const sorted = Object.entries(groupData).sort((a, b) => b[1].area - a[1].area);
      const totalHH = sorted.reduce((s, [, g]) => s + g.households.size, 0);
      const totalPlots = sorted.reduce((s, [, g]) => s + g.plotCount, 0);
      const totalArea = sorted.reduce((s, [, g]) => s + g.area, 0);

      // Build type selector if multiple monitoring types
      const types = _monTypeFilter || [];
      let typeSelectorHtml = '';
      if (types.length > 1) {
        const opts = types.map((tk, i) => {
          const info = MONITORING_TYPES[tk] || {};
          return `<button class="btn btn-sm fw-bold ${i === 0 ? 'text-white' : 'btn-outline-secondary'}" style="${i === 0 ? 'background:' + (info.color || '#666') : ''}" data-mon-type="${tk}" onclick="selectMonType(this,'${tk}')">
            <i class="fas ${info.icon || 'fa-circle'} me-1"></i>${tmt(tk)}
          </button>`;
        }).join('');
        typeSelectorHtml = `<div class="d-flex gap-2 flex-wrap mb-3 align-items-center">
          <span class="fw-bold text-muted small">Loại giám sát:</span>${opts}
        </div>`;
      }

      let html = typeSelectorHtml + `<div class="table-responsive"><table class="table table-sm table-hover small mb-0" id="monDrillTable">
        <thead class="table-success"><tr>
          <th style="width:30px">#</th><th>Mã nhóm</th><th>Tên nhóm</th>
          <th class="text-end">Số hộ</th><th class="text-end">Số lô</th><th class="text-end">DT (ha)</th>
        </tr></thead><tbody>`;
      sorted.forEach(([gid, g], i) => {
        html += `<tr class="md-group-row" style="cursor:pointer" data-gid="${gid}" title="Bấm để xem hộ dân">
          <td>${i + 1}</td><td><strong>${gid}</strong> <i class="fa-solid fa-chevron-right fa-2xs text-muted md-chev"></i></td><td>${g.name}</td>
          <td class="text-end">${g.households.size}</td><td class="text-end">${g.plotCount}</td><td class="text-end fw-bold">${g.area.toFixed(2)}</td>
        </tr>`;
      });
      html += `</tbody><tfoot class="table-success fw-bold"><tr>
        <td colspan="3">Tổng</td><td class="text-end">${totalHH}</td><td class="text-end">${totalPlots}</td><td class="text-end">${totalArea.toFixed(2)}</td>
      </tr></tfoot></table></div>`;
      container.html(html);

      // Click group → expand owners inline
      $('#monDrillTable').on('click', '.md-group-row', function() {
        const $row = $(this), gid = $row.data('gid'), $chev = $row.find('.md-chev');
        if ($row.hasClass('md-expanded')) {
          $row.removeClass('md-expanded'); $chev.removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $row.nextUntil('.md-group-row').remove(); return;
        }
        $('#monDrillTable .md-expanded').each(function() {
          $(this).removeClass('md-expanded').find('.md-chev').removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $(this).nextUntil('.md-group-row').remove();
        });
        $row.addClass('md-expanded'); $chev.removeClass('fa-chevron-right').addClass('fa-chevron-down');
        const ownerMap = {};
        (plotsByGroup[gid] || []).forEach(p => {
          const oid = p['ID chủ rừng']; if (!oid) return;
          if (!ownerMap[oid]) ownerMap[oid] = { name: ownerNameMap[oid] || oid, plotCount: 0, area: 0 };
          ownerMap[oid].plotCount++; ownerMap[oid].area += safeFloat(p['Tổng diện tích']);
        });
        let ownerHtml = '';
        Object.entries(ownerMap).sort((a, b) => a[0].localeCompare(b[0])).forEach(([oid, o], idx) => {
          ownerHtml += `<tr class="md-owner-row table-light" style="cursor:pointer" data-oid="${oid}" data-gid="${gid}" title="Bấm để xem lô rừng">
            <td></td><td class="ps-3"><i class="fa-solid fa-user text-success fa-xs me-1"></i>${oid} <i class="fa-solid fa-chevron-right fa-2xs text-muted md-chev-o"></i></td>
            <td>${o.name}</td><td class="text-end">${idx + 1}</td><td class="text-end">${o.plotCount}</td><td class="text-end">${o.area.toFixed(2)}</td>
          </tr>`;
        });
        $row.after(ownerHtml);
      });

      // Click owner → expand plots inline
      $('#monDrillTable').on('click', '.md-owner-row', function(e) {
        e.stopPropagation();
        const $row = $(this), oid = $row.data('oid'), gid = $row.data('gid'), $chev = $row.find('.md-chev-o');
        if ($row.hasClass('md-owner-expanded')) {
          $row.removeClass('md-owner-expanded'); $chev.removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $row.nextUntil('.md-owner-row, .md-group-row').remove(); return;
        }
        $row.siblings('.md-owner-expanded[data-gid="' + gid + '"]').each(function() {
          $(this).removeClass('md-owner-expanded').find('.md-chev-o').removeClass('fa-chevron-down').addClass('fa-chevron-right');
          $(this).nextUntil('.md-owner-row, .md-group-row').remove();
        });
        $row.addClass('md-owner-expanded'); $chev.removeClass('fa-chevron-right').addClass('fa-chevron-down');
        const oPlots = (plotsByOwner[oid] || []).filter(p => p['ID nhóm'] === gid);
        let plotHtml = '';
        oPlots.forEach(p => {
          const pid = p['ID lô rừng'] || '';
          const maLo = p['Mã số lô rừng'] || pid;
          plotHtml += `<tr class="md-plot-row" style="font-size:11px;background:#f0faf0">
            <td></td><td class="ps-5"><i class="fa-solid fa-tree text-success fa-xs me-1"></i>${maLo}</td>
            <td>${p['Tên lô rừng'] || ''}</td><td></td>
            <td class="text-end">${safeFloat(p['Tổng diện tích']).toFixed(2)}</td>
            <td class="text-center">
              <button class="btn btn-outline-success btn-sm py-0 px-1" onclick="event.stopPropagation();showOnMap('${pid.replace(/'/g,"\\'")}')"><i class="fa-solid fa-map-location-dot fa-xs"></i></button>
              <button class="btn btn-outline-primary btn-sm py-0 px-1 ms-1" onclick="event.stopPropagation();monStartFromPlot('${pid.replace(/'/g,"\\'")}')"><i class="fa-solid fa-clipboard-check fa-xs"></i></button>
            </td>
          </tr>`;
        });
        if (!oPlots.length) plotHtml = '<tr class="md-plot-row"><td colspan="6" class="text-center text-muted ps-5" style="font-size:11px">Không có lô rừng</td></tr>';
        $row.after(plotHtml);
      });
    }

    let _selectedMonType = null; // Currently selected monitoring sub-type

    window.selectMonType = function(btn, typeKey) {
      _selectedMonType = typeKey;
      // Update button styles
      $(btn).closest('.d-flex').find('button[data-mon-type]').each(function() {
        const tk = $(this).data('mon-type');
        const info = MONITORING_TYPES[tk] || {};
        if (tk === typeKey) {
          $(this).removeClass('btn-outline-secondary').addClass('text-white').css('background', info.color || '#666');
        } else {
          $(this).addClass('btn-outline-secondary').removeClass('text-white').css('background', '');
        }
      });
    };

    window.monStartFromPlot = function(plotId) {
      const typeFilter = _monTypeFilter;
      if (!typeFilter || !typeFilter.length) return;
      const typeKey = _selectedMonType && typeFilter.includes(_selectedMonType) ? _selectedMonType : typeFilter[0];
      const plots = APP_DATA['Lo_rung'] || [];
      const p = plots.find(x => String(x['ID lô rừng']) === String(plotId));
      const targetName = p ? (p['Mã số lô rừng'] || p['Tên lô rừng'] || plotId) : plotId;
      renderMonitoringFormUI(typeKey, plotId, targetName);
    };

    const MONITORING_VIEW_TYPES = {
      'GS_Nhom': ['giam_sat_nhom'],
      'GS_TrongRung': ['trong_rung'],
      'GS_KhaiThac': ['truoc_khai_thac', 'trong_khai_thac', 'sau_khai_thac'],
      'GS_MoiTruong': ['bao_ve_rung', 'hanh_lang_ven_suoi']
    };

    function monGoBack() {
      if (_monReturnContext) {
        if (_monReturnContext.type === 'plot') return showPlotMonitoring(_monReturnContext.data);
        if (_monReturnContext.type === 'group') return showGroupMonitoring(_monReturnContext.data);
      }
      renderMonitoringModule();
    }

    function showPlotMonitoring(d) {
      _monReturnContext = { type: 'plot', data: d };
      const container = $('#page-content-dynamic');
      container.empty();

      const plotId = d['ID lô rừng'];
      const plotName = d['Mã số lô rừng'] || d['Tên lô rừng'] || plotId;
      const ownerName = d['Họ tên chủ rừng'] || '';
      const groupName = findGroupName(d['ID nhóm'] || '');
      const area = d['Diện tích GIS'] || d['Diện tích đăng ký'] || '';

      // Filter history for this plot (also apply type filter if active)
      let gsList = (APP_DATA['GiamSat_LoRung'] || []).filter(r => String(r['ID lô rừng']) === String(plotId));
      if (_monTypeFilter && _monTypeFilter.length > 0) {
        gsList = gsList.filter(r => _monTypeFilter.includes(r['Loại giám sát']));
      }

      // Plot-related monitoring types (exclude giam_sat_nhom, apply filter if active)
      let plotTypes = Object.entries(MONITORING_TYPES).filter(([k, v]) => v.target === 'lo_rung');
      if (_monTypeFilter && _monTypeFilter.length > 0) {
        plotTypes = plotTypes.filter(([k]) => _monTypeFilter.includes(k));
      }

      let html = `
        <div class="card shadow-sm border-0 mb-3">
          <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <h5 class="fw-bold text-success mb-1"><i class="fas fa-clipboard-check me-2"></i>${t('dd_giamsat')}: ${plotName}</h5>
                <span class="text-muted small"><i class="fas fa-user me-1"></i>${ownerName} &nbsp;|&nbsp; <i class="fas fa-layer-group me-1"></i>${groupName} &nbsp;|&nbsp; <i class="fas fa-ruler-combined me-1"></i>${area} ha</span>
              </div>
              <button class="btn btn-outline-secondary btn-sm fw-bold" onclick="navigateBack()"><i class="fas fa-arrow-left me-1"></i>${t('mon_back')}</button>
            </div>
          </div>
          <div class="card-body p-3">
            <h6 class="fw-bold text-muted mb-3"><i class="fas fa-play-circle me-2"></i>${t('mon_start_new')}</h6>
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2 mb-4">`;

      plotTypes.forEach(([typeKey, info]) => {
        const count = gsList.filter(r => r['Loại giám sát'] === typeKey).length;
        html += `
              <div class="col">
                <div class="card h-100 border-0 shadow-sm text-center p-3 mon-type-card"
                     style="cursor:pointer; border-left:4px solid ${info.color}!important; transition:transform 0.15s"
                     onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'"
                     onclick="startPlotMonitoring('${typeKey}')">
                  <i class="fas ${info.icon} fa-2x mb-2" style="color:${info.color}"></i>
                  <div class="fw-bold small" style="color:${info.color}">${tmt(typeKey)}</div>
                  ${count > 0 ? `<span class="badge bg-light text-dark border mt-1">${count} ${t('mon_records')}</span>` : ''}
                </div>
              </div>`;
      });

      html += `</div>`;

      // History table
      html += `<h6 class="fw-bold text-muted mb-2"><i class="fas fa-history me-2"></i>${t('mon_tab_history')} (${gsList.length})</h6>`;
      if (gsList.length === 0) {
        html += `<div class="alert alert-light text-center border"><i class="fas fa-inbox me-2"></i>${t('mon_no_data')}</div>`;
      } else {
        html += `<div class="table-responsive"><table class="table table-sm table-hover align-middle mb-0" id="plotMonTable">
          <thead class="table-light"><tr>
            <th>${t('mon_code')}</th>
            <th>${t('mon_type')}</th>
            <th>${t('mon_date_label')}</th>
            <th>${t('mon_staff')}</th>
            <th>${t('mon_weather')}</th>
            <th></th>
          </tr></thead><tbody>`;
        gsList.sort((a, b) => (b['Ngày giám sát'] || '').localeCompare(a['Ngày giám sát'] || ''));
        gsList.forEach(r => {
          const tKey = r['Loại giám sát'];
          const tInfo = MONITORING_TYPES[tKey] || { color: '#666', icon: 'fa-clipboard' };
          html += `<tr>
            <td class="fw-bold small">${r['ID']}</td>
            <td><span class="badge text-white" style="background:${tInfo.color}"><i class="fas ${tInfo.icon} me-1"></i>${tmt(tKey)}</span></td>
            <td>${r['Ngày giám sát'] || ''}</td>
            <td>${r['Người giám sát'] || ''}</td>
            <td>${r['Thời tiết'] || ''}</td>
            <td><button class="btn btn-sm btn-outline-primary" onclick="viewMonitoringDetail('${r['ID']}')"><i class="fas fa-eye"></i></button></td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      }

      html += `</div></div>`;
      container.html(html);
      if (gsList.length > 5) {
        $('#plotMonTable').DataTable({ paging: true, pageLength: 10, searching: false, info: false, language: { emptyTable: t('mon_no_data') }});
      }
    }

    function startPlotMonitoring(typeKey) {
      if (!_monReturnContext || _monReturnContext.type !== 'plot') return;
      const d = _monReturnContext.data;
      const targetId = d['ID lô rừng'];
      const targetName = d['Mã số lô rừng'] || d['Tên lô rừng'] || targetId;
      renderMonitoringFormUI(typeKey, targetId, targetName);
    }

    function showGroupMonitoring(d) {
      _monReturnContext = { type: 'group', data: d };
      const container = $('#page-content-dynamic');
      container.empty();

      const groupId = d['ID nhóm'];
      const groupName = d['Tên nhóm'] || groupId;

      const gsList = (APP_DATA['GiamSat_LoRung'] || []).filter(r => String(r['ID nhóm']) === String(groupId) && r['Loại giám sát'] === 'giam_sat_nhom');
      const info = MONITORING_TYPES['giam_sat_nhom'];

      let html = `
        <div class="card shadow-sm border-0 mb-3">
          <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <h5 class="fw-bold mb-1" style="color:${info.color}"><i class="fas ${info.icon} me-2"></i>${tmt('giam_sat_nhom')}: ${groupName}</h5>
              </div>
              <button class="btn btn-outline-secondary btn-sm fw-bold" onclick="navigateBack()"><i class="fas fa-arrow-left me-1"></i>${t('mon_back')}</button>
            </div>
          </div>
          <div class="card-body p-3">
            <div class="text-center mb-4">
              <button class="btn btn-lg fw-bold text-white shadow px-5" style="background:${info.color}" onclick="startGroupMonitoring()">
                <i class="fas fa-plus-circle me-2"></i>${t('mon_start_new')}
              </button>
            </div>`;

      html += `<h6 class="fw-bold text-muted mb-2"><i class="fas fa-history me-2"></i>${t('mon_tab_history')} (${gsList.length})</h6>`;
      if (gsList.length === 0) {
        html += `<div class="alert alert-light text-center border"><i class="fas fa-inbox me-2"></i>${t('mon_no_data')}</div>`;
      } else {
        html += `<div class="table-responsive"><table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light"><tr>
            <th>${t('mon_code')}</th>
            <th>${t('mon_date_label')}</th>
            <th>${t('mon_staff')}</th>
            <th></th>
          </tr></thead><tbody>`;
        gsList.sort((a, b) => (b['Ngày giám sát'] || '').localeCompare(a['Ngày giám sát'] || ''));
        gsList.forEach(r => {
          html += `<tr>
            <td class="fw-bold small">${r['ID']}</td>
            <td>${r['Ngày giám sát'] || ''}</td>
            <td>${r['Người giám sát'] || ''}</td>
            <td><button class="btn btn-sm btn-outline-primary" onclick="viewMonitoringDetail('${r['ID']}')"><i class="fas fa-eye"></i></button></td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      }

      html += `</div></div>`;
      container.html(html);
    }

    function startGroupMonitoring() {
      if (!_monReturnContext || _monReturnContext.type !== 'group') return;
      const d = _monReturnContext.data;
      const targetId = d['ID nhóm'];
      const targetName = d['Tên nhóm'] || targetId;
      renderMonitoringFormUI('giam_sat_nhom', targetId, targetName);
    }

    // ============================================================
    // === CONSULTATION MODULE (Tham vấn các bên liên quan) ===
    // ============================================================

    function renderConsultationModule() {
      const container = $('#page-content-dynamic');
      container.empty();

      const html = `
        <div class="card shadow border-0 rounded-4">
          <div class="card-header bg-white border-0 pt-4 px-4">
            <ul class="nav nav-tabs card-header-tabs" id="conTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold text-success" id="con-sessions-tab" data-bs-toggle="tab" data-bs-target="#con-sessions-pane" type="button" role="tab"><i class="fas fa-list me-2"></i>${t('con_sessions')}</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold text-success" id="con-new-tab" data-bs-toggle="tab" data-bs-target="#con-new-pane" type="button" role="tab"><i class="fas fa-plus-circle me-2"></i>${t('con_new_session')}</button>
              </li>
            </ul>
          </div>
          <div class="card-body p-2">
            <div class="tab-content">
              <div class="tab-pane fade show active" id="con-sessions-pane" role="tabpanel">
                <div id="con-sessions-container"></div>
              </div>
              <div class="tab-pane fade" id="con-new-pane" role="tabpanel">
                <div id="con-new-container"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      container.html(html);
      renderConsultationSessions();
      renderConsultationNewForm();
    }

    function renderConsultationSessions() {
      const sessions = APP_DATA['DotThamVan'] || [];
      const responses = APP_DATA['PhanHoiThamVan'] || [];
      const container = $('#con-sessions-container');
      const isAdmin = currentUser && (String(currentUser['Chức vụ']).toLowerCase().includes('admin'));

      if (sessions.length === 0) {
        container.html(`<div class="text-center text-muted py-5"><i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i><br>${t('con_no_sessions')}</div>`);
        return;
      }

      const sorted = [...sessions].sort((a, b) => (b['Năm'] || 0) - (a['Năm'] || 0));
      let html = `<div class="table-responsive"><table class="table table-hover align-middle" id="con-sessions-table">
        <thead class="table-light text-success"><tr>
          <th>${t('con_session_name')}</th>
          <th>${t('con_year')}</th>
          <th>${t('con_status')}</th>
          <th>${t('con_responses')}</th>
          <th></th>
        </tr></thead><tbody>`;

      sorted.forEach(s => {
        const count = responses.filter(r => r['ID đợt'] === s['ID']).length;
        const isOpen = s['Trạng thái'] !== 'Đã đóng';
        const statusBadge = isOpen
          ? `<span class="badge bg-success">${t('con_status_open')}</span>`
          : `<span class="badge bg-secondary">${t('con_status_closed')}</span>`;
        const sId = s['ID'];
        html += `<tr>
          <td class="fw-bold">${s['Tên đợt'] || sId}</td>
          <td>${s['Năm'] || ''}</td>
          <td>${statusBadge}</td>
          <td><span class="badge bg-info text-dark">${count} ${t('con_responses')}</span></td>
          <td>
            <div class="btn-group btn-group-sm">
              ${isOpen ? `<button class="btn btn-outline-primary" onclick="copyConsultationLink('${sId}')" title="${t('con_copy_link')}"><i class="fas fa-link"></i></button>` : ''}
              ${isOpen ? `<button class="btn btn-outline-success" onclick="sendBulkEmail('${sId}')" title="${t('con_send_email')}"><i class="fas fa-envelope"></i></button>` : ''}
              <button class="btn btn-outline-info" onclick="viewConsultationResponses('${sId}')" title="${t('con_view_responses')}"><i class="fas fa-chart-bar"></i></button>
              ${isOpen ? `<button class="btn btn-outline-warning" onclick="closeConsultationSession('${sId}')" title="${t('con_close_session')}"><i class="fas fa-lock"></i></button>` : ''}
              ${isAdmin ? `<button class="btn btn-outline-danger" onclick="deleteConsultationSession('${sId}','${(s['Tên đợt']||sId).replace(/'/g,'\\&#39;')}')" title="${t('btn_delete')}"><i class="fas fa-trash-alt"></i></button>` : ''}
            </div>
          </td>
        </tr>`;
      });
      html += `</tbody></table></div>`;
      container.html(html);

      if ($.fn.DataTable && sorted.length > 5) {
        $('#con-sessions-table').DataTable({
          language: currentLang === 'en' ? {} : { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/vi.json" },
          pageLength: 10, dom: 'ftp', ordering: false
        });
      }
    }

    function renderConsultationNewForm() {
      const container = $('#con-new-container');
      const year = new Date().getFullYear();
      const html = `
        <div class="card bg-light border-0 mb-3">
          <div class="card-body py-4">
            <h6 class="fw-bold text-success mb-3"><i class="fas fa-plus-circle me-2"></i>${t('con_create_btn')}</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="fw-bold small mb-1">${t('con_session_name')}</label>
                <input type="text" class="form-control" id="con-name" value="Tham vấn QLRBV ${year}" placeholder="${t('con_session_name')}">
              </div>
              <div class="col-md-3">
                <label class="fw-bold small mb-1">${t('con_year')}</label>
                <input type="number" class="form-control" id="con-year" value="${year}">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success fw-bold w-100" onclick="createConsultationSession()"><i class="fas fa-check me-1"></i>${t('con_create_btn')}</button>
              </div>
              <div class="col-12">
                <label class="fw-bold small mb-1">${t('con_intro')}</label>
                <textarea class="form-control" id="con-intro" rows="4" placeholder="Xin chân thành cảm ơn quý vị đã đọc bản Báo cáo tóm tắt Phương án quản lý rừng bền vững..."></textarea>
              </div>
            </div>
          </div>
        </div>
      `;
      container.html(html);
    }

    async function createConsultationSession() {
      const name = $('#con-name').val().trim();
      const year = parseInt($('#con-year').val()) || new Date().getFullYear();
      const intro = $('#con-intro').val().trim();
      if (!name) { alert('Vui lòng nhập tên đợt tham vấn'); return; }

      const existing = APP_DATA['DotThamVan'] || [];
      const seq = existing.filter(s => (s['Năm'] || 0) == year).length + 1;
      const id = `TV_${year}_${String(seq).padStart(3, '0')}`;
      const staff = currentUser ? (currentUser['Họ và tên'] || currentUser['Username'] || '') : '';

      const insertData = { id, ten_dot: name, nam: year, noi_dung_gioi_thieu: intro, trang_thai: 'Đang mở', nguoi_tao: staff };
      const { error } = await sb.from('dot_tham_van').insert(insertData);
      if (error) { alert('Lỗi: ' + error.message); return; }

      if (!APP_DATA['DotThamVan']) APP_DATA['DotThamVan'] = [];
      APP_DATA['DotThamVan'].push({ 'ID': id, 'Tên đợt': name, 'Năm': year, 'Nội dung giới thiệu': intro, 'Trạng thái': 'Đang mở', 'Người tạo': staff });

      renderConsultationModule();
      // Switch to sessions tab and show the new session
      setTimeout(() => { $('#con-sessions-tab').tab('show'); }, 100);
    }

    function getConsultationLink(idDot) {
      const base = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
      return `${base}consultation.html?dot=${encodeURIComponent(idDot)}`;
    }

    function copyConsultationLink(idDot) {
      const link = getConsultationLink(idDot);
      navigator.clipboard.writeText(link).then(() => {
        alert(t('con_link_copied'));
      }).catch(() => {
        prompt('Copy link:', link);
      });
    }

    function sendBulkEmail(idDot) {
      const session = (APP_DATA['DotThamVan'] || []).find(s => s['ID'] === idDot);
      const stakeholders = APP_DATA['BenLienQuan'] || [];
      if (!session) return;

      const link = getConsultationLink(idDot);
      const container = $('#page-content-dynamic');

      let listHtml = '';
      stakeholders.forEach(s => {
        const checked = s['Email'] ? 'checked' : '';
        listHtml += `<div class="form-check">
          <input class="form-check-input con-email-check" type="checkbox" value="${s['ID']}" data-email="${s['Email'] || ''}" ${checked} id="chk_${s['ID']}">
          <label class="form-check-label" for="chk_${s['ID']}">${s['Tên tổ chức'] || ''} — ${s['Người đại diện'] || ''} (${s['Email'] || 'N/A'})</label>
        </div>`;
      });

      if (stakeholders.length === 0) {
        listHtml = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Chưa có bên liên quan nào. Hãy thêm tại menu "Danh sách bên liên quan" trước.</div>`;
      }

      const html = `
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="fw-bold text-success mb-0"><i class="fas fa-envelope me-2"></i>${t('con_send_email')}: ${session['Tên đợt']}</h5>
              <button class="btn btn-outline-secondary btn-sm" onclick="renderConsultationModule()"><i class="fas fa-arrow-left me-1"></i>${t('mon_back')}</button>
            </div>
          </div>
          <div class="card-body">
            <div class="alert alert-info mb-3"><i class="fas fa-link me-2"></i>Link form: <a href="${link}" target="_blank" class="fw-bold">${link}</a></div>
            <h6 class="fw-bold mb-3">Chọn tổ chức gửi email:</h6>
            ${listHtml}
            ${stakeholders.length > 0 ? `
            <div class="mt-3">
              <button class="btn btn-success fw-bold" onclick="executeBulkEmail('${idDot}')"><i class="fas fa-paper-plane me-2"></i>${t('con_send_all')}</button>
            </div>` : ''}
          </div>
        </div>
      `;
      container.html(html);
    }

    function executeBulkEmail(idDot) {
      const session = (APP_DATA['DotThamVan'] || []).find(s => s['ID'] === idDot);
      if (!session) return;
      const link = getConsultationLink(idDot);

      const emails = [];
      $('.con-email-check:checked').each(function() {
        const email = $(this).data('email');
        if (email) emails.push(email);
      });

      if (emails.length === 0) { alert('Không có email nào được chọn.'); return; }

      const subject = encodeURIComponent(`Tham vấn quản lý rừng FSC - ${session['Tên đợt']}`);
      const body = encodeURIComponent(
        `Kính gửi Quý cơ quan,\n\n` +
        `Chúng tôi kính mời Quý cơ quan tham gia đợt tham vấn về hoạt động quản lý rừng FSC.\n\n` +
        `${session['Nội dung giới thiệu'] || ''}\n\n` +
        `Vui lòng truy cập link sau để điền phiếu tham vấn:\n${link}\n\n` +
        `Trân trọng cảm ơn.\n\nBan quản lý CCR - Nhóm hộ chứng chỉ rừng FSC`
      );
      window.open(`mailto:?bcc=${emails.join(',')}&subject=${subject}&body=${body}`);
    }

    async function closeConsultationSession(idDot) {
      if (!confirm('Đóng đợt tham vấn này? Sẽ không nhận phản hồi mới.')) return;
      const { error } = await sb.from('dot_tham_van').update({ trang_thai: 'Đã đóng' }).eq('id', idDot);
      if (error) { alert('Lỗi: ' + error.message); return; }
      const s = (APP_DATA['DotThamVan'] || []).find(s => s['ID'] === idDot);
      if (s) s['Trạng thái'] = 'Đã đóng';
      renderConsultationModule();
    }

    async function deleteConsultationSession(idDot, tenDot) {
      const isAdmin = currentUser && (String(currentUser['Chức vụ']).toLowerCase().includes('admin'));
      if (!isAdmin) { alert('Chỉ Admin mới có quyền xóa đợt tham vấn.'); return; }

      const responses = (APP_DATA['PhanHoiThamVan'] || []).filter(r => r['ID đợt'] === idDot);
      const msg = responses.length > 0
        ? `Xóa đợt "${tenDot}" cùng ${responses.length} phản hồi? Hành động này không thể hoàn tác!`
        : `Xóa đợt "${tenDot}"? Hành động này không thể hoàn tác!`;
      if (!confirm(msg)) return;

      // Delete responses first (CASCADE should handle, but explicit for safety)
      if (responses.length > 0) {
        const { error: rErr } = await sb.from('phan_hoi_tham_van').delete().eq('id_dot', idDot);
        if (rErr) { alert('Lỗi xóa phản hồi: ' + rErr.message); return; }
      }

      const { error } = await sb.from('dot_tham_van').delete().eq('id', idDot);
      if (error) { alert('Lỗi xóa đợt: ' + error.message); return; }

      // Update local data
      APP_DATA['DotThamVan'] = (APP_DATA['DotThamVan'] || []).filter(s => s['ID'] !== idDot);
      APP_DATA['PhanHoiThamVan'] = (APP_DATA['PhanHoiThamVan'] || []).filter(r => r['ID đợt'] !== idDot);
      renderConsultationModule();
    }

    function viewConsultationResponses(idDot) {
      const session = (APP_DATA['DotThamVan'] || []).find(s => s['ID'] === idDot);
      const responses = (APP_DATA['PhanHoiThamVan'] || []).filter(r => r['ID đợt'] === idDot);
      const container = $('#page-content-dynamic');

      let html = `
        <div class="card shadow-sm border-0 mb-3">
          <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <h5 class="fw-bold text-success mb-1"><i class="fas fa-chart-bar me-2"></i>${t('con_summary')}: ${session ? session['Tên đợt'] : idDot}</h5>
                <span class="text-muted small">${responses.length} ${t('con_responses')}</span>
              </div>
              <button class="btn btn-outline-secondary btn-sm" onclick="renderConsultationModule()"><i class="fas fa-arrow-left me-1"></i>${t('mon_back')}</button>
            </div>
          </div>
          <div class="card-body p-3">`;

      if (responses.length === 0) {
        html += `<div class="alert alert-light text-center border"><i class="fas fa-inbox me-2"></i>${t('con_no_responses')}</div>`;
      } else {
        // Summary statistics for rating questions
        html += `<h6 class="fw-bold text-success mb-3"><i class="fas fa-poll me-2"></i>${t('con_section_b1')}</h6>`;
        html += `<div class="table-responsive mb-4"><table class="table table-sm table-bordered align-middle"><thead class="table-light"><tr><th>#</th><th>Câu hỏi</th><th class="text-center text-success">${t('con_good')}</th><th class="text-center text-warning">${t('con_moderate')}</th><th class="text-center text-danger">${t('con_poor')}</th></tr></thead><tbody>`;

        const ratingQs = CONSULTATION_DICTIONARY["B-I. Đánh giá hoạt động quản lý rừng"] || [];
        ratingQs.forEach((q, idx) => {
          let good = 0, mod = 0, poor = 0;
          responses.forEach(r => {
            try {
              const ans = r[q.id] ? (typeof r[q.id] === 'string' && r[q.id].startsWith('{') ? JSON.parse(r[q.id]) : { r: r[q.id] }) : null;
              if (ans) {
                if (ans.r === 'Tot') good++;
                else if (ans.r === 'VuaPhai') mod++;
                else if (ans.r === 'ChuaTot') poor++;
              }
            } catch(e) {}
          });
          html += `<tr><td>${idx + 1}</td><td class="small">${q.label}</td><td class="text-center fw-bold text-success">${good || '-'}</td><td class="text-center fw-bold text-warning">${mod || '-'}</td><td class="text-center fw-bold text-danger">${poor || '-'}</td></tr>`;
        });
        html += `</tbody></table></div>`;

        // Yes/No summary
        html += `<h6 class="fw-bold text-success mb-3"><i class="fas fa-check-circle me-2"></i>${t('con_section_c')}</h6>`;
        html += `<div class="table-responsive mb-4"><table class="table table-sm table-bordered align-middle"><thead class="table-light"><tr><th>#</th><th>Câu hỏi</th><th class="text-center text-success">${t('con_yes')}</th><th class="text-center text-danger">${t('con_no')}</th></tr></thead><tbody>`;

        const ynQs = CONSULTATION_DICTIONARY["C. Giá trị bảo tồn cao"] || [];
        ynQs.forEach((q, idx) => {
          let yes = 0, no = 0;
          responses.forEach(r => {
            try {
              const ans = r[q.id] ? (typeof r[q.id] === 'string' && r[q.id].startsWith('{') ? JSON.parse(r[q.id]) : { r: r[q.id] }) : null;
              if (ans) {
                if (ans.r === 'Co') yes++;
                else if (ans.r === 'Khong') no++;
              }
            } catch(e) {}
          });
          html += `<tr><td>${idx + 1}</td><td class="small">${q.label}</td><td class="text-center fw-bold text-success">${yes || '-'}</td><td class="text-center fw-bold text-danger">${no || '-'}</td></tr>`;
        });
        html += `</tbody></table></div>`;

        // Individual responses
        html += `<h6 class="fw-bold text-success mb-3"><i class="fas fa-users me-2"></i>Phản hồi chi tiết</h6>`;
        html += `<div class="accordion" id="conResAccordion">`;
        responses.forEach((r, idx) => {
          html += `<div class="accordion-item mb-2 border rounded shadow-sm overflow-hidden">
            <h2 class="accordion-header"><button class="accordion-button ${idx > 0 ? 'collapsed' : ''} fw-bold bg-white text-success py-2" type="button" data-bs-toggle="collapse" data-bs-target="#conRes${idx}">
              ${r['Người trả lời'] || 'Ẩn danh'} — ${r['Ngày phản hồi'] || ''}
            </button></h2>
            <div id="conRes${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#conResAccordion">
              <div class="accordion-body small">
                <p><strong>${t('con_address')}:</strong> ${r['Địa chỉ'] || '-'} | <strong>${t('con_phone')}:</strong> ${r['Điện thoại'] || '-'}</p>`;

          // Show answers
          for (const [section, questions] of Object.entries(CONSULTATION_DICTIONARY)) {
            html += `<h6 class="fw-bold mt-2">${section}</h6>`;
            questions.forEach(q => {
              let ans = { r: '-', n: '' };
              try {
                if (r[q.id]) ans = typeof r[q.id] === 'string' && r[q.id].startsWith('{') ? JSON.parse(r[q.id]) : { r: r[q.id], n: '' };
              } catch(e) {}

              let display = ans.r || '-';
              if (q.type === 'rating') {
                const rMap = { 'Tot': `<span class="badge bg-success">${t('con_good')}</span>`, 'VuaPhai': `<span class="badge bg-warning text-dark">${t('con_moderate')}</span>`, 'ChuaTot': `<span class="badge bg-danger">${t('con_poor')}</span>` };
                display = rMap[ans.r] || `<span class="badge bg-light text-dark">${ans.r || '-'}</span>`;
              } else if (q.type === 'yesno') {
                const yMap = { 'Co': `<span class="badge bg-success">${t('con_yes')}</span>`, 'Khong': `<span class="badge bg-danger">${t('con_no')}</span>` };
                display = yMap[ans.r] || `<span class="badge bg-light text-dark">${ans.r || '-'}</span>`;
              } else {
                display = ans.r || '-';
              }

              html += `<div class="mb-1"><strong>${q.label}</strong><br>${display}`;
              if (ans.n) html += ` <em class="text-muted ms-2">${ans.n}</em>`;
              html += `</div>`;
            });
          }
          html += `</div></div></div>`;
        });
        html += `</div>`;
      }

      html += `</div></div>`;
      container.html(html);
    }

    // ============================================================
    // === CONSULTATION REPORT (Báo cáo tham vấn) ===
    // ============================================================

    function renderConsultationReport() {
      const container = $('#page-content-dynamic');
      container.empty();
      const sessions = APP_DATA['DotThamVan'] || [];

      let html = `
        <div class="card shadow border-0 rounded-4">
          <div class="card-header bg-white border-0 pt-4 px-4">
            <h5 class="fw-bold text-success mb-3"><i class="fas fa-chart-bar me-2"></i>${t('rpt_title')}</h5>
            <div class="row align-items-end g-2 mb-2">
              <div class="col-md-6">
                <label class="form-label small fw-bold">${t('rpt_select_session')}</label>
                <select class="form-select" id="rpt-session-select">
                  <option value="">-- ${t('rpt_select_session')} --</option>
                  ${sessions.map(s => `<option value="${s['ID']}">${s['Tên đợt']} (${s['Năm'] || ''})</option>`).join('')}
                </select>
              </div>
              <div class="col-auto">
                <button class="btn btn-success" onclick="generateConsultationReport()"><i class="fas fa-file-alt me-1"></i>${t('rpt_generate')}</button>
              </div>
              <div class="col-auto">
                <button class="btn btn-outline-primary" onclick="exportConsultationReportPDF()" id="rpt-export-btn" disabled><i class="fas fa-file-pdf me-1"></i>${t('rpt_export_pdf')}</button>
              </div>
            </div>
          </div>
          <div class="card-body p-3" id="rpt-content">
            <div class="text-center text-muted py-5"><i class="fas fa-chart-pie fa-3x mb-3 opacity-25"></i><p>${t('rpt_select_session')}</p></div>
          </div>
        </div>`;

      container.html(html);
    }

    function generateConsultationReport() {
      const idDot = $('#rpt-session-select').val();
      if (!idDot) return;

      const session = (APP_DATA['DotThamVan'] || []).find(s => s['ID'] === idDot);
      const responses = (APP_DATA['PhanHoiThamVan'] || []).filter(r => r['ID đợt'] === idDot);
      const stakeholders = APP_DATA['BenLienQuan'] || [];
      const rptContainer = $('#rpt-content');

      if (!session) return;

      if (responses.length === 0) {
        rptContainer.html(`<div class="alert alert-warning text-center"><i class="fas fa-exclamation-triangle me-2"></i>${t('rpt_no_data')}</div>`);
        return;
      }

      const totalStakeholders = stakeholders.length;
      const totalResponses = responses.length;
      const nonRespondents = totalStakeholders - totalResponses;
      const responseRate = totalStakeholders > 0 ? ((totalResponses / totalStakeholders) * 100).toFixed(1) : 0;

      // === Identify non-respondent stakeholders ===
      const respondentBLQIds = new Set(responses.map(r => r['ID BLQ']).filter(Boolean));
      const nonRespondentList = stakeholders.filter(s => !respondentBLQIds.has(s['ID']));

      // === Analyze rating questions (ONLY from actual respondents) ===
      const ratingQs = CONSULTATION_DICTIONARY["B-I. Đánh giá hoạt động quản lý rừng"] || [];
      const ratingStats = ratingQs.map(q => {
        let good = 0, mod = 0, poor = 0;
        responses.forEach(r => {
          try {
            const ans = r[q.id] ? (typeof r[q.id] === 'string' && r[q.id].startsWith('{') ? JSON.parse(r[q.id]) : { r: r[q.id] }) : null;
            if (ans) {
              if (ans.r === 'Tot') good++;
              else if (ans.r === 'VuaPhai') mod++;
              else if (ans.r === 'ChuaTot') poor++;
            }
          } catch(e) {}
        });
        const total = good + mod + poor;
        return { ...q, good, mod, poor, total, goodPct: total > 0 ? (good / total * 100).toFixed(1) : 0, poorPct: total > 0 ? (poor / total * 100).toFixed(1) : 0 };
      });

      // Strengths: >60% Tốt (only from respondents)
      const strengths = ratingStats.filter(s => s.total > 0 && parseFloat(s.goodPct) >= 60);
      // Weaknesses: >30% Chưa tốt or <40% Tốt (only from respondents who answered)
      const weaknesses = ratingStats.filter(s => s.total > 0 && (parseFloat(s.poorPct) >= 30 || parseFloat(s.goodPct) < 40));

      // Overall positive/negative (only from respondents)
      const totalRatings = ratingStats.reduce((s, q) => s + q.total, 0);
      const totalGood = ratingStats.reduce((s, q) => s + q.good, 0);
      const totalPoor = ratingStats.reduce((s, q) => s + q.poor, 0);
      const overallPositive = totalRatings > 0 ? (totalGood / totalRatings * 100).toFixed(1) : 0;
      const overallNegative = totalRatings > 0 ? (totalPoor / totalRatings * 100).toFixed(1) : 0;

      // === Analyze yes/no questions (ONLY from actual respondents) ===
      const ynQs = CONSULTATION_DICTIONARY["C. Giá trị bảo tồn cao"] || [];
      const ynStats = ynQs.map(q => {
        let yes = 0, no = 0;
        responses.forEach(r => {
          try {
            const ans = r[q.id] ? (typeof r[q.id] === 'string' && r[q.id].startsWith('{') ? JSON.parse(r[q.id]) : { r: r[q.id] }) : null;
            if (ans) {
              if (ans.r === 'Co') yes++;
              else if (ans.r === 'Khong') no++;
            }
          } catch(e) {}
        });
        const total = yes + no;
        return { ...q, yes, no, total, yesPct: total > 0 ? (yes / total * 100).toFixed(1) : 0 };
      });

      // === Collect text responses ===
      const textQs = CONSULTATION_DICTIONARY["B-II. Vấn đề và kiến nghị"] || [];
      const textResponses = textQs.map(q => {
        const texts = [];
        responses.forEach(r => {
          try {
            const ans = r[q.id] ? (typeof r[q.id] === 'string' && r[q.id].startsWith('{') ? JSON.parse(r[q.id]) : { r: r[q.id] }) : null;
            if (ans && ans.r && ans.r !== '-') texts.push({ name: r['Người trả lời'] || 'Ẩn danh', text: ans.r });
          } catch(e) {}
        });
        return { ...q, texts };
      });

      // === Build report HTML ===
      let rpt = `<div id="rpt-printable">`;

      // Header
      rpt += `<div class="text-center mb-4 border-bottom pb-3">
        <h4 class="fw-bold text-success">${t('rpt_title')}</h4>
        <h5>${session['Tên đợt']} — ${session['Năm'] || ''}</h5>
        <p class="text-muted small">${session['Nội dung giới thiệu'] || ''}</p>
      </div>`;

      // 1. Overview - clearly separate respondents vs non-respondents
      rpt += `<h5 class="fw-bold text-success mb-3"><i class="fas fa-info-circle me-2"></i>1. ${t('rpt_overview')}</h5>`;
      rpt += `<div class="row g-3 mb-3">
        <div class="col-md-3"><div class="border rounded p-3 text-center"><div class="fs-2 fw-bold text-primary">${totalResponses}</div><div class="small text-muted">${currentLang === 'vi' ? 'Phản hồi' : 'Responses'}</div></div></div>
        <div class="col-md-3"><div class="border rounded p-3 text-center"><div class="fs-2 fw-bold text-info">${totalStakeholders}</div><div class="small text-muted">${t('rpt_stakeholders')}</div></div></div>
        <div class="col-md-3"><div class="border rounded p-3 text-center"><div class="fs-2 fw-bold text-success">${responseRate}%</div><div class="small text-muted">${t('rpt_response_rate')}</div></div></div>
        <div class="col-md-3"><div class="border rounded p-3 text-center"><div class="fs-2 fw-bold text-warning">${overallPositive}%</div><div class="small text-muted">${currentLang === 'vi' ? 'Đánh giá tích cực' : 'Positive rating'}</div></div></div>
      </div>`;
      rpt += `<div class="alert alert-info border-0 rounded-3 small mb-4"><i class="fas fa-info-circle me-2"></i>${currentLang === 'vi'
        ? '<strong>Lưu ý:</strong> Tất cả số liệu phân tích bên dưới chỉ được tính dựa trên <strong>' + totalResponses + ' bên liên quan đã phản hồi</strong>. Các bên không phản hồi (' + nonRespondents + ') được liệt kê riêng ở mục cuối báo cáo.'
        : '<strong>Note:</strong> All analysis below is based only on <strong>' + totalResponses + ' respondents</strong>. Non-respondents (' + nonRespondents + ') are listed separately at the end.'}</div>`;

      // 2. Rating analysis table (only from respondents)
      rpt += `<h5 class="fw-bold text-success mb-3"><i class="fas fa-poll me-2"></i>2. ${t('rpt_rating_analysis')}</h5>`;
      rpt += `<p class="small text-muted mb-2">${currentLang === 'vi' ? 'Cơ sở phân tích: ' + totalResponses + ' phản hồi' : 'Analysis base: ' + totalResponses + ' responses'}</p>`;
      rpt += `<div class="table-responsive mb-4"><table class="table table-sm table-bordered align-middle">
        <thead class="table-success"><tr><th style="width:40px">#</th><th>${currentLang === 'vi' ? 'Tiêu chí đánh giá' : 'Evaluation Criteria'}</th>
        <th class="text-center" style="width:80px">${t('con_good')}</th><th class="text-center" style="width:80px">${t('con_moderate')}</th><th class="text-center" style="width:80px">${t('con_poor')}</th>
        <th class="text-center" style="width:60px">N</th>
        <th class="text-center" style="width:100px">% ${t('con_good')}</th></tr></thead><tbody>`;
      ratingStats.forEach((s, idx) => {
        const barColor = parseFloat(s.goodPct) >= 60 ? '#4CAF50' : parseFloat(s.goodPct) >= 40 ? '#FF9800' : '#f44336';
        rpt += `<tr>
          <td>${idx + 1}</td><td class="small">${s.label}</td>
          <td class="text-center fw-bold text-success">${s.good}</td>
          <td class="text-center fw-bold text-warning">${s.mod}</td>
          <td class="text-center fw-bold text-danger">${s.poor}</td>
          <td class="text-center text-muted">${s.total}</td>
          <td><div class="d-flex align-items-center gap-1"><div class="progress flex-grow-1" style="height:16px"><div class="progress-bar" style="width:${s.goodPct}%;background:${barColor}">${s.goodPct}%</div></div></div></td>
        </tr>`;
      });
      rpt += `</tbody></table></div>`;

      // 3. Strengths
      rpt += `<h5 class="fw-bold text-success mb-3"><i class="fas fa-thumbs-up me-2"></i>3. ${t('rpt_strengths')}</h5>`;
      if (strengths.length > 0) {
        rpt += `<div class="alert alert-success border-0 rounded-3"><ul class="mb-0">`;
        strengths.forEach(s => {
          rpt += `<li><strong>${s.label}</strong> — ${s.goodPct}% ${t('con_good')} (n=${s.total})</li>`;
        });
        rpt += `</ul></div>`;
      } else {
        rpt += `<p class="text-muted">${currentLang === 'vi' ? 'Chưa có tiêu chí nào đạt mức thuận lợi rõ ràng (>60% Tốt).' : 'No criteria clearly rated as favorable (>60% Good).'}</p>`;
      }

      // 4. Weaknesses / Risks
      rpt += `<h5 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>4. ${currentLang === 'vi' ? 'Điểm yếu và rủi ro' : 'Weaknesses & Risks'}</h5>`;
      if (weaknesses.length > 0) {
        rpt += `<div class="alert alert-danger border-0 rounded-3"><ul class="mb-0">`;
        weaknesses.forEach(s => {
          rpt += `<li><strong>${s.label}</strong> — ${s.poorPct}% ${t('con_poor')}, ${s.goodPct}% ${t('con_good')} (n=${s.total})</li>`;
        });
        rpt += `</ul></div>`;
      } else {
        rpt += `<p class="text-muted">${currentLang === 'vi' ? 'Không có tiêu chí nào đánh giá tiêu cực đáng kể.' : 'No criteria with significant negative ratings.'}</p>`;
      }

      // 5. Objective/Subjective analysis
      rpt += `<h5 class="fw-bold text-primary mb-3"><i class="fas fa-balance-scale me-2"></i>5. ${t('rpt_objective')} / ${t('rpt_subjective')}</h5>`;
      rpt += `<div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card border-info h-100">
            <div class="card-header bg-info bg-opacity-10 fw-bold"><i class="fas fa-cloud-sun me-2"></i>${t('rpt_objective')}</div>
            <div class="card-body small"><ul>
              <li>${currentLang === 'vi' ? 'Điều kiện tự nhiên, khí hậu, địa hình ảnh hưởng đến hoạt động trồng rừng' : 'Natural conditions, climate, terrain affecting afforestation'}</li>
              <li>${currentLang === 'vi' ? 'Chính sách pháp luật về lâm nghiệp và chứng chỉ rừng' : 'Forestry and forest certification legal policies'}</li>
              <li>${currentLang === 'vi' ? 'Thị trường tiêu thụ sản phẩm gỗ rừng trồng' : 'Market conditions for planted forest timber products'}</li>
              ${parseFloat(overallPositive) >= 60 ? `<li><strong class="text-success">${currentLang === 'vi' ? 'Kết quả đánh giá tích cực (' + overallPositive + '%) phản ánh môi trường quản lý thuận lợi' : 'Positive evaluation (' + overallPositive + '%) reflects favorable management environment'}</strong></li>` : ''}
              ${parseFloat(overallNegative) >= 20 ? `<li><strong class="text-danger">${currentLang === 'vi' ? 'Tỉ lệ đánh giá tiêu cực (' + overallNegative + '%) cần xem xét các yếu tố ngoại cảnh' : 'Negative rate (' + overallNegative + '%) needs external factor review'}</strong></li>` : ''}
            </ul></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-warning h-100">
            <div class="card-header bg-warning bg-opacity-10 fw-bold"><i class="fas fa-user-cog me-2"></i>${t('rpt_subjective')}</div>
            <div class="card-body small"><ul>
              <li>${currentLang === 'vi' ? 'Năng lực quản lý và điều hành của ban quản lý nhóm' : 'Management capacity of the group management board'}</li>
              <li>${currentLang === 'vi' ? 'Nhận thức và cam kết của thành viên nhóm hộ' : 'Awareness and commitment of group members'}</li>
              <li>${currentLang === 'vi' ? 'Hiệu quả của các hoạt động đào tạo, tập huấn' : 'Effectiveness of training activities'}</li>
              ${strengths.length > 0 ? `<li><strong class="text-success">${currentLang === 'vi' ? strengths.length + ' tiêu chí đạt kết quả thuận lợi nhờ nỗ lực chủ quan' : strengths.length + ' criteria achieved favorable results through subjective efforts'}</strong></li>` : ''}
              ${weaknesses.length > 0 ? `<li><strong class="text-warning">${currentLang === 'vi' ? weaknesses.length + ' tiêu chí cần cải thiện — cần tăng cường năng lực nội bộ' : weaknesses.length + ' criteria need improvement — internal capacity building needed'}</strong></li>` : ''}
            </ul></div>
          </div>
        </div>
      </div>`;

      // 6. HCV Analysis
      rpt += `<h5 class="fw-bold text-success mb-3"><i class="fas fa-shield-alt me-2"></i>6. ${t('rpt_hcv_analysis')}</h5>`;
      rpt += `<div class="table-responsive mb-4"><table class="table table-sm table-bordered align-middle">
        <thead class="table-success"><tr><th style="width:40px">#</th><th>${currentLang === 'vi' ? 'Tiêu chí' : 'Criteria'}</th>
        <th class="text-center" style="width:80px">${t('con_yes')}</th><th class="text-center" style="width:80px">${t('con_no')}</th>
        <th class="text-center" style="width:60px">N</th>
        <th class="text-center" style="width:100px">% ${t('con_yes')}</th></tr></thead><tbody>`;
      ynStats.forEach((s, idx) => {
        rpt += `<tr><td>${idx + 1}</td><td class="small">${s.label}</td>
          <td class="text-center fw-bold text-success">${s.yes}</td>
          <td class="text-center fw-bold text-danger">${s.no}</td>
          <td class="text-center text-muted">${s.total}</td>
          <td class="text-center"><span class="badge ${parseFloat(s.yesPct) >= 50 ? 'bg-success' : 'bg-secondary'}">${s.yesPct}%</span></td>
        </tr>`;
      });
      rpt += `</tbody></table></div>`;

      // 7. Text responses (opinions, recommendations)
      rpt += `<h5 class="fw-bold text-success mb-3"><i class="fas fa-comment-dots me-2"></i>7. ${currentLang === 'vi' ? 'Ý kiến và kiến nghị' : 'Opinions & Recommendations'}</h5>`;
      textResponses.forEach(q => {
        if (q.texts.length === 0) return;
        rpt += `<h6 class="fw-bold mt-3 mb-2">${q.label}</h6>`;
        rpt += `<div class="list-group mb-3">`;
        q.texts.forEach(tx => {
          rpt += `<div class="list-group-item"><strong>${tx.name}:</strong> ${tx.text}</div>`;
        });
        rpt += `</div>`;
      });

      // 8. Non-respondents section
      rpt += `<h5 class="fw-bold text-secondary mb-3"><i class="fas fa-user-slash me-2"></i>8. ${currentLang === 'vi' ? 'Các bên liên quan chưa phản hồi' : 'Non-respondent Stakeholders'}</h5>`;
      if (nonRespondentList.length > 0) {
        rpt += `<div class="alert alert-secondary border-0 rounded-3 small mb-3">
          <i class="fas fa-info-circle me-2"></i>${currentLang === 'vi'
            ? '<strong>' + nonRespondentList.length + '/' + totalStakeholders + '</strong> bên liên quan chưa gửi phản hồi. Các lý do khách quan có thể bao gồm:'
            : '<strong>' + nonRespondentList.length + '/' + totalStakeholders + '</strong> stakeholders did not respond. Objective reasons may include:'}
          <ul class="mt-2 mb-0">
            <li>${currentLang === 'vi' ? 'Đã nhận báo cáo nhưng chưa có thời gian phản hồi' : 'Received the report but did not have time to respond'}</li>
            <li>${currentLang === 'vi' ? 'Nội dung tham vấn không liên quan trực tiếp đến hoạt động của bên liên quan' : 'Consultation content not directly relevant to stakeholder activities'}</li>
            <li>${currentLang === 'vi' ? 'Thông tin liên lạc không chính xác hoặc không tiếp cận được' : 'Contact information inaccurate or unreachable'}</li>
            <li>${currentLang === 'vi' ? 'Lý do khác (bận công tác, thay đổi nhân sự, v.v.)' : 'Other reasons (busy, personnel changes, etc.)'}</li>
          </ul>
        </div>`;
        rpt += `<div class="table-responsive mb-4"><table class="table table-sm table-bordered">
          <thead class="table-light"><tr><th style="width:40px">#</th><th>${currentLang === 'vi' ? 'Tên bên liên quan' : 'Stakeholder Name'}</th>
          <th>${currentLang === 'vi' ? 'Loại' : 'Type'}</th><th>${currentLang === 'vi' ? 'Liên hệ' : 'Contact'}</th></tr></thead><tbody>`;
        nonRespondentList.forEach((s, idx) => {
          rpt += `<tr><td>${idx + 1}</td><td class="small">${s['Tên tổ chức'] || s['Họ và tên'] || '—'}</td>
            <td class="small">${s['Loại bên liên quan'] || '—'}</td>
            <td class="small">${s['Điện thoại'] || s['Email'] || '—'}</td></tr>`;
        });
        rpt += `</tbody></table></div>`;
      } else {
        rpt += `<p class="text-success"><i class="fas fa-check-circle me-1"></i>${currentLang === 'vi' ? 'Tất cả bên liên quan đã phản hồi.' : 'All stakeholders have responded.'}</p>`;
      }

      // 9. Conclusion
      rpt += `<h5 class="fw-bold text-success mb-3"><i class="fas fa-flag-checkered me-2"></i>9. ${t('rpt_conclusion')}</h5>`;
      rpt += `<div class="alert alert-light border rounded-3">`;
      if (parseFloat(overallPositive) >= 70) {
        rpt += `<p class="mb-2"><strong class="text-success"><i class="fas fa-check-circle me-1"></i>${currentLang === 'vi'
          ? 'Kết quả tham vấn cho thấy hoạt động quản lý rừng bền vững được đánh giá TÍCH CỰC với tỉ lệ ' + overallPositive + '% đánh giá tốt (dựa trên ' + totalResponses + ' phản hồi).'
          : 'Consultation results show forest management activities are rated POSITIVELY with ' + overallPositive + '% good ratings (based on ' + totalResponses + ' responses).'}</strong></p>`;
      } else if (parseFloat(overallPositive) >= 50) {
        rpt += `<p class="mb-2"><strong class="text-warning"><i class="fas fa-exclamation-circle me-1"></i>${currentLang === 'vi'
          ? 'Kết quả tham vấn ở mức TRUNG BÌNH với ' + overallPositive + '% đánh giá tốt (dựa trên ' + totalResponses + ' phản hồi). Cần cải thiện một số tiêu chí.'
          : 'Consultation results are MODERATE with ' + overallPositive + '% good ratings (based on ' + totalResponses + ' responses). Some criteria need improvement.'}</strong></p>`;
      } else {
        rpt += `<p class="mb-2"><strong class="text-danger"><i class="fas fa-times-circle me-1"></i>${currentLang === 'vi'
          ? 'Kết quả tham vấn CẦN CẢI THIỆN ĐÁNG KỂ. Chỉ có ' + overallPositive + '% đánh giá tốt (dựa trên ' + totalResponses + ' phản hồi).'
          : 'Consultation results NEED SIGNIFICANT IMPROVEMENT. Only ' + overallPositive + '% good ratings (based on ' + totalResponses + ' responses).'}</strong></p>`;
      }

      rpt += `<ul class="mb-0">
        <li>${currentLang === 'vi' ? 'Tổng số phản hồi: <strong>' + totalResponses + '</strong> / ' + totalStakeholders + ' bên liên quan (' + responseRate + '%)' : 'Total responses: <strong>' + totalResponses + '</strong> / ' + totalStakeholders + ' stakeholders (' + responseRate + '%)'}</li>
        <li>${currentLang === 'vi' ? 'Điểm mạnh: ' + strengths.length + ' tiêu chí (>60% đánh giá Tốt)' : 'Strengths: ' + strengths.length + ' criteria (>60% Good rating)'}</li>
        <li>${currentLang === 'vi' ? 'Cần cải thiện: ' + weaknesses.length + ' tiêu chí' : 'Needs improvement: ' + weaknesses.length + ' criteria'}</li>
        ${nonRespondents > 0 ? `<li>${currentLang === 'vi' ? 'Chưa phản hồi: ' + nonRespondents + ' bên liên quan (xem mục 8)' : 'Non-respondents: ' + nonRespondents + ' stakeholders (see section 8)'}</li>` : ''}
      </ul></div>`;

      rpt += `</div>`; // close rpt-printable

      rptContainer.html(rpt);
      $('#rpt-export-btn').prop('disabled', false);
    }

    function exportConsultationReportPDF() {
      const content = document.getElementById('rpt-printable');
      if (!content) return;

      const printWin = window.open('', '_blank');
      printWin.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
        <title>${t('rpt_title')}</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          body { font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 12pt; color: #333; }
          h4, h5 { color: #1B5E20; }
          .table { font-size: 10pt; }
          .badge { font-size: 9pt; }
          .progress { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
          .progress-bar { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
          .alert { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
          .bg-success, .bg-danger, .bg-warning, .bg-info, .bg-secondary, .bg-light { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
          .text-success { color: #1B5E20 !important; }
          .text-danger { color: #dc3545 !important; }
          .text-warning { color: #ff9800 !important; }
          @media print {
            body { padding: 0; }
            .page-break { page-break-before: always; }
          }
        </style>
      </head><body>${content.innerHTML}</body></html>`);
      printWin.document.close();
      printWin.onload = () => { printWin.print(); };
    }

    // ============================================================
    // === HANDBOOK VIEWER (Sổ tay quản lý rừng bền vững) ===
    // ============================================================

    const _handbookCache = {};

    function renderHandbookView() {
      const container = $('#page-content-dynamic');
      container.empty();

      const HANDBOOK_TABS = [
        { key: 'process', label: t('hb_process') },
        { key: 'm1', label: `${t('hb_part')} M1` },
        { key: 'm2', label: `${t('hb_part')} M2` },
        { key: 'm3', label: `${t('hb_part')} M3` },
        { key: 'm4', label: `${t('hb_part')} M4` },
        { key: 'm5', label: `${t('hb_part')} M5` },
        { key: 'm6', label: `${t('hb_part')} M6` }
      ];

      let tabHeaders = HANDBOOK_TABS.map((tab, i) =>
        `<li class="nav-item" role="presentation">
           <button class="nav-link ${i === 0 ? 'active' : ''} fw-bold text-success" id="hb-tab-${tab.key}" data-bs-toggle="tab" data-bs-target="#hb-pane-${tab.key}" type="button" role="tab" data-hb-key="${tab.key}">${tab.label}</button>
         </li>`
      ).join('');

      let tabPanes = HANDBOOK_TABS.map((tab, i) =>
        `<div class="tab-pane fade ${i === 0 ? 'show active' : ''}" id="hb-pane-${tab.key}" role="tabpanel">
           <div class="handbook-content" id="hb-content-${tab.key}">
             <div class="handbook-loading"><div class="spinner-border text-success mb-3"></div><br>${t('hb_loading')}</div>
           </div>
         </div>`
      ).join('');

      const html = `
        <div class="card shadow border-0 rounded-4">
          <div class="card-header bg-white border-0 pt-4 px-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="text-success fw-bold mb-0"><i class="fas fa-book me-2"></i>${t('hb_title')}</h5>
              <button class="btn btn-outline-success btn-sm no-print" onclick="printHandbookTab()"><i class="fas fa-print me-1"></i>${t('hb_print')}</button>
            </div>
            <ul class="nav nav-tabs card-header-tabs flex-nowrap overflow-auto no-print" id="handbookTabs" role="tablist" style="white-space:nowrap">
              ${tabHeaders}
            </ul>
          </div>
          <div class="card-body p-3 p-md-4">
            <div class="tab-content" id="handbookTabsContent">
              ${tabPanes}
            </div>
          </div>
        </div>
      `;
      container.html(html);

      // Load first tab immediately
      loadHandbookTab('process');

      // Lazy load on tab click
      $(document).off('shown.bs.tab', '#handbookTabs button').on('shown.bs.tab', '#handbookTabs button', function() {
        const key = $(this).data('hb-key');
        if (key) loadHandbookTab(key);
      });
    }

    async function loadHandbookTab(key) {
      const el = document.getElementById('hb-content-' + key);
      if (!el || el.dataset.loaded === 'true') return;

      // Check cache
      if (_handbookCache[key]) {
        el.innerHTML = _handbookCache[key];
        el.dataset.loaded = 'true';
        return;
      }

      try {
        const resp = await fetch('handbook/' + key + '.html');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const html = await resp.text();
        _handbookCache[key] = html;
        el.innerHTML = html;
        el.dataset.loaded = 'true';
      } catch (err) {
        el.innerHTML = `<div class="text-center py-5 text-muted"><i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i><br>Không tải được nội dung: ${err.message}</div>`;
      }
    }

    function printHandbookTab() {
      // Find active tab pane and print its content
      const activePane = document.querySelector('#handbookTabsContent .tab-pane.active .handbook-content');
      if (!activePane) return;

      const printWin = window.open('', '_blank');
      printWin.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
        <title>${t('hb_title')}</title>
        <style>
          body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 0 20px; font-size: 12pt; line-height: 1.5; color: #333; }
          h1 { color: #1b5e20; font-size: 16pt; border-bottom: 2px solid #a5d6a7; padding-bottom: 6px; }
          h2 { color: #2e7d32; font-size: 14pt; border-bottom: 1px solid #c8e6c9; padding-bottom: 4px; }
          h3 { color: #388e3c; font-size: 13pt; }
          p { text-align: justify; margin-bottom: 8px; }
          table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 11pt; }
          th { background: #e8f5e9; font-weight: bold; border: 1px solid #a5d6a7; padding: 6px 8px; }
          td { border: 1px solid #ccc; padding: 5px 8px; vertical-align: top; }
          tr:nth-child(even) { background: #f9f9f9; }
          img { max-width: 80%; height: auto; }
          ul, ol { padding-left: 20px; }
          @media print { table { page-break-inside: auto; } tr { page-break-inside: avoid; } img { page-break-inside: avoid; } }
        </style>
      </head><body>${activePane.innerHTML}</body></html>`);
      printWin.document.close();
      printWin.focus();
      setTimeout(() => { printWin.print(); }, 500);
    }

    function renderBreadcrumb() {
      let bc = `<div class="fsc-breadcrumb"><span class="breadcrumb-item" onclick="showDashboard()"><i class="fa-solid fa-house"></i> ${t('btn_home')}</span>`;
      navHistory.forEach((item, index) => {
        bc += `<span class="breadcrumb-separator">/</span>`;
        let t = item.title;
        if (index === navHistory.length - 1) bc += `<span class="breadcrumb-item active">${t}</span>`;
        else bc += `<span class="breadcrumb-item" onclick="navigateBack(${index})">${t}</span>`;
      });
      bc += '</div>';
      if ($('#breadcrumb-container').length === 0) $('<div id="breadcrumb-container"></div>').insertBefore('#page-content-dynamic');
      $('#breadcrumb-container').html(bc);
    }

    function navigateBack(index) {
      if (typeof index === 'number') {
        navHistory = navHistory.slice(0, index + 1);
      } else {
        if (navHistory.length > 1) {
          navHistory.pop();
        } else {
          // At root: go back to parent group sub-menu if available, else dashboard
          if (_parentMenuGroup) {
            const grp = _parentMenuGroup;
            _parentMenuGroup = null;
            goHome();
            openMenuGroup(grp);
            return;
          }
          showDashboard();
          return;
        }
      }
      renderBreadcrumb();
      renderContent();
    }

    function handleRowClick(sheetName, rowJson) {
      const rowData = JSON.parse(decodeURIComponent(rowJson));
      let title = rowData['Tên ban quản lý'] || rowData['Tên nhóm'] || rowData['Họ tên chủ rừng'] || rowData['Mã số lô rừng'] || rowData['Họ và tên'] || t('detail_title');

      // Chế độ xem chi tiết mặc định
      navHistory.push({ mode: 'DETAIL', viewName: sheetName, title: title, rowData: rowData });

      // HỖ TRỢ DRILL-DOWN (Nâng cao)
      if (sheetName === 'Ban_Quanlynhom') {
        // Nếu click vào Ban quản lý, có thể tùy chọn xem danh sách Nhóm thuộc ban đó
        const drillBtn = `<button class="btn btn-success btn-sm mt-2" onclick="loadViewWithFilter('NhomCCR', 'ID ban quản lý', '${rowData['ID ban quản lý']}', 'Nhóm thuộc ${rowData['Tên ban quản lý']}')">Xem các Nhóm</button>`;
        // Ta sẽ chèn button này vào content sau khi render
      } else if (sheetName === 'NhomCCR') {
        // Tương tự cho Nhóm -> Chủ rừng
      }

      renderBreadcrumb();
      renderContent();
    }

    function loadViewWithFilter(viewName, filterKey, filterValue, title) {
      if ($(window).width() < 768) { $('#sidebar-wrapper').removeClass('show-sidebar'); $('#sidebar-overlay').removeClass('active'); }
      $('#dashboard-view').addClass('d-none');
      $('#data-view').removeClass('d-none');
      const realSheetName = VIEW_MAP[viewName] || viewName;
      // Push onto navHistory to preserve drill-down path (back = 1 level)
      navHistory.push({ mode: 'LIST', viewName: realSheetName, title: title, filter: { key: filterKey, value: filterValue } });
      renderBreadcrumb();
      renderContent();
      highlightActiveMenu(viewName, title);
    }

    function renderDetailMaster(sheetName, d) {
      const rowJson = encodeURIComponent(JSON.stringify(d));
      const canEdit = hasPermission(sheetName, 'Sửa');
      const canDelete = hasPermission(sheetName, 'Xóa');
      const vcols = getVisibleColumns(sheetName);

      let html = `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded-3 shadow-sm border-start border-4 border-success">
            <div><h6 class="fw-bold text-success m-0">${d['Tên nhóm'] || d['Họ tên chủ rừng'] || d['Mã số lô rừng'] || d['Họ và tên'] || t('detail_title')}</h6><div class="text-muted small">ID: ${d[Object.keys(d)[0]]}</div></div>
            <div>
              ${canEdit ? `<button class="btn btn-outline-primary btn-sm me-1" onclick="openModal('UPDATE', '${sheetName}', '${rowJson}')"><i class="fa-solid fa-pen"></i></button>` : ''}
              ${canDelete ? `<button class="btn btn-outline-danger btn-sm" onclick="deleteRow('${sheetName}', '${rowJson}')"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>
          </div>`;

      // ACTION BUTTONS AT TOP (before data) - Ông-Cha-Con-Cháu hierarchy
      if (sheetName === 'Ban_Quanlynhom') {
        html += `<div class="d-flex gap-1 mb-2 flex-nowrap detail-action-bar">
          <button class="btn btn-success btn-sm fw-bold shadow-sm flex-fill" onclick="loadViewWithFilter('NhomCCR', 'ID ban quản lý', '${d['ID ban quản lý']}', 'Nhóm thuộc ${d['Tên ban quản lý']}')"><i class="fa-solid fa-layer-group me-1"></i> ${t('dd_nhom')}</button>
        </div>`;
      } else if (sheetName === 'NhomCCR') {
        const safeItem = JSON.stringify(d).replace(/"/g, '&quot;');
        const grpSafe = JSON.stringify(d).replace(/"/g, '&quot;');
        html += `<div class="d-flex gap-1 mb-2 flex-nowrap detail-action-bar">
          <button class="btn btn-success btn-sm fw-bold shadow-sm flex-fill" onclick="loadViewWithFilter('Churung', 'ID nhóm', '${d['ID nhóm']}', 'Hộ dân thuộc ${d['Tên nhóm']}')"><i class="fa-solid fa-users me-1"></i> ${t('dd_hodan')}</button>
          <button class="btn btn-outline-success btn-sm fw-bold shadow-sm flex-fill" onclick="showTargetHistory(${safeItem}, 'NhomCCR')"><i class="fa-solid fa-clipboard-check me-1"></i> ${t('dd_danhgia')}</button>
          <button class="btn btn-outline-primary btn-sm fw-bold shadow-sm flex-fill" onclick="showGroupMonitoring(${grpSafe})"><i class="fa-solid fa-users-viewfinder me-1"></i> ${t('dd_giamsat')}</button>
        </div>`;
      } else if (sheetName === 'Churung') {
        html += `<div class="d-flex gap-1 mb-2 flex-nowrap detail-action-bar">
          <button class="btn btn-success btn-sm fw-bold shadow-sm flex-fill" onclick="loadViewWithFilter('Lo_rung', 'ID chủ rừng', '${d['ID chủ rừng']}', 'Lô rừng của ${d['Họ tên chủ rừng']}')"><i class="fa-solid fa-map-location-dot me-1"></i> ${t('dd_lorung')}</button>
          <button class="btn btn-outline-success btn-sm fw-bold shadow-sm flex-fill" onclick="loadViewWithFilter('Taphuan', 'ID chủ rừng', '${d['ID chủ rừng']}', 'Tập huấn của ${d['Họ tên chủ rừng']}')"><i class="fa-solid fa-graduation-cap me-1"></i> ${t('dd_taphuan')}</button>
        </div>`;
      } else if (sheetName === 'Lo_rung') {
        const plotSafe = JSON.stringify(d).replace(/"/g, '&quot;');
        html += `<div class="d-flex gap-1 mb-2 flex-nowrap detail-action-bar">
          <button class="btn btn-success btn-sm fw-bold shadow-sm flex-fill" onclick="showOnMap('${d['ID lô rừng']}')"><i class="fa-solid fa-map me-1"></i> ${t('dd_bando')}</button>
          <button class="btn btn-outline-success btn-sm fw-bold shadow-sm flex-fill" onclick="loadViewWithFilter('HD_Lorung', 'ID lô rừng', '${d['ID lô rừng']}', 'Hoạt động lô ${d['Mã số lô rừng']}')"><i class="fa-solid fa-clipboard-list me-1"></i> ${t('dd_baocao')}</button>
          <button class="btn btn-outline-success btn-sm fw-bold shadow-sm flex-fill" onclick="loadViewWithFilter('KH_QL_Lorung', 'ID lô rừng', '${d['ID lô rừng']}', 'Kế hoạch lô ${d['Mã số lô rừng']}')"><i class="fa-solid fa-calendar-check me-1"></i> ${t('dd_kehoach')}</button>
          <button class="btn btn-outline-primary btn-sm fw-bold shadow-sm flex-fill" onclick="showPlotMonitoring(${plotSafe})"><i class="fa-solid fa-clipboard-check me-1"></i> ${t('dd_giamsat')}</button>
        </div>`;
      } else if (sheetName === 'NhanSu') {
        const isAdmin = currentUser && (String(currentUser['Chức vụ']).toLowerCase().includes('admin'));
        const isPending = d['Trạng thái'] === 'Pending';
        if (isAdmin && isPending) {
          html += `<div class="d-flex gap-1 mb-2 detail-action-bar">
            <button class="btn btn-success btn-sm fw-bold shadow-sm flex-fill" onclick="approveMember('${d['ID_staff']}')"><i class="fa-solid fa-check-circle me-1"></i> ${t('dd_pheduyet')}</button>
          </div>`;
        }
      }

      html += `<div class="card p-2 shadow border-0 overflow-hidden"><div class="row g-2">`;

      // Lấy tất cả các cột khả dụng cho bảng này
      const allCols = TABLE_CONFIG[sheetName] ? TABLE_CONFIG[sheetName].columns : Object.keys(d);

      allCols.forEach(k => {
        const v = d[k] || '';
        const isVisible = vcols.includes(k);
        html += `
          <div class="col-md-4 mb-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
               <label class="text-muted small fw-bold m-0">${k}</label>
               <div class="form-check form-switch" title="${t('detail_show_table')}">
                 <input class="form-check-input" type="checkbox" style="width: 1.5em; height: 0.8em;" ${isVisible ? 'checked' : ''} onclick="toggleColumnVisibility('${sheetName}', '${k}')">
               </div>
            </div>
            <div class="fw-medium border-bottom pb-1 small">${v}</div>
          </div>`;
      });
      html += `</div></div>`;

      $('#page-content-dynamic').html(html);
    }

    let currentAction = '', currentSheetTarget = '';
    function openModal(action, sheetName, rowJson = null) {
      currentAction = action;
      currentSheetTarget = (sheetName === 'PhanQuyen') ? 'NhanSu' : sheetName;
      $('#modalTitle').text(action === 'CREATE' ? t('modal_add') : t('modal_update'));
      const form = $('#dynamic-form'); form.empty();

      let columns = TABLE_CONFIG[sheetName] ? TABLE_CONFIG[sheetName].columns : (APP_DATA[sheetName] && APP_DATA[sheetName][0] ? Object.keys(APP_DATA[sheetName][0]) : []);
      let rowData = rowJson ? JSON.parse(decodeURIComponent(rowJson)) : {};

      // TỰ ĐỘNG ĐIỀN KHÓA NGOẠI NẾU ĐANG TRONG VIEW LỌC (DRILL-DOWN)
      const lastHist = navHistory[navHistory.length - 1];
      if (action === 'CREATE' && lastHist && lastHist.filter) {
        rowData[lastHist.filter.key] = lastHist.filter.value;
      }

      columns.forEach(col => {
        let val = rowData[col] || '';

        // TỰ ĐỘNG CẬP NHẬT NGÀY THÁNG
        if (col.toLowerCase().includes('ngày') || col.toLowerCase().includes('cập nhật')) {
          if (action === 'CREATE' || col.toLowerCase().includes('cập nhật')) {
            val = new Date().toLocaleDateString('vi-VN');
          }
        }
        if (col === 'Người cập nhật' || col === 'Người nhập liệu' || col === 'Người nhập') {
          val = currentUser['Họ và tên'] || currentUser['Email'];
        }

        let inputHtml = '';
        const isKey = col.toLowerCase().includes('id') || col.toLowerCase().includes('mã');

        if (col === 'Trạng thái') {
          inputHtml = `<select class="form-select" name="${col}"><option value="Act" ${val === 'Act' ? 'selected' : ''}>Act</option><option value="inAct" ${val === 'inAct' ? 'selected' : ''}>inAct</option><option value="Pending" disabled ${val === 'Pending' ? 'selected' : ''}>Pending</option></select>`;
        } else if (col === 'Chức vụ') {
          const roles = ['Admin', 'Thành viên'];
          inputHtml = `<select class="form-select" name="${col}">${roles.map(r => `<option value="${r}" ${val === r ? 'selected' : ''}>${r}</option>`).join('')}</select>`;
        } else if (col === 'Mật khẩu') {
          if (action === 'CREATE') inputHtml = `<input type="text" class="form-control" name="${col}" placeholder="Mật khẩu khởi tạo">`;
          else if (String(rowData['Email']) === String(currentUser['Email'])) inputHtml = `<input type="text" class="form-control" name="${col}" placeholder="Đổi mật khẩu">`;
        } else {
          // KHÔNG CHO SỬA KEY
          const readonly = (action === 'UPDATE' && isKey) || (action === 'CREATE' && lastHist && lastHist.filter && col === lastHist.filter.key) ? 'readonly class="form-control bg-light"' : '';
          inputHtml = `<input type="text" class="form-control" name="${col}" value="${val}" ${readonly}>`;
        }
        if (inputHtml) form.append(`<div class="col-md-6"><label class="form-label small fw-bold text-muted">${col}</label>${inputHtml}</div>`);
      });
      new bootstrap.Modal(document.getElementById('dataModal')).show();
    }

    function performAggregation() {
      console.log("Starting Bottom-Up Aggregation...");

      const safeFloat = (v) => {
        if (!v) return 0;
        if (typeof v === 'number') return v;
        return parseFloat(String(v).replace(/,/g, '').replace(/[^0-9.-]/g, '')) || 0;
      };

      // 1. Aggregation Level 3: Lo_rung -> Churung
      if (APP_DATA['Lo_rung'] && APP_DATA['Churung']) {
        const plots = APP_DATA['Lo_rung'];
        const owners = APP_DATA['Churung'];

        owners.forEach(owner => {
          const ownerID = String(owner['ID chủ rừng'] || owner['ID chủ rừng']).trim();
          const myPlots = plots.filter(p => String(p['ID chủ rừng']).trim() === ownerID);

          owner['Số lô rừng'] = myPlots.length;
          owner['Tổng diện tích'] = myPlots.reduce((sum, p) => sum + safeFloat(p['Tổng diện tích']), 0).toFixed(2);
          owner[' Diện tích FSC'] = myPlots.reduce((sum, p) => sum + safeFloat(p[' Diện tích FSC']), 0).toFixed(2);
          owner['Diện tích rừng tự nhiên'] = myPlots.reduce((sum, p) => sum + safeFloat(p['Diện tích rừng tự nhiên']), 0).toFixed(2);
          owner['Diện tích vùng đệm'] = myPlots.reduce((sum, p) => sum + safeFloat(p['Diện tích vùng đệm']), 0).toFixed(2);
          owner['Sản lượng dự kiến năm'] = myPlots.reduce((sum, p) => sum + safeFloat(p['Sản lượng khai thác xe'] || p['Sản lượng dự kiến']), 0).toFixed(2);
          owner['Diện tích trồng rừng năm'] = myPlots.reduce((sum, p) => sum + safeFloat(p['Diện tích trồng rừng'] || p['Diện tích trồng']), 0).toFixed(2);
        });
      }

      // 2. Aggregation Level 2: Churung -> NhomCCR
      if (APP_DATA['Churung'] && APP_DATA['NhomCCR']) {
        const owners = APP_DATA['Churung'];
        const groups = APP_DATA['NhomCCR'];

        groups.forEach(group => {
          const groupID = String(group['ID nhóm'] || group['Mã nhóm']).trim();
          const myOwners = owners.filter(o => String(o['ID nhóm']).trim() === groupID);

          group['Số thành viên'] = myOwners.length;
          group['Tổng diện tích'] = myOwners.reduce((sum, o) => sum + safeFloat(o['Tổng diện tích']), 0).toFixed(2);
          group[' Diện tích FSC'] = myOwners.reduce((sum, o) => sum + safeFloat(o[' Diện tích FSC']), 0).toFixed(2);
          group['Diện tích rừng tự nhiên'] = myOwners.reduce((sum, o) => sum + safeFloat(o['Diện tích rừng tự nhiên']), 0).toFixed(2);
          group['Diện tích vùng đệm'] = myOwners.reduce((sum, o) => sum + safeFloat(o['Diện tích vùng đệm']), 0).toFixed(2);
          group['Sản lượng dự kiến năm'] = myOwners.reduce((sum, o) => sum + safeFloat(o['Sản lượng dự kiến năm']), 0).toFixed(2);
          group['Diện tích trồng rừng năm'] = myOwners.reduce((sum, o) => sum + safeFloat(o['Diện tích trồng rừng năm']), 0).toFixed(2);
        });
      }

      // 3. Aggregation Level 1: NhomCCR -> Ban_Quanlynhom
      if (APP_DATA['NhomCCR'] && APP_DATA['Ban_Quanlynhom']) {
        const groups = APP_DATA['NhomCCR'];
        const boards = APP_DATA['Ban_Quanlynhom'];

        boards.forEach(board => {
          const boardID = String(board['ID ban quản lý']).trim();
          const myGroups = groups.filter(g =>
            String(g['ID ban quản lý'] || '').trim() === boardID ||
            String(g['Tên ban quản lý'] || '').trim() === String(board['Tên ban quản lý']).trim()
          );

          board['Số nhóm quản lý'] = myGroups.length;
          board['Số hộ thành viên'] = myGroups.reduce((sum, g) => sum + safeFloat(g['Số thành viên']), 0);
          board['Tổng diện tích'] = myGroups.reduce((sum, g) => sum + safeFloat(g['Tổng diện tích']), 0).toFixed(2);
          board[' Diện tích FSC'] = myGroups.reduce((sum, g) => sum + safeFloat(g[' Diện tích FSC']), 0).toFixed(2);
          board['Diện tích rừng tự nhiên'] = myGroups.reduce((sum, g) => sum + safeFloat(g['Diện tích rừng tự nhiên']), 0).toFixed(2);
          board['Diện tích vùng đệm'] = myGroups.reduce((sum, g) => sum + safeFloat(g['Diện tích vùng đệm']), 0).toFixed(2);
          board['Sản lượng dự kiến năm'] = myGroups.reduce((sum, g) => sum + safeFloat(g['Sản lượng dự kiến năm']), 0).toFixed(2);
          board['Diện tích trồng rừng năm'] = myGroups.reduce((sum, g) => sum + safeFloat(g['Diện tích trồng rừng năm']), 0).toFixed(2);
        });
      }
      console.log("Bottom-Up Aggregation Complete.");
    }

    async function saveData() {
      const formDataArray = $('#dynamic-form').serializeArray();
      const dataObj = {};
      formDataArray.forEach(item => dataObj[item.name] = item.value);

      const btn = $('#btn-save');
      btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>ĐANG LƯU...');

      try {
        const dbTable = getDBTable(currentSheetTarget);
        const dbData = toDB(currentSheetTarget, dataObj);

        let result;
        if (currentAction === 'CREATE') {
          // Auto-generate ID if empty
          if (!dbData.id || dbData.id === '') {
            const prefix = currentSheetTarget.substring(0, 3).toUpperCase();
            dbData.id = `${prefix}-${new Date().getFullYear().toString().substr(-2)}-${Math.floor(1000 + Math.random() * 9000)}`;
          }
          result = await sb.from(dbTable).insert(dbData).select();
        } else {
          const idVal = dbData.id;
          delete dbData.id; // Don't update the PK
          delete dbData.created_at;
          result = await sb.from(dbTable).update(dbData).eq('id', idVal).select();
        }

        if (result.error) {
          alert("Lỗi: " + result.error.message);
          return;
        }

        bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();

        // Update local data
        if (currentAction === 'CREATE') {
          if (!APP_DATA[currentSheetTarget]) APP_DATA[currentSheetTarget] = [];
          const newRows = fromDB(currentSheetTarget, result.data);
          if (newRows.length > 0) APP_DATA[currentSheetTarget].push(newRows[0]);
        } else {
          const updated = fromDB(currentSheetTarget, result.data);
          if (updated.length > 0) {
            const idCol = Object.keys(dataObj)[0];
            const idx = APP_DATA[currentSheetTarget].findIndex(r => String(r[idCol]) === String(dataObj[idCol]));
            if (idx !== -1) APP_DATA[currentSheetTarget][idx] = updated[0];
          }
        }

        performAggregation();
        renderContent();
        alert('Thành công!');

      } catch (err) {
        console.error("Save error:", err);
        alert("Lỗi: " + err.message);
      } finally {
        btn.prop('disabled', false).text('Lưu');
      }
    }

    async function deleteRow(sheetName, rowJson) {
      if (!confirm(t('confirm_delete'))) return;
      const rowData = JSON.parse(decodeURIComponent(rowJson));
      const idCol = Object.keys(rowData)[0];
      const idVal = rowData[idCol];

      try {
        const dbTable = getDBTable(sheetName);
        const dbData = toDB(sheetName, rowData);
        const dbId = dbData.id;

        const { error } = await sb.from(dbTable).delete().eq('id', dbId);
        if (error) {
          alert("Lỗi khi xóa: " + error.message);
          return;
        }

        APP_DATA[sheetName] = APP_DATA[sheetName].filter(r => String(r[idCol]) !== String(idVal));
        performAggregation();
        navigateBack();
        alert('Đã xóa thành công.');

      } catch (err) { alert("Lỗi: " + err.message); }
    }

    async function approveMember(targetID) {
      if (!confirm("Xác nhận duyệt thành viên này?")) return;
      try {
        // Find the profile by id_staff
        const { data: profiles, error: findErr } = await sb.from('profiles')
          .select('id').eq('id_staff', targetID).single();

        if (findErr || !profiles) {
          alert("Không tìm thấy nhân sự.");
          return;
        }

        const { error } = await sb.from('profiles')
          .update({ trang_thai: 'Act' }).eq('id', profiles.id);

        if (error) {
          alert("Lỗi: " + error.message);
          return;
        }

        alert("Đã duyệt thành công!");
        const idx = APP_DATA['NhanSu'].findIndex(u => String(u['ID_staff']) === String(targetID));
        if (idx !== -1) {
          APP_DATA['NhanSu'][idx]['Trạng thái'] = 'Act';
          renderDetailMaster('NhanSu', APP_DATA['NhanSu'][idx]);
        }

      } catch (err) { alert("Lỗi: " + err.message); }
    }

    function renderTable(data, context, sheetName) {
      const isAdmin = currentUser && (String(currentUser['Chức vụ']).toLowerCase().includes('admin'));
      let displayData = data;

      // LỌC DỮ LIỆU THEO PHÂN QUYỀN (Nếu không phải Admin)
      if (!isAdmin) {
        const myBoard = String(currentUser['Thuộc Ban quản lý'] || '').trim().toLowerCase();
        const myGroup = String(currentUser['Thuộc nhóm'] || '').trim().toLowerCase();

        console.log("Filtering data for staff:", { myBoard, myGroup, sheetName });

        if (myBoard) {
          displayData = displayData.filter(r => {
            const bId = String(r['ID ban quản lý'] || r['Tên ban quản lý'] || '').trim().toLowerCase();
            if (sheetName === 'Ban_Quanlynhom') return bId === myBoard;
            if (bId) return bId === myBoard;
            return true;
          });
        }
        if (myGroup) {
          displayData = displayData.filter(r => {
            const gId = String(r['ID nhóm'] || r['Mã nhóm'] || r['Tên nhóm'] || '').trim().toLowerCase();
            if (sheetName === 'NhomCCR') return gId === myGroup;
            if (gId) return gId === myGroup;
            return true;
          });
        }
      }

      if (context.filter) displayData = displayData.filter(row => String(row[context.filter.key]) === String(context.filter.value));

      const canAdd = hasPermission(sheetName, 'Thêm');
      const addBtn = canAdd ? `<button class="btn btn-light btn-sm text-success fw-bold rounded-pill px-3 shadow-sm" onclick="openModal('CREATE', '${sheetName}')"><i class="fa-solid fa-plus"></i> ${t('btn_add')}</button>` : '';

      if (!displayData || !displayData.length) {
        $('#page-content-dynamic').html(`
            <div class="card shadow border-0 rounded-4 mt-3">
              <div class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">${context.title}</h5>${addBtn}
              </div>
              <div class="card-body p-5 text-center text-muted">${currentLang==='en'?'No data available for this table.':'Chưa có dữ liệu cho bảng này.'}</div>
            </div>`);
        return;
      }

      // XÁC ĐỊNH CỘT HIỂN THỊ
      const cols = getVisibleColumns(sheetName);

      let th = '<tr>' + cols.map(c => `<th class="text-nowrap">${tc(c)}</th>`).join('') + '</tr>';
      let tb = '';
      displayData.forEach((row) => {
        let rowJson = encodeURIComponent(JSON.stringify(row));
        tb += `<tr class='clickable-row' onclick='handleRowClick("${sheetName}", "${rowJson}")'>`;
        cols.forEach(c => {
          let val = row[c] || '';
          let displayVal = val.toString().length > 50 ? val.toString().substring(0, 50) + '...' : val;
          tb += `<td>${displayVal}</td>`;
        });
        tb += '</tr>';
      });

      const html = `
          <div class="card shadow border-0 rounded-4 overflow-hidden mt-3">
            <div class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold"><i class="fa-solid fa-list me-2"></i>${context.title}</h5>${addBtn}
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table id="dt-table" class="table table-striped table-hover w-100 mb-0">
                  <thead>${th}</thead>
                  <tbody>${tb}</tbody>
                </table>
              </div>
            </div>
          </div>`;
      $('#page-content-dynamic').html(html);
      if ($.fn.DataTable) {
        $('#dt-table').DataTable({
          language: currentLang === 'en' ? {} : { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/vi.json" },
          pageLength: 20,
          dom: 'frtip'
        });
      }
    }

    function fGroup(d, fields) {
      return fields.map(f => `
          <div class="d-flex justify-content-between py-1 border-bottom border-light mb-0">
            <span class="text-muted small">${f}</span>
            <span class="fw-bold text-dark text-end small">${d[f] || '-'}</span>
          </div>`).join('');
    }

    // === SMART SEARCH ===
    const SEARCH_TABLES = {
      'Ban_Quanlynhom': { titleKey: 'st_ban_ql', icon: 'fa-building', viewName: 'Ban_Quanly', displayCols: ['Tên ban quản lý','Địa chỉ','Người đại diện'] },
      'NhomCCR': { titleKey: 'st_nhom', icon: 'fa-users', viewName: 'DS_NhomCCR', displayCols: ['Tên nhóm','Mã nhóm','Người đại diện','Địa chỉ'] },
      'Churung': { titleKey: 'st_churung', icon: 'fa-user', viewName: 'Churung', displayCols: ['Họ tên chủ rừng','Số điện thoại','Xã','Thôn'] },
      'Lo_rung': { titleKey: 'st_lorung', icon: 'fa-tree', viewName: 'Lo_rung', displayCols: ['Tên lô rừng','ID lô rừng','Loài cây trồng chính','Trạng thái'] },
      'NhanSu': { titleKey: 'st_nhansu', icon: 'fa-id-badge', viewName: 'Nhan_Su', displayCols: ['Họ và tên','Email','Chức vụ'] },
      'Taphuan': { titleKey: 'st_taphuan', icon: 'fa-chalkboard-teacher', viewName: 'Taphuan', displayCols: ['Loại tập huấn','Ngày tập huấn','Giảng viên'] },
      'DG_noibo': { titleKey: 'st_danhgia', icon: 'fa-clipboard-check', viewName: 'DG_noibo', displayCols: ['ID','ID nhóm','Date','Staff'] }
    };

    const APP_FUNCTIONS = [
      { labelKey: 'fn_gis_map', icon: 'fa-map-location-dot', action: "loadView('BanDo','Bản đồ')" },
      { labelKey: 'fn_internal_audit', icon: 'fa-clipboard-check', action: "loadView('DG_noibo','Đánh giá nội bộ')" },
      { labelKey: 'fn_settings', icon: 'fa-sliders', action: "loadView('CaiDat_HeThong','Cài đặt hệ thống')" },
      { labelKey: 'fn_staff_mgmt', icon: 'fa-id-badge', action: "loadView('Nhan_Su','Nhân sự')" },
      { labelKey: 'fn_training', icon: 'fa-chalkboard-teacher', action: "loadView('Taphuan','Tập huấn')" },
      { labelKey: 'fn_geo_repo', icon: 'fa-database', action: "loadView('BanDo','Bản đồ');setTimeout(()=>openGeoJSONRepo&&openGeoJSONRepo(),500)" },
      { labelKey: 'fn_reports', icon: 'fa-chart-pie', action: "openMenuGroup('Báo cáo')" },
      { labelKey: 'fn_plot_mgmt', icon: 'fa-tree', action: "loadView('Lo_rung','Lô rừng')" },
      { labelKey: 'fn_owner_mgmt', icon: 'fa-user', action: "loadView('Churung','Chủ rừng')" },
      { labelKey: 'fn_ccr_groups', icon: 'fa-users', action: "loadView('DS_NhomCCR','Nhóm CCR')" },
      { labelKey: 'fn_mgmt_board', icon: 'fa-building', action: "loadView('Ban_Quanly','Ban quản lý nhóm')" }
    ];

    let searchDebounce = null;
    function smartSearch(query) {
      clearTimeout(searchDebounce);
      const $r = $('#smart-search-results');
      if (!query || query.trim().length < 2) { $r.addClass('d-none').html(''); return; }
      searchDebounce = setTimeout(() => doSmartSearch(query.trim().toLowerCase()), 200);
    }

    function doSmartSearch(q) {
      const $r = $('#smart-search-results');
      let html = '';
      let totalResults = 0;
      const MAX = 30;

      // 1. Search menu items
      const menuData = APP_DATA['Menu'] || [];
      const menuMatches = menuData.filter(m => {
        const txt = [m['Module'], m['Nhom'], m['View']].filter(Boolean).join(' ').toLowerCase();
        return txt.includes(q);
      });
      if (menuMatches.length) {
        html += `<div class="px-3 py-1 bg-light border-bottom"><small class="fw-bold text-muted"><i class="fa-solid fa-bars me-1"></i>${t('search_menu')}</small></div>`;
        menuMatches.slice(0, 5).forEach(m => {
          const v = (m['View'] || '').replace(/'/g, "\\'");
          const mod = m['Module'] || '';
          const grp = m['Nhom'] || '';
          html += `<a href="#" class="d-block px-3 py-2 text-decoration-none border-bottom search-result-item" onclick="$('#smart-search-results').addClass('d-none');$('#smart-search-input').val('');loadView('${v}','${mod.replace(/'/g,"\\'")}');return false">
            <div class="fw-semibold text-dark" style="font-size:13px">${highlightMatch(mod, q)}</div>
            <small class="text-muted">${grp}</small></a>`;
          totalResults++;
        });
      }

      // 2. Search app functions
      const funcMatches = APP_FUNCTIONS.filter(f => t(f.labelKey).toLowerCase().includes(q));
      if (funcMatches.length) {
        html += `<div class="px-3 py-1 bg-light border-bottom"><small class="fw-bold text-muted"><i class="fa-solid fa-bolt me-1"></i>${t('search_functions')}</small></div>`;
        funcMatches.slice(0, 5).forEach(f => {
          html += `<a href="#" class="d-block px-3 py-2 text-decoration-none border-bottom search-result-item" onclick="$('#smart-search-results').addClass('d-none');$('#smart-search-input').val('');${f.action};return false">
            <div class="fw-semibold text-dark" style="font-size:13px"><i class="fa-solid ${f.icon} me-2 text-success"></i>${highlightMatch(t(f.labelKey), q)}</div></a>`;
          totalResults++;
        });
      }

      // 3. Search data tables
      for (const [sheetName, cfg] of Object.entries(SEARCH_TABLES)) {
        if (totalResults >= MAX) break;
        const rows = APP_DATA[sheetName] || [];
        if (!rows.length) continue;
        const matches = [];
        for (const row of rows) {
          if (matches.length >= 5) break;
          const allVals = Object.values(row).filter(v => v != null).map(v => String(v).toLowerCase());
          if (allVals.some(v => v.includes(q))) matches.push(row);
        }
        if (matches.length) {
          const cfgTitle = t(cfg.titleKey);
          html += `<div class="px-3 py-1 bg-light border-bottom"><small class="fw-bold text-muted"><i class="fa-solid ${cfg.icon} me-1"></i>${cfgTitle}</small></div>`;
          matches.forEach(row => {
            const mainVal = cfg.displayCols.map(c => row[c]).filter(Boolean).join(' - ');
            const realView = cfg.viewName;
            html += `<a href="#" class="d-block px-3 py-2 text-decoration-none border-bottom search-result-item" onclick="$('#smart-search-results').addClass('d-none');$('#smart-search-input').val('');loadView('${realView}','${cfgTitle.replace(/'/g,"\\'")}');return false">
              <div class="fw-semibold text-dark" style="font-size:13px">${highlightMatch(mainVal, q)}</div>
              <small class="text-muted">${cfgTitle}</small></a>`;
            totalResults++;
          });
        }
      }

      if (!totalResults) {
        html = `<div class="px-3 py-3 text-center text-muted"><i class="fa-solid fa-search me-2"></i>${t('no_results')} "<b>${q}</b>"</div>`;
      }

      $r.html(html).removeClass('d-none');
    }

    function highlightMatch(text, query) {
      if (!text || !query) return text || '';
      const idx = text.toLowerCase().indexOf(query.toLowerCase());
      if (idx === -1) return text;
      return text.substring(0, idx) + '<mark class="bg-warning bg-opacity-50 px-0">' + text.substring(idx, idx + query.length) + '</mark>' + text.substring(idx + query.length);
    }

    // Close search results when clicking outside
    $(document).on('click', function(e) {
      if (!$(e.target).closest('#smart-search-input, #smart-search-results').length) {
        $('#smart-search-results').addClass('d-none');
      }
    });
  </script>
</body>

</html>