<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Kim Khanh Jewelry Management</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-color: #054a37; 
            --secondary-color: #1a6b54;
            --accent-gold: #c5a059;
            --accent-gold-light: #e6d3a3;
            --bg-body: #f4f6f8;       
            --text-dark: #2c3e50;
            --sidebar-width: 260px;
            --navbar-height: 70px;
            --success-bright: #00C851;
        }

        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-dark); 
            font-size: 14px; 
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6, .brand-font { font-family: 'Playfair Display', serif; }

        /* LOGIN SCREEN */
        #login-screen {
            background: radial-gradient(circle at center, #0a5c45 0%, #022c20 100%);
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            width: 90%; max-width: 400px;
            border-radius: 12px; padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid var(--accent-gold);
            text-align: center;
        }
        .btn-gold {
            background: linear-gradient(135deg, var(--accent-gold), #b08d45);
            border: none; color: #fff; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.3s; padding: 12px; border-radius: 6px;
        }
        .btn-gold:hover {
            background: linear-gradient(135deg, #b08d45, var(--accent-gold));
            box-shadow: 0 5px 15px rgba(197, 160, 89, 0.4); transform: translateY(-2px); color: white;
        }

        /* LOADING */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85); z-index: 10000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner-gold { color: var(--accent-gold); font-size: 3rem; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* LAYOUT */
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: var(--navbar-height); z-index: 1030; }
        .sidebar {
            background: #fff; position: fixed; top: var(--navbar-height); left: 0;
            width: var(--sidebar-width); height: calc(100vh - var(--navbar-height));
            border-right: 1px solid rgba(0,0,0,0.05); z-index: 1020; transition: 0.3s;
            padding-top: 20px; overflow-y: auto;
        }
        .main-content { margin-top: var(--navbar-height); margin-left: var(--sidebar-width); padding: 30px; transition: 0.3s; }
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); box-shadow: 5px 0 20px rgba(0,0,0,0.1); }
            .main-content { margin-left: 0; padding: 15px; }
        }

        .nav-item {
            padding: 12px 25px; margin: 5px 15px; border-radius: 8px;
            cursor: pointer; color: #666; font-weight: 500; transition: 0.2s; display: flex; align-items: center;
        }
        .nav-item:hover { background-color: #f1f8f6; color: var(--primary-color); }
        .nav-item.active {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white; box-shadow: 0 4px 10px rgba(5, 74, 55, 0.2);
        }

        /* CARDS & TABLES */
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.03); margin-bottom: 20px; background: white; }
        .kpi-card {
            background: white; border-radius: 12px; padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid var(--accent-gold); height: 100%;
        }
        .kpi-value { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin: 0; }
        
        .table-custom thead th { 
            background-color: var(--primary-color); color: white; 
            font-weight: 500; border: none; padding: 15px 10px; text-transform: uppercase; font-size: 0.8rem;
        }
        .table-custom tbody tr { border-bottom: 1px solid #eee; transition: 0.2s; }
        .table-custom tbody tr:hover { background-color: rgba(197, 160, 89, 0.1); cursor: pointer; }
        
        .badge-stock { 
            background-color: #e8f5e9; color: #00C851; border: 1px solid #00C851; 
            padding: 5px 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge-sold { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; padding: 5px 12px; }

        /* PRINT STYLES */
        @media screen { #print-area, #receipt-area { display: none; } }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #receipt-area, #receipt-area * { visibility: visible; }
            
            /* TEM TRANG S·ª®C */
            #print-area { position: absolute; left: 0; top: 0; }
            .jewelry-tag { 
                display: flex; width: 44mm; height: 15mm; 
                font-family: Arial, sans-serif; font-size: 5pt; page-break-inside: avoid; 
                color: black;
            }
            .tag-left { 
                width: 21mm; height: 15mm; 
                border-right: 1px dashed #999; 
                padding: 1px 2px; 
                display: flex; flex-direction: column; justify-content: space-between;
                overflow: hidden;
            }
            .tag-right { 
                width: 23mm; height: 15mm; 
                padding: 1px 2px; padding-left: 4px;
                display: flex; flex-direction: column; justify-content: start;
                overflow: hidden; position: relative;
            }
            .store-name { font-weight: bold; font-size: 4.5pt; text-transform: uppercase; text-align: center; margin-bottom: 1px; }
            .store-addr { font-size: 3.5pt; text-align: center; line-height: 1.1; margin-bottom: 2px;}
            .nxs-block { font-size: 3.5pt; line-height: 1.1; }
            .tccs { font-size: 3.5pt; margin-top: auto; text-align: center; font-weight: bold;}
            .row-top { display: flex; justify-content: space-between; margin-bottom: 1px; }
            .prod-name { font-weight: bold; font-size: 5pt; }
            .prod-symbol { font-size: 4pt; }
            .prod-specs { font-size: 4pt; line-height: 1.2; }
            .klv-row { font-weight: bold; font-size: 6pt; margin-top: 1px; margin-bottom: 1px; }
            .tag-footer { font-weight: bold; font-size: 4pt; text-transform: uppercase; margin-top: auto; text-align: center; }

            /* H√ìA ƒê∆†N */
            #receipt-area { 
                position: absolute; left: 0; top: 0; width: 75mm; 
                font-family: 'Courier New', monospace; font-size: 12px;
                color: black; background: white; padding: 5px;
            }
            .bill-header { text-align: center; margin-bottom: 10px; }
            .bill-title { font-weight: bold; font-size: 16px; text-transform: uppercase; }
            .dashed-line { border-top: 1px dashed #000; margin: 5px 0; }
            .bill-row { display: flex; justify-content: space-between; }
            .bill-total { font-weight: bold; font-size: 14px; margin-top: 10px; }
            .bill-footer { text-align: center; margin-top: 20px; font-style: italic; font-size: 10px; }
        }
    </style>
  </head>
  <body>

    <div id="loading-overlay">
        <i class="fas fa-circle-notch spinner-gold"></i>
        <div class="mt-3 fw-bold text-muted">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <div class="mb-4">
                <i class="fa-solid fa-gem text-warning" style="font-size: 3rem;"></i>
                <h2 class="mt-3 brand-font" style="color: var(--primary-color)">Kim Kh√°nh Gold</h2>
            </div>
            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="mb-3 text-start"><label class="fw-bold small">M√£ nh√¢n vi√™n</label><input type="text" class="form-control" id="username" placeholder="KKH001" required></div>
                <div class="mb-4 text-start"><label class="fw-bold small">M·∫≠t kh·∫©u</label><input type="password" class="form-control" id="password" required></div>
                <button type="submit" class="btn btn-gold w-100">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <nav class="navbar border-bottom fixed-top px-4">
            <div class="d-flex align-items-center">
                <button class="btn btn-light me-3 d-lg-none" type="button" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <span class="fw-bold fs-4 brand-font" style="color: var(--primary-color)"><i class="fas fa-gem me-2 text-warning"></i>KIM KH√ÅNH</span>
            </div>
            <div class="d-flex align-items-center">
                <div class="text-end me-3 d-none d-sm-block"><div class="fw-bold text-dark" id="user-display-name">Admin</div></div>
                <div class="rounded-circle bg-light text-success d-flex justify-content-center align-items-center shadow-sm" style="width: 40px; height: 40px;"><i class="fas fa-user"></i></div>
            </div>
        </nav>

        <div id="sidebar" class="sidebar">
            <div class="p-2">
                <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard"><i class="fas fa-chart-pie me-3"></i>T·ªïng Quan</div>
                <div class="nav-item" onclick="switchView('inventory')" id="nav-inventory"><i class="fas fa-boxes me-3"></i>Kho H√†ng</div>
                <div class="nav-item" onclick="switchView('sales')" id="nav-sales"><i class="fas fa-cash-register me-3"></i>B√°n H√†ng</div>
                <div class="nav-item" onclick="switchView('users')" id="nav-users"><i class="fas fa-users-cog me-3"></i>Nh√¢n Vi√™n</div>
                <hr class="mx-3">
                <div class="nav-item text-danger" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-3"></i>ƒêƒÉng xu·∫•t</div>
            </div>
        </div>

        <div class="main-content">
            <div id="view-dashboard" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="brand-font fw-bold m-0" style="color: var(--primary-color)">B·∫£ng Tin</h3>
                    <span class="badge bg-light text-dark border">H√¥m nay: <span id="current-date">--</span></span>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-4"><div class="kpi-card"><div><div class="kpi-label">Doanh thu</div><div class="kpi-value" id="kpi-revenue">0</div></div><div class="kpi-icon"><i class="fas fa-coins"></i></div></div></div>
                    <div class="col-6 col-md-4"><div class="kpi-card" style="border-left-color: var(--primary-color)"><div><div class="kpi-label">T·ªìn kho</div><div class="kpi-value" id="kpi-stock">0</div></div><div class="kpi-icon" style="color:var(--primary-color); background: #e8f5e9"><i class="fas fa-gem"></i></div></div></div>
                    <div class="col-6 col-md-4"><div class="kpi-card" style="border-left-color: #2c3e50"><div><div class="kpi-label">ƒê√£ b√°n</div><div class="kpi-value" id="kpi-sold">0</div></div><div class="kpi-icon" style="color:#2c3e50; background: #eceff1"><i class="fas fa-check-double"></i></div></div></div>
                </div>
                <div class="card p-4"><h5 class="brand-font mb-3">Bi·ªÉu ƒë·ªì doanh thu 7 ng√†y</h5><div style="height: 300px;"><canvas id="chart-revenue"></canvas></div></div>
            </div>

            <div id="view-inventory" class="view-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="brand-font fw-bold m-0" style="color: var(--primary-color)">Kho H√†ng</h3>
                    <div>
                        <button class="btn btn-gold btn-sm me-1" onclick="showAddModal()"><i class="fas fa-plus"></i> Nh·∫≠p</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="forceReload()"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive" style="max-height: 70vh;">
                        <table class="table table-custom align-middle mb-0 text-nowrap">
                            <thead class="sticky-top"><tr><th>Thao t√°c</th><th>ID</th><th>T√™n SP</th><th>NXS</th><th>HLV</th><th>KLT</th><th>KLH</th><th>KLV</th><th>Ng√†y Nh·∫≠p</th><th>Tr·∫°ng Th√°i</th></tr></thead>
                            <tbody id="inventory-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-sales" class="view-section d-none">
                <h3 class="brand-font fw-bold mb-3" style="color: var(--primary-color)">B√°n H√†ng</h3>
                <div class="card p-3 mb-3"><input type="text" class="form-control border-0 bg-light" id="search-sales" placeholder="üîç T√¨m ki·∫øm..." onkeyup="filterSalesTable()"></div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive" style="max-height: 70vh;">
                        <table class="table table-custom align-middle mb-0">
                            <thead class="sticky-top"><tr><th>Ch·ªçn</th><th>M√£ SP</th><th>T√™n SP</th><th class="text-end">Gi√° B√°n</th><th>Tr·∫°ng Th√°i</th></tr></thead>
                            <tbody id="sales-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-users" class="view-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-3"><h3 class="brand-font fw-bold m-0">Nh√¢n S·ª±</h3><button class="btn btn-primary btn-sm" onclick="showUserModal('add')"><i class="fas fa-user-plus"></i> Th√™m</button></div>
                <div class="card border-0 shadow-sm"><div class="table-responsive"><table class="table table-custom align-middle mb-0"><thead><tr><th>ID</th><th>T√™n</th><th>SƒêT</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody id="users-table-body"></tbody></table></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white"><h5 class="modal-title fw-bold">Th√¥ng Tin S·∫£n Ph·∫©m</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-add">
                        <div class="row g-3">
                            <div class="col-md-6"><label>T√™n S·∫£n Ph·∫©m</label><input type="text" class="form-control" name="tenSp" required></div>
                            <div class="col-md-6"><label>Nh√† Xu·∫•t X∆∞·ªüng</label><select class="form-select" name="maNxs" id="select-nxs" onchange="autoFillOrigin()" required></select></div>
                            <div class="col-4"><label>Xu·∫•t X·ª©</label><input type="text" class="form-control bg-light" name="xuatXu" id="inp-xuatxu" readonly></div>
                            <div class="col-4"><label>H√†m L∆∞·ª£ng</label><select class="form-select" name="hlv" id="select-hlv" required></select></div>
                            <div class="col-4"><label>K√Ω Hi·ªáu</label><input type="text" class="form-control" name="kyHieu" placeholder="VD: C"></div>
                            <div class="col-4"><label>KL T·ªïng (c)</label><input type="number" step="0.01" class="form-control" name="klt" id="inp-klt" oninput="calcKLV()" required></div>
                            <div class="col-4"><label>KL H·ªôt (c)</label><input type="number" step="0.01" class="form-control" name="klh" id="inp-klh" value="0" oninput="calcKLV()" required></div>
                            <div class="col-4"><label class="text-success fw-bold">KL V√†ng</label><input type="text" class="form-control fw-bold text-success" id="out-klv" readonly value="0.0"></div>
                            <div class="col-6"><label>Gi√° Nh·∫≠p</label><input type="text" class="form-control money-input" name="giaNhap" placeholder="0"></div>
                            <div class="col-6"><label>Gi√° B√°n</label><input type="text" class="form-control money-input" name="giaBan" placeholder="0"></div>
                            <div class="col-12"><label>Ti√™u chu·∫©n c∆° s·ªü</label><input type="text" class="form-control" name="tccs" value="01:2024/TCCS"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button><button type="button" class="btn btn-success" id="btn-save-product" onclick="submitProduct()">L∆∞u</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="salesDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-warning">
                <div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold">Thanh To√°n</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-edit-sales">
                       <input type="hidden" id="edit-id">
                       <div class="mb-3"><label class="text-muted">S·∫£n ph·∫©m:</label><input type="text" class="form-control fw-bold border-0 bg-white fs-5" id="view-name" disabled></div>
                       <div class="mb-3"><label class="fw-bold">Gi√° b√°n th·ª±c t·∫ø:</label><input type="text" class="form-control fw-bold text-success fs-4 money-input" id="edit-giaban"></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button><button type="button" class="btn btn-gold w-100" onclick="submitEditSales()">X√ÅC NH·∫¨N & IN</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold" id="userModalTitle">Nh√¢n vi√™n</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-user"><input type="hidden" id="user-action"><div class="mb-3"><label>ID:</label><input type="text" class="form-control" id="u-id" name="id" required></div><div class="mb-3"><label>T√™n:</label><input type="text" class="form-control" id="u-name" name="username" required></div><div class="mb-3"><label>M·∫≠t kh·∫©u:</label><input type="text" class="form-control" id="u-pass" name="password"></div><div class="mb-3"><label>SƒêT:</label><input type="text" class="form-control" id="u-phone" name="phone"></div><div class="mb-3"><label>Tr·∫°ng th√°i:</label><select class="form-select" id="u-status" name="status"><option value="Act">Act</option><option value="Off">Off</option></select></div></form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="submitUser()">L∆∞u</button></div></div></div></div>

    <div id="print-area"></div>
    <div id="receipt-area"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // <<< ƒêI·ªÄN URL WEB APP GOOGLE SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY (K·∫øt th√∫c b·∫±ng /exec) >>>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzv-UUSMqDi-bMl3rNkr1y_nUSvqXmU4CvNM7KLwialDqSa0zjtPaXeyY37JkTD9xk/exec';

    // --- C·∫§U H√åNH H·ªÜ TH·ªêNG ---
    let GLOBAL_DATA = { products: [], store: {}, nxs: [], hlv: [], revenue: 0, stock: 0, sold: 0 };
    let userList = [];
    let charts = {};

    // --- H√ÄM G·ªåI API (THAY TH·∫æ GOOGLE.SCRIPT.RUN) ---
    async function callAPI(action, method = 'GET', bodyData = null) {
        let url = `${SCRIPT_URL}?action=${action}`;
        
        // C·∫•u h√¨nh fetch
        let options = {
            method: method,
            redirect: "follow", // Quan tr·ªçng: Google Script lu√¥n tr·∫£ v·ªÅ redirect 302
        };

        if (method === 'POST') {
             // Google Script y√™u c·∫ßu g·ª≠i text/plain ƒë·ªÉ tr√°nh l·ªói CORS Preflight
            options.headers = { "Content-Type": "text/plain;charset=utf-8" };
            options.body = JSON.stringify(bodyData);
        }

        try {
            const response = await fetch(url, options);
            const json = await response.json();
            return json;
        } catch (error) {
            console.error("L·ªói API:", error);
            Swal.fire('L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß Google', 'error');
            return null;
        }
    }

    // --- KH·ªûI T·∫†O ---
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('vi-VN');
        const u = document.getElementById('username'); if(u) u.value = 'KKH001';
        
        document.addEventListener('keyup', function(e) {
            if(e.target.classList.contains('money-input')) {
                let value = e.target.value.replace(/,/g, '').replace(/\D/g, ''); 
                e.target.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
        });
    });

    // --- UI HELPERS ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }
    function showLoading(show = true) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
    function formatMoney(n) { return n ? parseFloat(n).toLocaleString('en-US') : '0'; }
    function unformatMoney(str) { return str ? str.toString().replace(/,/g, '') : '0'; }

    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.remove('d-none');
        const nav = document.getElementById(`nav-${viewName}`); if(nav) nav.classList.add('active');
        if(viewName === 'users') loadUserList();
        if(viewName === 'inventory') renderTables(); 
        if(window.innerWidth < 992) document.getElementById('sidebar').classList.remove('show');
    }

    // --- 1. X·ª¨ L√ù LOGIN (ƒê√£ s·ª≠a d√πng API POST) ---
    async function handleLogin(e) {
        e.preventDefault();
        showLoading(true);
        
        // G·ªçi API Login
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const res = await callAPI('login', 'POST', { username: u, password: p });
        
        showLoading(false);
        if(res && res.success) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('user-display-name').innerText = res.user.Username;
            loadData(true); 
        } else { 
            Swal.fire('L·ªói', res ? res.message : 'L·ªói kh√¥ng x√°c ƒë·ªãnh', 'error'); 
        }
    }

    function handleLogout() {
            Swal.fire({
            title: 'ƒêƒÉng xu·∫•t?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#054a37'
            }).then((r) => { 
                if (r.isConfirmed) {
                    document.getElementById('app-screen').style.display = 'none';
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('form-login').reset();
                    GLOBAL_DATA = { products: [], store: {}, nxs: [], hlv: [], revenue: 0, stock: 0, sold: 0 };
                }
            });
    }

    // --- 2. T·∫¢I D·ªÆ LI·ªÜU (ƒê√£ s·ª≠a d√πng API GET) ---
    async function loadData(isInitial = false) {
        if(isInitial) showLoading(true);
        
        // G·ªçi Configs (GET)
        const resConfig = await callAPI('getConfigs', 'GET');
        if(resConfig) {
            GLOBAL_DATA.store = resConfig.store;
            GLOBAL_DATA.nxs = resConfig.nxs;
            GLOBAL_DATA.hlv = resConfig.hlv;
            renderDropdowns();
        }

        // G·ªçi Products & Report (GET)
        const resData = await callAPI('getReportData', 'GET');
        if(resData) {
            GLOBAL_DATA.products = resData.products;
            GLOBAL_DATA.stock = resData.stock;
            GLOBAL_DATA.sold = resData.sold;
            GLOBAL_DATA.revenue = resData.revenue;
            
            renderTables();
            renderDashboard();
        }
        
        if(isInitial) showLoading(false);
    }

    function forceReload() {
        showLoading(true);
        loadData(false);
        setTimeout(() => showLoading(false), 1000); 
    }

    // --- 3. RENDER UI (Gi·ªØ nguy√™n) ---
    function renderTables() {
        const invBody = document.getElementById('inventory-table-body');
        invBody.innerHTML = GLOBAL_DATA.products.map(p => `
        <tr onclick="viewProductDetail('${p.ID}')">
            <td onclick="event.stopPropagation()">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-dark" onclick="printLabel('${p.ID}')"><i class="fas fa-barcode"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${p.ID}')"><i class="fas fa-trash-alt"></i></button>
                </div>
            </td>
            <td><small class="text-muted">${p.ID}</small></td>
            <td class="fw-bold">${p.Ten_SP}</td>
            <td>${p.Ma_NXS}</td>
            <td>${p.HLV}</td>
            <td>${p.KLT}</td>
            <td>${p.KLH}</td>
            <td class="text-success fw-bold">${p.KLV}</td>
            <td>${p.Ngay_Nhap}</td>
            <td><span class="badge ${p.Trang_Thai==='T·ªìn kho'?'badge-stock':'badge-sold'}">${p.Trang_Thai==='T·ªìn kho' ? 'S·∫¥N S√ÄNG' : p.Trang_Thai}</span></td>
        </tr>`).join('');
        
        renderSalesTable();
    }

    function renderSalesTable() {
        const t = document.getElementById('search-sales').value.toLowerCase();
        const salesBody = document.getElementById('sales-table-body');
        const saleable = GLOBAL_DATA.products.filter(p => p.Trang_Thai === 'T·ªìn kho' && (p.Ten_SP.toLowerCase().includes(t) || String(p.ID).toLowerCase().includes(t)));
        
        salesBody.innerHTML = saleable.map(p => `
        <tr onclick="showSalesDetail('${p.ID}')" style="cursor:pointer">
            <td>
                <button type="button" class="btn btn-sm btn-gold shadow-sm" onclick="event.stopPropagation(); showSalesDetail('${p.ID}')">B√°n</button>
            </td>
            <td>${p.ID}</td>
            <td class="fw-bold">${p.Ten_SP}</td>
            <td class="text-end fw-bold text-success">${formatMoney(p.Gia_Ban)}</td>
            <td><span class="badge badge-stock">S·∫µn s√†ng</span></td>
        </tr>`).join('');
    }

    function renderDashboard() {
        document.getElementById('kpi-stock').innerText = GLOBAL_DATA.stock;
        document.getElementById('kpi-sold').innerText = GLOBAL_DATA.sold;
        document.getElementById('kpi-revenue').innerText = formatMoney(GLOBAL_DATA.revenue); 
        
        if(charts.revenue) charts.revenue.destroy();
        let mapRev = {};
        GLOBAL_DATA.products.forEach(p => {
            if(p.Trang_Thai === 'ƒê√£ b√°n' && p.Ngay_Ban) {
                let date = p.Ngay_Ban.split(' ')[0];
                let val = parseFloat(String(p.Gia_Ban).replace(/,/g,'')) || 0;
                mapRev[date] = (mapRev[date] || 0) + val;
            }
        });
        charts.revenue = new Chart(document.getElementById('chart-revenue'), {
            type: 'bar',
            data: { labels: Object.keys(mapRev).slice(-7), datasets: [{ label: 'Doanh thu', data: Object.values(mapRev).slice(-7), backgroundColor: '#c5a059' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- 4. C√ÅC ACTION MODAL (ƒê√£ s·ª≠a d√πng API POST) ---
    function showAddModal() { 
        document.getElementById('form-add').reset(); 
        document.getElementById('out-klv').value = '0.0'; 
        document.querySelectorAll('#form-add input').forEach(i => {
            if(i.id !== 'out-klv' && i.id !== 'inp-xuatxu') i.readOnly = false;
        });
        document.getElementById('btn-save-product').style.display = 'block';
        new bootstrap.Modal(document.getElementById('addModal')).show(); 
    }

    function viewProductDetail(id) {
            const p = GLOBAL_DATA.products.find(x => x.ID == id);
            if(!p) return;
            const form = document.getElementById('form-add');
            form.elements['tenSp'].value = p.Ten_SP;
            form.elements['maNxs'].value = p.Ma_NXS;
            form.elements['xuatXu'].value = p.Xuat_Xu;
            form.elements['hlv'].value = p.HLV;
            form.elements['kyHieu'].value = p.Ky_Hieu || '';
            form.elements['klt'].value = p.KLT;
            form.elements['klh'].value = p.KLH;
            form.elements['giaNhap'].value = formatMoney(p.Gia_Nhap);
            form.elements['giaBan'].value = formatMoney(p.Gia_Ban);
            form.elements['tccs'].value = p.TCCS;
            document.getElementById('out-klv').value = p.KLV;

            document.querySelectorAll('#form-add input').forEach(i => i.readOnly = true);
            document.getElementById('btn-save-product').style.display = 'none'; 
            new bootstrap.Modal(document.getElementById('addModal')).show();
    }
    
    async function submitProduct() { 
        const form = document.getElementById('form-add');
        const formData = new FormData(form);
        const obj = Object.fromEntries(formData.entries());
        obj.giaNhap = unformatMoney(obj.giaNhap); 
        obj.giaBan = unformatMoney(obj.giaBan);
        
        showLoading(true);
        // G·ªçi API POST
        const res = await callAPI('addProduct', 'POST', obj);
        
        showLoading(false);
        if(res && res.success) { 
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide(); 
            Swal.fire({icon:'success', title:'ƒê√£ l∆∞u', timer: 1000, showConfirmButton: false});
            loadData(false); 
        } else { 
            Swal.fire('L·ªói', res ? res.message : 'Error', 'error'); 
        }
    }

    function showSalesDetail(id) {
        const p = GLOBAL_DATA.products.find(x => x.ID == id);
        if(!p) return;
        document.getElementById('edit-id').value = p.ID;
        document.getElementById('view-name').value = p.Ten_SP;
        document.getElementById('edit-giaban').value = formatMoney(p.Gia_Ban); 
        new bootstrap.Modal(document.getElementById('salesDetailModal')).show();
    }

    async function submitEditSales() {
        const id = document.getElementById('edit-id').value;
        const finalPrice = unformatMoney(document.getElementById('edit-giaban').value);
        const p = GLOBAL_DATA.products.find(x => x.ID == id);
        
        showLoading(true);
        // Step 1: C·∫≠p nh·∫≠t gi√° b√°n m·ªõi (POST)
        await callAPI('updateSoldProduct', 'POST', {editId: id, editGiaBan: finalPrice});
        
        // Step 2: Th·ª±c hi·ªán b√°n (POST)
        const res = await callAPI('sellProduct', 'POST', {id: id});
        
        showLoading(false);
        if(res && res.success) {
            bootstrap.Modal.getInstance(document.getElementById('salesDetailModal')).hide();
            printReceipt(p, GLOBAL_DATA.store, finalPrice);
            Swal.fire({icon: 'success', title: 'ƒê√£ b√°n', timer: 1500, showConfirmButton: false});
            loadData(false);
        } else {
             Swal.fire('L·ªói', res ? res.message : 'L·ªói b√°n h√†ng', 'error');
        }
    }

    // --- 5. IN ·∫§N (Gi·ªØ nguy√™n) ---
    function printLabel(id) {
        const product = GLOBAL_DATA.products.find(p => p.ID == id);
        if(!product) return;
        const store = GLOBAL_DATA.store;
        const nxs = GLOBAL_DATA.nxs.find(n => n.Ma_NXS == product.Ma_NXS) || {Ten_Day_Du: product.Ma_NXS, Dia_Chi: ''};
        
        document.getElementById('print-area').innerHTML = `
            <div class="jewelry-tag">
                <div class="tag-left">
                    <div class="store-name">${store.Ten_Cua_Hang || 'DOANH NGHI·ªÜP T∆Ø NH√ÇN V√ÄNG B·∫†C KIM KH√ÅNH'}</div>
                    <div class="store-addr">${store.Dia_Chi || 'ƒê/c: L√¥ s·ªë 5 nh√† 1, T·∫ßng 1 Ch·ª£ ƒê√¥ng H√†, TP. ƒê√¥ng H√†, Qu·∫£ng Tr·ªã'}</div>
                    <div class="nxs-block">
                        <b>NXS:</b> ${nxs.Ten_Day_Du}<br>
                        ƒê/c: ${nxs.Dia_Chi || ''}
                    </div>
                    <div class="tccs">${product.TCCS || 'TCCS 01:2024/PNJP'}</div>
                </div>
                <div class="tag-right">
                    <div class="row-top">
                        <span class="prod-name">${product.Ten_SP}</span>
                        <span class="prod-symbol">K√Ω hi·ªáu: ${product.Ky_Hieu || ''}</span>
                    </div>
                    <div class="prod-specs">
                        Xu·∫•t x·ª©: ${product.Xuat_Xu || 'Vi·ªát Nam'}<br>
                        HLV: ${product.HLV}
                    </div>
                    <div class="prod-specs">
                        KLT: ${product.KLT} ch·ªâ &nbsp;&nbsp;&nbsp; KLH: ${product.KLH} ch·ªâ
                    </div>
                    <div class="klv-row">KLV: &nbsp;&nbsp;&nbsp; ${product.KLV} ch·ªâ</div>
                    <div class="tag-footer">KIM KH√ÅNH ${product.HLV.replace('K','')}K</div>
                </div>
            </div>`;
        setTimeout(() => window.print(), 300);
    }

    function printReceipt(p, store, actualPrice) {
        const area = document.getElementById('receipt-area');
        const now = new Date();
        const dateStr = now.toLocaleDateString('vi-VN') + ' ' + now.toLocaleTimeString('vi-VN');
        const priceStr = formatMoney(actualPrice);
        
        area.innerHTML = `
            <div class="bill-header">
                <div class="bill-title">${store.Ten_Cua_Hang || 'KIM KH√ÅNH JEWELRY'}</div>
                <div>${store.Dia_Chi || 'ƒê√¥ng H√†, Qu·∫£ng Tr·ªã'}</div>
                <div>Hotline: ${store.SDT || ''}</div>
            </div>
            <div class="dashed-line"></div>
            <div class="text-center">H√ìA ƒê∆†N B√ÅN L·∫∫</div>
            <div class="text-center small">${dateStr}</div>
            <div class="dashed-line"></div>
            <div class="bill-row fw-bold"><span>S·∫£n ph·∫©m</span><span>Th√†nh ti·ªÅn</span></div>
            <div class="bill-row" style="margin-top:5px">
                <span style="max-width: 60%">${p.Ten_SP}<br><small>(${p.HLV} - ${p.KLV}c)</small></span>
                <span>${priceStr}</span>
            </div>
            <div class="dashed-line"></div>
            <div class="bill-row bill-total"><span>T·ªîNG C·ªòNG:</span><span>${priceStr} ƒë</span></div>
            <div class="bill-footer">Xin c·∫£m ∆°n v√† h·∫πn g·∫∑p l·∫°i!<br><i>Vui l√≤ng gi·ªØ l·∫°i h√≥a ƒë∆°n ƒë·ªÉ b·∫£o h√†nh.</i></div>
        `;
        setTimeout(() => window.print(), 500);
    }

    // --- HELPERS (Logic c≈©, thay ƒë·ªïi c√°ch g·ªçi API) ---
    async function deleteItem(id) { 
        if(confirm('X√≥a SP n√†y?')) { 
            showLoading(true); 
            const res = await callAPI('deleteProduct', 'POST', {id: id});
            if(res && res.success) loadData(false);
            else { showLoading(false); Swal.fire('L·ªói', 'Kh√¥ng x√≥a ƒë∆∞·ª£c', 'error'); }
        } 
    }
    
    function calcKLV() { document.getElementById('out-klv').value = (parseFloat(document.getElementById('inp-klt').value)||0 - parseFloat(document.getElementById('inp-klh').value)||0).toFixed(1); }
    function filterSalesTable() { renderSalesTable(); }
    function renderDropdowns() {
            const nxs = document.getElementById('select-nxs'); const hlv = document.getElementById('select-hlv');
            if(nxs) nxs.innerHTML = '<option value="">--Ch·ªçn--</option>' + GLOBAL_DATA.nxs.map(n => `<option value="${n.Ma_NXS}">${n.Ten_Day_Du}</option>`).join('');
            if(hlv) hlv.innerHTML = GLOBAL_DATA.hlv.map(h => `<option value="${h.HLV}">${h.HLV}</option>`).join('');
    }
    function autoFillOrigin() { const val = document.getElementById('select-nxs').value; const item = GLOBAL_DATA.nxs.find(n => n.Ma_NXS == val); document.getElementById('inp-xuatxu').value = item ? (item.Xuat_Xu||'VN') : ''; }
    
    // --- 6. USERS MANAGEMENT (API POST/GET) ---
    async function loadUserList() { 
        const data = await callAPI('getUserList', 'GET');
        if(data) {
            userList = data; 
            document.getElementById('users-table-body').innerHTML = data.map(u => `<tr><td>${u.ID}</td><td>${u.Username}</td><td>${u.Phone}</td><td>${u.Status}</td><td><button class="btn btn-sm btn-warning" onclick="showUserModal('edit','${u.ID}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger ms-1" onclick="deleteUser('${u.ID}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); 
        }
    }

    function showUserModal(action, id) { document.getElementById('form-user').reset(); document.getElementById('user-action').value = action; document.getElementById('userModalTitle').innerText = action === 'add' ? 'Th√™m NV' : 'S·ª≠a NV'; document.getElementById('u-id').readOnly = (action !== 'add'); if(action === 'edit') { const u = userList.find(x => x.ID == id); if(u) { document.getElementById('u-id').value = u.ID; document.getElementById('u-name').value = u.Username; document.getElementById('u-phone').value = u.Phone; document.getElementById('u-status').value = u.Status; } } new bootstrap.Modal(document.getElementById('userModal')).show(); }
    
    async function submitUser() { 
        const form = document.getElementById('form-user'); 
        const data = Object.fromEntries(new FormData(form).entries()); 
        const action = document.getElementById('user-action').value;
        showLoading(true); 
        
        const res = await callAPI('manageUser', 'POST', {actionType: action, userData: data});
        
        showLoading(false); 
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide(); 
        if(res && res.success) { Swal.fire('OK', res.message, 'success'); loadUserList(); } 
        else Swal.fire('L·ªói', res ? res.message : 'Error', 'error'); 
    }
    
    async function deleteUser(id) { 
        if(confirm('X√≥a nh√¢n vi√™n?')) {
            const res = await callAPI('manageUser', 'POST', {actionType: 'delete', userData: {id: id}});
            if(res && res.success) loadUserList();
        }
    }
</script>
  </body>
</html>
